// AUTO-GENERATED FILE, do not edit, use 'npm run dist' to build
// Copyright and licensing information at https://github.com/marcodb26/TabMania/blob/main/LICENSE

function setProd(flag){Object.defineProperty(window,"productionCode",{value:flag,configurable:false,enumerable:false,writable:false})}setProd(true);function isProd(){return window.productionCode??false}function optionalWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null){return defaultValue}return value}function emptyFn(){}Classes={};Classes.Base={_Base_:{lastId:0,_idGen:function(){return++this.lastId}},__idPrefix:null,roDef:function(obj,propName,propValue){Object.defineProperty(obj,propName,{value:propValue,configurable:true,enumerable:false,writable:false})},_genLogFn:function(consoleFn,setPrefix=false,consoleObj=console){if(!setPrefix){return Function.prototype.bind.call(consoleFn,consoleObj)}return Function.prototype.bind.call(consoleFn,consoleObj,"["+this._id+"]")},create:function(){return this.createAs(null,...arguments)},createAs:function(id,...restArgs){var retVal=Object.create(this);this.roDef(retVal,"_hiddenId",this._Base_._idGen());this.roDef(retVal,"_id",id==null?this._formatId(retVal._hiddenId):id);this.debug.call(retVal,false);this.roDef(retVal,"_err",this._genLogFn.call(retVal,console.error,true));this.roDef(retVal,"_assert",this._genLogFn.call(retVal,console.assert));retVal._init.apply(retVal,restArgs);return retVal},debug:function(flag=true){if(flag&&!isProd()){this.roDef(this,"_log",this._genLogFn(console.log,true));this.roDef(this._log,"raw",this._genLogFn(console.log,false));this.roDef(this._log,"trace",this._genLogFn(console.trace,true))}else{this.roDef(this,"_log",emptyFn);this.roDef(this._log,"raw",emptyFn);this.roDef(this._log,"trace",emptyFn)}},subclass:function(extension){return Object.assign({},this,extension)},getId:function(){return this._id},_init:function(){},_formatId:function(hiddenId){if(this.__idPrefix==null){return hiddenId}return this.__idPrefix+"-"+hiddenId},_errorMustSubclass:function(){return Function.prototype.bind.call(console.error,console,"This method must be subclassed: ")}()};Classes.AsyncBase=Classes.Base.subclass({_initPromise:null,_initialized:null,_init:function(){Classes.Base._init.call(this);this._initialized=false;this._initPromise=this._asyncInit().then(function(){this._initialized=true}.bind(this))},_asyncInit:function(){return Promise.resolve()},isInitialized:function(){return this._initialized},getInitPromise:function(){return this._initPromise}});Classes.EventManager=Classes.Base.subclass({_elem:null,_ownerObj:null,_init:function(domId){Classes.Base._init.call(this);this._elem=document.createElement("div");if(domId!=null){this._elem.setAttribute("id",domId);document.body.append(this._elem)}this.addEventListener=this._elem.addEventListener.bind(this._elem);this.removeEventListener=this._elem.removeEventListener.bind(this._elem)},dispatchEvent:function(eventName,detailObj){this._elem.dispatchEvent(new CustomEvent(eventName,{detail:detailObj}))},notifyListeners:function(eventId,extraData={}){let detail=Object.assign({target:this._ownerObj},extraData);this.dispatchEvent(eventId,detail)},attachRegistrationFunctions:function(obj){obj.addEventListener=this.addEventListener;obj.removeEventListener=this.removeEventListener;this._assert(this._ownerObj==null);this._ownerObj=obj},discard:function(){this.addEventListener=null;this.removeEventListener=null;this._ownerObj.addEventListener=null;this._ownerObj.removeEventListener=null;this._ownerObj=null;this._elem.remove();gcChecker.add(this);gcChecker.add(this._elem,this.getId()+"._elem");this._elem=null},addEventListener:function(){},removeEventListener:function(){}});Classes.Base.roDef(Classes.EventManager,"Events",{});Classes.Base.roDef(Classes.EventManager.Events,"UPDATED","tmUpdated");Classes.EventListenersWrapper=Classes.Base.subclass({_weakRefListeners:null,_listenFnName:null,_unlistenFnName:null,_init:function(listenFnName="addEventListener",unlistenFnName="removeEventListener"){Classes.Base._init.call(this);this.debug();this._weakRefListeners=[];this._listenFnName=listenFnName;this._unlistenFnName=unlistenFnName},listen:function(obj,...listenerArgs){const logHead="EventListenersWrapper.listen():";if(obj==null){this._err(logHead,"event target can't be null",obj);return}let weakRefArgs=[];for(let i=0;i<arguments.length;i++){if(["function","object"].includes(typeof arguments[i])){try{weakRefArgs[i]={weakRef:new WeakRef(arguments[i]),type:"weakRef"}}catch(e){this._err(logHead,"building new WeakRef(), on argument ",i,arguments[i]);throw e}}else{weakRefArgs[i]={arg:arguments[i],type:"standard"}}}this._weakRefListeners.push(weakRefArgs);obj[this._listenFnName].apply(obj,listenerArgs)},unlisten:function(obj,...listenerArgs){const logHead="EventListenersWrapper.unlisten():";if(obj[this._unlistenFnName]==null){this._log(logHead,"obj",obj?.getId()??"[not derived from Base]","missing _unlistenFnName =",this._unlistenFnName,arguments);return}obj[this._unlistenFnName].apply(obj,listenerArgs)},_unlistenWrapper:function(weakRefObj,...listenerWeakRefArgs){let allArgs=[];for(let i=0;i<arguments.length;i++){switch(arguments[i].type){case"weakRef":allArgs[i]=arguments[i].weakRef.deref();break;case"standard":allArgs[i]=arguments[i].arg;break}if(allArgs[i]===undefined){return}}this.unlisten.apply(this,allArgs)},clear:function(){for(let i=0;i<this._weakRefListeners.length;i++){this._unlistenWrapper.apply(this,this._weakRefListeners[i])}this._weakRefListeners=[]},discard:function(){this.clear()}});Classes.Error=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)}});Classes.Base.roDef(Classes.Error,"NOTRUNNING","Not running");Classes.TmUtils=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug();this.err=this._err;this.log=this._log;if(isProd()){this.freeze=this._freezeProd}else{this.freeze=this._freezeDev}},err:null,log:null,isEqual:function(objA,objB,verbose){verbose=optionalWithDefault(verbose,false);const logHead="TmUtils::isEqual():";let debugFn=this._log;if(!verbose){debugFn=emptyFn}if(typeof objA!=typeof objB){debugFn(logHead,"different types",objA,objB);return false}if(typeof objA!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead,'"'+typeof objA+'" is not supported');return objA===objB}if(Array.isArray(objA)){if(Array.isArray(objB)){if(objA.length!=objB.length){debugFn(logHead,"different array length",objA,objB);return false}for(let i=0;i<objA.length;i++){if(!this.isEqual(objA[i],objB[i],verbose)){debugFn(logHead,"different array value at index:",i,objA,objB);return false}}return true}else{debugFn(logHead,"objA is an Array, objB is not",objA,objB);return false}}if(objA==null||objB==null){return objA===objB}let keysA=Object.keys(objA).sort();let keysB=Object.keys(objB).sort();if(keysA.length!=keysB.length){debugFn(logHead,"different object key counts",keysA,keysB);return false}for(let i=0;i<keysA.length;i++){if(keysA[i]!=keysB[i]){debugFn(logHead,"different keys:",keysA[i]," / ",keysB[i]);return false}if(!this.isEqual(objA[keysA[i]],objB[keysB[i]],verbose)){debugFn(logHead,"different values for key:",keysA[i],objA[keysA[i]],objB[keysB[i]]);return false}}return true},deepCopy:function(obj){const logHead="TmUtils::deepCopy(): ";if(obj===undefined){return undefined}if(typeof obj=="string"){return obj.repeat(1)}if(typeof obj!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead+'"'+typeof objA+'" is not supported');return obj}if(obj==null){return null}if(Array.isArray(obj)){let retVal=Array(obj.length);for(let i=0;i<obj.length;i++){retVal[i]=this.deepCopy(obj[i])}return retVal}let retVal={};let keys=Object.keys(obj);for(let i=0;i<keys.length;i++){retVal[keys[i]]=this.deepCopy(obj[keys[i]])}return retVal},arrayDiff:function(a,b,sortCmpFn,nodeCmpFn,inPlace){inPlace=optionalWithDefault(inPlace,true);let basicSortCmpFn=function(x,y){if(x==y){return 0}if(x<y){return-1}return 1};let basicNodeCmpFn=function(x,y){return x==y};sortCmpFn=optionalWithDefault(sortCmpFn,basicSortCmpFn);nodeCmpFn=optionalWithDefault(nodeCmpFn,basicNodeCmpFn);if(!inPlace){a=[].concat(a);b=[].concat(b)}a.sort(sortCmpFn);b.sort(sortCmpFn);let added=[];let deleted=[];let changed=[];let aIdx=0;let bIdx=0;for(;aIdx<a.length&&bIdx<b.length;){let sortCmpResult=sortCmpFn(a[aIdx],b[bIdx]);if(sortCmpResult==0){if(!nodeCmpFn(a[aIdx],b[bIdx])){changed.push(b[bIdx])}aIdx++;bIdx++}else{if(sortCmpResult<0){deleted.push(a[aIdx]);aIdx++}else{added.push(b[bIdx]);bIdx++}}}for(;aIdx<a.length;aIdx++){deleted.push(a[aIdx])}for(;bIdx<b.length;bIdx++){added.push(b[bIdx])}return[added,deleted,changed]},_regexEscapePatternObj:/[-\/\\^$*+?.()|[\]{}]/g,regexEscape:function(string){return string.replace(this._regexEscapePatternObj,"\\$&")},_freezeDev:function(obj){return Object.freeze(obj)},_freezeProd:function(obj){return obj},freeze:null,splitCamelCase:function(str){let splits=str.split(/([A-Z][a-z]+)/);let lowerCaseSplits=[];for(let i=0;i<splits.length;i++){if(splits[i]!=""){lowerCaseSplits.push(splits[i].toLowerCase())}}if(lowerCaseSplits.length==0){return""}lowerCaseSplits[0]=this.toUpperCaseInitial(lowerCaseSplits[0]);return lowerCaseSplits.join(" ")},toLowerCaseInitial:function(str){return str.charAt(0).toLowerCase()+str.substring(1)},toUpperCaseInitial:function(str){return str.charAt(0).toUpperCase()+str.substring(1)},isTabPinned:function(tab){return tab.pinned||tab.tm.pinInherited!=null}});Classes.Base.roDef(window,"tmUtils",Classes.TmUtils.create());tmUtils.debug();Classes.TmConsole=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this)},clearStorage:function(){chrome.storage.local.clear();chrome.storage.sync.clear()},showStorage:function(){chrome.storage.local.get(function(result){console.log(result)});chrome.storage.sync.get(function(result){console.log(result)})},_showTabInfoInner:function(tabId,bsTabLabel){let tabsBsTabViewer=popupViewer.getBsTabByLabel(bsTabLabel);let[tabInfo,tileInfo]=tabsBsTabViewer.getTabInfo(tabId);if(tileInfo==null&&tabInfo==null){console.log('Not found in bsTab "'+bsTabLabel+'"');return}console.log('Found in bsTab "'+bsTabLabel+'"');if(tileInfo!=null&&tabInfo==null){console.log("tabInfo (through tile):",tileInfo.getTabInfo())}else{console.log("tabInfo:",tabInfo)}console.log("tileInfo:",tileInfo)},showTabInfo:function(tabId){this._showTabInfoInner(tabId,"home");this._showTabInfoInner(tabId,"incognito")},showSearchParserInfo:function(){let allTabsBsTabViewer=null;if(popupViewer.isSettingsBsTabActive()){allTabsBsTabViewer=popupViewer.getHomeBsTab()}else{allTabsBsTabViewer=popupViewer.getActiveBsTab()}let searchParserText=allTabsBsTabViewer.getSearchParserInfo();if(searchParserText==null){console.log("No active search, nothing to show");return}console.log(searchParserText)},showBookmarksStats:function(){if(!bookmarksManager.isActive()){console.log("bookmarksManager is not active");return}console.log("bookmarksManager statistics:",bookmarksManager.getStats())},_getRandomInt:function(min,max){return Math.floor(min)+Math.floor(Math.random()*Math.floor(max-min))},testConcatPush:function(){let createArrays=function(arrayCnt,arraySize){let retVal=Array(arrayCnt);for(let i=0;i<arrayCnt;i++){retVal[i]=Array(arraySize);for(let j=0;j<arraySize;j++){retVal[i][j]=this._getRandomInt(0,100)}}return retVal}.bind(this);function appendArray(dst,src){let dstLength=dst.length;let srcLength=src.length;dst.length=dstLength+srcLength;for(let i=0;i<srcLength;i++){dst[dstLength+i]=src[i]}}let maxRepeat=100;let origArray=createArrays(1e3,100);perfProf.mark("testConcatPush_concatStart");let concatResult=null;for(let r=0;r<maxRepeat;r++){concatResult=[].concat.apply([],origArray)}perfProf.mark("testConcatPush_concatEnd");perfProf.mark("testConcatPush_pushStart");let pushResult=null;for(let r=0;r<maxRepeat;r++){pushResult=[];for(let i=0;i<origArray.length;i++){pushResult.push.apply(pushResult,origArray[i])}}perfProf.mark("testConcatPush_pushEnd");perfProf.mark("testConcatPush_appendStart");let appendResult=null;for(let r=0;r<maxRepeat;r++){appendResult=[];for(let i=0;i<origArray.length;i++){appendArray(appendResult,origArray[i])}}perfProf.mark("testConcatPush_appendEnd");if(!tmUtils.isEqual(concatResult,pushResult)){this._err("Invalid result, concat() and push() generated different output arrays");return}if(!tmUtils.isEqual(concatResult,appendResult)){this._err("Invalid result, concat() and appendArray() generated different output arrays");return}console.log("Valid result, concat(), push() and appendArray() generated the same output");let toMeasure={concat:["testConcatPush_concatStart","testConcatPush_concatEnd"],push:["testConcatPush_pushStart","testConcatPush_pushEnd"],append:["testConcatPush_appendStart","testConcatPush_appendEnd"]};perfProf.showMeasures(toMeasure);perfProf.clearMarksByPrefix(toMeasure);perfProf.clearMeasures(toMeasure)},testIncludesRegex:function(){let createStrings=function(stringCnt,stringLength){let retVal=Array(stringCnt);for(let i=0;i<stringCnt;i++){let tmp=[];for(let j=0;j<stringLength;j++){tmp.push(String.fromCharCode(this._getRandomInt(97,122)))}retVal[i]=tmp.join("")}return retVal}.bind(this);let maxRepeat=100;let strings=createStrings(1e4,1e3);function runTest(testFn){let found=null;for(let r=0;r<maxRepeat;r++){found=[];for(let i=0;i<strings.length;i++){if(testFn(strings[i])){found.push(strings[i])}}}return found}let queries=createStrings(10,50);let regex=null;let escapedQueries=[];for(let i=0;i<queries.length;i++){queries[i]="aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"+queries[i];escapedQueries[i]=tmUtils.regexEscape(queries[i])}console.log("queries, escapedQueries",queries,escapedQueries);try{regex=new RegExp("("+escapedQueries.join(")|(")+")")}catch(e){console.error("Unable to parse regex",e);return}perfProf.mark("testIncludesRegex_includesStart");let includesFound=runTest(function(string){for(let i=0;i<queries.length;i++){if(string.includes(queries[i])){return true}}return false});perfProf.mark("testIncludesRegex_includesEnd");perfProf.mark("testIncludesRegex_regexStart");let regexFound=runTest(function(string){return regex.test(string)});perfProf.mark("testIncludesRegex_regexEnd");if(!tmUtils.isEqual(includesFound,regexFound)){this._err("Invalid result, includes() and RegExp.test() generated different output strings");return}console.log("Valid result, includes() and RegExp.test() generated the same output:",regexFound);let toMeasure={"includes()":["testIncludesRegex_includesStart","testIncludesRegex_includesEnd"],"RegExp.test()":["testIncludesRegex_regexStart","testIncludesRegex_regexEnd"]};perfProf.showMeasures(toMeasure);perfProf.clearMarksByPrefix(toMeasure);perfProf.clearMeasures(toMeasure)}});Classes.Base.roDef(window,"tmConsole",Classes.TmConsole.create());tmConsole.debug();Classes.PersistentDict=Classes.AsyncBase.subclass({_storageObj:null,_dict:null,_eventManager:null,_initPromise:null,_initialized:null,_init:function(storageObj=chrome.storage.local){this.debug();this._storageObj=storageObj;this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);chrome.storage.onChanged.addListener(this._onStorageChangedCb.bind(this));Classes.AsyncBase._init.call(this)},_asyncInit:function(){let parentPromise=Classes.AsyncBase._asyncInit.call(this);let thisPromise=chromeUtils.storageGet(this._id,this._storageObj).then(function(results){const logHead="PersistentDict._initDict().cb:";this._dict={};if(this._id in results){this._dict=results[this._id];this._log(logHead,"initializing this._dict to",this._dict)}else{this._log(logHead,"key",this._id,"not found, initializing empty")}}.bind(this));return Promise.all([parentPromise,thisPromise])},_onStorageChangedCb:function(changes,areaName){const logHead="PersistentDict._onStorageChangedCb("+areaName+"):";if(!this.isInitialized()){this._log(logHead,"still initializing, ignoring event");return}if(chromeUtils.storageObjByAreaName(areaName)!=this._storageObj){this._log(logHead,"not my storage object, ignoring event");return}if(!(this._id in changes)){this._log(logHead,"not my storage key, ignoring event",changes);return}if(tmUtils.isEqual(this._dict,changes[this._id].newValue)){this._log(logHead,"the object has not changed, ignoring event",changes);return}this._log(logHead,"setting to",changes[this._id]);this._dict=changes[this._id].newValue??{};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED)},_persist:function(){var items={};items[this._id]=this._dict;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED);return chromeUtils.storageSet(items,this._storageObj)},_setInner:function(key,value=null){if(tmUtils.isEqual(this._dict[key],value)){return false}this._dict[key]=tmUtils.deepCopy(value);return true},set:function(key,value=null){const logHead="PersistentDict.set():";this._assert(this.isInitialized(),logHead,"still waiting for initialization",key,value);if(this._setInner(key,value)){return this._persist()}this._log(logHead,"the key has not changed, ignoring call",key,value);return Promise.resolve()},get:function(key){const logHead="PersistentDict.get():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");return tmUtils.deepCopy(this._dict[key])},has:function(key,ignoreCase=false){const logHead="PersistentDict.has():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(!ignoreCase){return key in this._dict}let allKeys=Object.keys(this._dict);let searchKey=key.toLowerCase();let result=allKeys.findIndex(function(currKey){return currKey.toLowerCase()==searchKey});return result!=-1},rename:function(key,newKey){const logHead="PersistentDict.rename("+key+", "+newKey+"):";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(!(key in this._dict)){this._log(logHead,"original key not in _dict, nothing to do");return Promise.resolve()}if(newKey in this._dict){this._err(logHead,"new key already in _dict, can't overwrite");return Promise.reject()}this._dict[newKey]=this._dict[key];delete this._dict[key];this._log(logHead,"completed",this._dict);return this._persist()},_delInner:function(key){if(!(key in this._dict)){return false}delete this._dict[key];return true},del:function(key){const logHead="PersistentDict.del():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(this._delInner(key)){return this._persist()}return Promise.resolve()},delMany:function(keyList){let anyChanges=false;for(let i=0;i<keyList.length;i++){if(this._delInner(keyList[i])){anyChanges=true}}if(anyChanges){return this._persist()}return Promise.resolve()},setAll:function(dict){const logHead="PersistentDict.setAll():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(tmUtils.isEqual(this._dict,dict)){this._log(logHead,"the object has not changed, ignoring call",dict,this._dict);return Promise.resolve()}this._dict=tmUtils.deepCopy(dict);return this._persist()},getAll:function(){const logHead="PersistentDict.getAll():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");return tmUtils.deepCopy(this._dict)},getAllKeys:function(){const logHead="PersistentSet.getAllKeys():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");return Object.keys(this._dict)}});Classes.PersistentSet=Classes.PersistentDict.subclass({add:function(key){return this.set(key)},addMany:function(keyList){let anyChanges=false;for(let i=0;i<keyList.length;i++){if(this._setInner(keyList[i])){anyChanges=true}}if(anyChanges){return this._persist()}return Promise.resolve()},getAll:function(){return this.getAllKeys()},setAll:function(keys){let dict={};for(let i=0;i<keys.length;i++){dict[keys[i]]=null}return Classes.PersistentDict.setAll.call(this,dict)}});Classes.GarbageCollectionChecker=Classes.Base.subclass({_weakRefs:null,_cnt:null,_init:function(){Classes.Base._init.call(this);this.debug();this._weakRefs=[];this._cnt=0;if(isProd()){this.add=emptyFn}else{this.add({txt:"a test object"},"test-obj")}},add:function(obj,label=obj.getId?.()??""){this._weakRefs.push({weakRef:new WeakRef(obj),label:label,timestamp:performance.now(),pos:this._cnt++})},check:function(clear=false){let cleared=[];let collected=[];let more=true;while(this._weakRefs.length>0&&clear&&more){if(this._weakRefs[0].weakRef.deref()===undefined){let item=this._weakRefs.shift();cleared.push(item);collected.push(item)}else{more=false}}for(let i=0;i<this._weakRefs.length;i++){if(this._weakRefs[0].weakRef.deref()===undefined){collected.push(this._weakRefs[i])}}return{cleared:cleared,collected:collected,weakRefs:this._weakRefs}}});Classes.Base.roDef(window,"gcChecker",Classes.GarbageCollectionChecker.createAs("gcChecker"));Classes.BoundArray=Classes.Base.subclass({_array:null,_maxElements:null,_init:function(maxElements){Classes.Base._init.apply(this,arguments);this._maxElements=maxElements;this._array=[];this.debug()},resize:function(){if(this._array.length>=this._maxElements){this._array.splice(0,this._maxElements-this._array.length)}return this._array.length},push:function(value){this._array.push(value);return this.resize()},pop:function(){return this._array.pop()},isEmpty:function(){return this._array.length==0},peek:function(cnt){if(this.isEmpty()){return null}if(cnt==null){return this._array[this._array.length-1]}if(cnt>this._array.length){cnt=this._array.length}return this._array.slice(-cnt)},append:function(value){this._array.splice(-1,0,...value);return this.resize()},removeValueOLD:function(value){var nextIndex=0;while((nextIndex=this._array.indexOf(value,nextIndex))!=-1){this._array.splice(nextIndex,1)}},removeValue:function(value,matchFn){matchFn=optionalWithDefault(matchFn,function(a,b){return a==b});const logHead="BoundArray::removeValue("+value+"): ";let foundIdx=[];for(let i=0;i<this._array.length;i++){if(matchFn(value,this._array[i])){foundIdx.push(i)}}this._log(logHead+"need to remove these indices:",foundIdx);for(let i=foundIdx.length-1;i>=0;i--){this._log(logHead+"now removing index "+foundIdx[i]+" (value = "+this._array[foundIdx[i]]+")");this._array.splice(foundIdx[i],1)}},get:function(pos){if(pos!=undefined){return this._array[pos]}return this._array}});Classes.MsgServer=Classes.Base.subclass({_cmdMap:null,_init:function(){Classes.Base._init.apply(this,arguments);this._cmdMap={}},start:function(){chrome.runtime.onMessage.addListener(this._processMsgCb.bind(this))},_printTabInfo:function(tab){if(tab){return tab.id}return"[extension]"},_processMsgInner:function(request,sender,sendResponse){if(request.cmd in this._cmdMap){return this._cmdMap[request.cmd].fn.apply(this,arguments)}else{return this.formatErrMsg("unknown command: "+request.cmd)}},_processMsgCb:function(request,sender,sendResponse){const logHead="MsgServer::_processMsgCb(from tab "+this._printTabInfo(sender.tab)+"): ";this._log(logHead+JSON.stringify(request),sender);var response=this._processMsgInner.apply(this,arguments);if(response==null){if(this._cmdMap[request.cmd].needResponse){return true}sendResponse("");return false}sendResponse(response);return false},addCmd:function(cmd,fn,needResponse){needResponse=optionalWithDefault(needResponse,true);var cmdWrapper=safeFnWrapper(fn,null,function(e){this._err('cmd "'+cmd+'" generated an exception: ',e);return this.formatErrMsg(e.message,e.toString())}.bind(this));this._cmdMap[cmd]={fn:cmdWrapper,needResponse:needResponse}},formatErrMsg:function(msg,details){var retVal={status:"error",message:msg};if(details!=null){retVal.details=details}return retVal}});Classes.MsgClient=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)},_requestInner:function(request){const logHead="MsgClient::_requestInner("+JSON.stringify(request)+"): ";this._log(logHead+"entering");return chromeUtils.wrap(chrome.runtime.sendMessage,logHead,request)},_formatRequest:function(cmd,otherOptions){return{cmd:cmd,...otherOptions}},sendRequest:function(cmd,otherOptions){const request=this._formatRequest.apply(this,arguments);return this._requestInner(request).then(function(response){this._debugResponse(cmd,response);return response}.bind(this))},sendNotification:function(cmd,otherOptions){const notification=this._formatRequest.apply(this,arguments);return this._requestInner(notification)},_debugResponse:function(cmd,response){const logHead="MsgClient::_debugResponse("+cmd+"): ";if(response.status!="success"){this._err(logHead+"response failed: "+JSON.stringify(response))}}});function optArrayWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null||value.length==0){return defaultValue}return value}function delay(delayTime){return new Promise(function(resolve){setTimeout(resolve,delayTime)})}function safeFnWrapper(fnToWrap,errMsgPrefix,errFn){return function(){try{return fnToWrap(...arguments)}catch(e){if(errMsgPrefix!=null){tmUtils.err(errMsgPrefix+e.message+" |",e)}if(errFn!=null){return errFn(e,...arguments)}}}}function isUrl(url){try{let urlObj=new URL(url);return true}catch(e){return false}}function stackTrace(){return(new Error).stack}function asyncFn(fn){return Promise.resolve().then(fn)}Classes.PerfProfiler=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},mark:function(mark){performance.mark(mark)},measure:function(name,startMark,endMark){try{performance.measure(...arguments)}catch(e){this._log("Measure failed for",name,[startMark,endMark],e)}},log:function(){const logHead="PerfProfiler::log(): ";this._log.raw("%c"+logHead+"type measure: %o","background-color: powderblue;",performance.getEntriesByType("measure"))},logAll:function(){const logHead="PerfProfiler::log(): ";this._log(logHead+"all types: ",performance.getEntries())},_sortEntries:function(a,b){if(a.startTime>b.startTime){return 1}if(a.startTime<b.startTime){return-1}return 0},_getMeasures:function(measuresTable){for(const[measureName,marks]of Object.entries(measuresTable)){this.measure(measureName,marks[0],marks[1])}let p=[];for(const measureName of Object.keys(measuresTable)){p=p.concat(performance.getEntriesByName(measureName,"measure"));performance.clearMeasures(measureName)}p.sort(this._sortEntries);return p},_getMarks:function(measuresTable){let p=[];for(const[measureName,marks]of Object.entries(measuresTable)){p=p.concat(performance.getEntriesByName(marks[0],"mark"));p=p.concat(performance.getEntriesByName(marks[1],"mark"))}p.sort(this._sortEntries);return p},_getMarksByPrefix:function(measuresTable){let allMarks=performance.getEntriesByType("mark");let markPrefixes=[];for(const[measureName,marks]of Object.entries(measuresTable)){markPrefixes.push(marks[0],marks[1])}let p=[];for(const[index,entry]of Object.entries(allMarks)){for(const[index,prefix]of Object.entries(markPrefixes)){if(entry.name.startsWith(prefix)){p.push(entry)}}}p.sort(this._sortEntries);return p},clearMarksByPrefix:function(measuresTable){let allMarks=performance.getEntriesByType("mark");let markPrefixes=[];for(const[measureName,marks]of Object.entries(measuresTable)){markPrefixes.push(marks[0],marks[1])}for(const[index,entry]of Object.entries(allMarks)){for(const[index,prefix]of Object.entries(markPrefixes)){if(entry.name.startsWith(prefix)){performance.clearMarks(entry.name)}}}},clearMeasures:function(measuresTable){for(const[measureName,marks]of Object.entries(measuresTable)){performance.clearMeasures(measureName)}},showMeasures:function(measuresTable){console.table(this._getMarksByPrefix(measuresTable),["name","startTime"]);console.table(this._getMeasures(measuresTable),["name","duration","startTime"])},showAllMarks:function(){console.table(performance.getEntriesByType("mark"),["name","startTime"])},showAllEntries:function(){console.table(performance.getEntries(),["entryType","name","duration","startTime"])},showSearch:function(){let toMeasure={"parse query":["parseQueryStart","parseQueryEnd"],"full search":["searchStart","searchEnd"],"chrome.history.search()":["historySearchStart","historySearchEnd"],"history reduce":["historyReduceStart","historyReduceEnd"],"filter bookmarks":["bookmarksSearchStart","bookmarksSearchEnd"],"filter tabs + rcTabs + hItems":["searchFilterStart","searchFilterEnd"],"sort search results":["searchSortStart","searchSortEnd"],render:["searchRenderStart","searchRenderEnd"]};this.showMeasures(toMeasure)},showAsyncQueues:function(){let toMeasure={"discard batch":["discardAsyncQueueBatchStart","discardAsyncQueueBatchEnd"],"run batch":["runAsyncQueueBatchStart","runAsyncQueueBatchEnd"],"full run":["runAsyncQueueStart","runAsyncQueueEnd"]};console.table(this._getMarksByPrefix(toMeasure),["name","startTime"])},showStats:function(){chromeUtils.queryTabs({},"PerfProfiler::tmStats(): ").then(function(tabs){console.log("Total tabs count: "+tabs.length);console.table(performance.getEntriesByType("measure"),["name","duration","startTime"])})}});Classes.Base.roDef(window,"perfProf",Classes.PerfProfiler.create());Classes.AsyncQueue=Classes.Base.subclass({__idPrefix:"AsyncQueue",_eventManager:null,_queues:null,_batchSize:50,_running:null,_discarded:null,_init:function(){const logHead="AsyncQueue::_init(): ";Classes.Base._init.call(this);this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);this._initQueues();this._running=false;this._discarded=false},_isRunning:function(){return this._running},_isDiscarded:function(){return this._discarded},_initQueues:function(){this._queues={};this._queues[Classes.AsyncQueue.priority.HIGH]={name:Classes.AsyncQueue.priority.HIGH,delay:0,queue:[]};this._queues[Classes.AsyncQueue.priority.NORMAL]={name:Classes.AsyncQueue.priority.NORMAL,delay:0,queue:[]};this._queues[Classes.AsyncQueue.priority.LOW]={name:Classes.AsyncQueue.priority.LOW,delay:200,queue:[]}},_getQueue:function(priority){return this._queues[priority]},_getQueueToProcess:function(){const logHead="AsyncQueue::_getQueueToProcess(): ";let priorities=[Classes.AsyncQueue.priority.HIGH,Classes.AsyncQueue.priority.NORMAL,Classes.AsyncQueue.priority.LOW];for(priority of priorities){if(this._queues[priority].queue.length!=0){this._log(logHead+'queue of priority "'+priority+'" has pending work: '+this._queues[priority].queue.length);return this._queues[priority]}}this._log(logHead+"all queues are empty");return null},_getAllQueueLengths:function(){let retVal=[];for(const[priority,queue]of Object.entries(this._queues)){retVal.push(priority+": "+queue.queue.length)}return retVal},_processQueue:async function(perfLabel,processFn,resumeFn,cleanupFn){const logHead="AsyncQueue::_processQueue(): ";let processedCnt=this._batchSize;let firstRound=true;let queue=null;while((queue=this._getQueueToProcess())!=null){while(queue.queue.length>0){if(processedCnt>=this._batchSize){if(!firstRound){perfProf.mark(perfLabel+"AsyncQueueBatchEnd"+this._id);await delay(queue.delay)}else{firstRound=false}processedCnt=0;if(resumeFn!=null&&!resumeFn()){if(cleanupFn!=null){await cleanupFn()}return false}perfProf.mark(perfLabel+"AsyncQueueBatchStart"+this._id)}let entry=queue.queue.shift();processFn(entry);processedCnt++}}perfProf.mark(perfLabel+"AsyncQueueBatchEnd"+this._id);return true},_discardProcessFn:function(entry){if(entry.discardFn!=null){entry.discardFn()}},_runResumeFn:function(){return!this._isDiscarded()},_runProcessFn:function(entry){let retVal=entry.fn();entry.resolveFn(retVal)},_runCleanupFn:async function(){const logHead="AsyncQueue::_runCleanupFn(): ";this._log(logHead+"entering, queue lengths = ",this._getAllQueueLengths());await this._processQueue("discard",this._discardProcessFn.bind(this))},_runQueue:async function(){const logHead="AsyncQueue::_runQueue(): ";if(this._isRunning()){return}this._log(logHead+"entering");this._running=true;perfProf.mark("runAsyncQueueStart"+this._id);let normalState=true;try{while(this._getQueueToProcess()!=null&&normalState){normalState=await this._processQueue("run",this._runProcessFn.bind(this),this._runResumeFn.bind(this),this._runCleanupFn.bind(this))}}catch(e){this._err(logHead,e)}perfProf.mark("runAsyncQueueEnd"+this._id);this._running=false},_enqueueInner:function(queueEntry,priority){this._getQueue(priority).queue.push(queueEntry);this._runQueue()},enqueue:function(fn,fnSignature,priority){priority=optionalWithDefault(priority,Classes.AsyncQueue.priority.NORMAL);return new Promise(function(resolveFn,rejectFn){let queueEntry={fn:safeFnWrapper(fn,fnSignature,rejectFn),resolveFn:resolveFn,rejectFn:rejectFn,discardFn:null};this._enqueueInner(queueEntry,priority)}.bind(this))},discard:async function(){const logHead="AsyncQueue::discard(): ";this._discarded=true;gcChecker.add(this);if(!this._isRunning()){this._assert(this._getQueueToProcess()==null);if(this._getQueueToProcess()!=null){await this._runCleanupFn()}}}});Classes.Base.roDef(Classes.AsyncQueue,"priority",{});Classes.Base.roDef(Classes.AsyncQueue.priority,"HIGH","high");Classes.Base.roDef(Classes.AsyncQueue.priority,"NORMAL","normal");Classes.Base.roDef(Classes.AsyncQueue.priority,"LOW","low");Classes.SerialPromises=Classes.Base.subclass({_currPromise:null,_nextPromise:null,_init:function(){Classes.Base._init.call(this);this.debug();this.reset()},_resetCurrPromise:function(){this._currPromise=null},_runNext:function(nextPromise,nextFn,debugInfo){const logHead="SerialPromises::_runNext("+debugInfo+"): ";if(nextPromise!=null&&nextPromise!=this._nextPromise){this._log(logHead+"suppressing old call");return null}this._log(logHead+"running new call");this._currPromise=nextFn();return this._currPromise.then(this._resetCurrPromise.bind(this),this._resetCurrPromise.bind(this))},next:function(nextFn,debugInfo){if(this._currPromise==null){return this._runNext(null,nextFn,debugInfo)}this._nextPromise=new Promise(function(resolve,reject){this._currPromise.then(resolve,resolve)}.bind(this));return this._nextPromise.then(this._runNext.bind(this,this._nextPromise,nextFn,debugInfo))},reset:function(){this._currPromise=null;this._nextPromise=null}});Classes.ChromeUtils=Classes.Base.subclass({bAction:chrome.browserAction,_init:function(){Classes.Base._init.apply(this,arguments)},_wrapInner:function(verbose,chromeFn,debugCtx,...args){return new Promise(function(resolve,reject){chromeFn(...args,function(){const logHead="ChromeUtils::wrap().cb: "+(debugCtx!=null?debugCtx:"");if(chrome.runtime.lastError){if(verbose){this._err(logHead+"chrome.runtime.lastError = "+chrome.runtime.lastError.message)}reject(chrome.runtime.lastError)}else{resolve(...arguments)}}.bind(this))}.bind(this))},wrap:function(chromeFn,debugCtx,...args){return this._wrapInner(true,...arguments)},wrapQuiet:function(){return this._wrapInner(false,...arguments)},getExtensionId:function(){const logHead="chromeUtils::getExtensionId(): ";let retVal=chrome.runtime.getURL("");this._log(logHead,retVal);retVal=retVal.replace("chrome-extension://","");retVal=retVal.replace("/","");return retVal},_queryWithFilter:async function(queryFn,callerLogHead,queryInfo){const incognitoFlag=queryInfo?.incognito;delete queryInfo?.incognito;let objs=await this.wrap(queryFn,callerLogHead,queryInfo);if(incognitoFlag!==undefined){return objs.filter(obj=>obj.incognito==incognitoFlag)}return objs},queryTabs:async function(queryInfo,callerLogHead){const logHead="ChromeUtils::queryTabs(): ";callerLogHead=optionalWithDefault(callerLogHead,logHead);if(queryInfo.windowId!=null&&queryInfo.incognito!==undefined){delete queryInfo.incognito}if(queryInfo.url==null){return this._queryWithFilter(chrome.tabs.query,callerLogHead,queryInfo)}let fragmentOffset=queryInfo.url.indexOf("#");if(fragmentOffset==-1){return this._queryWithFilter(chrome.tabs.query,callerLogHead,queryInfo)}let origUrl=queryInfo.url;queryInfo.url=queryInfo.url.substring(0,fragmentOffset);let tabListNoFragment=await this._queryWithFilter(chrome.tabs.query,callerLogHead,queryInfo);this._log(logHead+"chrome.tabs.query() for "+queryInfo.url+" returned:",tabListNoFragment);let tabList=[];for(let i=0;i<tabListNoFragment.length;i++){let currTab=tabListNoFragment[i];if(currTab.url==origUrl||currTab.pendingUrl==origUrl){tabList.push(currTab)}}return tabList},getLeastTabbedWindowId:function(incognito=false,preferredWinId){const logHead="ChromeUtils::getLeastTabbedWindowId(): ";let options={populate:true,incognito:incognito,windowTypes:["normal"]};let preferredWinTabsCount=999999;function leastTabbedReducer(currentMinWin,winInfo){let tabsCount=winInfo.tabs.length;if(winInfo.id==preferredWinId){preferredWinTabsCount=tabsCount}if(currentMinWin==0||currentMinWin.tabsCount>tabsCount){return{winInfo:winInfo,tabsCount:tabsCount}}return currentMinWin}return this._queryWithFilter(chrome.windows.getAll,logHead,options).then(function(winList){if(winList.length==0){return null}let minWin=winList.reduce(leastTabbedReducer,0);if(minWin.tabsCount<preferredWinTabsCount-1){this._log(logHead+"Found: ",minWin);return minWin.winInfo.id}this._assert(minWin.tabsCount<=preferredWinTabsCount,logHead+"unexpected");this._log(logHead+"Found multiple matches, returning preferredWinId",preferredWinId,minWin);return preferredWinId}.bind(this))},getEmptyTabsList:function(incognito=false,windowId){const logHead="ChromeUtils::getEmptyTabsList():";return this.queryTabs({url:"chrome://newtab/",incognito:incognito,windowId:windowId},logHead)},discardTab:async function(tab){const logHead="ChromeUtils::discardTab("+tab.id+"): ";if(tab.active){let activateIndex=tab.index-1;if(tab.index==0){activateIndex=1}let neighborTabs=await this.queryTabs({index:activateIndex,windowId:tab.windowId},logHead);this._log(logHead+"tabs.query for index "+activateIndex+" returned: ",neighborTabs);if(neighborTabs.length!=0){await this.activateTab(neighborTabs[0],false)}}this.wrap(chrome.tabs.discard,logHead,tab.id);this._log(logHead+"completed")},focusWindowByTabId:function(tabId){const logHead="ChromeUtils::focusWindowByTabId("+tabId+"): ";return this.wrap(chrome.tabs.get,logHead,tabId).then(function(tab){this._log(logHead+tab.windowId,tab);return this.focusWindow(tab)}.bind(this))},focusWindow:function(tab){const logHead="ChromeUtils::focusWindow():";return this.wrap(chrome.windows.update,logHead,tab.windowId,{focused:true})},createWindow:function(createData){const logHead="ChromeUtils::createWindow():";return this.wrap(chrome.windows.create,logHead,createData)},activateTabByTabId:function(tabId){let activatePromise=this.wrap(chrome.tabs.update,"ChromeUtils::activateTabByTabId(): ",tabId,{active:true});let focusPromise=this.focusWindowByTabId(tabId);return Promise.all([activatePromise,focusPromise])},activateTab:function(tab,focusWindow=true){const logHead="ChromeUtils::activateTab(): ";let activatePromise=this.wrap(chrome.tabs.update,logHead,tab.id,{active:true});if(!focusWindow){return activatePromise}let focusPromise=this.wrap(chrome.windows.update,logHead,tab.windowId,{focused:true});return Promise.all([activatePromise,focusPromise])},_createTabInner:function(url,winId=chrome.windows.WINDOW_ID_CURRENT){const logHead="ChromeUtils::_createTabInner("+url+"): ";let promiseA=this.wrap(chrome.tabs.create,logHead,{url:url,windowId:winId});let promiseB=this.wrap(chrome.windows.update,logHead,winId,{focused:true});return Promise.all([promiseA,promiseB])},createTab:async function(options){const logHead="ChromeUtils.createTab():";let incognito=options?.incognito??false;let reuse=options?.reuse??true;let url=options?.url??null;let winId=options?.winId??null;let tabs=[];if(reuse){tabs=await this.getEmptyTabsList(incognito,winId)}this._log(logHead,"empty tabs:",tabs,options,incognito,winId,reuse);if(tabs.length!=0){return this.loadUrl(url,{tabId:tabs[0].id})}if(winId==null){winId=await this.getLeastTabbedWindowId(incognito)}if(winId==null){return this.createWindow({incognito:incognito,url:url,focused:true})}return this._createTabInner(url,winId)},loadUrl:function(url,options){const logHead="ChromeUtils::loadUrl("+url+"):";let incognito=options?.incognito??false;let tabId=options?.tabId??null;let winId=options?.winId??null;this._log(logHead,"entering",incognito,tabId,winId);this._assert(!(tabId!=null&&winId!=null),logHead);if(winId==chrome.windows.WINDOW_ID_NONE){this._assert(tabId==null);return this.createWindow({focused:true,url:url,incognito:incognito})}if(tabId==null){return this.createTab({incognito:incognito,url:url,winId:winId})}let promiseA=null;let promiseB=null;promiseA=this.activateTabByTabId(tabId);promiseB=this.wrap(chrome.tabs.update,logHead,tabId,{url:url});return Promise.all([promiseA,promiseB])},moveTab:function(tab,newWindowId,activate,oldWindowActiveTabId){activate=optionalWithDefault(activate,false);const logHead="chromeUtils::moveTab(activate: "+activate+"): ";if(oldWindowActiveTabId!=null&&tab.active){this.wrap(chrome.tabs.update,logHead,oldWindowActiveTabId,{active:true})}let moveProperties={index:-1,windowId:newWindowId};let movePromise=this.wrap(chrome.tabs.move,logHead,tab.id,moveProperties);let focusPromise=null;let activatePromise=null;if(activate){focusPromise=this.wrap(chrome.windows.update,logHead,newWindowId,{focused:true});activatePromise=this.wrap(chrome.tabs.update,logHead,tab.id,{active:true})}else{focusPromise=Promise.resolve();activatePromise=Promise.resolve()}return Promise.all([movePromise,focusPromise,activatePromise])},moveTabToLeastTabbedWindow:function(tab,activate,oldWindowActiveTabId){activate=optionalWithDefault(activate,false);const logHead="chromeUtils::moveTabToLeastTabbedWindow(activate: "+activate+"): ";return this.getLeastTabbedWindowId(tab.incognito,tab.windowId).then(function(winId){if(tab.windowId==winId){this._log(logHead+"tab "+tab.id+" is already in the least tabbed window "+winId);return null}return this.moveTab(tab,winId,activate,oldWindowActiveTabId)}.bind(this))},closeTab:function(tabId){return this.wrap(chrome.tabs.remove,"ChromeUtils::closeTab(): ",tabId)},inject:function(tabId,jsFile,jsCode){const logHead="ChromeUtils::inject("+tabId+"): ";let injectDetails={};if(jsFile!=null&&jsFile!=""){injectDetails.file=jsFile}else{if(jsCode!=null&&jsCode!=""){injectDetails.code=jsCode}}return this.wrapQuiet(chrome.tabs.executeScript,logHead,tabId,injectDetails).catch(function(chromeLastError){switch(chromeLastError.message){case Classes.ChromeUtils.Error.INJECT_NOFRAME:return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_ERRORPAGE:this._log(logHead+"tab has an error (network down?)");return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_EXTGALLERY:this._log(logHead+"can't inject in the extensions gallery");return Promise.resolve(null);default:this._err(logHead+"unknown error: "+chromeLastError.message);return Promise.reject(chromeLastError)}}.bind(this))},getBookmarkPathList:async function(bmNode){const logHead="ChromeUtils::getBookmarkPathList("+bmNode.id+"): ";let pathList=[];while(bmNode!=null&&bmNode.parentId!=null){let result=await this.wrap(chrome.bookmarks.get,logHead,bmNode.parentId);if(result.length>0){bmNode=result[0];pathList.push(bmNode.title!=null?bmNode.title:"")}else{bmNode=null;this._err(logHead+"unexpected, it should not get here")}}pathList.reverse();return pathList},getBookmarksCount:function(){const logHead="ChromeUtils::getBookmarksCount("+bmNode.id+"): ";return this.wrap(chrome.bookmarks.getTree,logHead).then(function(nodesList){return nodesList.length}.bind(this))},storageGet:function(keys,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageGet(): ";return this.wrap(storageObj.get.bind(storageObj),logHead,keys)},storageSet:function(items,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageSet(): ";return this.wrap(storageObj.set.bind(storageObj),logHead,items)},_areaNamesDict:{sync:chrome.storage.sync,local:chrome.storage.local,managed:chrome.storage.managed},storageObjByAreaName:function(areaName){const logHead="ChromeUtils.storageObjByAreaName("+areaName+"): ";let retVal=this._areaNamesDict[areaName];this._assert(retVal!=null,logHead+"assertion failed");return retVal}});Classes.Base.roDef(Classes.ChromeUtils,"Error",{});Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_COMMUNICATION","Error when communicating with the native messaging host.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_EXITED","Native host has exited.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_NOTFOUND","Specified native messaging host not found.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_NOFRAME","The frame was removed.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_ERRORPAGE",'Cannot access contents of url "chrome-error://chromewebdata/". Extension manifest must request permission to access this host.');Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_EXTGALLERY","The extensions gallery cannot be scripted.");Classes.Base.roDef(window,"chromeUtils",Classes.ChromeUtils.create());chromeUtils.debug();Classes.TabNormalizer=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},compareTitlesFn:function(a,b){return a.tm.sortTitle.localeCompare(b.tm.sortTitle)},compareTabsFn:function(a,b){if(tmUtils.isTabPinned(a)&&!tmUtils.isTabPinned(b)){return-1}if(tmUtils.isTabPinned(b)&&!tmUtils.isTabPinned(a)){return 1}return Classes.TabNormalizer.compareTitlesFn(a,b)},comparePositionFn:function(a,b){if(a.windowId<b.windowId){return-1}if(a.windowId>b.windowId){return 1}if(a.index<b.index){return-1}if(a.index>b.index){return 1}return 0},getProtocolHostname:function(url){try{var urlObj=new URL(url);return[urlObj.protocol,urlObj.hostname]}catch(e){return[null,null]}},_titleNormalizationPattern:/^(([^a-z0-9]+)|(www\.))/i,normalizeLowerCaseTitle:function(lowerCaseTitle){return lowerCaseTitle.replace(this._titleNormalizationPattern,"")},_cleanupChromeBookmarksManagerTitle:function(title,url){if(!url.startsWith("chrome://bookmarks/?id=")){return title}if(title!="Bookmarks"){return title}let split=url.split("=");if(split.length<2){return title}let bmNode=null;try{bmNode=bookmarksManager.getBmNode(+split[1])}catch(e){return title}if(bmNode==null){return title}let type="Folder";if(bmNode.url!=null){type="Bookmark"}return`${title} - ${type} "${bmNode.title}"`},_cleanupTitle:function(title,url){if(url==null){return title}if(title==""){return url}return this._cleanupChromeBookmarksManagerTitle(title,url)},updateUrl:function(tab){let url=(tab.url!=""?tab.url:tab.pendingUrl)??"";let[protocol,hostname]=this.getProtocolHostname(url);tab.tm.url=url;tab.tm.protocol=protocol;tab.tm.hostname=hostname;tab.tm.customGroupName=settingsStore.getCustomGroupsManager().getCustomGroupByHostname(hostname);tab.tm.lowerCaseUrl=url.toLowerCase()},updateTitle:function(tab,oldTab){tab.title=this._cleanupTitle(tab.title,tab.tm.url);let lowerCaseTitle=tab.title.toLowerCase();tab.tm.lowerCaseTitle=lowerCaseTitle;if(oldTab!=null&&tab.status=="loading"){tab.tm.sortTitle=oldTab.tm.sortTitle}else{tab.tm.sortTitle=this.normalizeLowerCaseTitle(lowerCaseTitle)}},_updateFavIcon:function(tab){let useCachedFavIcon=false;const cachedFavIconUrl=this.buildCachedFavIconUrl(tab.tm.url);if(tab.favIconUrl==null||tab.favIconUrl==""||this.isCachedFavIconUrl(tab.favIconUrl)){tab.favIconUrl=cachedFavIconUrl;useCachedFavIcon=true}tab.tm.useCachedFavIcon=useCachedFavIcon;tab.tm.cachedFavIconUrl=cachedFavIconUrl},formatExtendedId:function(tab,type){type=type??(tab?.tm.type??Classes.TabNormalizer.type.TAB);switch(type){case Classes.TabNormalizer.type.TAB:return tab.windowId+":"+tab.id+"/"+tab.index;case Classes.TabNormalizer.type.RCTAB:return"rc["+tab.sessionId+"]";case Classes.TabNormalizer.type.BOOKMARK:return"bm["+(tab.parentId!=null?tab.parentId:"")+"."+tab.bookmarkId+"]";case Classes.TabNormalizer.type.HISTORY:return"h["+tab.historyId+"]";default:const logHead="TabNormalizer.formatExtendedId():";this._err(logHead,"unknown type",type,tab);break}return"[none]"},_addNormalizedShortcutBadges:function(tab,secondary){let sm=settingsStore.getShortcutsManager();let scKeys=sm.getShortcutKeysForTab(tab,!secondary);let array=tab.tm.primaryShortcutBadges;if(secondary){array=tab.tm.secondaryShortcutBadges}scKeys.forEach(function(key){let keyAsString=sm.keyToUiString(key);array.push(keyAsString);tab.tm.searchBadges.push(keyAsString.toLowerCase())}.bind(this))},addShortcutBadges:function(tab){const logHead="TabNormalizer.addShortcutBadges():";if(tab.tm.type!=Classes.TabNormalizer.type.TAB){this._err(logHead,"this function can only be called for standard tabs");return}if(tab.tm.primaryShortcutBadges.length!=0||tab.tm.secondaryShortcutBadges.length!=0){this._err(logHead,"this function can only be called once after normalize()");return}this._addNormalizedShortcutBadges(tab,false);this._addNormalizedShortcutBadges(tab,true)},_addNormalizedVisualBadge:function(tab,badge,visible=true){if(visible){tab.tm.visualBadges.push(badge)}tab.tm.searchBadges.push(badge.toLowerCase())},_updateSearchBadges:function(tab){if(tab.active){this._addNormalizedVisualBadge(tab,"active")}if(tab.audible){this._addNormalizedVisualBadge(tab,"audible",false)}if(tab.discarded){this._addNormalizedVisualBadge(tab,"suspended",false)}if(tab.tm.type==Classes.TabNormalizer.type.RCTAB){this._addNormalizedVisualBadge(tab,"closed",false)}if(tab.highlighted){this._addNormalizedVisualBadge(tab,"highlighted",false)}if(tab.incognito){this._addNormalizedVisualBadge(tab,"incognito",false)}if(tab.mutedInfo!=null&&tab.mutedInfo.muted){this._addNormalizedVisualBadge(tab,"muted",false)}this._addNormalizedVisualBadge(tab,tab.status,false);if(tmUtils.isTabPinned(tab)){this._addNormalizedVisualBadge(tab,"pinned",false)}if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false);tab.tm.customGroupBadges.push(tab.tm.customGroupName.toLowerCase())}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},_updateBookmarkBadges:function(tab){tab.tm.searchBadges.push("bookmark");if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false);tab.tm.customGroupBadges.push(tab.tm.customGroupName.toLowerCase())}if(tmUtils.isTabPinned(tab)){this._addNormalizedVisualBadge(tab,"pinned",false)}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},_updateHistoryBadges:function(tab){if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false);tab.tm.customGroupBadges.push(tab.tm.customGroupName.toLowerCase())}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},buildCachedFavIconUrl:function(url){return"chrome://favicon/size/16@1x/"+url},isCachedFavIconUrl:function(favIconUrl){return favIconUrl.startsWith("chrome://favicon/size/16@1x/")},_isTabMatchingBookmark:function(tab,bmNode){if(tab.tm.url!=""){return tab.tm.url.startsWith(bmNode.url)}return false},_setPinInheritance:function(tab,bmNode){tab.tm.pinInherited={type:"bookmark",id:bmNode.bookmarkId};if(tab.title==""||tab.url.includes(tab.title)||tab.title==tab.pendingUrl){tab.title=bmNode.title}},_updatePinInheritance:function(tab){if(window.bookmarksManager==null){return}let pinnedBookmarks=bookmarksManager.getPinnedBookmarks();if(pinnedBookmarks.length==0){return}for(let i=0;i<pinnedBookmarks.length;i++){let bmNode=pinnedBookmarks[i];if(!this._isTabMatchingBookmark(tab,bmNode)){continue}this._setPinInheritance(tab,bmNode);return}},normalizeBookmarkId:function(id){return"b"+id},_initBookmarkAsTab:function(tab){tab.bookmarkId=tab.id;tab.id=this.normalizeBookmarkId(tab.id);tab.status="unloaded"},updateBookmarkFolder:function(tab){const logHead="TabNormalizer.updateBookmarkFolder():";let folder=bookmarksManager.getBmFolderSync(tab);if(folder!=null){tab.tm.folder=folder;tab.tm.lowerCaseFolder=folder.toLowerCase()}else{this._log(logHead,"folder not available for",tab);tab.tm.folder="";tab.tm.lowerCaseFolder=""}},normalizeHistoryItemId:function(id){return"h"+id},_initHistoryItemAsTab:function(tab){tab.historyId=tab.id;tab.id=this.normalizeHistoryItemId(tab.id);tab.status="unloaded"},normalizeRecentlyClosedId:function(id){return"c"+id},_initRecentlyClosedAsTab:function(tab){tab.active=false;tab.id=this.normalizeRecentlyClosedId(tab.sessionId);tab.status="unloaded"},normalize:function(tab,options={}){let addShortcutBadges=options.addShortcutBadges??true;let type=options.type??Classes.TabNormalizer.type.TAB;let oldTab=options.oldTab;const logHead="TabNormalizer.normalize():";if(tab.tm==null){switch(type){case Classes.TabNormalizer.type.TAB:break;case Classes.TabNormalizer.type.RCTAB:this._initRecentlyClosedAsTab(tab);break;case Classes.TabNormalizer.type.BOOKMARK:this._initBookmarkAsTab(tab);break;case Classes.TabNormalizer.type.HISTORY:this._initHistoryItemAsTab(tab);break;default:this._err(logHead,"unknown type",type);break}}else{this._assert(tab.tm.type==type,tab,type)}tab.tm={type:type,url:null,protocol:null,hostname:null,pinInherited:null,customGroupName:null,lowerCaseUrl:null,lowerCaseTitle:null,sortTitle:null,useCachedFavIcon:null,cachedFavIconUrl:null,folder:"",lowerCaseFolder:"",wantsAttention:false,extId:this.formatExtendedId(tab,type),visualBadges:[],searchBadges:[],customGroupBadges:[],primaryShortcutBadges:[],secondaryShortcutBadges:[]};this.updateUrl(tab);if(type==Classes.TabNormalizer.type.TAB){this._updatePinInheritance(tab)}this.updateTitle(tab,oldTab);this._updateFavIcon(tab);switch(type){case Classes.TabNormalizer.type.TAB:this._updateSearchBadges(tab);if(addShortcutBadges){this.addShortcutBadges(tab)}break;case Classes.TabNormalizer.type.RCTAB:this._updateSearchBadges(tab);break;case Classes.TabNormalizer.type.BOOKMARK:this.updateBookmarkFolder(tab);this._updateBookmarkBadges(tab);break;case Classes.TabNormalizer.type.HISTORY:this._updateHistoryBadges(tab);break;default:this._err(logHead,"unknown type",type);break}}});Classes.Base.roDef(Classes.TabNormalizer,"type",{});Classes.Base.roDef(Classes.TabNormalizer.type,"TAB","tab");Classes.Base.roDef(Classes.TabNormalizer.type,"RCTAB","rctab");Classes.Base.roDef(Classes.TabNormalizer.type,"BOOKMARK","bookmark");Classes.Base.roDef(Classes.TabNormalizer.type,"HISTORY","history");Classes.Base.roDef(window,"tabNormalizer",Classes.TabNormalizer.createAs("tabNormalizer"));Classes.TabsStoreBase=Classes.Base.subclass({_dict:null,_list:null,_useList:null,_init:function(tabs,useList=true){Classes.Base._init.call(this);this._useList=useList;this.reset();if(tabs!=null){if(this._useList){this._list=tabs}for(let i=0;i<tabs.length;i++){this._dict[tabs[i].id]=tabs[i]}}},reset:function(){this._dict={};if(this._useList){this._list=[]}},_findTabIndexById:function(searchTabId){if(!this._useList){return-1}return this._list.findIndex(function(tab){if(tab.id==searchTabId){return true}return false}.bind(this))},add:function(tab,value){value=optionalWithDefault(value,tab);this._dict[tab.id]=value;if(this._useList){this._list.push(value)}},update:function(tab,value,tabIdx){value=optionalWithDefault(value,tab);if(!(tab.id in this._dict)){Classes.TabsStoreBase.add.call(this,tab,value);return null}if(tabIdx==null){tabIdx=this._findTabIndexById(tab.id)}if(this._useList){this._assert(tabIdx!=-1)}let retVal=this._dict[tab.id];this._dict[tab.id]=value;if(tabIdx!=-1){this._list[tabIdx]=value}return retVal},removeById:function(tabId){if(!(tabId in this._dict)){return null}let tabIdx=this._findTabIndexById(tabId);if(this._useList){this._assert(tabIdx!=-1,tabId,this._dict[tabId],this._list)}let retVal=this._dict[tabId];delete this._dict[tabId];if(tabIdx!=-1){this._list.splice(tabIdx,1)}return retVal},getById:function(searchTabId){return this._dict[searchTabId]},hasById:function(searchTabId){return this.getById(searchTabId)!==undefined},get:function(){if(!this._useList){return Object.values(this._dict)}return this._list},getDict:function(){return this._dict},getTabIdList:function(){return Object.keys(this._dict)},getCount:function(){return this._list.length},discard:function(){this.reset();gcChecker.add(this)}});Classes.TabsStore=Classes.TabsStoreBase.subclass({_tabsLoading:null,_tabsPinnedFromBookmarks:null,_init:function(tabs,oldTabsDict){this._tabsLoading=Classes.TabsStoreBase.create();this._tabsPinnedFromBookmarks=Classes.TabsStoreBase.create(null,false);Classes.TabsStoreBase._init.call(this,tabs);this.debug();this.normalizeAll({addShortcutBadges:false,oldTabsDict:oldTabsDict})},normalizeAll:function(options){options=optionalWithDefault(options,{});let oldTabsDict=optionalWithDefault(options.oldTabsDict,[]);const logHead="TabsStore::normalizeAll(): ";perfProf.mark("normalizeStart");let tabs=this.get();this._tabsLoading.reset();this._tabsPinnedFromBookmarks.reset();for(let i=0;i<tabs.length;i++){let tab=tabs[i];tabNormalizer.normalize(tab,{addShortcutBadges:options.addShortcutBadges,oldTab:oldTabsDict[tab.id]});if(tab.status=="loading"){this._log(logHead+"found tab in loading status",tab);this._tabsLoading.add(tab)}if(tab.tm.pinInherited!=null){this._tabsPinnedFromBookmarks.add(tab,tab.tm.pinInherited.id)}}perfProf.mark("normalizeEnd");perfProf.measure("Normalize","normalizeStart","normalizeEnd")},addShortcutBadges:function(){let tabs=this.get();for(let i=0;i<tabs.length;i++){tabNormalizer.addShortcutBadges(tabs[i])}},reset:function(){this._tabsLoading.reset();this._tabsPinnedFromBookmarks.reset();Classes.TabsStoreBase.reset.call(this)},_addOrUpdateInner:function(newTab,oldTab){const logHead="TabsStore::_addOrUpdateInner(): ";tabNormalizer.normalize(newTab,{oldTab:oldTab});if(newTab.status=="loading"){this._log(logHead+"found tab in loading status",newTab);this._tabsLoading.add(newTab)}else{this._tabsLoading.removeById(newTab.id)}if(newTab.tm.pinInherited!=null){this._tabsPinnedFromBookmarks.add(newTab,newTab.tm.pinInherited.id)}else{this._tabsPinnedFromBookmarks.removeById(newTab.id)}},add:function(newTab){Classes.TabsStoreBase.add.call(this,newTab);this._addOrUpdateInner(newTab)},update:function(newTab,tabIdx){let oldTab=Classes.TabsStoreBase.update.call(this,newTab,null,tabIdx);this._addOrUpdateInner(newTab,oldTab);return oldTab},removeById:function(tabId){let retVal=Classes.TabsStoreBase.removeById.call(this,tabId);if(retVal==null){return null}this._tabsLoading.removeById(tabId);this._tabsPinnedFromBookmarks.removeById(tabId);return retVal},_tabsCmp:function(a,b){return tmUtils.isEqual(a,b,false)},cloneTabs:function(){return tmUtils.deepCopy(this.get())},diff:function(oldTabList){let sortByIdFn=function(x,y){if(x.id==y.id){return 0}if(x.id<y.id){return-1}return 1};return tmUtils.arrayDiff(oldTabList,this.get(),sortByIdFn,this._tabsCmp.bind(this))},getTabsLoading:function(){return this._tabsLoading.getDict()},getPinnedBookmarkIdsFromTabs:function(){return this._tabsPinnedFromBookmarks.get()}});Classes.Base.roDef(window,"ExtCommands",{});Classes.Base.roDef(window.ExtCommands,"BACK","00back");Classes.Base.roDef(window.ExtCommands,"FWD","01fwd");Classes.Base.roDef(window.ExtCommands,"LAUNCHORSEARCH","02los");Classes.Base.roDef(window.ExtCommands,"CLOSEBACK","03closeback");Classes.Base.roDef(window.ExtCommands,"CLOSEFWD","04closefwd");Classes.Base.roDef(window.ExtCommands,"SHORTCUT01","90shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT02","91shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT03","92shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT04","93shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT05","94shortcut");Classes.ShortcutsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_shortcutsStore:null,_tabs:null,_eventManager:null,_shortcutsInfo:null,_shortcutKeys:[window.ExtCommands.SHORTCUT01,window.ExtCommands.SHORTCUT02,window.ExtCommands.SHORTCUT03,window.ExtCommands.SHORTCUT04,window.ExtCommands.SHORTCUT05],_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this._shortcutsStore=null;this._shortcutsInfo=null;this._tabs=[];this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this._shortcutsStore={};for(let i=0;i<this._shortcutKeys.length;i++){let persDict=this._shortcutsStore[this._shortcutKeys[i]]=Classes.PersistentDict.createAs(this._storageKeyPrefix+"shortcut0"+(i+1),chrome.storage.sync);promiseArray.push(persDict.getInitPromise());persDict.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this,this._shortcutKeys[i]))}return Promise.all(promiseArray).then(this._computeShortcutsInfo.bind(this))},_onUpdatedCb:function(key,ev){this._computeInfo(key);this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_propertySearch:function(key,value){let retVal=this._tabs.reduce(function(res,tab){if(tab.incognito==false&&tab.tm[key]==value){res.push(tab)}return res},[]);return retVal.sort(Classes.TabNormalizer.comparePositionFn)},_computeByHostname:function(hostname){const logHead="ShortcutsManager::_computeByHostname("+hostname+"): ";let tabs=this._propertySearch("hostname",hostname);if(tabs.length==0){this._log(logHead+"setting as URL");return{url:"https://"+hostname}}return{tab:tabs[0]}},_computeByUrlNoSearch:function(sc,forceNewTab){if(forceNewTab){return{url:sc.get("url")}}let tabs=this._propertySearch("lowerCaseUrl",sc.get("url").toLowerCase());if(tabs.length==0){return{url:sc.get("url")}}return{tab:tabs[0]}},_computeByUrl:function(sc){let forceNewTab=optionalWithDefault(sc.get("alwaysNewTab"),false);let useClipboard=optionalWithDefault(sc.get("useClipboard"),false);if(!useClipboard){return this._computeByUrlNoSearch(sc,forceNewTab)}if(!sc.get("url").includes("%s")){return this._computeByUrlNoSearch(sc,forceNewTab)}if(forceNewTab){return{searchUrl:sc.get("url")}}let retVal={searchUrl:sc.get("url")};let[protocol,hostname]=tabNormalizer.getProtocolHostname(retVal.searchUrl);let tabs=this._propertySearch("hostname",hostname);if(tabs.length!=0){retVal.candidateTabs=tabs}return retVal},_computeInfo:function(shortcutKey){let sc=this._shortcutsStore[shortcutKey];if(sc.get("tabMania")!=null){this._shortcutsInfo[shortcutKey]={tabMania:true};return}if(sc.get("hostname")!=null){this._shortcutsInfo[shortcutKey]=this._computeByHostname(sc.get("hostname"));return}if(sc.get("url")==null){this._shortcutsInfo[shortcutKey]={empty:true};return}this._shortcutsInfo[shortcutKey]=this._computeByUrl(sc)},_computeShortcutsInfo:function(){this._shortcutsInfo={};this._shortcutKeys.forEach(this._computeInfo.bind(this))},updateTabs:function(tabs){this._assert(this.isInitialized());this._tabs=optionalWithDefault(tabs,[]);this._computeShortcutsInfo()},_isTabInCandidateTabs:function(tabId,candidateTabs,firstCandidate){if(candidateTabs==null){return false}if(firstCandidate){return candidateTabs[0].id==tabId}let idx=candidateTabs.findIndex(function(elem,index){if(index==0){return false}if(elem.id==tabId){return true}return false});return idx!=-1},getShortcutKeys:function(){return this._shortcutKeys},getSearchShortcutKeys:function(){let retVal=[];this._shortcutKeys.forEach(function(key){if(this._shortcutsInfo[key].searchUrl!=null){retVal.push(key)}}.bind(this));return retVal},getShortcutKeysForTab:function(tab,firstCandidate){firstCandidate=optionalWithDefault(firstCandidate,true);let retVal=[];this._shortcutKeys.forEach(function(key){if(this._shortcutsInfo[key].tab!=null&&this._shortcutsInfo[key].tab.id==tab.id&&firstCandidate){retVal.push(key)}if(this._isTabInCandidateTabs(tab.id,this._shortcutsInfo[key].candidateTabs,firstCandidate)){retVal.push(key)}}.bind(this));return retVal},getShortcutInfo:function(shortcutKey){const logHead="ShortcutsManager::getShortcutInfo("+shortcutKey+"): ";this._log(logHead+"entering ",this._shortcutsInfo);return this._shortcutsInfo[shortcutKey]},setShortcut:function(shortcutKey,shortcutStoreDict){return this._shortcutsStore[shortcutKey].setAll(shortcutStoreDict)},setShortcutProp:function(shortcutKey,prop,value){return this._shortcutsStore[shortcutKey].set(prop,value)},delShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].del(prop)},getShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].get(prop)},setShortcutTitle:function(shortcutKey,value){return this.setShortcutProp(shortcutKey,"title",value)},getShortcutTitle:function(shortcutKey){return optionalWithDefault(this.getShortcutProp(shortcutKey,"title"),"")},setShortcutHostnameOrUrl:function(shortcutKey,value){const logHead="ShortcutsManager::setShortcutHostnameOrUrl("+shortcutKey+', "'+value+'"): ';value=value.trim();let currDict=this._shortcutsStore[shortcutKey].getAll();if(value==""||value.toLowerCase()=="tabmania"){this._log(logHead+"clearing both hostname and URL");delete currDict["hostname"];delete currDict["url"];if(value.toLowerCase()=="tabmania"){currDict["tabMania"]=value}else{delete currDict["tabMania"]}return this.setShortcut(shortcutKey,currDict)}delete currDict["tabMania"];let toSet="hostname";let toDel="url";if(isUrl(value)){toSet="url";toDel="hostname";this._log(logHead+"setting as URL")}else{this._log(logHead+"setting as hostname")}currDict[toSet]=value;delete currDict[toDel];return this.setShortcut(shortcutKey,currDict)},getShortcutHostnameOrUrl:function(shortcutKey){let tabMania=this.getShortcutProp(shortcutKey,"tabMania");if(tabMania!=null){return tabMania}let hostname=this.getShortcutProp(shortcutKey,"hostname");if(hostname==null||hostname==""){return this.getShortcutProp(shortcutKey,"url")}return hostname},isShortcutKey:function(key){return this._shortcutKeys.includes(key)},keyToUiString:function(shortcutKey){let idx=this._shortcutKeys.indexOf(shortcutKey);if(idx==-1){return"SC-err"}return"SC"+(idx+1)}});Classes.CustomGroupsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_customGroupsStore:null,_parsedCustomGroups:null,_eventManager:null,_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this._customGroupsStore=Classes.PersistentDict.createAs(this._storageKeyPrefix+"customGroups",chrome.storage.sync);promiseArray.push(this._customGroupsStore.getInitPromise());this._customGroupsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(this._buildCustomGroups.bind(this))},_onUpdatedCb:function(ev){let key=ev.detail.target.getId();const logHead="CustomGroupsManager._onUpdatedCb():";this._log(logHead,"processing update",key);this._buildCustomGroups();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_parseRegex:function(matchList){const logHead="CustomGroupsManager._parseRegex():";if(matchList==null){return null}let list=matchList.split("\n");let trimmedList=[];list.forEach(function(regex){let trimmedRegex=regex.trim();if(trimmedRegex!=""){trimmedList.push("("+tmUtils.regexEscape(trimmedRegex)+")")}}.bind(this));if(trimmedList.length==0){return null}let fullExpr=trimmedList.join("|");this._log(logHead,"after split:",matchList,fullExpr);try{return new RegExp(fullExpr)}catch(e){this._err(logHead,"unable to parse regex",e,matchList);return null}},_buildCustomGroups:function(){const logHead="CustomGroupsManager._buildCustomGroups():";this._parsedCustomGroups={};let groupTitles=this.getCustomGroupNames();groupTitles.forEach(function(title){this._parsedCustomGroups[title]=this.getCustomGroup(title);this._log(logHead,'processing group "'+title+'":',this._parsedCustomGroups[title]);this._parsedCustomGroups[title].parsedRegex=this._parseRegex(this._parsedCustomGroups[title].matchList)}.bind(this))},getCustomGroupByHostname:function(hostname){let titles=this.getCustomGroupNames();for(let i=0;i<titles.length;i++){if(this._parsedCustomGroups[titles[i]].parsedRegex!=null&&this._parsedCustomGroups[titles[i]].parsedRegex.test(hostname)){return titles[i]}}return null},hasCustomGroup:function(name,ignoreCase){return this._customGroupsStore.has(name,ignoreCase)},getCustomGroupNames:function(){return this._customGroupsStore.getAllKeys()},getCustomGroup:function(name){return this._customGroupsStore.get(name)},setCustomGroup:function(name,obj){return this._customGroupsStore.set(name,obj)},renameCustomGroup:function(name,newName){return this._customGroupsStore.rename(name,newName)},delCustomGroup:function(name){return this._customGroupsStore.del(name)},getCustomGroupProp:function(name,prop){if(!this._customGroupsStore.has(name)){return null}return this._customGroupsStore.get(name)[prop]},setCustomGroupProp:function(name,prop,value){const logHead="CustomGroupsManager.setCustomGroupProp():";if(!this._customGroupsStore.has(name)){this._err(logHead,"custom group not found",name);return Promise.reject()}this._log(logHead,"setting value:",name,prop,value);let groupInfo=this.getCustomGroup(name);groupInfo[prop]=value;return this.setCustomGroup(name,groupInfo)},_colorToCalloutCss:{none:"",gray:"tm-callout-gray",blue:"tm-callout-blue",red:"tm-callout-red",yellow:"tm-callout-yellow",green:"tm-callout-green",pink:"tm-callout-pink",purple:"tm-callout-purple",cyan:"tm-callout-cyan"},getCustomGroupCssByColor:function(color){return this._colorToCalloutCss[color]},getCustomGroupColor:function(groupName){let color=this.getCustomGroupProp(groupName,"color")??"none";if(color=="grey"){color="gray";this.setCustomGroupProp(groupName,"color",color)}return color},getCustomGroupCss:function(groupName){let color=this.getCustomGroupColor(groupName);return this.getCustomGroupCssByColor(color)}});Classes.SettingsStore=Classes.AsyncBase.subclass({_storageKeyPrefix:"",_options:null,_customGroups:null,_pinnedGroups:null,_pinnedBookmarks:null,_shortcutsManager:null,_eventManager:null,_init:function(storageKeyPrefix){this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this._options=Classes.PersistentDict.createAs(this._storageKeyPrefix+"options",chrome.storage.sync);promiseArray.push(this._options.getInitPromise());this._options.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._customGroupsManager=Classes.CustomGroupsManager.create(this._storageKeyPrefix);promiseArray.push(this._customGroupsManager.getInitPromise());this._customGroupsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._pinnedGroups=Classes.PersistentSet.createAs(this._storageKeyPrefix+"pinnedGroups",chrome.storage.sync);promiseArray.push(this._pinnedGroups.getInitPromise());this._pinnedGroups.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._pinnedBookmarks=Classes.PersistentSet.createAs(this._storageKeyPrefix+"pinnedBookmarks",chrome.storage.sync);promiseArray.push(this._pinnedBookmarks.getInitPromise());this._pinnedBookmarks.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._shortcutsManager=Classes.ShortcutsManager.create(this._storageKeyPrefix);promiseArray.push(this._shortcutsManager.getInitPromise());this._shortcutsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(function(){perfProf.mark("settingsLoaded")})},_onUpdatedCb:function(ev){let key=ev.detail.key;if(key==null){key=ev.detail.target.getId()}this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},getAllOptions:function(){this._assert(this.isInitialized());return this._options},_getOption:function(prop){this._assert(this.isInitialized());return this._options.get(prop)},_getBooleanOption:function(prop,defaultValue=false){let retVal=this._getOption(prop);if(retVal==null){return defaultValue}return retVal},_setOption:function(prop,value){this._assert(this.isInitialized());return this._options.set(prop,value)},getOptionRecentlyClosedInSearch:function(){return this._getBooleanOption("recentlyClosedInSearch",true)},setOptionRecentlyClosedInSearch:function(value){return this._setOption("recentlyClosedInSearch",value)},getOptionBookmarksInSearch:function(){return this._getBooleanOption("bookmarksInSearch",true)},setOptionBookmarksInSearch:function(value){return this._setOption("bookmarksInSearch",value)},getOptionHistoryInSearch:function(){return this._getBooleanOption("historyInSearch")},setOptionHistoryInSearch:function(value){return this._setOption("historyInSearch",value)},getOptionBookmarksInIncognitoSearch:function(){return this._getBooleanOption("bookmarksInIncognitoSearch",true)},setOptionBookmarksInIncognitoSearch:function(value){return this._setOption("bookmarksInIncognitoSearch",value)},getOptionShowTabId:function(){if(!this._getBooleanOption("devMode")){return false}return this._getBooleanOption("showTabId")},setOptionShowTabId:function(value){return this._setOption("showTabId",value)},getOptionDevMode:function(){return this._getBooleanOption("devMode")},setOptionDevMode:function(value){return this._setOption("devMode",value)},getOptionAdvancedMenu:function(){return this._getBooleanOption("advancedMenu")},setOptionAdvancedMenu:function(value){return this._setOption("advancedMenu",value)},getOptionSearchUrl:function(){return this._getOption("searchUrl")},setOptionSearchUrl:function(value){return this._setOption("searchUrl",value)},getOptionNewTabToLtw:function(){return this._getBooleanOption("newTabToLtw",false)},setOptionNewTabToLtw:function(value){return this._setOption("newTabToLtw",value)},getOptionNewTabToLtwNoOpener:function(){return this._getBooleanOption("newTabToLtwNoOpener",true)},setOptionNewTabToLtwNoOpener:function(value){return this._setOption("newTabToLtwNoOpener",value)},getOptionNewTabToLtwWithOpener:function(){return this._getBooleanOption("newTabToLtwWithOpener")},setOptionNewTabToLtwWithOpener:function(value){return this._setOption("newTabToLtwWithOpener",value)},getOptionNewTabToLtwEmpty:function(){return this._getBooleanOption("newTabToLtwEmpty",true)},setOptionNewTabToLtwEmpty:function(value){return this._setOption("newTabToLtwEmpty",value)},getOptionNewTabDedup:function(){return this._getBooleanOption("newTabDedup",false)},setOptionNewTabDedup:function(value){return this._setOption("newTabDedup",value)},getOptionNewTabDedupNoOpener:function(){return this._getBooleanOption("newTabDedupNoOpener",true)},setOptionNewTabDedupNoOpener:function(value){return this._setOption("newTabDedupNoOpener",value)},getOptionNewTabDedupWithOpener:function(){return this._getBooleanOption("newTabDedupWithOpener",true)},setOptionNewTabDedupWithOpener:function(value){return this._setOption("newTabDedupWithOpener",value)},getOptionNewTabDedupEmpty:function(){return this._getBooleanOption("newTabDedupEmpty",true)},setOptionNewTabDedupEmpty:function(value){return this._setOption("newTabDedupEmpty",value)},getOptionStartupOpenPopup:function(){return this._getBooleanOption("startupOpenPopup",false)},setOptionStartupOpenPopup:function(value){return this._setOption("startupOpenPopup",value)},getOptionIncognitoBsTab:function(){return this._getBooleanOption("incognitoBsTab",false)},setOptionIncognitoBsTab:function(value){return this._setOption("incognitoBsTab",value)},getPinnedGroups:function(){this._assert(this.isInitialized());return this._pinnedGroups},isGroupPinned:function(groupName){return this._pinnedGroups.has(groupName)},pinGroup:function(groupName){return this._pinnedGroups.add(groupName)},unpinGroup:function(groupName){return this._pinnedGroups.del(groupName)},getPinnedBookmarks:function(){this._assert(this.isInitialized());return this._pinnedBookmarks},isBookmarkPinned:function(bmId){return this._pinnedBookmarks.has(bmId)},pinBookmark:function(bmId){return this._pinnedBookmarks.add(bmId)},pinManyBookmarks:function(bmIdList){return this._pinnedBookmarks.addMany(bmIdList)},unpinBookmark:function(bmId){return this._pinnedBookmarks.del(bmId)},unpinManyBookmarks:function(bmIdList){return this._pinnedBookmarks.delMany(bmIdList)},getCustomGroupsManager:function(){this._assert(this.isInitialized());return this._customGroupsManager},getShortcutsManager:function(){this._assert(this.isInitialized());return this._shortcutsManager}});perfProf.mark("settingsStarted");Classes.Base.roDef(window,"settingsStore",Classes.SettingsStore.create());settingsStore.debug();Classes.ScheduledJob=Classes.Base.subclass({_handle:null,_jobName:null,_recurInterval:null,_init:function(jobFn,jobName){Classes.Base._init.call(this);this._jobName=optionalWithDefault(jobName,"");if(jobFn!=null){this._jobFn=jobFn}else{this._jobFn=this._job}},run:function(delay){const logHead="ScheduledJob::run(delay = "+delay+", now: "+Date.now()+', job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(delay==null||delay==0){this.skip();this._jobFn();return}if(this._handle!=null){this._log(logHead+"already scheduled");return}this._handle=setTimeout(function(){this._jobFn();this._handle=null}.bind(this),delay)},start:function(interval,runOnceNow){runOnceNow=optionalWithDefault(runOnceNow,true);const logHead="ScheduledJob::start("+interval+', job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(this.isRunning()){this._log(logHead+"already scheduled");return}this._recurInterval=interval;this._handle=this._safeSetInterval(this._jobFn.bind(this),interval);this._log(logHead+"started");if(runOnceNow){this._jobFn()}},stop:function(){const logHead='ScheduledJob::stop(job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(!this.isRunning()){this._log(logHead+"not scheduled");return}this._log(logHead+"stopping");if(this._recurInterval==null){clearInterval(this._handle);this._recurInterval=null}else{clearTimeout(this._handle)}this._handle=null},skip:function(){const logHead='ScheduledJob::skip(job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(this._handle==null){this._log(logHead+"not scheduled");return}this._log(logHead+"skipping");let savedRecurInterval=this._recurInterval;this.stop();if(savedRecurInterval!=null){this.start(savedRecurInterval,false)}},discard:function(){this.stop();this._jobFn=null;gcChecker.add(this)},isRunning:function(){return this._handle!=null},_job:function(){this._errorMustSubclass("ScheduledJob::_job()")},_safeSetInterval:function(fn,interval){const logHead="ScheduledJob::_safeSetInterval(): ";if(typeof interval!=="number"){this._err(logHead+"interval is not a number ("+interval+"), bypassing setInterval() to avoid trouble");return}if(interval<1e3){this._err(logHead+"interval is too small ("+interval+"), bypassing setInterval() to avoid trouble");return}return setInterval(fn,interval)}});Classes.PopupDockerBase=Classes.Base.subclass({_undockedInitWidth:420,_undockedInitHeight:800,_init:function(){Classes.Base._init.call(this);this.debug()},getPopupUrl:function(undocked){undocked=optionalWithDefault(undocked,false);let urlSearch="";if(undocked){urlSearch="?undocked"}return chrome.runtime.getURL(isProd()?"popup.html"+urlSearch:"popup/popup.html"+urlSearch)},_launchUndocked:function(){const logHead="PopupDockerBase::_launchUndocked(): ";let storedSize=optionalWithDefault(localStore.getPopupSize(),{});let createData={url:this.getPopupUrl(true),focused:true,type:"popup",left:optionalWithDefault(storedSize.posX,0),top:optionalWithDefault(storedSize.posY,0),width:optionalWithDefault(storedSize.width,this._undockedInitWidth),height:optionalWithDefault(storedSize.height,this._undockedInitHeight)};chromeUtils.wrap(chrome.windows.create,logHead,createData).then(function(){this._log(logHead+"launched",createData)}.bind(this))},_openUndocked:function(){const logHead="PopupDockerBase::_openUndocked(): ";this._log(logHead+"entering");chromeUtils.queryTabs({url:this.getPopupUrl(true)},logHead).then(function(tabs){if(tabs.length==0){this._log(logHead+"undocked tab not found, launching it");this._launchUndocked();return}if(tabs.length>1){this._log(logHead+"unexpected, multiple undocked popups found")}chromeUtils.activateTab(tabs[0]).then(function(){const extTabId=tabNormalizer.formatExtendedId(tabs[0]);this._log(logHead+"activated tab "+extTabId)}.bind(this))}.bind(this))},_setDocked:function(docked){docked=optionalWithDefault(docked,true);const logHead="PopupDockerBase::_setDocked("+docked+"): ";localStore.setPopupDocked(docked);let popupUrl="";if(docked){popupUrl=this.getPopupUrl()}chromeUtils.wrap(chromeUtils.bAction.setPopup,logHead,{popup:popupUrl}).then(function(){this._log(logHead+"chromeUtils.bAction.setPopup() succeeded")}.bind(this))},showState:function(){const logHead="PopupDockerBase::showState(): ";chromeUtils.wrap(chromeUtils.bAction.getPopup,logHead,{}).then(function(result){this._log(logHead+'chromeUtils.bAction.getPopup() returned "'+result+'" (empty means "undocked")')}.bind(this))}});Classes.Base.roDef(Classes.PopupDockerBase,"cmd",{});Classes.Base.roDef(Classes.PopupDockerBase.cmd,"SEARCH","search");Classes.LocalStore=Classes.AsyncBase.subclass({_storageKeyPrefix:"",standardTabsBsTabExpandedGroups:null,incognitoTabsBsTabExpandedGroups:null,_bootstrapTabs:null,_eventManager:null,_incognitoAccess:null,_init:function(storageKeyPrefix){this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){const logHead="LocalStore::_asyncInit(): ";let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this.standardTabsBsTabExpandedGroups=Classes.PersistentSet.createAs("standardTabsBsTab_expanded");promiseArray.push(this.standardTabsBsTabExpandedGroups.getInitPromise());this.incognitoTabsBsTabExpandedGroups=Classes.PersistentSet.createAs("incognitoTabsBsTab_expanded");promiseArray.push(this.incognitoTabsBsTabExpandedGroups.getInitPromise());this._bootstrapTabs=Classes.PersistentDict.createAs("bootstrapTabs");promiseArray.push(this._bootstrapTabs.getInitPromise());this._bootstrapTabs.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));promiseArray.push(chromeUtils.wrap(chrome.extension.isAllowedIncognitoAccess,logHead).then(function(isAllowedAccess){this._incognitoAccess=isAllowedAccess}.bind(this)));return Promise.all(promiseArray).then(function(){perfProf.mark("localStoreLoaded")})},_onUpdatedCb:function(ev){let key=ev.detail.target.getId();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},getActiveBsTabId:function(){return this._bootstrapTabs.get("activeTabId")},setActiveBsTabId:function(bsTabId){return this._bootstrapTabs.set("activeTabId",bsTabId)},isPopupDocked:function(){return false},setPopupDocked:function(docked){return Promise.resolve()},getPopupSize:function(){return this._bootstrapTabs.get("popupSize")},setPopupSize:function(posX,posY,width,height){size={posX:posX,posY:posY,width:width,height:height};return this._bootstrapTabs.set("popupSize",size)},isAllowedIncognitoAccess:function(){return this._incognitoAccess}});perfProf.mark("localStoreStarted");Classes.Base.roDef(window,"localStore",Classes.LocalStore.create());localStore.debug();Classes.SearchTokenizer=Classes.Base.subclass({_parserDebug:null,_validUnaryOpList:["-","site","intitle","inurl","badge","group","folder"],_escapedCharsList:['"',"'",":"," ","\t","(",")"],_errors:null,_init:function(value){const logHead="SearchTokenizer::_init(): ";Classes.Base._init.call(this);this.debug();this._parserDebug=emptyFn},_nextCharIsEscapable:function(queryString,escapedCharsList){let nextChar=queryString[0];if(escapedCharsList.includes(nextChar)){return true}if(nextChar=="\\"&&queryString.length>1&&escapedCharsList.includes(queryString[1])){return true}return false},_consumeEscapedCharacter:function(queryString,escapedCharsList=this._escapedCharsList){if(queryString.length==0||!this._nextCharIsEscapable(queryString,escapedCharsList)){return[queryString,"\\"]}let currChar=queryString[0];queryString=queryString.substring(1);return[queryString,currChar]},_consumeQuotedString:function(queryString,matchingQuoteChar){const logHead='SearchTokenizer::_consumeQuotedString("'+queryString+'", matchingQuoteChar: "'+matchingQuoteChar+'"): ';let token="";while(queryString.length>0){let currChar=queryString[0];queryString=queryString.substring(1);switch(currChar){case"\\":let escapedString="";let escapedCharsList=this.getEscapedCharsList(Classes.SearchTokenizer.type.QUOTEDTEXT,matchingQuoteChar);[queryString,escapedString]=this._consumeEscapedCharacter(queryString,escapedCharsList);token+=escapedString;break;case matchingQuoteChar:return[queryString,token];default:token+=currChar;break}}this._log(logHead+"no matching closing quote");return[queryString,token]},_consumeRegexString:function(queryString){const logHead='SearchTokenizer::_consumeRegexString("'+queryString+'"): ';let token="";while(queryString.length>0){let currChar=queryString[0];queryString=queryString.substring(1);switch(currChar){case"\\":let escapedString="";let escapedCharsList=this.getEscapedCharsList(Classes.SearchTokenizer.type.REGEX);[queryString,escapedString]=this._consumeEscapedCharacter(queryString,escapedCharsList);token+=escapedString;break;case" ":case"\t":return[queryString,token];case'"':case"'":if(token.length>0){token+=currChar}else{return this._consumeQuotedString(queryString,currChar)}break;default:token+=currChar;break}}return[queryString,token]},_setRegexToken:function(token){if(token.length==0){return null}let regex=null;let regexErr=null;let retVal={type:Classes.SearchTokenizer.type.REGEX,sources:[tmUtils.freeze({type:Classes.SearchTokenizer.type.REGEX,value:token})]};try{retVal.value=new RegExp(token,"i")}catch(e){const logHead="SearchTokenizer::_setRegexToken(): ";this._log(logHead+"unable to parse regex for token /"+token+"/: ",e);console.error("RegExp parser: "+e.name+": "+e.message);this._errors.push(e);retVal.error=e}return retVal},_setTextOrBinaryOpToken:function(token){switch(token){case"and":case"or":return{type:Classes.SearchTokenizer.type.BINARYOP,value:token}}return{type:Classes.SearchTokenizer.type.TEXT,value:token}},_setUnaryOpToken:function(token){if(this._validUnaryOpList.includes(token)){return{type:Classes.SearchTokenizer.type.UNARYOP,value:token}}else{const logHead="SearchTokenizer::_setUnaryOpToken(): ";this._log(logHead+'discarding unknown unary operator "'+token+'"');return null}},_genTokenByType:function(token,tokenType){switch(tokenType){case Classes.SearchTokenizer.type.TEXT:return this._setTextOrBinaryOpToken(token.toLowerCase());case Classes.SearchTokenizer.type.REGEX:return this._setRegexToken(token);case Classes.SearchTokenizer.type.UNARYOP:return this._setUnaryOpToken(token.toLowerCase());case Classes.SearchTokenizer.type.QUOTEDTEXT:return{type:Classes.SearchTokenizer.type.TEXT,value:token.toLowerCase()};case Classes.SearchTokenizer.type.SUBTREE:case Classes.SearchTokenizer.type.BINARYOP:default:const logHead="SearchTokenizer::_genTokenByType(): ";this._err(logHead+'invalid or unknown tokenType "'+tokenType+'"')}return null},tokenize:function(queryString,tokenList,topLevel=true){const logHead='SearchTokenizer::tokenize("'+queryString+'", topLevel: '+topLevel+"): ";this._errors=[];let token="";let generateToken=function(tokenType){if(token.length>0){let tokenObj=this._genTokenByType(token,tokenType);if(tokenObj!=null){tokenList.push(tokenObj)}token=""}}.bind(this);while(queryString.length>0){let currChar=queryString[0];queryString=queryString.substring(1);this._parserDebug(logHead+'processing: "'+currChar+'"');switch(currChar){case" ":case"\t":generateToken(Classes.SearchTokenizer.type.TEXT);break;case'"':case"'":generateToken(Classes.SearchTokenizer.type.TEXT);[queryString,token]=this._consumeQuotedString(queryString,currChar);generateToken(Classes.SearchTokenizer.type.QUOTEDTEXT);break;case"\\":let escapedString="";[queryString,escapedString]=this._consumeEscapedCharacter(queryString);token+=escapedString;break;case"-":token+="-";case":":if(queryString.length==0||[" ","\t"].includes(queryString[0])||!(this._validUnaryOpList.includes(token)||token=="r")){if(currChar==":"){token+=currChar}break}if(token=="r"){[queryString,token]=this._consumeRegexString(queryString);generateToken(Classes.SearchTokenizer.type.REGEX);break}generateToken(Classes.SearchTokenizer.type.UNARYOP);break;case"(":generateToken(Classes.SearchTokenizer.type.TEXT);let subTokenList=[];queryString=this.tokenize(queryString,subTokenList,false);if(subTokenList.length!=0){tokenList.push({type:Classes.SearchTokenizer.type.SUBTREE,value:subTokenList})}break;case")":if(!topLevel){generateToken(Classes.SearchTokenizer.type.TEXT);return queryString}this._log(logHead+'found unbalanced ")"');break;default:token+=currChar;break}}generateToken(Classes.SearchTokenizer.type.TEXT);if(!topLevel){this._log(logHead+'no matching closing ")"');return""}},getEscapedCharsList:function(tokenType,quoteChar='"'){switch(tokenType){case Classes.SearchTokenizer.type.TEXT:return this._escapedCharsList;case Classes.SearchTokenizer.type.REGEX:return[" "];case Classes.SearchTokenizer.type.QUOTEDTEXT:return[quoteChar];case Classes.SearchTokenizer.type.SUBTREE:case Classes.SearchTokenizer.type.BINARYOP:case Classes.SearchTokenizer.type.UNARYOP:default:const logHead="SearchTokenizer::getEscapedCharsList(): ";this._err(logHead+'invalid or unknown tokenType "'+tokenType+'"')}},getErrors:function(){return this._errors}});Classes.Base.roDef(Classes.SearchTokenizer,"type",{});Classes.Base.roDef(Classes.SearchTokenizer.type,"BINARYOP","binaryOp");Classes.Base.roDef(Classes.SearchTokenizer.type,"UNARYOP","unaryOp");Classes.Base.roDef(Classes.SearchTokenizer.type,"SUBTREE","subtree");Classes.Base.roDef(Classes.SearchTokenizer.type,"TEXT","text");Classes.Base.roDef(Classes.SearchTokenizer.type,"QUOTEDTEXT","quotedText");Classes.Base.roDef(Classes.SearchTokenizer.type,"REGEX","regex");Classes.Base.roDef(Classes.SearchTokenizer.type,"TRUTH","truth");Classes.SearchParser=Classes.Base.subclass({_parserDebug:null,_binaryOpPrecedenceList:{and:2,or:1},_init:function(value){const logHead="SearchParser::_init(): ";Classes.Base._init.call(this);this.debug();this._parserDebug=emptyFn},_parseRegex:function(regexText){let regex=null;try{regex=new RegExp(regexText,"i")}catch(e){const logHead="SearchParser::_parseRegex(): ";this._log(logHead+"unable to parse regex for text /"+regexText+"/: ",e);return null}return regex},buildRegexValue:function(node){return this._parseRegex(this._mergeNodeSources(node))},isRegexParsable:function(node){switch(node.type){case Classes.SearchTokenizer.type.REGEX:if(node.error==null){return true}return false;default:return this._parseRegex(tmUtils.regexEscape(node.value))!=null}},_updateUnaryOps:function(tokenList){const logHead="SearchParser::_updateUnaryOps(): ";let newTokenList=[];let i=0;while(i<tokenList.length){let node=tokenList[i];newTokenList.push(node);while(node.type==Classes.SearchTokenizer.type.UNARYOP&&i<tokenList.length){i++;if(i<tokenList.length){node.operand=tokenList[i];node=node.operand}else{this._log(logHead+"unary operator without operand (end of tokenList), demoting to text");node.type=Classes.SearchTokenizer.type.TEXT}}i++}return newTokenList},_addImplicitNodes:function(tokenList){const logHead="SearchParser::_addImplicitNodes(): ";let newTokenList=[];let i=0;if(tokenList[0].type==Classes.SearchTokenizer.type.BINARYOP){this._log(logHead+"invalid syntax, binary operator at beginning of query string, adding dummy node");newTokenList.push({type:Classes.SearchTokenizer.type.TEXT,value:""})}while(i<tokenList.length){let node=tokenList[i];newTokenList.push(node);if(node.type!=Classes.SearchTokenizer.type.BINARYOP){if(tokenList.length>i+1){if(tokenList[i+1].type!=Classes.SearchTokenizer.type.BINARYOP){newTokenList.push({type:Classes.SearchTokenizer.type.BINARYOP,value:"and"})}}}if(node.type==Classes.SearchTokenizer.type.BINARYOP){if(tokenList.length>i+1){if(tokenList[i+1].type==Classes.SearchTokenizer.type.BINARYOP){this._log(logHead+"invalid syntax, two consecutive binary operators, adding dummy node");newTokenList.push({type:Classes.SearchTokenizer.type.TEXT,value:""})}}else{this._log(logHead+"invalid syntax, binary operator at end of query string, adding dummy node");newTokenList.push({type:Classes.SearchTokenizer.type.TEXT,value:""})}}i++}return newTokenList},getBinaryOpPrecedence:function(binaryOp){return this._binaryOpPrecedenceList[binaryOp]},_parseSubtree:function(node){if(node.type==Classes.SearchTokenizer.type.SUBTREE){return this.parse(node.value)}if(node.type==Classes.SearchTokenizer.type.UNARYOP){node.operand=this._parseSubtree(node.operand)}return node},_parseInner:function(leftOperand,minPrecedence,tokenList){const logHead="SearchParser::_parseInner(): ";this._parserDebug(logHead+"entering, minPrecedence: "+minPrecedence+", leftOperand: ",JSON.stringify(leftOperand));let lookahead=tokenList[0];this._parserDebug(logHead+"outer lookahead: ",JSON.stringify(lookahead));while(lookahead!=null&&lookahead.type==Classes.SearchTokenizer.type.BINARYOP&&this.getBinaryOpPrecedence(lookahead.value)>=minPrecedence){let op=tokenList.shift();let rightOperand=tokenList.shift();this._assert(rightOperand.type!=Classes.SearchTokenizer.type.BINARYOP);lookahead=tokenList[0];this._parserDebug(logHead+"inner lookahead: ",JSON.stringify(lookahead));while(lookahead!=null&&lookahead.type==Classes.SearchTokenizer.type.BINARYOP&&this.getBinaryOpPrecedence(lookahead.value)>this.getBinaryOpPrecedence(op.value)){rightOperand=this._parseInner(rightOperand,minPrecedence+1,tokenList);this._parserDebug(logHead+"innermost right operand: ",JSON.stringify(rightOperand));lookahead=tokenList[0];this._parserDebug(logHead+"innermost lookahead: ",JSON.stringify(lookahead))}op.operands=[this._parseSubtree(leftOperand),this._parseSubtree(rightOperand)];this._parserDebug(logHead+"op assigned operands: ",JSON.stringify(op));leftOperand=op}return this._parseSubtree(leftOperand)},parse:function(tokenList){const logHead="SearchParser::parse(): ";tokenList=this._updateUnaryOps(tokenList);tokenList=this._addImplicitNodes(tokenList);this._parserDebug(logHead+"after cleanup:",tokenList);let leftOperand=tokenList.shift();parsedTree=this._parseInner(leftOperand,1,tokenList);this._parserDebug(logHead+"after parsing:",parsedTree);return parsedTree},cloneTree:function(node){const logHead="SearchParser::cloneTree(): ";let newNode={type:node.type};switch(node.type){case Classes.SearchTokenizer.type.BINARYOP:newNode.operands=[];for(let i=0;i<node.operands.length;i++){newNode.operands.push(this.cloneTree(node.operands[i]))}newNode.value=node.value.repeat(1);break;case Classes.SearchTokenizer.type.UNARYOP:newNode.operand=this.cloneTree(node.operand);newNode.value=node.value.repeat(1);break;case Classes.SearchTokenizer.type.TEXT:case Classes.SearchTokenizer.type.QUOTEDTEXT:newNode.value=node.value.repeat(1);break;case Classes.SearchTokenizer.type.REGEX:newNode.sources=[].concat(node.sources);if(node.error!=null){newNode.error=node.error}else{this._assert(node.value!=null,logHead+"original node has null regex");newNode.value=this.buildRegexValue(node);this._assert(newNode.value!=null,logHead+"copied node has null regex")}break;case Classes.SearchTokenizer.type.TRUTH:this._assert(node.type!=Classes.SearchTokenizer.type.TRUTH,logHead+"unexpected");newNode.value=node.value.repeat(1);break;default:this._err(logHead+'unknown node type "'+node.type+'"')}return newNode},_escapeText:function(text,tokenType,quoteChar){let retVal="";let escapedCharsList=Classes.SearchTokenizer.getEscapedCharsList(tokenType,quoteChar);for(i=0;i<text.length;i++){if(escapedCharsList.includes(text[i])){retVal+="\\"+text[i]}else{retVal+=text[i]}}if(retVal[retVal.length-1]=="\\"){retVal+="\\"}return retVal},_hasHigherPrecedence:function(node,parentNode){if(parentNode==null){return true}if(parentNode.type!=Classes.SearchTokenizer.type.BINARYOP){return false}return this.getBinaryOpPrecedence(node.value)>=this.getBinaryOpPrecedence(parentNode.value)},_mergeNodeSources:function(node){if(node.sources.length==1){return node.sources[0].value}let values=[];for(let i=0;i<node.sources.length;i++){values.push(node.sources[i].value)}return"("+values.join(")|(")+")"},rebuildQueryString:function(node,parentNode,rebuildMode){rebuildMode=optionalWithDefault(rebuildMode,Classes.SearchParser.rebuildMode.MIN);let retVal=[];let fullRebuild=rebuildMode!=Classes.SearchParser.rebuildMode.SIMPLE;switch(node.type){case Classes.SearchTokenizer.type.BINARYOP:let needParantheses=false;if(!this._hasHigherPrecedence(node,parentNode)||rebuildMode==Classes.SearchParser.rebuildMode.MAX){needParantheses=true}if(fullRebuild&&needParantheses){retVal.push("(")}let innerRebuild=[];for(let i=0;i<node.operands.length;i++){innerRebuild.push(this.rebuildQueryString(node.operands[i],node,rebuildMode))}if(fullRebuild){retVal.push(innerRebuild.join(" "+node.value.toUpperCase()+" "))}else{retVal=retVal.concat(innerRebuild)}if(fullRebuild&&needParantheses){retVal.push(")")}return retVal.join(" ");case Classes.SearchTokenizer.type.UNARYOP:if(fullRebuild){retVal.push(node.value);if(node.value!="-"){retVal.push(":")}}retVal.push(this.rebuildQueryString(node.operand,node,rebuildMode));return retVal.join("");case Classes.SearchTokenizer.type.TEXT:case Classes.SearchTokenizer.type.QUOTEDTEXT:if(fullRebuild){return'"'+this._escapeText(node.value,Classes.SearchTokenizer.type.QUOTEDTEXT,'"')+'"'}else{return node.value}case Classes.SearchTokenizer.type.REGEX:if(!fullRebuild){return""}let prefix="r:";if(node.error!=null){console.error("RegExp parser: "+node.error.name+": "+node.error.message);prefix="r<error>:"}let rawRegex=this._mergeNodeSources(node);return prefix+'"'+this._escapeText(rawRegex,Classes.SearchTokenizer.type.QUOTEDTEXT,'"')+'"';case Classes.SearchTokenizer.type.TRUTH:return"<"+node.value.toUpperCase()+">";default:const logHead="SearchParser::rebuildQueryString()";this._err(logHead+'unknown operator type "'+node.type+'":',node);return""}return""}});Classes.Base.roDef(Classes.SearchParser,"rebuildMode",{});Classes.Base.roDef(Classes.SearchParser.rebuildMode,"MIN","min");Classes.Base.roDef(Classes.SearchParser.rebuildMode,"MAX","max");Classes.Base.roDef(Classes.SearchParser.rebuildMode,"SIMPLE","simple");Classes.SearchOptimizer=Classes.Base.subclass({_parserDebug:null,_parser:null,_changeHistory:null,_iterationsCnt:null,_maxIterationCnt:100,_init:function(searchParser){Classes.Base._init.call(this);this.debug();this._parserDebug=emptyFn;this._parser=searchParser},_setChanged:function(changed,msg){changed.changed=true;changed.what.push("["+changed.iteration+"] "+msg)},_convertNodeToRegexSource:function(node){const logHead="SearchOptimizer::_convertNodeToRegexSource(): ";let convertibleTypes=[Classes.SearchTokenizer.type.TEXT,Classes.SearchTokenizer.type.QUOTEDTEXT,Classes.SearchTokenizer.type.REGEX];if(!convertibleTypes.includes(node.type)){return null}if(!this._parser.isRegexParsable(node)){return null}let sources=[];if(node.type==Classes.SearchTokenizer.type.REGEX){sources=sources.concat(node.sources);this._parserDebug(logHead+"regex sources: ",sources)}else{sources=[tmUtils.freeze({type:node.type,value:tmUtils.regexEscape(node.value)})];this._parserDebug(logHead+"sources: ",sources)}return sources},_convertOrToRegex:function(node,changed){let regexNode={type:Classes.SearchTokenizer.type.REGEX,sources:[]};let operandsLeft=[];let convertedSources=[];let countRegex=0;let countNonRegex=0;for(let i=0;i<node.operands.length;i++){let newSources=this._convertNodeToRegexSource(node.operands[i]);if(newSources==null){operandsLeft.push(node.operands[i])}else{convertedSources.push(newSources);if(node.operands[i].type==Classes.SearchTokenizer.type.REGEX){countRegex++}else{countNonRegex++}}}if(countRegex<2&&countNonRegex==0){return null}regexNode.sources=regexNode.sources.concat.apply(regexNode.sources,convertedSources);regexNode.value=this._parser.buildRegexValue(regexNode);if(regexNode.value==null){const logHead="SearchOptimizer::_convertOrToRegex(): ";this._log(logHead+"unable to parse regex for sources:",regexNode.sources);return null}if(operandsLeft.length>0){this._setChanged(changed,"kept OR node, consolidated some operands");operandsLeft.push(regexNode);return{type:Classes.SearchTokenizer.type.BINARYOP,value:node.value,operands:operandsLeft}}this._setChanged(changed,"consolidated all operands, OR replaced");return regexNode},_groupByUnaryModifier:function(node){const logHead="SearchOptimizer::_groupByUnaryModifier(): ";let groups={};let ungrouped=[];this._parserDebug(logHead+"node: ",node);for(let i=0;i<node.operands.length;i++){let operand=node.operands[i];if(operand.type==Classes.SearchTokenizer.type.UNARYOP&&operand.value!="-"){if(groups[operand.value]!=null){groups[operand.value].push(operand)}else{groups[operand.value]=[operand]}}else{ungrouped.push(operand)}}this._parserDebug(logHead+"groups: ",groups);let groupKeys=Object.keys(groups);for(let i=0;i<groupKeys.length;i++){let group=groups[groupKeys[i]];if(group.length==1){ungrouped.push(group[0]);delete groups[groupKeys[i]]}}groups["_ungrouped"]=ungrouped;return groups},_createUnaryGroupNode:function(group,refBinaryOpNode){let newBinaryOperand={type:refBinaryOpNode.type,value:refBinaryOpNode.value,operands:[]};for(let i=0;i<group.length;i++){newBinaryOperand.operands.push(group[i].operand)}return{type:group[0].type,value:group[0].value,operand:newBinaryOperand}},_promoteUnaryModifierOverUnaryBoolean:function(node,changed){if(!(node.type==Classes.SearchTokenizer.type.UNARYOP&&node.type==node.operand.type)){return node}if(!(node.value=="-"&&node.operand.value!="-")){return node}this._setChanged(changed,"promoted '"+node.operand.value+":' by swapping with unaryOp '-'");return{type:node.type,value:node.operand.value,operand:{type:node.type,value:node.value,operand:node.operand.operand}}},_promoteUnaryModifierOverBinaryOp:function(node,changed){const logHead="SearchOptimizer::_promoteUnaryModifierOverBinaryOp(): ";let groups=this._groupByUnaryModifier(node);let groupKeys=Object.keys(groups);this._parserDebug(logHead+"groups: ",groups);if(groupKeys.length==1){return node}let groupNodes=[];let ungrouped=null;for(let i=0;i<groupKeys.length;i++){if(groupKeys[i]!="_ungrouped"){groupNodes.push(this._createUnaryGroupNode(groups[groupKeys[i]],node))}else{ungrouped=groups[groupKeys[i]]}}if(ungrouped.length==0&&groupNodes.length==1){this._setChanged(changed,"promoted '"+groupNodes[0].value+":' by swapping with binaryOp '"+node.value+"'");return groupNodes[0]}this._setChanged(changed,"partial swap of '"+node.value+"' and unary groups");return{type:node.type,value:node.value,operands:[].concat(groupNodes,ungrouped)}},_orOptimizer:function(node,changed){newNode=this._convertOrToRegex(node,changed);if(newNode!=null){return newNode}return node},_createOperandInfo:function(operand,operandIdx,operandDropped){if(operand==null){return null}let opdInfo={opd:operand,val:operand.value,idx:operandIdx,neg:false,dropped:operandDropped};while(opdInfo.opd.type==Classes.SearchTokenizer.type.UNARYOP&&opdInfo.opd.value!="-"){opdInfo.pOpd=opdInfo.opd;opdInfo.val=opdInfo.opd.operand.value;opdInfo.opd=opdInfo.opd.operand}if(opdInfo.opd.type==Classes.SearchTokenizer.type.UNARYOP&&opdInfo.opd.value=="-"){opdInfo.neg=true;opdInfo.val=opdInfo.opd.operand.value;opdInfo.opd=opdInfo.opd.operand}return opdInfo},_dropWhatForIncludes:function(longer,shorter,longerName,shorterName,operator){const logHead="SearchOptimizer::_dropWhatForIncludes() ";this._assert(longer.val!=shorter.val,logHead+"don't call this function for identical values",longer,shorter);if(!longer.dropped&&!shorter.dropped){if(operator=="and"&&(!longer.neg&&!shorter.neg)||operator=="or"&&(longer.neg&&shorter.neg)){return shorterName}if(operator=="and"&&(longer.neg&&shorter.neg)||operator=="or"&&(!longer.neg&&!shorter.neg)){return longerName}}else{if(!longer.neg&&!shorter.neg||longer.neg&&shorter.neg){return"none"}}if(operator=="and"&&longer.neg||operator=="or"&&shorter.neg){return"none"}if(operator=="and"&&shorter.neg){return"false"}if(operator=="or"&&longer.neg){return"true"}},_dropWhatForEquality:function(ref,cmp,operator){if(!ref.neg&&!cmp.neg||ref.neg&&cmp.neg){return"either"}if(operator=="and"){return"false"}if(operator=="or"){return"true"}},_dropWhatForTruth:function(opdInfo,opdInfoName,operator){const logHead="SearchOptimizer::_dropWhatForTruth(): ";let truthVal=opdInfo.val;let negated="";if(opdInfo.neg){truthVal=truthVal=="true"?"false":"true";negated="(negated)"}if(opdInfo.opd.type==Classes.SearchTokenizer.type.TRUTH){if(operator=="and"&&truthVal=="false"||operator=="or"&&truthVal=="true"){this._parserDebug(logHead+"returning '"+truthVal+"' for operator '"+operator+"' and",isProd()||this._parser.rebuildQueryString(opdInfo.opd),negated);return truthVal}this._parserDebug(logHead+"returning '"+opdInfoName+"' for operator '"+operator+"' and",isProd()||this._parser.rebuildQueryString(opdInfo.opd),negated);return opdInfoName}return null},_dropWhat:function(refOpdInfo,cmpOpdInfo,operator){if(refOpdInfo.pOpd!=null&&cmpOpdInfo.pOpd!=null&&refOpdInfo.pOpd.value!=cmpOpdInfo.pOpd.value){return"none"}let truthFound=this._dropWhatForTruth(refOpdInfo,"ref",operator);if(truthFound!=null){return truthFound}truthFound=this._dropWhatForTruth(cmpOpdInfo,"cmp",operator);if(truthFound!=null){return truthFound}let inclusionTypes=[Classes.SearchTokenizer.type.TEXT,Classes.SearchTokenizer.type.QUOTEDTEXT];let equalityTypes=[Classes.SearchTokenizer.type.REGEX];if(inclusionTypes.includes(refOpdInfo.opd.type)&&inclusionTypes.includes(cmpOpdInfo.opd.type)){if(refOpdInfo.val==cmpOpdInfo.val){return this._dropWhatForEquality(refOpdInfo,cmpOpdInfo,operator)}if(cmpOpdInfo.val.includes(refOpdInfo.val)){return this._dropWhatForIncludes(cmpOpdInfo,refOpdInfo,"cmp","ref",operator)}if(refOpdInfo.val.includes(cmpOpdInfo.val)){return this._dropWhatForIncludes(refOpdInfo,cmpOpdInfo,"ref","cmp",operator)}return"none"}if(equalityTypes.includes(refOpdInfo.opd.type)&&equalityTypes.includes(cmpOpdInfo.opd.type)){if(refOpdInfo.val==cmpOpdInfo.val){return this._dropWhatForEquality(refOpdInfo,cmpOpdInfo,operator)}return"none"}return"none"},_adjustDropWhat:function(dropWhat,refOpdInfo,cmpOpdInfo,operator){if(refOpdInfo.pOpd==null&&cmpOpdInfo.pOpd==null||refOpdInfo.pOpd!=null&&cmpOpdInfo.pOpd!=null){if(dropWhat=="either"){return"cmp"}return dropWhat}switch(dropWhat){case"none":return"none";case"either":if(refOpdInfo.pOpd!=null){if(operator=="and"){return"cmp"}return"ref"}if(operator=="and"){return"ref"}return"cmp";case"ref":if(refOpdInfo.pOpd!=null&&operator=="or"||cmpOpdInfo.pOpd!=null&&operator=="and"){return dropWhat}return"none";case"cmp":if(cmpOpdInfo.pOpd!=null&&operator=="or"||refOpdInfo.pOpd!=null&&operator=="and"){return dropWhat}return"none";case"true":return dropWhat;case"false":return"none"}},_mergeBinaryOperands:function(node,changed){let operandsKept=[].concat(node.operands);let somethingDropped=false;let innerLoop=function(refOpdInfo){const logHead="SearchOptimizer::_mergeBinaryOperands.innerLoop(): ";for(let j=refOpdInfo.idx+1;j<node.operands.length;j++){let cmpOpdInfo=this._createOperandInfo(node.operands[j],j,operandsKept[j]==null);let dropWhat=this._dropWhat(refOpdInfo,cmpOpdInfo,node.value);this._parserDebug(logHead+"_dropWhat() returned '"+dropWhat+"' for ||| ref:",isProd()||this._parser.rebuildQueryString(node.operands[refOpdInfo.idx]),"||| cmp:",isProd()||this._parser.rebuildQueryString(node.operands[j]));dropWhat=this._adjustDropWhat(dropWhat,refOpdInfo,cmpOpdInfo,node.value);switch(dropWhat){case"ref":operandsKept[refOpdInfo.idx]=null;refOpdInfo.dropped=true;somethingDropped=true;continue;case"cmp":operandsKept[j]=null;somethingDropped=true;continue;case"none":continue;case"true":this._assert(node.value=="or",logHead+"unexpected operator");return"true";case"false":this._assert(node.value=="and",logHead+"unexpected operator");return"false";default:this._err(logHead+'unknown dropWhat = "'+dropWhat+'"');continue}}}.bind(this);for(let i=0;i<node.operands.length;i++){let refOpdInfo=this._createOperandInfo(node.operands[i],i,operandsKept[i]==null);let nuclear=innerLoop(refOpdInfo);if(nuclear!=null){this._setChanged(changed,"binary operator '"+node.value+"' is a tautology/contradiction");return{type:Classes.SearchTokenizer.type.TRUTH,value:nuclear}}}if(!somethingDropped){return node}let newNode={type:node.type,value:node.value,operands:[]};for(let i=0;i<operandsKept.length;i++){if(operandsKept[i]==null){this._setChanged(changed,"dropped redundant operand "+i+" ("+this._parser.rebuildQueryString(node.operands[i])+") for '"+node.value+"'")}else{newNode.operands.push(operandsKept[i])}}if(newNode.operands.length==1){this._setChanged(changed,"single operand left, dropped redundant operator '"+node.value+"'");return newNode.operands[0]}return newNode},_mergeBinaryOperators:function(node,changed){switch(node.type){case Classes.SearchTokenizer.type.BINARYOP:for(let i=0;i<node.operands.length;i++){node.operands[i]=this._mergeBinaryOperators(node.operands[i],changed)}break;case Classes.SearchTokenizer.type.UNARYOP:node.operand=this._mergeBinaryOperators(node.operand,changed);return node;default:return node}let newOperands=[];for(let i=0;i<node.operands.length;i++){if(node.operands[i].type==node.type&&node.operands[i].value==node.value){this._setChanged(changed,"merged parent and child '"+node.value+"'");newOperands=newOperands.concat(node.operands[i].operands)}else{newOperands.push(node.operands[i])}}return{type:node.type,value:node.value,operands:newOperands}},_mergeUnaryOperators:function(node,changed){switch(node.type){case Classes.SearchTokenizer.type.BINARYOP:for(let i=0;i<node.operands.length;i++){node.operands[i]=this._mergeUnaryOperators(node.operands[i],changed)}return node;case Classes.SearchTokenizer.type.UNARYOP:node.operand=this._mergeUnaryOperators(node.operand,changed);break;default:return node}if(node.operand.type==Classes.SearchTokenizer.type.TRUTH){if(node.value!="-"){this._setChanged(changed,"eliminated unary modifier '"+node.value+":' as it's followed by <"+node.operand.value.toUpperCase()+">");return node.operand}else{this._setChanged(changed,"applied unary '-' to <"+node.operand.value.toUpperCase()+">");return{type:Classes.SearchTokenizer.type.TRUTH,value:node.operand.value=="true"?"false":"true"}}}if(node.operand.type!=node.type){return node}if(node.value=="-"){if(node.operand.value!="-"){return this._promoteUnaryModifierOverUnaryBoolean(node,changed)}this._setChanged(changed,"eliminated a consecutive pair of '-'");return node.operand.operand}if(node.operand.value=="-"){return node}this._setChanged(changed,"eliminated a '"+node.value+":', since it was followed by a '"+node.operand.value+":'");return node.operand},_optimizeInner:function(node,changed){switch(node.type){case Classes.SearchTokenizer.type.BINARYOP:for(let i=0;i<node.operands.length;i++){node.operands[i]=this._optimizeInner(node.operands[i],changed)}node=this._promoteUnaryModifierOverBinaryOp(node,changed);if(node.type!=Classes.SearchTokenizer.type.BINARYOP){return node}node=this._mergeBinaryOperands(node,changed);if(node.type!=Classes.SearchTokenizer.type.BINARYOP){return node}if(node.value=="or"){return this._orOptimizer(node,changed)}return node;case Classes.SearchTokenizer.type.UNARYOP:node.operand=this._optimizeInner(node.operand,changed);return node;case Classes.SearchTokenizer.type.TEXT:case Classes.SearchTokenizer.type.QUOTEDTEXT:case Classes.SearchTokenizer.type.REGEX:case Classes.SearchTokenizer.type.TRUTH:default:return node}},_sortOptimized:function(node){function typeSort(a,b){if(a.type==b.type){return 0}let aType=a.type;let bType=b.type;if(aType==Classes.SearchTokenizer.type.QUOTEDTEXT){aType=Classes.SearchTokenizer.type.TEXT}if(bType==Classes.SearchTokenizer.type.QUOTEDTEXT){bType=Classes.SearchTokenizer.type.TEXT}return aType<bType?-1:1}function operandSort(a,b){let typeSorted=typeSort(a,b);if(typeSorted!=0){return typeSorted}if(a.value!=null&&b.value!=null){return a.value.localeCompare(b.value)}if(a.value!=null){return 1}if(b.value!=null){return-1}return 0}function sourcesSort(a,b){return a.value.localeCompare(b.value)}switch(node.type){case Classes.SearchTokenizer.type.BINARYOP:for(let i=0;i<node.operands.length;i++){this._sortOptimized(node.operands[i])}node.operands.sort(operandSort);break;case Classes.SearchTokenizer.type.UNARYOP:this._sortOptimized(node.operand);break;case Classes.SearchTokenizer.type.REGEX:node.sources.sort(sourcesSort);case Classes.SearchTokenizer.type.TEXT:case Classes.SearchTokenizer.type.QUOTEDTEXT:case Classes.SearchTokenizer.type.TRUTH:default:break}},optimize:function(rootNode){const logHead="SearchOptimizer::optimize(): ";let targetTree=this._parser.cloneTree(rootNode);let changed={changed:true,what:[]};this._iterationsCnt=0;while(changed.changed&&this._iterationsCnt++<this._maxIterationCnt){changed.changed=false;changed.iteration=this._iterationsCnt;targetTree=this._mergeBinaryOperators(targetTree,changed);targetTree=this._mergeUnaryOperators(targetTree,changed);targetTree=this._optimizeInner(targetTree,changed)}if(this._iterationsCnt>=this._maxIterationCnt){this._err(logHead+"interrupted optimization loop");this._iterationsCnt--}this._sortOptimized(targetTree);this._changeHistory=changed.what;return targetTree},getInfo:function(){return{iterationsCnt:this._iterationsCnt,changeHistory:this._changeHistory}}});Classes.SearchQuery=Classes.Base.subclass({_parserDebug:null,_tokenizer:null,_parser:null,_optimizer:null,_searchQuery:null,_parsedQuery:null,_unoptimizedParsedQuery:null,_unoptimizedParsedQueryStats:null,_optimizedParsedQueryStats:null,_optimizedTabsStats:null,_unoptimizedTabsStats:null,_init:function(value){const logHead="SearchQuery::_init(): ";Classes.Base._init.call(this);this.debug();this._parserDebug=emptyFn;this._tokenizer=Classes.SearchTokenizer.create();this._parser=Classes.SearchParser.create();this._optimizer=Classes.SearchOptimizer.create(this._parser);this.reset();if(value!=null){this.update(value)}},isInitialized:function(){return this._searchQuery.length!=0},_countParsedNodes:function(node,stats){const logHead="SearchQuery::_countParsedNodes(): ";stats.parsedNodes++;switch(node.type){case Classes.SearchTokenizer.type.BINARYOP:for(let i=0;i<node.operands.length;i++){this._countParsedNodes(node.operands[i],stats)}return;case Classes.SearchTokenizer.type.UNARYOP:this._countParsedNodes(node.operand,stats);return;case Classes.SearchTokenizer.type.TEXT:case Classes.SearchTokenizer.type.QUOTEDTEXT:case Classes.SearchTokenizer.type.REGEX:stats.parsedTextNodes++;return;case Classes.SearchTokenizer.type.TRUTH:return}this._err(logHead+'unknown operator type "'+node.type+'":',node)},_parse:function(queryString){const logHead='SearchQuery::_parse("'+queryString+'"): ';this._unoptimizedParsedQueryStats={parsedNodes:0,parsedTextNodes:0};this._optimizedParsedQueryStats={parsedNodes:0,parsedTextNodes:0};this._unoptimizedParsedQuery=null;this._parsedQuery=null;let tokenList=[];this._tokenizer.tokenize(queryString,tokenList);this._log(logHead+"tokenize() returned",tokenList);if(tokenList.length!=0){this._unoptimizedParsedQuery=this._parser.parse(tokenList);this._countParsedNodes(this._unoptimizedParsedQuery,this._unoptimizedParsedQueryStats);this._parsedQuery=this._optimizer.optimize(this._unoptimizedParsedQuery);this._countParsedNodes(this._parsedQuery,this._optimizedParsedQueryStats)}else{this._log(logHead+"no tokens, nothing to parse")}},_evaluateBinaryNode:function(tab,node,stats,modifier){let fullResult=node.value=="and";for(let i=0;i<node.operands.length;i++){let result=this._evaluate(tab,node.operands[i],stats,modifier);if(node.value=="and"){fullResult=fullResult&&result;if(fullResult===false){return fullResult}}else{fullResult=fullResult||result;if(fullResult===true){return fullResult}}}return fullResult},_evaluateRegexNode:function(tab,regex,modifier){const logHead="SearchQuery::_evaluateRegexNode(): ";if(modifier==null){if(regex.test(tab.tm.lowerCaseTitle)){return true}if(regex.test(tab.tm.lowerCaseUrl)){return true}for(let i=0;i<tab.tm.searchBadges.length;i++){if(regex.test(tab.tm.searchBadges[i])){return true}}return false}switch(modifier){case"site":return regex.test(tab.tm.hostname);case"intitle":return regex.test(tab.tm.lowerCaseTitle);case"inurl":return regex.test(tab.tm.lowerCaseUrl);case"badge":for(let i=0;i<tab.tm.searchBadges.length;i++){if(regex.test(tab.tm.searchBadges[i])){return true}}return false;case"group":for(let i=0;i<tab.tm.customGroupBadges.length;i++){if(regex.test(tab.tm.customGroupBadges[i])){return true}}return false;case"folder":return regex.test(tab.tm.lowerCaseFolder);default:this._err(logHead+"unknown modifier",modifier);break}return false},_evaluateTextNode:function(tab,text,modifier){const logHead='SearchQuery::_evaluateTextNode(text: "'+text+'"): ';if(text==""){return true}if(modifier==null){if(tab.tm.lowerCaseTitle.includes(text)){return true}if(tab.tm.lowerCaseUrl.includes(text)){return true}for(let i=0;i<tab.tm.searchBadges.length;i++){if(tab.tm.searchBadges[i].includes(text)){return true}}return false}switch(modifier){case"site":return tab.tm.hostname.includes(text);case"intitle":return tab.tm.lowerCaseTitle.includes(text);case"inurl":return tab.tm.lowerCaseUrl.includes(text);case"badge":for(let i=0;i<tab.tm.searchBadges.length;i++){if(tab.tm.searchBadges[i].includes(text)){return true}}return false;case"group":for(let i=0;i<tab.tm.customGroupBadges.length;i++){if(tab.tm.customGroupBadges[i].includes(text)){return true}}return false;case"folder":return tab.tm.lowerCaseFolder.includes(text);default:this._err(logHead+"unknown modifier",modifier);break}return false},_evaluate:function(tab,queryNode,stats,modifier){const logHead="SearchQuery::_evaluate(): ";stats.evaluated++;switch(queryNode.type){case Classes.SearchTokenizer.type.BINARYOP:return this._evaluateBinaryNode(tab,queryNode,stats,modifier);case Classes.SearchTokenizer.type.UNARYOP:if(queryNode.value=="-"){return!this._evaluate(tab,queryNode.operand,stats,modifier)}return this._evaluate(tab,queryNode.operand,stats,queryNode.value);case Classes.SearchTokenizer.type.TEXT:case Classes.SearchTokenizer.type.QUOTEDTEXT:stats.evaluatedText++;return this._evaluateTextNode(tab,queryNode.value,modifier);case Classes.SearchTokenizer.type.REGEX:if(queryNode.error==null){stats.evaluatedText++;return this._evaluateRegexNode(tab,queryNode.value,modifier)}return false;case Classes.SearchTokenizer.type.TRUTH:return queryNode.value=="true"}this._err(logHead+'unknown node type "'+queryNode.type+'":',queryNode);return false},isTabInSearch:function(tab,tabsStats=[]){const logHead="SearchQuery::isTabInSearch(): ";if(this._parsedQuery==null){return false}let stats={};tabsStats.push(stats);stats.searchStats={evaluated:0,evaluatedText:0};let optimizedResult=this._evaluate(tab,this._parsedQuery,stats.searchStats);if(!isProd()){stats.unoptimizedSearchStats={evaluated:0,evaluatedText:0};let unoptimizedResult=this._evaluate(tab,this._unoptimizedParsedQuery,stats.unoptimizedSearchStats);this._assert(optimizedResult===unoptimizedResult,logHead+"inconsistent results between unoptimized ("+unoptimizedResult+") and optimized ("+optimizedResult+") evaluation",tab)}return optimizedResult},search:function(inputTabs,statsSource,maxResults){const logHead='SearchQuery::search("'+this._searchQuery+'"): ';this._log(logHead+"inputTabs",inputTabs);function maxReached(results){if(maxResults==null){return false}return results.length>=maxResults}let tabsStats=[];let filteredTabs=[];let i=0;for(let i=0;i<inputTabs.length&&!maxReached(filteredTabs);i++){let tab=inputTabs[i];if(this.isTabInSearch(tab,tabsStats)){filteredTabs.push(tab)}}let interrupted=false;if(maxReached(filteredTabs)&&i<inputTabs.length){this._log(logHead+"max ("+maxResults+") reached, interrupting search for "+statsSource);interrupted=true}this._aggregateStats(tabsStats,statsSource,maxResults,interrupted);return filteredTabs},_aggregateStats:function(tabsStats,statsSource,maxResults,maxReached){const logHead=" SearchQuery::_aggregateStats(): ";let optimizedStats={source:statsSource,totalEvaluated:0,totalEvaluatedText:0,totalTabsEvaluated:maxReached?maxResults:tabsStats.length,maxResults:maxResults,maxReached:maxReached};let unoptimizedStats=null;if(!isProd()){unoptimizedStats={source:statsSource,totalEvaluated:0,totalEvaluatedText:0,totalTabsEvaluated:maxReached?maxResults:tabsStats.length,maxResults:maxResults,maxReached:maxReached}}for(let i=0;i<tabsStats.length;i++){optimizedStats.totalEvaluated+=tabsStats[i].searchStats.evaluated;optimizedStats.totalEvaluatedText+=tabsStats[i].searchStats.evaluatedText;if(!isProd()){unoptimizedStats.totalEvaluated+=tabsStats[i].unoptimizedSearchStats.evaluated;unoptimizedStats.totalEvaluatedText+=tabsStats[i].unoptimizedSearchStats.evaluatedText}}this._optimizedTabsStats[statsSource]=optimizedStats;this._log(logHead,this.getStats(statsSource,this._optimizedParsedQueryStats,this._optimizedTabsStats));if(!isProd()){this._unoptimizedTabsStats[statsSource]=unoptimizedStats;this._log(logHead,this.getStats(statsSource,this._unoptimizedParsedQueryStats,this._unoptimizedTabsStats))}},update:function(value){const logHead='SearchQuery::update("'+value+'"): ';if(value.length==0){return}this._searchQuery=value;this._parse(value);this._log(logHead+"_parse() returned",this._parsedQuery);if(this._unoptimizedParsedQuery!=null){this._simplifiedSearchQuery=this._parser.rebuildQueryString(this._unoptimizedParsedQuery,null,Classes.SearchParser.rebuildMode.SIMPLE)}else{this._simplifiedSearchQuery=""}},reset:function(){this._searchQuery="";this._simplifiedSearchQuery="";this._unoptimizedParsedQuery=null;this._parsedQuery=null;this._unoptimizedParsedQueryStats=null;this._optimizedParsedQueryStats=null;this._optimizedTabsStats={};this._unoptimizedTabsStats={}},getStats:function(source,queryStats,tabsStats){queryStats=optionalWithDefault(queryStats,this._optimizedParsedQueryStats);tabsStats=optionalWithDefault(tabsStats,this._optimizedTabsStats);let retVal="";let keys=Object.keys(tabsStats);let i=0;let max=keys.length;try{if(source!=null){i=keys.indexOf(source);if(i==-1){return`Source "${source}" not found`}max=i+1}for(;i<max;i++){s=tabsStats[keys[i]];retVal+=`For source "${s.source}":\n`+`\tTotal nodes evaluated: ${s.totalEvaluated}, for ${s.totalTabsEvaluated} `+`tabs (average of ${(s.totalEvaluated/s.totalTabsEvaluated).toFixed(1)} nodes per tab `+`(of ${queryStats.parsedNodes}))\n`+`\tTotal text nodes evaluated: ${s.totalEvaluatedText}, for ${s.totalTabsEvaluated} `+`tabs (average of ${(s.totalEvaluatedText/s.totalTabsEvaluated).toFixed(1)} nodes per tab `+`(of ${queryStats.parsedTextNodes}))\n`;if(s.maxResults!=null){retVal+=`\tResults limited to a max of ${s.maxResults} (limit ${s.maxReached?"":"not "}reached)\n`}}return retVal}catch(e){return e}},getOptimizedStats:function(){return this.getStats()},getUnoptimizedStats:function(){if(isProd()){return""}return this.getStats(null,this._unoptimizedParsedQueryStats,this._unoptimizedTabsStats)},getQuery:function(){return this._searchQuery},getSimplifiedQuery:function(){return this._simplifiedSearchQuery},getUnoptimizedParsedQuery:function(rebuildMode){if(this._unoptimizedParsedQuery==null){return""}return this._parser.rebuildQueryString(this._unoptimizedParsedQuery,null,rebuildMode)},getParsedQuery:function(rebuildMode){if(this._parsedQuery==null){return""}this._log(this._parsedQuery,this._optimizer.getInfo());return this._parser.rebuildQueryString(this._parsedQuery,null,rebuildMode)},getOptimizerInfo:function(){let optInfo=this._optimizer.getInfo();optInfo.unoptimizedStats=this._unoptimizedParsedQueryStats;optInfo.optimizedStats=this._optimizedParsedQueryStats;return optInfo},getErrors:function(){errors=this._tokenizer.getErrors();if(errors==null||errors.length==0){return null}let retVal=[];for(let i=0;i<errors.length;i++){retVal.push(tmUtils.splitCamelCase(errors[i].name)+": "+tmUtils.toLowerCaseInitial(errors[i].message))}return retVal}});Classes.BookmarksManager=Classes.Base.subclass({_bookmarksManagerActive:null,_bookmarksImportInProgress:null,_bookmarksLoadingPromise:null,_eventManager:null,_maxBookmarkNodesInSearch:500,_maxBookmarkNodesTracked:5e3,_bookmarksDict:null,_bookmarks:null,_folders:null,_pinnedBookmarks:null,_pinnedBookmarkIds:null,_loadBookmarksJob:null,_loadBookmarksDelay:500,_applyOptionsChangeJob:null,_applyOptionsChangeDelay:1e3,_stats:null,_init:function(){Classes.Base._init.call(this);this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);this.resetStats();this._loadBookmarksJob=Classes.ScheduledJob.create(this._loadBookmarks.bind(this),"BookmarksManager.loadBookmarks");this._loadBookmarksJob.debug();this._applyOptionsChangeJob=Classes.ScheduledJob.create(this._applyOptionsChange.bind(this),"BookmarksManager.applyOptionsChange");this._applyOptionsChangeJob.debug();settingsStore.getAllOptions().addEventListener(Classes.EventManager.Events.UPDATED,this._optionsUpdatedCb.bind(this));settingsStore.getPinnedBookmarks().addEventListener(Classes.EventManager.Events.UPDATED,this._delayableEventCb.bind(this,this._applyPinnedUpdateCb.bind(this),false));if(settingsStore.getOptionBookmarksInSearch()){this._initBookmarks(false).then(this._initChromeListeners.bind(this))}else{this._bookmarksManagerActive=false;this._initChromeListeners()}},_initBookmarks:function(sendEvent){this._bookmarksManagerActive=true;return this._loadBookmarks(sendEvent).then(function(){try{perfProf.measure("chrome.bookmarks.getTree()","bookmarksLoadStart","bookmarksLoadEnd")}catch(e){}try{perfProf.measure("Bookmarks treeToList","bookmarksTreeToListStart","bookmarksTreeToListEnd")}catch(e){}try{perfProf.measure("Setting up bookmarks","bookmarksSetupStart","bookmarksSetupEnd")}catch(e){}}.bind(this))},_compareDateAdded:function(a,b){if(a.dateAdded>b.dateAdded){return-1}if(a.dateAdded<b.dateAdded){return 1}return 0},_compareFolderThenDateAdded:function(a,b){if(a.url==null&&b.url!=null){return-1}if(b.url==null&&a.url!=null){return 1}return this._compareDateAdded(a,b)},_removePinnedBookmark:function(bmNodeToRemove){const logHead="BookmarksManager._removePinnedBookmark("+bmNodeToRemove.bookmarkId+"):";let idx=this._pinnedBookmarks.findIndex(node=>node.id===bmNodeToRemove.id);if(idx==-1){this._err(logHead,"node should exist, but not found",bmNodeToRemove);return}this._log(logHead,"removing node",bmNodeToRemove);this._pinnedBookmarks.splice(idx,1)},_appendOrReplaceNode:function(nodeToAdd,replace,targetList,debugName){const logHead="BookmarksManager._appendOrReplaceNode("+nodeToAdd.id+"):";if(!replace){targetList.push(nodeToAdd);return}let idx=targetList.findIndex(node=>node.id===nodeToAdd.id);if(idx==-1){this._err(logHead,"node should exist, but not found",debugName,nodeToAdd);targetList.push(nodeToAdd)}else{this._log(logHead,"replacing existing",debugName,nodeToAdd);targetList[idx]=nodeToAdd}},_loadBookmarkTreeNode:function(node){const logHead="BookmarksManager._loadBookmarkTreeNode():";let bmAlreadyTracked=false;if(this._bookmarksDict[node.id]!=null){bmAlreadyTracked=true;this._assert(!bmAlreadyTracked,logHead,"unexpected, bookmark/folder node already tracked",node)}this._bookmarksDict[node.id]=node;if(node.url==null){this._appendOrReplaceNode(node,bmAlreadyTracked,this._folders,"folder");return}node.pinned=settingsStore.isBookmarkPinned(node.id);if(!bmAlreadyTracked&&node.pinned){this._pinnedBookmarkIds.push(node.id)}tabNormalizer.normalize(node,{type:Classes.TabNormalizer.type.BOOKMARK});this._appendOrReplaceNode(node,bmAlreadyTracked,this._bookmarks,"bookmark");if(node.pinned){this._appendOrReplaceNode(node,bmAlreadyTracked,this._pinnedBookmarks,"pinnedBookmark")}},_resetShadowCopy:function(){this._bookmarksDict={};this._bookmarks=[];this._folders=[];this._pinnedBookmarks=[];this._pinnedBookmarkIds=[];this._stats.folders=0;this._stats.bookmarks=0;this._stats.pinnedBookmarks=0;this._stats.bookmarksOverCap=0},resetStats:function(){this._stats={load:0,find:0,folders:0,bookmarks:0,pinnedBookmarks:0,bookmarksOverCap:0,asyncPathQueries:0,syncPathQueries:0,onCreated:0,onCreatedIgnored:0,onChanged:0,onChangedUntracked:0,onRemoved:0,onMoved:0,onMovedUntracked:0,onImportBegan:0,onImportEnded:0}},_loadBookmarkTreeNodeList:function(nodes){const logHead="BookmarksManager._loadBookmarkTreeNodeList():";this._log(logHead,"received: ",nodes);this._resetShadowCopy();perfProf.mark("bookmarksSetupStart");for(let i=0;i<nodes.length&&i<this._maxBookmarkNodesTracked;i++){this._loadBookmarkTreeNode(nodes[i])}if(nodes.length>this._maxBookmarkNodesTracked){this._stats.bookmarksOverCap=nodes.length-this._maxBookmarkNodesTracked}perfProf.mark("bookmarksSetupEnd")},OLD_loadBookmarks:function(sendEvent){sendEvent=optionalWithDefault(sendEvent,true);const logHead="BookmarksManager._loadBookmarks("+sendEvent+"):";perfProf.mark("bookmarksLoadStart");this._log(logHead,"loading bookmarks");this._stats.load++;this._bookmarksLoadingPromise=chromeUtils.wrap(chrome.bookmarks.getRecent,logHead,this._maxBookmarkNodesTracked).then(function(nodes){perfProf.mark("bookmarksLoadEnd");try{this._loadBookmarkTreeNodeList(nodes)}catch(e){this._err(logHead,e)}this._bookmarksLoadingPromise=null;if(sendEvent){this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{})}}.bind(this),function(e){this._err(logHead,"rejected",e);this._bookmarksLoadingPromise=null}.bind(this));return this._bookmarksLoadingPromise},_treeToList:function(rootNode){let rootNodeId="none";let children=null;if(Array.isArray(rootNode)){children=rootNode}else{rootNodeId=rootNode.id;children=rootNode.children}if(children==null||children.length==0){return[]}let subNodes=Array(children.length);for(let i=0;i<children.length;i++){subNodes[i]=this._treeToList(children[i])}return children.concat.apply(children,subNodes)},_loadBookmarks:function(sendEvent){sendEvent=optionalWithDefault(sendEvent,true);const logHead="BookmarksManager._loadBookmarks("+sendEvent+"):";perfProf.mark("bookmarksLoadStart");this._log(logHead,"loading bookmarks");this._stats.load++;this._bookmarksLoadingPromise=chromeUtils.wrap(chrome.bookmarks.getTree,logHead).then(function(rootNodes){perfProf.mark("bookmarksLoadEnd");this._log(logHead,"chrome.bookmarks.getTree() returned",rootNodes);try{perfProf.mark("bookmarksTreeToListStart");let nodes=this._treeToList(rootNodes);nodes.sort(this._compareFolderThenDateAdded.bind(this));perfProf.mark("bookmarksTreeToListEnd");this._loadBookmarkTreeNodeList(nodes)}catch(e){this._err(logHead,e)}this._bookmarksLoadingPromise=null;if(sendEvent){this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{})}}.bind(this),function(e){this._err(logHead,"rejected",e);this._bookmarksLoadingPromise=null}.bind(this));return this._bookmarksLoadingPromise},_initChromeListeners:function(){chrome.bookmarks.onCreated.addListener(this._bookmarkCreatedCb.bind(this));chrome.bookmarks.onChanged.addListener(this._delayableEventCb.bind(this,this._applyBookmarkChangeCb.bind(this),false));chrome.bookmarks.onRemoved.addListener(this._delayableEventCb.bind(this,this._applyBookmarkRemoveCb.bind(this),false));chrome.bookmarks.onMoved.addListener(this._delayableEventCb.bind(this,this._applyBookmarkMoveCb.bind(this),false));chrome.bookmarks.onImportBegan.addListener(this._bookmarkImportBeganCb.bind(this));chrome.bookmarks.onImportEnded.addListener(this._bookmarkImportEndedCb.bind(this))},_bookmarkCreatedCb:function(id,bmNode){const logHead="BookmarksManager._bookmarkCreatedCb("+id+"):";if(!this.isActive()){this._log(logHead,"ignoring event while bookmarksManager is not active");return}this._stats.onCreated++;if(this._bookmarksImportInProgress){this._stats.onCreatedIgnored++;return}this._delayableEventCb(this._applyBookmarkCreateCb.bind(this),false,id,bmNode)},_delayableEventCb:function(eventCb,runAlways,...args){const logHead="BookmarksManager._delayableEventCb("+args[0]+"):";if(!this.isActive()&&!runAlways){this._log(logHead,"ignoring event while bookmarksManager is not active");return}if(this._bookmarksLoadingPromise!=null){this._log(logHead,"loading in progress, delaying event processing",args[1]);this._bookmarksLoadingPromise.then(function(){eventCb.apply(this,args)}.bind(this))}else{eventCb.apply(this,args)}},_applyBookmarkCreateCb:function(id,bmNode){const logHead="BookmarksManager._applyBookmarkCreateCb("+id+"):";this._log(logHead,"processing",bmNode);this._loadBookmarksJob.run(this._loadBookmarksDelay)},_applyBookmarkChangeCb:function(id,changeInfo){const logHead="BookmarksManager._applyBookmarkChangeCb("+id+"):";let bm=this._bookmarksDict[id];if(bm==null){this._log(logHead,"not tracked, ignoring",changeInfo);this._stats.onChangedUntracked++;return}this._log(logHead,"processing",changeInfo);this._stats.onChanged++;bm.title=changeInfo.title;bm.url=changeInfo.url;tabNormalizer.updateUrl(bm);tabNormalizer.updateTitle(bm);this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{id:tabNormalizer.normalizeBookmarkId(id)})},_applyBookmarkRemoveCb:function(id,removeInfo){const logHead="BookmarksManager._applyBookmarkRemoveCb("+id+"):";this._stats.onRemoved++;this._log(logHead,"processing",removeInfo);if(settingsStore.isBookmarkPinned(id)){settingsStore.unpinBookmark(id)}this._loadBookmarksJob.run(this._loadBookmarksDelay)},_applyBookmarkMoveCb:function(id,moveInfo){const logHead="BookmarksManager._applyBookmarkMoveCb("+id+"):";let bm=this._bookmarksDict[id];if(bm!=null){this._log(logHead,"not tracked, ignoring",moveInfo);this._stats.onMovedUntracked++;return}this._log(logHead,"processing",moveInfo);this._stats.onMoved++;this._assert(bm.parentId==moveInfo.oldParentId);bm.parentId=moveInfo.parentId;tabNormalizer.updateBookmarkFolder(bm);bm.index=moveInfo.index;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{id:tabNormalizer.normalizeBookmarkId(id)})},_bookmarkImportBeganCb:function(){const logHead="BookmarksManager._bookmarkImportBeganCb():";this._log(logHead,"import started");this._bookmarksImportInProgress=true;this._stats.onImportBegan++},_bookmarkImportEndedCb:function(){const logHead="BookmarksManager_bookmarkImportBeganCb():";this._log(logHead,"import ended");this._bookmarksImportInProgress=false;this._stats.onImportEnded++;if(!this.isActive()){this._log(logHead,"ignoring event while bookmarksManager is not active");return}this._loadBookmarksJob.run(this._loadBookmarksDelay)},_optionsUpdatedCb:function(ev){this._applyOptionsChangeJob.run(this._applyOptionsChangeDelay)},_applyOptionsChange:function(){this._delayableEventCb(this._applyOptionsUpdateCb.bind(this),true,"applyOptionsChange")},_applyOptionsUpdateCb:function(){const logHead="BookmarksManager._applyOptionsUpdateCb():";let bookmarksInSearch=settingsStore.getOptionBookmarksInSearch();if(this.isActive()&&!bookmarksInSearch){this._log(logHead,'property "bookmarksInSearch" set to "false", stopping bookmarksManager');this._bookmarksManagerActive=false;this._resetShadowCopy();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{});return}if(!this.isActive()&&bookmarksInSearch){this._log(logHead,'property "bookmarksInSearch" set to "true", starting bookmarksManager');this._initBookmarks();return}this._log(logHead,'property "bookmarksInSearch" unchanged, nothing to do')},_applyPinnedUpdateCb:function(){const logHead="BookmarksManager._applyPinnedUpdateCb():";let pinnedBmIdList=settingsStore.getPinnedBookmarks().getAll();let found=[];for(let i=0;i<pinnedBmIdList.length;i++){let bm=this._bookmarksDict[pinnedBmIdList[i]];if(bm==null){this._log(logHead,"discarding pinned bookmark ID",pinnedBmIdList[i]);settingsStore.unpinBookmark(pinnedBmIdList[i])}else{found.push(pinnedBmIdList[i]);if(!bm.pinned){bm.pinned=true;this._pinnedBookmarks.push(bm);this._log(logHead,"pinning bookmark ID",pinnedBmIdList[i],bm)}}}let[added,deleted,changed]=tmUtils.arrayDiff(this._pinnedBookmarkIds,found);for(let i=0;i<deleted.length;i++){let bm=this._bookmarksDict[deleted[i]];if(bm==null){this._err(logHead,"unexpected, bookmark ID",deleted[i],"not found")}else{if(bm.pinned){bm.pinned=false;this._removePinnedBookmark(bm);this._log(logHead,"unpinning bookmark ID",deleted[i],bm)}else{this._err(logHead,"unexpected, bookmark ID",deleted[i],"already unpinned",bm);this._removePinnedBookmark(bm)}}}this._pinnedBookmarkIds=found;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{pinned:{added:added,deleted:deleted}})},find:function(searchQuery){perfProf.mark("bookmarksSearchStart");const logHead="BookmarksManager.find():";this._stats.find++;let searchResults=[];if(!settingsStore.getOptionBookmarksInSearch()){this._log(logHead,"bookmarks are disabled in search, nothing to do")}else{this._log(logHead,"processing bookmarks");searchResults=searchQuery.search(this._bookmarks,logHead,this._maxBookmarkNodesInSearch)}perfProf.mark("bookmarksSearchEnd");return Promise.resolve(searchResults)},getBmNode:function(bmNodeId){let bmNode=this._bookmarksDict[bmNodeId];if(bmNode!=null){return bmNode}return null},getBmPathListAsync:async function(bmNode){const logHead="BookmarksManager.getBmPathListAsync("+bmNode.id+"):";this._stats.asyncPathQueries++;let pathList=[];while(bmNode!=null&&bmNode.parentId!=null){let parentNode=this.getBmNode(bmNode.parentId);if(parentNode==null){let result=await chromeUtils.wrap(chrome.bookmarks.get,logHead,bmNode.parentId);if(result.length>0){parentNode=result[0];if(this.getBmNode(parentNode.id)==null){this._loadBookmarkTreeNode(parentNode)}}}bmNode=parentNode;if(bmNode!=null){pathList.push(bmNode.title!=null?bmNode.title:"")}else{this._err(logHead,"unexpected, it should not get here")}}pathList.reverse();return pathList},getBmPathListSync:function(bmNode){const logHead="BookmarksManager.getBmPathListSync("+bmNode.id+"):";this._stats.syncPathQueries++;let pathList=[];while(bmNode!=null&&bmNode.parentId!=null){bmNode=this.getBmNode(bmNode.parentId);if(bmNode==null){return null}pathList.push(bmNode.title!=null?bmNode.title:"")}pathList.reverse();return pathList},getBmFolderSync:function(bmNode){let pathList=bookmarksManager.getBmPathListSync(bmNode);if(pathList==null){return null}return pathList.join("/")},getBmFolderAsync:async function(bmNode){let pathList=await bookmarksManager.getBmPathListAsync(bmNode);return pathList.join("/")},getPinnedBookmarks:function(filterOutIds){if(!this.isActive()){return[]}if(filterOutIds==null){return this._pinnedBookmarks}let retVal=[];for(let i=0;i<this._pinnedBookmarks.length;i++){let bmNode=this._pinnedBookmarks[i];if(!filterOutIds.includes(bmNode.bookmarkId)){retVal.push(bmNode)}}return retVal},getStats:function(){this._stats.folders=this._folders.length;this._stats.bookmarks=this._bookmarks.length;this._stats.pinnedBookmarks=this._pinnedBookmarks.length;return this._stats},isActive:function(){return this._bookmarksManagerActive}});Classes.HistoryFinder=Classes.Base.subclass({_eventManager:null,_maxHistoryItems:500,_hasHistoryPermission:null,_chromeElw:null,_historyElw:null,_init:function(){const logHead="HistoryFinder::_init(): ";Classes.Base._init.call(this);this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);this._chromeElw=Classes.EventListenersWrapper.create("addListener","removeListener");this._historyElw=Classes.EventListenersWrapper.create("addListener","removeListener");this._chromeElw.listen(chrome.permissions.onAdded,this._permissionAddedCb.bind(this));this._chromeElw.listen(chrome.permissions.onRemoved,this._permissionRemovedCb.bind(this));this._chromeElw.listen(chrome.sessions.onChanged,this._recentlyClosedChangedCb.bind(this));chromeUtils.wrap(chrome.permissions.contains,logHead,{permissions:["history"]}).then(function(hasPermission){if(hasPermission){this._hasHistoryPermission=true;this._addHistoryEventsListeners()}else{this._hasHistoryPermission=false;this._log(logHead+"permission not set, starting without event listeners")}}.bind(this))},_addHistoryEventsListeners:function(){const logHead="HistoryFinder::_addHistoryEventsListeners(): ";this._log(logHead+"initializing history event listeners");this._historyElw.listen(chrome.history.onVisitRemoved,this._visitRemovedCb.bind(this));this._historyElw.listen(chrome.history.onVisited,this._visitedCb.bind(this))},_removeHistoryEventsListeners:function(){const logHead="HistoryFinder::_removeHistoryEventsListeners(): ";this._log(logHead+"removing history event listeners");this._historyElw.clear()},_permissionAddedCb:function(permissions){const logHead="HistoryFinder::_permissionAddedCb(): ";if(permissions.permissions.includes("history")){this._log(logHead+'granted "history" permission',permissions);this._hasHistoryPermission=true;this._addHistoryEventsListeners()}else{this._log(logHead+'no "history" in permissions, ignoring',permissions)}},_permissionRemovedCb:function(permissions){const logHead="HistoryFinder::_permissionRemovedCb(): ";if(permissions.permissions.includes("history")){this._hasHistoryPermission=false;this._log(logHead+'revoked "history" permission',permissions);this._removeHistoryEventsListeners()}else{this._log(logHead+'no "history" in permissions, ignoring',permissions)}},_visitRemovedCb:function(removed){let extraDetail={event:Classes.HistoryFinder.event.REMOVED,data:removed};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,extraDetail)},_visitedCb:function(historyItem){let extraDetail={event:Classes.HistoryFinder.event.VISITED,data:historyItem};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,extraDetail)},_recentlyClosedChangedCb:function(){let extraDetail={event:Classes.HistoryFinder.event.RCTAB};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,extraDetail)},_processHistoryItems:function(items){perfProf.mark("historySearchEnd");const logHead="HistoryFinder::_processHistoryItems(): ";this._log(logHead+"received: ",items);perfProf.mark("historyReduceStart");let popupUrl=popupDocker.getPopupUrl(true);let retVal=items.reduce(function(result,tab){if(tab.url!=popupUrl){tabNormalizer.normalize(tab,{type:Classes.TabNormalizer.type.HISTORY});result.push(tab)}return result}.bind(this),[]);perfProf.mark("historyReduceEnd");return retVal},find:function(searchQuery){const logHead='HistoryFinder::find("'+searchQuery.getSimplifiedQuery()+'"): ';if(!settingsStore.getOptionHistoryInSearch()){this._log(logHead+"history is disabled in search, nothing to do");return Promise.resolve([])}this._log(logHead+"processing history");perfProf.mark("historySearchStart");let query={maxResults:this._maxHistoryItems,startTime:0,text:searchQuery.getSimplifiedQuery()};return chromeUtils.wrap(chrome.history.search,logHead,query).then(this._processHistoryItems.bind(this))},_processRecentlyClosedTabs:function(sessions){const logHead="HistoryFinder::_processRecentlyClosedTabs(): ";let tabs=[];let popupUrl=popupDocker.getPopupUrl(true);for(let i=0;i<sessions.length;i++){let session=sessions[i];if(session.tab==null){let window=session.window;for(let j=0;window.tabs!=null&&j<window.tabs.length;j++){let tab=window.tabs[j];if(tab.url!=popupUrl&&tab.index!=-1){if(tab.active){this._log(logHead+"recently closed tabs should not be active",tab)}tabNormalizer.normalize(tab,{type:Classes.TabNormalizer.type.RCTAB});tab.tm.windowSessionId=window.sessionId;tabs.push(tab)}}}else{let tab=session.tab;if(tab.url!=popupUrl){this._assert(!tab.active,logHead+"recently closed tabs can't be active",tab);tabNormalizer.normalize(tab,{type:Classes.TabNormalizer.type.RCTAB});tabs.push(tab)}}}return tabs},_getRecentlyClosedTabs:function(){const logHead="HistoryFinder::_getRecentlyClosedTabs(): ";if(!settingsStore.getOptionRecentlyClosedInSearch()){this._log(logHead+"recently closed tabs are disabled in search, nothing to do");return Promise.resolve([])}return chromeUtils.wrap(chrome.sessions.getRecentlyClosed,logHead,null).then(function(session){this._log(logHead+"sessions.getRecentlyClosed() returned: ",session);return this._processRecentlyClosedTabs(session)}.bind(this))}});Classes.Base.roDef(Classes.HistoryFinder,"event",{});Classes.Base.roDef(Classes.HistoryFinder.event,"REMOVED","removed");Classes.Base.roDef(Classes.HistoryFinder.event,"VISITED","visited");Classes.Base.roDef(Classes.HistoryFinder.event,"RCTAB","rctab");Classes.PopupDocker=Classes.PopupDockerBase.subclass({_dockedInitBodyWidth:400,_dockedInitBodyHeight:542,_ownTabId:null,_ownWindowId:null,_savePopupSizeJob:null,_savePopupSizeDelay:1e3,_elw:null,_init:function(){const logHead="PopupDocker::_init(): ";Classes.PopupDockerBase._init.call(this);this.debug();this._elw=Classes.EventListenersWrapper.create();this._savePopupSizeJob=Classes.ScheduledJob.createAs(this._id+".savePopupSize",this._savePopupSize.bind(this));this._savePopupSizeJob.debug();window.addEventListener("load",this._loadCb.bind(this));localStore.addEventListener(Classes.EventManager.Events.UPDATED,this._updatedCb.bind(this));this._addBackgroundCommandsListener();window.addEventListener("unload",this._onUnloadCb.bind(this));if(!this.isPopupDocked()){chromeUtils.queryTabs({currentWindow:true},logHead).then(function(tabs){this._assert(tabs.length==1);this._log(logHead+"chromeUtils.queryTabs() returned:",tabs);this._ownTabId=tabs[0].id;this._ownWindowId=tabs[0].windowId;chrome.tabs.onCreated.addListener(this._popupDefenderCb.bind(this));window.addEventListener("resize",this._onResizeCb.bind(this))}.bind(this))}},_addBackgroundCommandsListener:function(){const logHead="PopupDocker::_addBackgroundCommandListener(): ";let backgroundPage=chrome.extension.getBackgroundPage();if(backgroundPage==null){this._err(logHead+"unable to load DOM from background page");return}let popupDockerBgElem=backgroundPage.document.getElementById("popupDockerBg");if(popupDockerBgElem==null){this._err(logHead+'unable to get element with ID "popupDockerBg"');return}this._elw.listen(popupDockerBgElem,Classes.EventManager.Events.UPDATED,this._backgroundCommandCb.bind(this))},_loadCb:function(ev){if(this.isPopupDocked()){document.body.style.width=this._dockedInitBodyWidth+"px";document.body.style.height=this._dockedInitBodyHeight+"px"}},_updatedCb:function(ev){const logHead="PopupDocker::_updatedCb("+ev.detail.key+"): ";if(localStore.isPopupDocked()&&!this.isPopupDocked()){this._log(logHead+"the popup is now configured docked, need to close myself");this._log.bg(logHead+"the popup is now configured docked, need to close myself");window.close();return}if(!localStore.isPopupDocked()&&this.isPopupDocked()){this._log(logHead+"the popup is now configured undocked, need to close myself");this._log.bg(logHead+"the popup is now configured undocked, need to close myself");window.close();return}this._log(logHead+"docking state unchanged")},_backgroundCommandCb:function(ev){const logHead="PopupDocker::_backgroundCommandCb("+ev.detail.cmd+"): ";if(ev.detail.cmd!=Classes.PopupDockerBase.cmd.SEARCH){this._log(logHead+"ignoring command");return}this._log(logHead+"starting search",ev.detail);this.focus();let allTabsBsTabViewer=popupViewer.getHomeBsTab();allTabsBsTabViewer.activate();allTabsBsTabViewer.setSearchQuery(ev.detail.data)},_popupDefenderCb:function(tab){const logHead="PopupDocker::_popupDefenderCb(): ";if(tab.windowId!=this._ownWindowId){return}this._err(logHead+"need to relocate invader",tab);chromeUtils.moveTabToLeastTabbedWindow(tab)},_onResizeCb:function(ev){this._savePopupSizeJob.run(this._savePopupSizeDelay)},_onUnloadCb:function(ev){const logHead="PopupDocker::_onUnloadCb():";this._log(logHead,"entering");if(!this.isPopupDocked()){this._savePopupSize()}this._elw.discard();this._elw=null;this._log(logHead,"completed")},_savePopupSize:function(){const logHead="PopupDocker::_savePopupSize(): ";this._log(logHead+"saving window size: ",window.screenLeft,window.screenTop,window.outerWidth,window.outerHeight);localStore.setPopupSize(window.screenLeft,window.screenTop,window.outerWidth,window.outerHeight)},isPopupDocked:function(){if(window.location.search==""){return true}return false},undock:function(){const logHead="PopupDocker::undock(): ";if(!this.isPopupDocked()){this._log(logHead+"already undocked");this._log.bg(logHead+"already undocked");return}this._setDocked(false);this._openUndocked();window.close()},dock:function(){const logHead="PopupDocker::dock(): ";if(this.isPopupDocked()){this._log(logHead+"already docked");this._log.bg(logHead+"already docked");return}this._setDocked(true);window.close()},dockToggle:function(){if(this.isPopupDocked()){this.undock();return}this.dock()},getOwnTabId:function(){if(this.isPopupDocked()){return-1}if(this._ownTabId==null){const logHead="PopupDocker::getOwnTabId(): ";this._err(logHead+"still waiting for initialization");return-2}return this._ownTabId},focus:function(){let tabId=this.getOwnTabId();if(tabId>=0){chromeUtils.focusWindowByTabId(tabId)}}});Classes.Base.roDef(window,"popupDocker",Classes.PopupDocker.createAs("popupDocker"));Classes.PopupMsgServer=Classes.MsgServer.subclass({_init:function(){Classes.MsgServer._init.apply(this,arguments)}});icons={searchBox:`
	<svg class="tm-fa-magnifier-align" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
`,thumbtack:function(...args){let classes=optArrayWithDefault(args,["tm-fa-thumbtack-tile"]);return`
	<svg class="${classes.join(" ")}" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M298.028 214.267L285.793 96H328c13.255 0 24-10.745 24-24V24c0-13.255-10.745-24-24-24H56C42.745 0 32 10.745 32 24v48c0 13.255 10.745 24 24 24h42.207L85.972 214.267C37.465 236.82 0 277.261 0 328c0 13.255 10.745 24 24 24h136v104.007c0 1.242.289 2.467.845 3.578l24 48c2.941 5.882 11.364 5.893 14.311 0l24-48a8.008 8.008 0 0 0 .845-3.578V352h136c13.255 0 24-10.745 24-24-.001-51.183-37.983-91.42-85.973-113.733z"></path></svg>
	`},volumeMuted:function(...args){return`
	<svg class="tm-fa-volume-align ${args.join(" ")}" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M215.03 71.05L126.06 160H24c-13.26 0-24 10.74-24 24v144c0 13.25 10.74 24 24 24h102.06l88.97 88.95c15.03 15.03 40.97 4.47 40.97-16.97V88.02c0-21.46-25.96-31.98-40.97-16.97zM461.64 256l45.64-45.64c6.3-6.3 6.3-16.52 0-22.82l-22.82-22.82c-6.3-6.3-16.52-6.3-22.82 0L416 210.36l-45.64-45.64c-6.3-6.3-16.52-6.3-22.82 0l-22.82 22.82c-6.3 6.3-6.3 16.52 0 22.82L370.36 256l-45.63 45.63c-6.3 6.3-6.3 16.52 0 22.82l22.82 22.82c6.3 6.3 16.52 6.3 22.82 0L416 301.64l45.64 45.64c6.3 6.3 16.52 6.3 22.82 0l22.82-22.82c6.3-6.3 6.3-16.52 0-22.82L461.64 256z"></path></svg>
	`},volumeAudible:`
	<svg class="tm-fa-volume-align" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M215.03 71.05L126.06 160H24c-13.26 0-24 10.74-24 24v144c0 13.25 10.74 24 24 24h102.06l88.97 88.95c15.03 15.03 40.97 4.47 40.97-16.97V88.02c0-21.46-25.96-31.98-40.97-16.97zm233.32-51.08c-11.17-7.33-26.18-4.24-33.51 6.95-7.34 11.17-4.22 26.18 6.95 33.51 66.27 43.49 105.82 116.6 105.82 195.58 0 78.98-39.55 152.09-105.82 195.58-11.17 7.32-14.29 22.34-6.95 33.5 7.04 10.71 21.93 14.56 33.51 6.95C528.27 439.58 576 351.33 576 256S528.27 72.43 448.35 19.97zM480 256c0-63.53-32.06-121.94-85.77-156.24-11.19-7.14-26.03-3.82-33.12 7.46s-3.78 26.21 7.41 33.36C408.27 165.97 432 209.11 432 256s-23.73 90.03-63.48 115.42c-11.19 7.14-14.5 22.07-7.41 33.36 6.51 10.36 21.12 15.14 33.12 7.46C447.94 377.94 480 319.54 480 256zm-141.77-76.87c-11.58-6.33-26.19-2.16-32.61 9.45-6.39 11.61-2.16 26.2 9.45 32.61C327.98 228.28 336 241.63 336 256c0 14.38-8.02 27.72-20.92 34.81-11.61 6.41-15.84 21-9.45 32.61 6.43 11.66 21.05 15.8 32.61 9.45 28.23-15.55 45.77-45 45.77-76.88s-17.54-61.32-45.78-76.86z"></path></svg>
`,bookmark:`
	<svg class="tm-fa-bookmark" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M0 512V48C0 21.49 21.49 0 48 0h288c26.51 0 48 21.49 48 48v464L192 400 0 512z"></path></svg>
`,history:function(...args){return`
	<svg class="${args.join(" ")}" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 18"><path fill="currentColor" d="M3 9a8 8 0 113.73 6.77L8.2 14.3A6 6 0 105 9l3.01-.01-4 4-4-4h3L3 9zm7-4h1.01L11 9.36l3.22 2.1-.6.93L10 10V5z"></path></svg>
	`},list:`
	<svg class="tm-bi-list-task" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z"/><path d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z"/><path fill-rule="evenodd" d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5V7zM2 7h1v1H2V7zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2zm1 .5H2v1h1v-1z"/></svg>
`,closeHtml:function(closeId,buttonExtraClasses=[],iconClasses=["tm-close-icon"]){return`
		<button type="button" id="${closeId}" class="tm-close-icon-button ${buttonExtraClasses.join(" ")}" aria-label="Close">
			<span aria-hidden="true" class="${iconClasses.join(" ")}"></span>
		</button>
	`}};Classes.Viewer=Classes.Base.subclass({__elemWeakMap:new WeakMap,_rootElem:null,_bodyElem:null,_init:function(){Classes.Base._init.call(this)},getViewerByElement:function(elem){return Classes.Viewer.__elemWeakMap.get(elem)},_mapElement:function(elem){Classes.Viewer.__elemWeakMap.set(elem,this)},_elementGen:function(html){var tmpElem=document.createElement("div");tmpElem.innerHTML=html;return tmpElem.firstElementChild},_setRootElem:function(elem){this._rootElem=elem;this._mapElement(elem)},_getBodyElem:function(){if(this._bodyElem!=null){return this._bodyElem}if(this._rootElem!=null){return this._rootElem}return null},_safeText:function(text){var tmpElem=document.createElement("div");tmpElem.textContent=text;return tmpElem.innerHTML},getRootElement:function(){return this._rootElem},getBodyElement:function(){return this._getBodyElem()},getElementById:function(domId){return this._rootElem.querySelector("#"+domId)},addClasses:function(...args){this._rootElem.classList.add(...args)},removeClasses:function(...args){this._rootElem.classList.remove(...args)},getClasses:function(){return Array.from(this._rootElem.classList)},addBodyClasses:function(...args){if(this._bodyElem!=null){this._bodyElem.classList.add(...args)}},removeBodyClasses:function(...args){if(this._bodyElem!=null){this._bodyElem.classList.remove(...args)}},setHtml:function(html){const logHead="Viewer::setHtml(): ";var bodyElem=this._getBodyElem();try{bodyElem.innerHTML=html}catch(e){this._err(logHead,e)}},setText:function(text){const logHead="Viewer::setText(): ";var bodyElem=this._getBodyElem();try{bodyElem.textContent=text}catch(e){this._err(logHead,e)}},append:function(viewer){this._getBodyElem().append(viewer.getRootElement())},prepend:function(viewer){this._getBodyElem().prepend(viewer.getRootElement())},addBefore:function(viewer){let parentNode=this._getBodyElem().parentNode;this._assert(parentNode!=null);parentNode.insertBefore(viewer.getRootElement(),this._getBodyElem())},detach:function(){this.getRootElement().remove()},attachInParentElement:function(parentDomElem){parentDomElem.textContent="";this.appendInParentElement(parentDomElem)},appendInParentElement:function(parentDomElem){parentDomElem.append(this._rootElem)},prependInParentElement:function(parentDomElem){parentDomElem.prepend(this._rootElem)},clear:function(){const logHead="Viewer::clear(): ";var bodyElem=this._getBodyElem();if(bodyElem==null){log._err(logHead+"no body or root element, can't take action");return}bodyElem.textContent=""},show:function(){this._rootElem.classList.remove("d-none")},hide:function(){this._rootElem.classList.add("d-none")},isInDocumentDom:function(){if(this._rootElem.id==null){return null}return document.getElementById(this._rootElem.id)!=null},isInViewport:function(){let clientRect=this._rootElem.getBoundingClientRect();return clientRect.top<window.innerHeight&&clientRect.bottom>=0},runAnimation:function(animClass,elem=this._rootElem){let resolveFn=null;let retVal=new Promise(function(resolve,reject){resolveFn=resolve;elem.addEventListener("animationend",resolveFn)}.bind(this)).then(function(){elem.removeEventListener("animationend",resolveFn);elem.classList.remove(animClass)}.bind(this));elem.classList.add(animClass);return retVal}});Classes.HtmlViewer=Classes.Viewer.subclass({_rootElem:null,_init:function(html){Classes.Viewer._init.call(this);this._rootElem=this._elementGen(html)}});Classes.ButtonViewer=Classes.HtmlViewer.subclass({__idPrefix:"btn",_buttonElem:null,_options:null,_init:function(options={}){this._options={};this._options.labelHtml=options.labelHtml??"";this._options.fullWidth=options.fullWidth??false;this._options.btnExtraClasses=options.btnExtraClasses??[];const logHead="ButtonViewer::_init(): ";const buttonId=this._id+"-button";let fullWidthHtmlBefore="";let fullWidthHtmlAfter="";if(this._options.fullWidth){fullWidthHtmlBefore=`<div class="d-grid gap-2">`;fullWidthHtmlAfter=`</div>`}const buttonHtml=`
	<div class="tm-btnbar-btn h-100">
		${fullWidthHtmlBefore}
			<a class="btn ${this._options.btnExtraClasses.join(" ")}" role="button"	id="${buttonId}">
				${this._options.labelHtml}
			</a>
		${fullWidthHtmlAfter}
	</div>
	`;Classes.HtmlViewer._init.call(this,buttonHtml);this.debug();this._log(logHead,this);this._buttonElem=this.getElementById(buttonId);this._buttonElem.addEventListener("click",this._onButtonClickCbWrapper.bind(this),false)},_onButtonClickCbWrapper:function(ev){this.onButtonClickCb(ev)},onButtonClickCb:function(ev){this._errorMustSubclass("ButtonViewer::onButtonClickCb()")}});Classes.ImageViewer=Classes.HtmlViewer.subclass({__idPrefix:"img",_options:null,_init:function(options={}){this._options={};this._options.src=options.src??"";this._options.srcBackup=options.srcBackup??"";this._options.extraClasses=options.extraClasses??[];let imgSrc=window.navigator.onLine?this._options.src:this._options.srcBackup;let imgHtml=`
	<img id="${this._id}" class="${this._options.extraClasses.join(" ")}" src="${imgSrc}">
	`;Classes.HtmlViewer._init.call(this,imgHtml);this.debug();this.getRootElement().addEventListener("error",this._loadErrorCb.bind(this))},_loadErrorCb:function(ev){const logHead="ImageViewer::_loadErrorCb(): ";this._log(logHead,ev);if(ev.target.src!=this._options.srcBackup){this._log(logHead,"setting favIcon URL to "+this._options.srcBackup);ev.target.src=this._options.srcBackup}else{this._log(logHead+"failure with backup URL, no other action to take")}}});Classes.BsTabViewer=Classes.Viewer.subclass({_headingElem:null,_triggerElem:null,_rootElem:null,_activationListenerCbBound:null,_deactivationListenerCbBound:null,_elw:null,_init:function({labelHtml}){Classes.Viewer._init.call(this);this._elw=Classes.EventListenersWrapper.create();this._createBsTab(labelHtml)},_setParentActiveClass:function(active){if(active){this._triggerElem.parentElement.classList.add("tm-active")}else{this._triggerElem.parentElement.classList.remove("tm-active")}},_createBsTab:function(bsTabLabelHtml){const headingId=this._id;const bodyId=this._id+"-body";const headingHtml=`
		<li class="nav-item bg-light tm-xxs-hide" role="presentation">
			<button type="button" class="nav-link w-100 px-1 tm-cursor-default" id="${headingId}" data-bs-toggle="tab" data-bs-target="#${bodyId}" role="tab" aria-controls="${bodyId}" aria-selected="false">${bsTabLabelHtml}</button>
		</li>
	`;const bodyHtml=`
		<div class="tab-pane fade h-100" id="${bodyId}" role="tabpanel" aria-labelledby="${headingId}">
		</div>
	`;this._headingElem=this._elementGen(headingHtml);this._triggerElem=this._headingElem.querySelector("#"+headingId);this._rootElem=this._elementGen(bodyHtml);this._activationListenerCbBound=this._setParentActiveClass.bind(this,true);this._deactivationListenerCbBound=this._setParentActiveClass.bind(this,false);this.addBsTabActivationStartListener(this._activationListenerCbBound);this.addBsTabDeactivationStartListener(this._deactivationListenerCbBound)},discard:function(){this.removeBsTabActivationStartListener(this._activationListenerCbBound);this.removeBsTabDeactivationStartListener(this._deactivationListenerCbBound);this._elw.discard();this._elw=null;this._headingElem.remove();this._headingElem=null;this._rootElem.remove();this._rootElem=null;gcChecker.add(this)},addBsTabActivationStartListener:function(fn){this._elw.listen(this._triggerElem,"show.bs.tab",fn)},removeBsTabActivationStartListener:function(fn){this._elw.unlisten(this._triggerElem,"show.bs.tab",fn)},addBsTabActivationEndListener:function(fn){this._elw.listen(this._triggerElem,"shown.bs.tab",fn)},addBsTabDeactivationStartListener:function(fn){this._elw.listen(this._triggerElem,"hide.bs.tab",fn)},removeBsTabDeactivationStartListener:function(fn){this._elw.unlisten(this._triggerElem,"hide.bs.tab",fn)},addBsTabDeactivationEndListener:function(fn){this._elw.listen(this._triggerElem,"hidden.bs.tab",fn)},activate:function(){const logHead="BsTabViewer.activate():";this._log(logHead,"entering");let tab=new bootstrap.Tab(this._triggerElem);tab.show()},isBsTabActive:function(){return this._triggerElem.classList.contains("active")},getHeadingElement:function(){return this._headingElem},OLDblink:function(){this._triggerElem.classList.add("tm-blink");setTimeout(this._removeBlinkCb.bind(this),400)},blink:function(){this.runAnimation("tm-blink",this._triggerElem)},_removeBlinkCb:function(){this._triggerElem.classList.remove("tm-blink")},show:function(){this._headingElem.classList.remove("d-none");Classes.Viewer.show.call(this)},hide:function(){this._headingElem.classList.add("d-none");Classes.Viewer.hide.call(this)}});Classes.SearchableBsTabViewer=Classes.BsTabViewer.subclass({_searchBoxElem:null,_searchBoxContainerElem:null,_searchBoxErrorElem:null,_searchBoxCountElem:null,_searchActive:null,_standardViewScrollTop:null,_bodyElem:null,_activateSearchCbBoundFn:null,_init:function({labelHtml}){Classes.BsTabViewer._init.apply(this,arguments);this._activateSearchCbBoundFn=this._activateSearchCb.bind(this);this._SearchableBsTabViewer_initBodyElem();this._SearchableBsTabViewer_searchBoxInactiveInner()},_searchBoxProcessData:function(value){},_SearchableBsTabViewer_initBodyElem:function(){const bodyId=this._id+"-body-inner";const searchBoxId=this._id+"-searchbox";const searchBoxContainerId=this._id+"-searchbox-container";const searchBoxCountId=this._id+"-searchbox-count";const searchBoxErrorId=this._id+"-searchbox-error";const bodyHtml=`
	<div class="d-flex flex-column h-100">
		<div id="${searchBoxContainerId}" class="m-1 tm-stacked-below text-dark d-none">
			<input type="search" id="${searchBoxId}" incremental class="form-control tm-searchbox" placeholder="Type to start searching">
			<div class="tm-overlay tm-vertical-center tm-searchbox-icon">${icons.searchBox}</div>
			<div class="tm-overlay tm-vertical-center tm-searchbox-count">
				<span id="${searchBoxCountId}" class="tm-shaded badge tm-number-badge bg-secondary"></span>
			</div>
		</div>
		<div id="${searchBoxErrorId}" class="tm-searchbox-msg d-none"></div>
		<div class="tm-overflow-auto flex-fill" id="${bodyId}">
		</div>
	</div>
	`;this.setHtml(bodyHtml);this._searchBoxElem=this.getElementById(searchBoxId);this._searchBoxContainerElem=this.getElementById(searchBoxContainerId);this._searchBoxErrorElem=this.getElementById(searchBoxErrorId);this._searchBoxCountElem=this.getElementById(searchBoxCountId);this.addSearchEventListener(this._searchBoxInputListenerCb.bind(this));this._bodyElem=this.getElementById(bodyId);this.addBsTabActivationEndListener(this._bsTabActivatedCb.bind(this));this.addBsTabDeactivationEndListener(this._bsTabDeactivatedCb.bind(this))},_bsTabActivatedCb:function(ev){const logHead="SearchableBsTabViewer._bsTabActivatedCb():";this._log(logHead,"searchable tab activated");this._elw.listen(window,"keydown",this._activateSearchCbBoundFn,true);if(this._searchActive){this._searchBoxElemFocus()}},_bsTabDeactivatedCb:function(ev){const logHead="SearchableBsTabViewer._bsTabDeactivatedCb():";this._log(logHead,"searchable tab deactivated");this._elw.unlisten(window,"keydown",this._activateSearchCbBoundFn,true)},_SearchableBsTabViewer_searchBoxInactiveInner:function(){const logHead="SearchableBsTabViewer._SearchableBsTabViewer_searchBoxInactiveInner():";this._searchBoxContainerElem.classList.add("d-none");this._searchBoxElem.value="";this._searchActive=false;this._log(logHead,"about to call scrollTo(0,",this._standardViewScrollTop,")");this._bodyElem.scrollTo(0,this._standardViewScrollTop)},_searchBoxElemFocus:function(){this._searchBoxElem.click();this._searchBoxElem.focus()},_activateSearchBox:function(active){active=optionalWithDefault(active,true);if(active){this._standardViewScrollTop=this._bodyElem.scrollTop;this._searchBoxContainerElem.classList.remove("d-none");this._searchActive=true;this._searchBoxElemFocus()}else{this._SearchableBsTabViewer_searchBoxInactiveInner()}},_respondToEnterKey:function(searchBoxText){this._errorMustSubclass("SearchableBsTabViewer._respondToEnterKey():")},_modifierToString:function(ev){if(ev.altKey){return"Alt"}if(ev.ctrlKey){return"Control"}if(ev.metaKey){return"Meta"}return null},_isPasteKeyboardShortcut(ev,modifier){return(modifier=="Control"||modifier=="Meta")&&ev.key=="v"},_activateSearchCb:function(ev){const logHead="SearchableBsTabViewer._activateSearchCb(key = "+ev.key+"):";if(ev.defaultPrevented){this._log(logHead,"defaultPrevented == true, event already processed");return}if(this._searchActive){if(document.activeElement!==this._searchBoxElem){this._searchBoxElemFocus()}if(ev.key=="Enter"){this._respondToEnterKey(this._searchBoxElem.value)}return}if(ev.key.length>1){this._log(logHead,"ignoring key");return}let modifier=this._modifierToString(ev);if(modifier!=null){if(this._isPasteKeyboardShortcut(ev,modifier)){this._log(logHead,"identified 'paste' shortcut")}else{this._log(logHead,"ignoring key with key modifier",modifier,"active");return}}this._log(logHead,"starting search");this._activateSearchBox()},_searchBoxInputListenerCb:function(ev){const logHead='SearchableBsTabViewer._searchBoxInputListenerCb(value: "'+ev.target.value+'", '+"time: "+Date.now()+"):";this._log(logHead,"searchbox changed");if(ev.target.value==""){this._activateSearchBox(false);return}this._searchBoxProcessData(ev.target.value)},_setSearchBoxCount:function(cnt){if(cnt==null){this._searchBoxCountElem.innerHTML="Searching..."}else{this._searchBoxCountElem.textContent=cnt<1e4?cnt:"9999+"}},_setSearchBoxCountBlinking:function(flag){flag=optionalWithDefault(flag,true);const logHead="SearchableBsTabViewer._setSearchBoxCountBlinking("+flag+"):";this._log(logHead,"entering");if(flag){this._searchBoxCountElem.classList.add("tm-blink-loop")}else{this._searchBoxCountElem.classList.remove("tm-blink-loop")}},isSearchActive:function(){return this._searchActive},getSearchQuery:function(){if(!this.isSearchActive()){return null}return this._searchBoxElem.value},setSearchQuery:function(searchQuery){if(!this.isSearchActive()){this._activateSearchBox()}this._searchBoxElem.value=searchQuery;this._searchBoxProcessData(searchQuery)},setMessage:function(msgHtml,isInvalid){msgHtml=optionalWithDefault(msgHtml,"");isInvalid=optionalWithDefault(isInvalid,false);if(isInvalid){this._searchBoxElem.classList.add("is-invalid")}if(msgHtml!=""){this._searchBoxErrorElem.classList.remove("d-none");this._searchBoxErrorElem.innerHTML=msgHtml}else{this._searchBoxErrorElem.classList.add("d-none");this._searchBoxElem.classList.remove("is-invalid");this._searchBoxErrorElem.classList.textContent=""}},addSearchEventListener:function(fn){this._elw.listen(this._searchBoxElem,"search",fn,true)}});Classes.GroupsBuilder=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},_getHostname:function(tab){switch(tab.tm.protocol){case"file:":return"[ Pages on this device ]";case"chrome:":if(tab.tm.hostname=="newtab"){return"[ New tabs ]"}}if(tab.tm.hostname==""||tab.tm.hostname==null){return"[ No hostname ]"}return tab.tm.hostname},_getWindowId:function(tab){return tab.windowId},_findFavIconUrl:function(groupName,tabs){const favIconUrl=settingsStore.getCustomGroupsManager().getCustomGroupProp(groupName,"favIconUrl");const lastResortUrl=tabNormalizer.buildCachedFavIconUrl("");if(favIconUrl!=null){return[favIconUrl,lastResortUrl]}let secondChoiceUrl=null;for(var i=0;i<tabs.length;i++){if(tabs[i].favIconUrl!=null){if(tabs[i].tm.useCachedFavIcon){secondChoiceUrl=tabs[i].favIconUrl}else{return[tabs[i].favIconUrl,tabs[i].tm.cachedFavIconUrl]}}}if(secondChoiceUrl!=null){return[secondChoiceUrl,secondChoiceUrl]}return[lastResortUrl,lastResortUrl]},_tabGroupEntryToObj:function(groupName,data,pinned){pinned=optionalWithDefault(pinned,false);let retVal={tabs:data.tabs.sort(Classes.TabNormalizer.compareTabsFn),tm:{}};if(data.type==Classes.GroupsBuilder.Type.HOSTNAME&&data.tabs.length==1&&!settingsStore.isGroupPinned(groupName)){retVal.type=Classes.GroupsBuilder.Type.TAB;retVal.title=data.tabs[0].title;retVal.favIconUrl=data.tabs[0].favIconUrl;retVal.tm.lowerCaseTitle=data.tabs[0].tm.lowerCaseTitle;retVal.tm.sortTitle=data.tabs[0].tm.sortTitle}else{retVal.type=data.type;retVal.title=groupName;[retVal.favIconUrl,retVal.cachedFavIconUrl]=this._findFavIconUrl(groupName,data.tabs);retVal.tm.lowerCaseTitle=retVal.title.toLowerCase();retVal.tm.sortTitle=tabNormalizer.normalizeLowerCaseTitle(retVal.tm.lowerCaseTitle)}retVal.tm.pinned=pinned;return retVal},_tabsHasPinnedTab:function(tabs){for(let i=0;i<tabs.length;i++){if(tmUtils.isTabPinned(tabs[i])){return true}}return false},_tabGroupsToArrays:function(tabGroups){const logHead="GroupsBuilder::_tabGroupsToArrays(): ";let pinned=[];let unpinned=[];for(const[groupName,data]of Object.entries(tabGroups)){switch(data.type){case Classes.GroupsBuilder.Type.HOSTNAME:if(settingsStore.isGroupPinned(groupName)||this._tabsHasPinnedTab(data.tabs)){pinned.push(this._tabGroupEntryToObj(groupName,data,true))}else{unpinned.push(this._tabGroupEntryToObj(groupName,data))}break;case Classes.GroupsBuilder.Type.CUSTOM:if(settingsStore.isGroupPinned(groupName)||this._tabsHasPinnedTab(data.tabs)){pinned.push(this._tabGroupEntryToObj(groupName,data,true))}else{unpinned.push(this._tabGroupEntryToObj(groupName,data))}break;default:log._err(logHead+"unknown type "+data.type);break}}this._log(logHead+"pinned = ",pinned);this._log(logHead+"unpinned = ",unpinned);return[pinned.sort(Classes.TabNormalizer.compareTitlesFn),unpinned.sort(Classes.TabNormalizer.compareTitlesFn)]},_groupByCriterion:function(tabs,criterionFn,type){const logHead="GroupsBuilder::_groupByCriterion(): ";let tabGroups={};tabs.forEach(function(tab){var key=criterionFn(tab);if(key==null){this._err(logHead+"unable to generate key for tab ",tab);return}if(key in tabGroups){tabGroups[key].tabs.push(tab)}else{tabGroups[key]={type:type,tabs:[tab]}}}.bind(this));return tabGroups},_addCustomGroups:function(inputTabGroups){const logHead="GroupsBuilder::_addCustomGroups(): ";let retVal={};let cgm=settingsStore.getCustomGroupsManager();for(const[key,data]of Object.entries(inputTabGroups)){let tabs=data.tabs;let title=cgm.getCustomGroupByHostname(key);let type=Classes.GroupsBuilder.Type.CUSTOM;if(title==null){title=key;type=data.type}if(title in retVal){retVal[title].tabs.push(...tabs);if(retVal[title].type==Classes.GroupsBuilder.Type.HOSTNAME&&type==Classes.GroupsBuilder.Type.CUSTOM){retVal[title].type=Classes.GroupsBuilder.Type.CUSTOM}}else{retVal[title]={type:type,tabs:tabs}}}return retVal},_addEmptyPinnedGroups:function(tabGroups){let cgm=settingsStore.getCustomGroupsManager();settingsStore.getPinnedGroups().getAll().forEach(function(groupName){if(groupName in tabGroups){return}let type=cgm.hasCustomGroup(groupName,true)?Classes.GroupsBuilder.Type.CUSTOM:Classes.GroupsBuilder.Type.HOSTNAME;tabGroups[groupName]={type:type,tabs:[]}});return tabGroups},groupByHostname:function(tabs){let tabGroups=this._groupByCriterion(tabs,this._getHostname.bind(this),Classes.GroupsBuilder.Type.HOSTNAME);return this._tabGroupsToArrays(this._addEmptyPinnedGroups(this._addCustomGroups(tabGroups)))},groupByWindowId:function(tabs){return this._tabGroupsToArrays(this._groupByCriterion(tabs,this._getWindowId.bind(this),Classes.GroupsBuilder.Type.WINDOWID))},getGroupProperties:function(title){return this._groups[title]}});Classes.Base.roDef(Classes.GroupsBuilder,"Type",{});Classes.Base.roDef(Classes.GroupsBuilder.Type,"HOSTNAME","hostname");Classes.Base.roDef(Classes.GroupsBuilder.Type,"WINDOWID","windowid");Classes.Base.roDef(Classes.GroupsBuilder.Type,"CUSTOM","custom");Classes.Base.roDef(Classes.GroupsBuilder.Type,"TAB","tab");Classes.ContainerViewer=Classes.Viewer.subclass({__idPrefix:"ContainerViewer",_rootElem:null,_htmlWhenEmpty:null,_appendedCnt:null,_init:function(htmlWhenEmpty=""){Classes.Viewer._init.apply(this,arguments);const logHead="ContainerViewer::_init(): ";this._htmlWhenEmpty=htmlWhenEmpty;this._containerViewerRender()},_containerViewerRender:function(){const logHead="ContainerViewer::_containerViewerRender(): ";const bodyHtml=`
	<div id="${this._id}">
	</div>
	`;this._setRootElem(this._elementGen(bodyHtml));this._renderEmptyContainer()},_renderEmptyContainer:function(){const html=`
	<div class="tm-all-center text-center">
		<span>${this._htmlWhenEmpty}</span>
	</div>
	`;this._appendedCnt=0;this.setHtml(html)},append:function(viewer){if(this._appendedCnt==0){this._getBodyElem().textContent=""}this._appendedCnt++;Classes.Viewer.append.apply(this,arguments)},moveToTop:function(viewer){this.prepend(viewer)},clear:function(){this._renderEmptyContainer()}});Classes.CollapsibleContainerViewer=Classes.ContainerViewer.subclass({__idPrefix:"CollapsibleContainerViewer",_rootElem:null,_bodyElem:null,_headingElem:null,_headingOuterElem:null,_selectElem:null,_selectMode:null,_options:null,_init:function(options){options=optionalWithDefault(options,{});this._options={};this._options.startExpanded=options.startExpanded??false;this._options.htmlWhenEmpty=options.htmlWhenEmpty??"";this._options.border=options.border??true;this._options.bodyExtraClasses=[].concat(options.bodyExtraClasses??[]);this._options.incognitoStyle=options.incognitoStyle??false;this._options.selectable=options.selectable??false;this._options.selectStyle=options.selectStyle??Classes.CollapsibleContainerViewer.Select.BOX;Classes.ContainerViewer._init.call(this,this._options.htmlWhenEmpty);this._renderHeadingAndBody();this.setSelectMode(false)},_renderSelectHtml:function(selectId){if(!this.isSelectable()){return""}let parentClasses=[];if(this._options.selectStyle==Classes.CollapsibleContainerViewer.Select.SWITCH){parentClasses.push("form-switch")}return`<div class="ms-1 mt-0 d-none">
		<div class="${parentClasses.join(" ")}">
			<input id="${selectId}" class="form-check-input fs-6" type="checkbox" value="" style="min-width: 1em;">
		</div>
	</div>`},_renderHeadingAndBody:function(){const logHead="CollapsibleContainerViewer::_renderHeadingAndBody(): ";const headingOuterId=this._id+"-heading-outer";const headingId=this._id+"-heading";const bodyOuterId=this._id+"-body-outer";const bodyId=this._id+"-body";const selectId=this._id+"-select";this._rootElem.classList.add("accordion");let headingExtraClasses=[];let headingOuterExtraClasses=[];let bodyOuterExtraClasses=[];if(this._options.border){bodyOuterExtraClasses.push("accordion-collapse")}if(this._options.startExpanded){bodyOuterExtraClasses.push("show")}else{headingExtraClasses.push("collapsed")}if(this._options.incognitoStyle){headingExtraClasses.push("tm-accordion-button-incognito");headingOuterExtraClasses.push("border-dark")}if(this.isSelectable()){headingExtraClasses.push("p-0","py-2","pe-2")}else{headingExtraClasses.push("p-2")}let selectHtml=this._renderSelectHtml(selectId);const headingHtml=`
		<div class="d-flex align-items-center accordion-header tm-accordion-header ${headingOuterExtraClasses.join(" ")}" id="${headingOuterId}">
			${selectHtml}
			<button id=${headingId} class="accordion-button tm-accordion-button ${headingExtraClasses.join(" ")}"
						type="button" data-bs-toggle="collapse" data-bs-target="#${bodyOuterId}" aria-expanded="true" aria-controls="${bodyOuterId}" style="min-width: 0;">
			</button>
		</div>
	`;const bodyHtml=`
		<div id="${bodyOuterId}" class="collapse tm-min-empty-container ${bodyOuterExtraClasses.join(" ")}" aria-labelledby="${headingOuterId}" data-bs-parent="#${this._id}">
			<div id="${bodyId}" class="${this._options.bodyExtraClasses.join(" ")}">
			</div>
		</div>
	`;const outerHtml=`
		<div class="accordion-item">
			${headingHtml}
			${bodyHtml}
		</div>
	`;this.setHtml(outerHtml);this._headingElem=this.getElementById(headingId);this._headingOuterElem=this.getElementById(headingOuterId);this._bodyElem=this.getElementById(bodyId);this._mapElement(this._bodyElem);if(this.isSelectable()){this._selectElem=this.getElementById(selectId)}else{this._selectElem=null}this._renderEmptyContainer()},setHeadingHtml:function(html){this._headingElem.innerHTML=html},removeHeadingClasses:function(...args){this._headingElem.classList.remove(...args)},addHeadingClasses:function(...args){this._headingElem.classList.add(...args)},addHeadingOuterClasses:function(...args){this._headingOuterElem.classList.add(...args)},addCollapsedStartListener:function(fn){this._bodyElem.parentElement.addEventListener("hide.bs.collapse",fn)},addExpandedStartListener:function(fn){this._bodyElem.parentElement.addEventListener("show.bs.collapse",fn)},isSelectable:function(){return this._options.selectable},setSelectMode:function(flag=true){if(!this.isSelectable()){return}if(this._selectMode===flag){return}this._selectMode=flag;this._selectElem.parentElement.parentElement.classList[flag?"remove":"add"]("d-none");this._selectElem.checked=false}});Classes.Base.roDef(Classes.CollapsibleContainerViewer,"Select",{});Classes.Base.roDef(Classes.CollapsibleContainerViewer.Select,"BOX","box");Classes.Base.roDef(Classes.CollapsibleContainerViewer.Select,"SWITCH","switch");Classes.SettingsItemViewer=Classes.HtmlViewer.subclass({__idPrefix:"SettingsItemViewer",_rootElem:null,_inputElem:null,_setFn:null,_getFn:null,_label:null,_helpHtml:null,_rootHtml:`
		<div class="tm-settings-item">
		</div>
	`,_trackedUpdateKey:null,_init:function({setFn,getFn,label,helpHtml,updateKey}){Classes.HtmlViewer._init.call(this,this._rootHtml);this.debug();this._assert(setFn!=getFn);this._setFn=setFn;this._getFn=getFn;this._label=label;this._helpHtml=optionalWithDefault(helpHtml,"");this._trackedUpdateKey=updateKey;this._enabled=true;this._startListeners()},_startListeners:function(){settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,function(ev){if(this._trackedUpdateKey==null||this._trackedUpdateKey==ev.detail.key){this.setValue(this._getFn())}}.bind(this))},_setAttributesHtml:function(extraAttrs){if(!this._enabled){extraAttrs.push(`disabled`)}},_getHelpId:function(){return this._id+"help"},_getHelpHtml:function(){return`<div id="${this._getHelpId()}" class="form-text ms-2">${this._helpHtml}</div>`},setEnabled:function(flag){this._enabled=flag;this._assert(this._inputElem!=null);if(flag){this._inputElem.removeAttribute("disabled")}else{this._inputElem.setAttribute("disabled","")}},setValue:function(value=""){const logHead='SettingsItemViewer::setValue("'+value+'"):';if(this._inputElem==null){this._log(logHead,"_inputElem not ready, nothing to do");return}this._log(logHead,"setting value");this._inputElem.value=value},setFocus:function(){this._inputElem.focus()}});Classes.SettingsTextItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsTextItemViewer",_placeholderText:null,_init:function({setFn,getFn,label,placeholderText,helpHtml,updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();if(placeholderText==null||placeholderText==""){this._placeholderText=" "}else{this._placeholderText=this._safeText(placeholderText)}this._renderTextItem()},_setAttributesHtml:function(extraAttrs){const currentText=this._getFn();if(currentText!=null&&currentText!=""){extraAttrs.push(`value="${this._safeText(currentText)}"`)}if(this._placeholderText!=null&&this._placeholderText!=""){extraAttrs.push(`placeholder="${this._placeholderText}"`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_renderTextItem:function(){const inputId=this._id+"input";const helpId=this._getHelpId();let extraAttrs=[];this._setAttributesHtml(extraAttrs);const bodyHtml=`
	<div class="form-floating">
		<input type="search" id="${inputId}" class="form-control text-truncate" ${extraAttrs.join(" ")}
				aria-describedby="${helpId}">
		<label for="${inputId}" class="form-label pt-2 text-truncate w-100">${this._label}</label>
	</div>
	${this._getHelpHtml()}
	`;this.setHtml(bodyHtml);this._inputElem=this.getElementById(inputId);this._helpElem=this.getElementById(helpId);this._inputElem.addEventListener("change",this._onInputChangedCb.bind(this),true);this._inputElem.addEventListener("keydown",this._onKeydownCb.bind(this),true)},_onInputChangedCb:function(ev){const logHead='SettingsTextItemViewer::_onInputChangedCb(value: "'+ev.target.value+'"): ';this._log(logHead+"change event");this._setFn(ev.target.value)},_onKeydownCb:function(ev){const logHead='SettingsTextItemViewer::_onKeydownCb(value: "'+ev.target.value+'"): ';if(ev.key=="Enter"){this._log(logHead+"Enter pressed");this._inputElem.blur();ev.preventDefault()}},setInvalid:function(msgHtml){msgHtml=optionalWithDefault(msgHtml,null);this._inputElem.classList.add("is-invalid");if(msgHtml!=null){this._helpElem.classList.add("tm-invalid-feedback");this._helpElem.innerHTML=msgHtml}return delay(3e3).then(function(){this._inputElem.classList.remove("is-invalid");this._helpElem.classList.remove("tm-invalid-feedback");this._helpElem.innerHTML=this._helpHtml}.bind(this))}});Classes.SettingsTextAreaItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsTextAreaItemViewer",_placeholderText:null,_init:function({setFn,getFn,label,placeholderText,helpHtml,updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();if(placeholderText==null||placeholderText==""){this._placeholderText=" "}else{this._placeholderText=this._safeText(placeholderText)}this._renderTextAreaItem()},_setAttributesHtml:function(extraAttrs){if(this._placeholderText!=null&&this._placeholderText!=""){extraAttrs.push(`placeholder="${this._placeholderText}"`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_renderTextAreaItem:function(){const inputId=this._id+"input";let currentText=this._getFn();if(currentText==null){currentText=""}let extraAttrs=[];this._setAttributesHtml(extraAttrs);const bodyHtml=`
	<div class="tm-autosize form-floating" data-replicated-value="${this._safeText(currentText)}">
		<textarea id="${inputId}" class="form-control" ${extraAttrs.join(" ")} style="height: auto;"
				aria-describedby="${this._getHelpId()}">${this._safeText(currentText)}</textarea>
		<label for="${inputId}" class="form-label pt-2 text-truncate w-100">${this._label}</label>
	</div>
	${this._getHelpHtml()}
	`;this.setHtml(bodyHtml);this._inputElem=this.getElementById(inputId);this._inputElem.addEventListener("change",this._onInputChangedCb.bind(this),true);this._inputElem.addEventListener("input",this._onInputCb.bind(this),true)},_onInputChangedCb:function(ev){const logHead='SettingsTextAreaItemViewer::_onInputChangedCb(value: "'+ev.target.value+'"): ';this._log(logHead+"change event");this._setFn(ev.target.value)},_onInputCb:function(ev){ev.target.parentNode.dataset.replicatedValue=ev.target.value}});Classes.SettingsCheckboxItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsCheckboxItemViewer",_init:function({setFn,getFn,label,helpHtml,updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();this._renderCheckboxItem()},_setAttributesHtml:function(extraAttrs){const currentlyChecked=this._getFn();if(currentlyChecked!=null&&currentlyChecked){extraAttrs.push(`checked`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_renderCheckboxItem:function(){const checkboxId=this._id+"checkbox";let extraAttrs=[];this._setAttributesHtml(extraAttrs);const bodyHtml=`
	<div class="form-check form-switch">
	  <input class="form-check-input tm-align-checkbox" type="checkbox" id="${checkboxId}" ${extraAttrs}
	  aria-describedby="${this._getHelpId()}">
	  <label class="form-check-label" for="${checkboxId}">${this._label}</label>
	</div>
	${this._getHelpHtml()}
	`;this.setHtml(bodyHtml);this._inputElem=this.getElementById(checkboxId);this._inputElem.addEventListener("change",this._onInputChangedCb.bind(this),true)},_onInputChangedCb:function(ev){const logHead='SettingsCheckboxItemViewer::_onInputChangedCb(value: "'+ev.target.checked+'"): ';this._log(logHead+"change event",ev);this._setFn(ev.target.checked)},setValue:function(value=false){if(this._inputElem==null){return}this._inputElem.checked=value}});Classes.SettingsCheckboxPermViewer=Classes.SettingsCheckboxItemViewer.subclass({__idPrefix:"SettingsCheckboxPermViewer",_permission:null,_init:function({permission}){this._permission=permission;Classes.SettingsCheckboxItemViewer._init.apply(this,arguments);this.debug()},_requestPermission:function(ev){const logHead="SettingsCheckboxPermViewer::_requestPermission(): ";chromeUtils.wrap(chrome.permissions.request,logHead,{permissions:[this._permission]}).then(function(granted){if(granted){this._log(logHead+"permission granted");Classes.SettingsCheckboxItemViewer._onInputChangedCb.call(this,ev)}else{this._log(logHead+"permission refused");this._inputElem.checked=false}}.bind(this))},_removePermission:function(ev){const logHead="SettingsCheckboxPermViewer::_removePermission(): ";chromeUtils.wrap(chrome.permissions.remove,logHead,{permissions:[this._permission]}).then(function(removed){if(removed){this._log(logHead+"permission removed")}else{this._err(logHead+"failed")}}.bind(this))},_onInputChangedCb:function(ev){const logHead='SettingsCheckboxPermViewer::_onInputChangedCb(value: "'+ev.target.checked+'"): ';this._log(logHead+"change event",ev);if(ev.target.checked){this._requestPermission(ev)}else{this._removePermission(ev);Classes.SettingsCheckboxItemViewer._onInputChangedCb.call(this,ev)}}});Classes.SettingsColorsItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsColorsItemViewer",_eventManager:null,_radioElemByColor:null,_init:function({setFn,getFn,updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();this.removeClasses("mt-3");this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);this._renderColorsItem()},_setAttributesHtml:function(extraAttrs){const currentlyChecked=this._getFn();if(currentlyChecked!=null&&currentlyChecked){extraAttrs.push(`checked`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_colorData:{none:["bg-light","tm-check-reversed"],gray:["tm-bg-gray",""],blue:["tm-bg-blue",""],red:["tm-bg-red",""],yellow:["tm-bg-yellow",""],green:["tm-bg-green",""],pink:["tm-bg-pink",""],purple:["tm-bg-purple",""],cyan:["tm-bg-cyan",""]},_colorNameToCss:function(colorName){colorName=optionalWithDefault(colorName,"none");if(!(colorName in this._colorData)){return null}return this._colorData[colorName]},_colorToHtml:function(radioHtmlList,radioIdList,colorChecked,color){const radioGroupId=this._id+"-radio";const id=this._id+"-"+color;const bgColor=this._colorNameToCss(color).join(" ");let extraAttrs="";if(color==colorChecked){extraAttrs="checked"}if(color=="none"&&colorChecked==null){extraAttrs="checked"}radioIdList.push([id,color]);radioHtmlList.push(`<input class="form-check-input ${bgColor}" type="radio" name="${radioGroupId}" id="${id}" value="" aria-label="${color}" ${extraAttrs}>`)},_renderColorsItem:function(){const colorChecked=this._getFn();this._radioElemByColor=[];let extraAttrs=[];this._setAttributesHtml(extraAttrs);let radioHtmlList=[];let radioIdList=[];let colorList=Object.keys(this._colorData);colorList.forEach(this._colorToHtml.bind(this,radioHtmlList,radioIdList,colorChecked));const bodyHtml=`
	<div class="form-check-inline">
		${radioHtmlList.join("\n")}
	</div>
	`;this.setHtml(bodyHtml);radioIdList.forEach(function([id,color]){let elem=this.getElementById(id);elem.addEventListener("change",this._onInputChangedCb.bind(this,color),true);this._radioElemByColor[color]=elem}.bind(this))},_onInputChangedCb:function(color,ev){const logHead="SettingsColorsItemViewer::_onInputChangedCb("+color+', value: "'+ev.target.checked+'"): ';this._log(logHead+"change event",ev);if(color=="none"){color=null}if(ev.target.checked){this._setFn(color);this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{color:color})}},setEnabled:function(flag){this._enabled=flag;if(this._radioElemByColor==null){return}let colorList=Object.keys(this._radioElemByColor);colorList.forEach(function(color){if(flag){this._radioElemByColor[color].removeAttribute("disabled")}else{this._radioElemByColor[color].setAttribute("disabled","")}}.bind(this))},setValue:function(color){if(this._radioElemByColor==null){return}let mappedColor=optionalWithDefault(color,"none");this._radioElemByColor[mappedColor].checked=true;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{color:color})}});Classes.SettingsItemsGroupViewer=Classes.CollapsibleContainerViewer.subclass({__idPrefix:"SettingsItemsGroupViewer",_setFn:null,_getFn:null,_label:null,_helpHtml:null,_trackedUpdateKey:null,_init:function({startExpanded,selectable,setFn,getFn,label,helpHtml,updateKey}){let options={startExpanded:startExpanded,selectable:selectable,selectStyle:Classes.CollapsibleContainerViewer.Select.SWITCH,border:true};Classes.CollapsibleContainerViewer._init.call(this,options);this.debug();this._label=label??"";this._helpHtml=helpHtml??"";this._trackedUpdateKey=updateKey;this._enabled=true;this.setHeadingHtml(`<div class="fw-bold tm-accordion-header-align">${this._label}</div>`);this.addClasses("ms-2","tm-settings-container");this.addBodyClasses("pt-1","pb-1");if(!this.isSelectable()){return}this._assert(setFn!=getFn);this._setFn=setFn;this._getFn=getFn;this.setSelectMode(true);this.setValue(this._getFn());this._startListeners()},_startListeners:function(){settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,function(ev){if(this._trackedUpdateKey==null||this._trackedUpdateKey==ev.detail.key){this.setValue(this._getFn())}}.bind(this));this._selectElem.addEventListener("change",this._onInputChangedCb.bind(this),true)},_onInputChangedCb:function(ev){const logHead="SettingsItemsGroupViewer::_onInputChangedCb():";this._log(logHead,"change event",ev.target.checked,ev);this._setFn(ev.target.checked)},setEnabled:function(flag){this._enabled=flag;this._assert(this._selectElem!=null);if(flag){this._selectElem.removeAttribute("disabled")}else{this._selectElem.setAttribute("disabled","")}},setValue:function(value=false){const logHead="SettingsItemsGroupViewer::setValue():";this._log(logHead,"setting value",value);this._selectElem.checked=value}});Classes.SettingsCardViewer=Classes.HtmlViewer.subclass({__idPrefix:"SettingsCardViewer",_bodyElem:null,_titleElem:null,_cardColor:null,_init:function(titleHtml,canClose){this.debug();this._canClose=optionalWithDefault(canClose,false);const bodyId=this._id+"-body";const titleId=this._id+"-title";const closeId=this._id+"-close";let closeHtml="";if(this._canClose){closeHtml=`
		<div class="tm-overlay tm-full-size tm-hover-target tm-pointer-no">
			<div class="tm-float-right">
				${icons.closeHtml(closeId,["tm-pointer-all","mt-1"])}
			</div>
		</div>
		`}const rootHtml=`
	<div class="card py-1 tm-settings-card tm-hover tm-stacked-below">
		<div id="${titleId}" class="ms-2 fw-bold">${titleHtml}</div>
		<div id="${bodyId}"></div>
		${closeHtml}
	</div>
	`;Classes.HtmlViewer._init.call(this,rootHtml);this._bodyElem=this.getElementById(bodyId);this._titleElem=this.getElementById(titleId);if(this._canClose){this._closeElem=this.getElementById(closeId)}else{this._closeElem=null}},setCardColor:function(color){color=color??"none";const logHead="SettingsCardViewer.setCardColor():";if(this._cardColor==color){this._log(logHead,"nothing to do",color,this._cardColor);return}let cgm=settingsStore.getCustomGroupsManager();if(this._cardColor!=null&&this._cardColor!="none"){this._log(logHead,"removing old color ",this._cardColor);this.removeClasses("tm-callout",cgm.getCustomGroupCssByColor(this._cardColor))}if(color!="none"){this._log(logHead,"adding color",color);this.addClasses("tm-callout",cgm.getCustomGroupCssByColor(color))}this._cardColor=color},setTitle:function(titleHtml){this._titleElem.innerHTML=titleHtml},closeCard:function(useAnimation){useAnimation=optionalWithDefault(useAnimation,true);const logHead="SettingsCardViewer::closeCard("+useAnimation+"): ";if(!useAnimation){this._log(logHead+"closing without animation");this.detach();return Promise.resolve()}return this.runAnimation("tm-shrink").then(function(){this._log(logHead+"animation ended, removing self from DOM");this.detach()}.bind(this))}});Classes.SettingsButtonViewer=Classes.HtmlViewer.subclass({__idPrefix:"SettingsButtonViewer",_buttonElem:null,_init:function(labelHtml){labelHtml=optionalWithDefault(labelHtml,"");const logHead="SettingsButtonViewer::_init(): ";const buttonId=this._id+"-button";const buttonHtml=`
	<div class="tm-settings-item">
		<div class="d-grid gap-2">
			<button id="${buttonId}" type="button" class="btn btn-primary">${labelHtml}</button>
		</div>
	</div>
	`;Classes.HtmlViewer._init.call(this,buttonHtml);this.debug();this._log(logHead,this);this._buttonElem=this.getElementById(buttonId);this._buttonElem.addEventListener("click",this._onButtonClickCb.bind(this),false)},_onButtonClickCb:function(ev){this._errorMustSubclass("SettingsButtonViewer::_onButtonClickCb(): ")}});Classes.SettingsAddCustomGroupViewer=Classes.SettingsButtonViewer.subclass({__idPrefix:"SettingsAddCustomGroupViewer",_customGroupsContainer:null,_init:function(customGroupsContainer){Classes.SettingsButtonViewer._init.call(this,"+ add custom group");this.debug();this._customGroupsContainer=customGroupsContainer},_onButtonClickCb:function(ev){let newCustomGroup=Classes.SettingsCustomGroupViewer.create();this._customGroupsContainer.append(newCustomGroup);newCustomGroup.focusOnName()}});Classes.SettingsCustomGroupViewer=Classes.SettingsCardViewer.subclass({__idPrefix:"SettingsCustomGroupViewer",_groupName:null,_groupNameInput:null,_allInputsCanDisable:null,_init:function(groupName,htmlTitle){groupName=optionalWithDefault(groupName,"");htmlTitle=optionalWithDefault(htmlTitle,this._formatDefaultTitle(groupName));this.debug();Classes.SettingsCardViewer._init.call(this,htmlTitle,true);this._groupName=groupName;if(groupName!=""){this.setCardColor(settingsStore.getCustomGroupsManager().getCustomGroupColor(groupName))}this._renderCustomGroupSettings();this._closeElem.addEventListener("click",this._onCloseClickCb.bind(this),false)},_formatDefaultTitle:function(groupName){if(groupName!=""){return`Custom group "${groupName}"`}return"*New custom group"},_onCloseClickCb:function(ev){const logHead='SettingsCustomGroupViewer::_onCloseClickCb("'+this._groupName+'"): ';this._log(logHead+"closing");this.closeCard();if(this._groupName!=""){settingsStore.unpinGroup(this._groupName);settingsStore.getCustomGroupsManager().delCustomGroup(this._groupName)}},_applyColorChange:function(color){if(this._groupName==""){return}settingsStore.getCustomGroupsManager().setCustomGroupProp(this._groupName,"color",color)},_getGroupName:function(){return this._groupName},_showGroupNameError:function(msgHtml){this._groupNameInput.setInvalid(msgHtml);this._groupNameInput.setValue(this._groupName)},_enableSettings:function(flag){const logHead="SettingsCustomGroupViewer::_enableSettings(): ";flag=optionalWithDefault(flag,true);this._allInputsCanDisable.forEach(function(inputViewer){this._log(logHead,inputViewer);inputViewer.setEnabled(flag)}.bind(this))},_renameCustomGroup:function(newName){const logHead="SettingsCustomGroupViewer::_renameCustomGroup("+newName+"): ";if(newName==""){this._showGroupNameError(`A group must have a non-empty name`);this._log(logHead+"user error: the title is an empty string");return}newName=newName.trim();if(newName==""){this._showGroupNameError(`A group name can't be only made of whitespaces`);this._log(logHead+"user error: the title is a string of whitespaces");return}let cgm=settingsStore.getCustomGroupsManager();if(cgm.hasCustomGroup(newName,true)){this._showGroupNameError(`A group named <i>${newName}</i> already exists`);this._log(logHead+"user error: the title already exists");return}let isPinned=this._isCustomGroupPinned();this._pinCustomGroup(false);let oldName=this._groupName;this._groupName=newName;if(oldName!=""){cgm.renameCustomGroup(oldName,newName)}else{cgm.setCustomGroup(newName,{});this.closeCard(false)}this._pinCustomGroup(isPinned);this.setTitle(this._formatDefaultTitle(newName))},_getProp:function(prop){if(prop=="color"){return settingsStore.getCustomGroupsManager().getCustomGroupColor(this._groupName)}return settingsStore.getCustomGroupsManager().getCustomGroupProp(this._groupName,prop)},_setProp:function(prop,value){return settingsStore.getCustomGroupsManager().setCustomGroupProp(this._groupName,prop,value)},_colorUpdatedCb:function(ev){this.setCardColor(ev.detail.color)},_pinCustomGroup:function(flag){if(this._groupName==""){return}if(flag){settingsStore.pinGroup(this._groupName)}else{settingsStore.unpinGroup(this._groupName)}},_isCustomGroupPinned:function(){if(this._groupName==""){return false}return settingsStore.isGroupPinned(this._groupName)},_renderCustomGroupSettings:function(){this._allInputsCanDisable=[];let color=Classes.SettingsColorsItemViewer.create({setFn:this._applyColorChange.bind(this),getFn:this._getProp.bind(this,"color"),updateKey:"customGroups"});this.append(color);this._allInputsCanDisable.push(color);color.addEventListener(Classes.EventManager.Events.UPDATED,this._colorUpdatedCb.bind(this));let help="";if(this._groupName==""){help="Assign a unique name and press <i>Enter</i> to start using this custom group"}this._groupNameInput=Classes.SettingsTextItemViewer.create({setFn:this._renameCustomGroup.bind(this),getFn:this._getGroupName.bind(this),label:"Group name",placeholderText:"",helpHtml:help,updateKey:"customGroups"});this.append(this._groupNameInput);let pinnedInput=Classes.SettingsCheckboxItemViewer.create({setFn:this._pinCustomGroup.bind(this),getFn:this._isCustomGroupPinned.bind(this),label:"Pin group",updateKey:"pinnedGroups"});this.append(pinnedInput);this._allInputsCanDisable.push(pinnedInput);let favIconUrl=Classes.SettingsTextItemViewer.create({setFn:this._setProp.bind(this,"favIconUrl"),getFn:this._getProp.bind(this,"favIconUrl"),label:"Icon URL for this group",placeholderText:"",helpHtml:"Optional, if not specified, one will be taken from tabs in the custom group",updateKey:"customGroups"});this.append(favIconUrl);this._allInputsCanDisable.push(favIconUrl);let matchList=Classes.SettingsTextAreaItemViewer.create({setFn:this._setProp.bind(this,"matchList"),getFn:this._getProp.bind(this,"matchList"),label:"List of hostnames to match the group",placeholderText:"",helpHtml:"One hostname match expression per line",updateKey:"customGroups"});this.append(matchList);this._allInputsCanDisable.push(matchList);if(this._groupName==""){this._enableSettings(false)}},focusOnName:function(){this._groupNameInput.setFocus()}});Classes.SettingsContainerViewer=Classes.CollapsibleContainerViewer.subclass({_init:function(containerTitle,startExpanded=true){let containerOptions={startExpanded:startExpanded,border:false};Classes.CollapsibleContainerViewer._init.call(this,containerOptions);this.debug();this.setHeadingHtml(`<div class="fw-bold tm-accordion-header-align">${containerTitle}</div>`);this.addClasses("tm-settings-container");this.addBodyClasses("pt-1","pb-1")}});Classes.SettingsShortcutCardViewer=Classes.SettingsCardViewer.subclass({__idPrefix:"SettingsShortcutCardViewer",_shortcutKeyViewer:null,_shortcutUnsetText:"Not set",_settingsTabViewerObj:null,_init:function(title,settingsTabViewerObj){this.debug();Classes.SettingsCardViewer._init.call(this,title);this._settingsTabViewerObj=settingsTabViewerObj;this._shortcutKeyViewer=Classes.HtmlViewer.create(`<div></div>`);this.append(this._shortcutKeyViewer)},setShortcutText:function(text){const buttonId=this._id+"scTextBtn";let bgColorClass="bg-dark";if(text==null||text==""){bgColorClass="bg-secondary";text=this._shortcutUnsetText}const targetUrl="chrome://extensions/shortcuts";let html=`
	<div class="ms-2">
		<span id=${buttonId} class="badge tm-text-badge ${bgColorClass}" style="cursor: pointer">${text}</span>
	</div>
	`;this._shortcutKeyViewer.setHtml(html);let buttonElem=this._shortcutKeyViewer.getElementById(buttonId);buttonElem.addEventListener("click",function(ev){this._settingsTabViewerObj.loadUrlThroughBackground(targetUrl);ev.preventDefault()}.bind(this),false)}});Classes.SettingsLosShortcutViewer=Classes.SettingsShortcutCardViewer.subclass({__idPrefix:"SettingsLosShortcutViewer",_init:function(title){this.debug();Classes.SettingsShortcutCardViewer._init.call(this,title);this._renderShortcutSettings()},_renderShortcutSettings:function(){let searchUrl=Classes.SettingsTextItemViewer.create({setFn:settingsStore.setOptionSearchUrl.bind(settingsStore),getFn:settingsStore.getOptionSearchUrl.bind(settingsStore),label:"Search URL for launch/search shortcut",placeholderText:"https://www.google.com/search?q=%s",helpHtml:this._safeText("Use %s to indicate where the text from the clipboard should get pasted"),updateKey:"options"});this.append(searchUrl)}});Classes.SettingsCustomShortcutViewer=Classes.SettingsShortcutCardViewer.subclass({__idPrefix:"SettingsCustomShortcutViewer",_shortcutKey:null,_init:function(shortcutKey,title,settingsTabViewerObj){this.debug();Classes.SettingsShortcutCardViewer._init.call(this,title,settingsTabViewerObj);this._shortcutKey=shortcutKey;this._renderShortcutSettings()},_renderShortcutSettings:function(){let sm=settingsStore.getShortcutsManager();let shortcutTitle=Classes.SettingsTextItemViewer.create({setFn:sm.setShortcutTitle.bind(sm,this._shortcutKey),getFn:sm.getShortcutTitle.bind(sm,this._shortcutKey),label:"Title",helpHtml:this._safeText("If you enable search, this title will be used for the context menu item associated to this shortcut"),updateKey:this._shortcutKey});this.append(shortcutTitle);let hostnameOrUrl=Classes.SettingsTextItemViewer.create({setFn:sm.setShortcutHostnameOrUrl.bind(sm,this._shortcutKey),getFn:sm.getShortcutHostnameOrUrl.bind(sm,this._shortcutKey),label:"Hostname or URL",placeholderText:"e.g.: www.google.com",helpHtml:this._safeText("If you enable search, use %s to indicate where the text from the clipboard should get pasted"),updateKey:this._shortcutKey});this.append(hostnameOrUrl);let alwaysNewTab=Classes.SettingsCheckboxItemViewer.create({setFn:sm.setShortcutProp.bind(sm,this._shortcutKey,"alwaysNewTab"),getFn:sm.getShortcutProp.bind(sm,this._shortcutKey,"alwaysNewTab"),label:"Always open shortcut in new tab",updateKey:this._shortcutKey});this.append(alwaysNewTab);let useClipboard=Classes.SettingsCheckboxItemViewer.create({setFn:sm.setShortcutProp.bind(sm,this._shortcutKey,"useClipboard"),getFn:sm.getShortcutProp.bind(sm,this._shortcutKey,"useClipboard"),label:"Enable search of clipboard contents",updateKey:this._shortcutKey});this.append(useClipboard)}});Classes.SettingsCustomShortcutsContainerViewer=Classes.SettingsContainerViewer.subclass({_shortcutViewers:null,_init:function(settingsTabViewerObj){Classes.SettingsContainerViewer._init.call(this,"Shortcuts settings",false);this.debug();this._shortcutViewers=[];this.addExpandedStartListener(this._containerExpandedCb.bind(this));let losShortcut=Classes.SettingsLosShortcutViewer.create("Shortcut launch/search");this._shortcutViewers[window.ExtCommands.LAUNCHORSEARCH]=losShortcut;this.append(losShortcut);let sm=settingsStore.getShortcutsManager();sm.getShortcutKeys().forEach(function(key){this._shortcutViewers[key]=Classes.SettingsCustomShortcutViewer.create(key,"Custom shortcut "+sm.keyToUiString(key),settingsTabViewerObj);this.append(this._shortcutViewers[key])}.bind(this));this.updateShortcutText()},updateShortcutText:function(){const logHead="SettingsCustomShortcutViewer::updateShortcutText():";chromeUtils.wrap(chrome.commands.getAll,logHead).then(function(commands){this._log(logHead,"received",commands);commands.forEach(function(cmd){if(this._shortcutViewers[cmd.name]!=null){this._shortcutViewers[cmd.name].setShortcutText(cmd.shortcut)}else{this._log(logHead,'ignoring command "',cmd.name,'"')}}.bind(this))}.bind(this))},_containerExpandedCb:function(ev){const logHead="SettingsCustomShortcutViewer::_containerExpandedCb():";this._log(logHead,"container expanded:",ev.target.id,ev);this.updateShortcutText()}});Classes.SettingsBsTabViewer=Classes.BsTabViewer.subclass({_bodyElem:null,_manifest:null,_generalSettingsContainer:null,_customGroupsContainer:null,_shortcutsContainer:null,_customGroupsByName:null,_msgClient:null,_init:function({labelHtml}){Classes.BsTabViewer._init.apply(this,arguments);const logHead="SettingsBsTabViewer::_init():";this.debug();this._manifest=chrome.runtime.getManifest();this._log(logHead,"the manifest object:",this._manifest);this._msgClient=Classes.MsgClient.create();this._setBody();this._renderSettings();settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._updatedCb.bind(this));this.addBsTabActivationStartListener(this._bsTabActivatedCb.bind(this))},loadUrlThroughBackground:function(url){this._msgClient.sendRequest("launchUrl",{url:url}).then(function(response){const logHead="SettingsBsTabViewer::loadUrlThroughBackground().response():";if(response.status=="success"){this._log(logHead,"received",response)}else{this._err(logHead,"response failed:",response)}}.bind(this))},_setBody:function(){let bodyId=this._id+"-settingsBody";let html=`
		<div id="${bodyId}" class="mx-auto px-2 py-3" style="max-width: 800px;">
		</div>
	`;this.addClasses("tm-overflow-auto");this.setHtml(html);this._bodyElem=this.getElementById(bodyId)},_renderTitle:function(){let version=this._safeText(this._manifest.version);if(!isProd()){version+="-DEV"}const bodyHtml=`
	<div>
		<b>${this._safeText(this._manifest.name)}</b> <small>(v. ${version})</small>
	</div>
	`;this.setHtml(bodyHtml)},_renderIncognitoInfo:function(container){const linkId=this._id+"-extSettingsLink";const extensionId=chromeUtils.getExtensionId();const targetUrl=`chrome://extensions/?id=${extensionId}`;let incognitoAccessEnabled="enabled";let extraFootnote="";if(!localStore.isAllowedIncognitoAccess()){incognitoAccessEnabled="disabled";extraFootnote="Changes will apply only when access gets enabled. "}const footnote=`
		<div class="small">${extraFootnote}You can enable/disable access to Incognito tabs in
		the <a id="${linkId}" href="${targetUrl}" target="_blank">Chrome extension settings</a>
	`;const bodyHtml=`
	<div class="tm-settings-item">
		<div>Access to Incognito tabs is <b>${incognitoAccessEnabled}</b><div> 
		${footnote}
	</div>
	`;let viewer=Classes.HtmlViewer.create(bodyHtml);let linkElem=viewer.getElementById(linkId);linkElem.addEventListener("click",function(ev){this.loadUrlThroughBackground(targetUrl);ev.preventDefault()}.bind(this),false);container.append(viewer)},_createOptionsGroup:function(label,startExpanded=true,selectOptions={}){let group=Classes.SettingsItemsGroupViewer.create({label:label,startExpanded:startExpanded,selectable:selectOptions.getFn!=null,getFn:selectOptions.getFn,setFn:selectOptions.setFn,updateKey:selectOptions.updateKey});this._generalSettingsContainer.append(group);return group},_renderDedupOptions:function(){let dedupGroup=this._createOptionsGroup("Deduplicate new tabs",false,{setFn:settingsStore.setOptionNewTabDedup.bind(settingsStore),getFn:settingsStore.getOptionNewTabDedup.bind(settingsStore),updateKey:"options"});let newTabDedupEmpty=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionNewTabDedupEmpty.bind(settingsStore),getFn:settingsStore.getOptionNewTabDedupEmpty.bind(settingsStore),label:"Chrome new tabs",updateKey:"options"});dedupGroup.append(newTabDedupEmpty);let newTabDedupWithOpener=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionNewTabDedupWithOpener.bind(settingsStore),getFn:settingsStore.getOptionNewTabDedupWithOpener.bind(settingsStore),label:"Links from other tabs",updateKey:"options"});dedupGroup.append(newTabDedupWithOpener);let newTabDedupNoOpener=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionNewTabDedupNoOpener.bind(settingsStore),getFn:settingsStore.getOptionNewTabDedupNoOpener.bind(settingsStore),label:"Links from other applications",updateKey:"options"});dedupGroup.append(newTabDedupNoOpener)},_renderLTWOptions:function(){let ltwGroup=this._createOptionsGroup("Move new tabs to least tabbed window",false,{setFn:settingsStore.setOptionNewTabToLtw.bind(settingsStore),getFn:settingsStore.getOptionNewTabToLtw.bind(settingsStore),updateKey:"options"});let newEmptyTabInLTW=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionNewTabToLtwEmpty.bind(settingsStore),getFn:settingsStore.getOptionNewTabToLtwEmpty.bind(settingsStore),label:"Chrome new tabs",updateKey:"options"});ltwGroup.append(newEmptyTabInLTW);let newTabToLtwWithOpener=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionNewTabToLtwWithOpener.bind(settingsStore),getFn:settingsStore.getOptionNewTabToLtwWithOpener.bind(settingsStore),label:"Links from other tabs",updateKey:"options"});ltwGroup.append(newTabToLtwWithOpener);let newTabToLtwNoOpener=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionNewTabToLtwNoOpener.bind(settingsStore),getFn:settingsStore.getOptionNewTabToLtwNoOpener.bind(settingsStore),label:"Links from other applications",updateKey:"options"});ltwGroup.append(newTabToLtwNoOpener)},_renderSearchOptions:function(){let searchGroup=this._createOptionsGroup("Search");let bookmarksInSearch=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionBookmarksInSearch.bind(settingsStore),getFn:settingsStore.getOptionBookmarksInSearch.bind(settingsStore),label:"Include bookmarks",updateKey:"options"});searchGroup.append(bookmarksInSearch);let recentlyClosedInSearch=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionRecentlyClosedInSearch.bind(settingsStore),getFn:settingsStore.getOptionRecentlyClosedInSearch.bind(settingsStore),label:"Include recently closed tabs",updateKey:"options"});searchGroup.append(recentlyClosedInSearch);let historyInSearch=Classes.SettingsCheckboxPermViewer.create({setFn:settingsStore.setOptionHistoryInSearch.bind(settingsStore),getFn:settingsStore.getOptionHistoryInSearch.bind(settingsStore),label:"Include browsing history",updateKey:"options",permission:"history"});searchGroup.append(historyInSearch)},_renderIncognitoOptions:function(){let incognitoGroup=this._createOptionsGroup("Incognito");this._renderIncognitoInfo(incognitoGroup);let splitIncognitoBsTab=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionIncognitoBsTab.bind(settingsStore),getFn:settingsStore.getOptionIncognitoBsTab.bind(settingsStore),label:"Track Incognito tabs separately",updateKey:"options"});incognitoGroup.append(splitIncognitoBsTab);let bookmarksInIncognitoSearch=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionBookmarksInIncognitoSearch.bind(settingsStore),getFn:settingsStore.getOptionBookmarksInIncognitoSearch.bind(settingsStore),label:"Include bookmarks in Incognito search",helpHtml:"<i>Include bookmarks</i> in the <i>Search</i> options must be enabled; applies to the <i>Incognito</i> tab",updateKey:"options"});incognitoGroup.append(bookmarksInIncognitoSearch)},_renderSettings:function(){this._renderTitle();this._generalSettingsContainer=Classes.SettingsContainerViewer.create("General settings");this.append(this._generalSettingsContainer);this._renderSearchOptions();this._renderDedupOptions();this._renderLTWOptions();this._renderIncognitoOptions();if(settingsStore.getOptionDevMode()){let showTabId=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionShowTabId.bind(settingsStore),getFn:settingsStore.getOptionShowTabId.bind(settingsStore),label:"Display extended tab ID badge (dev-mode)",updateKey:"options"});this._generalSettingsContainer.append(showTabId)}let startupOpenPopup=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionStartupOpenPopup.bind(settingsStore),getFn:settingsStore.getOptionStartupOpenPopup.bind(settingsStore),label:"Open TabMania on Chrome startup",updateKey:"options"});this._generalSettingsContainer.append(startupOpenPopup);let outerCustomGroupsContainer=Classes.SettingsContainerViewer.create("Custom groups settings",false);this.append(outerCustomGroupsContainer);this._customGroupsContainer=Classes.ContainerViewer.create("No custom groups defined");this._customGroupsContainer.addClasses("tm-min-empty-container");outerCustomGroupsContainer.append(this._customGroupsContainer);this._customGroupsByName=[];this._addCustomGroups(settingsStore.getCustomGroupsManager().getCustomGroupNames());let addCustomGroupButton=Classes.SettingsAddCustomGroupViewer.create(this._customGroupsContainer);outerCustomGroupsContainer.append(addCustomGroupButton);this._shortcutsContainer=Classes.SettingsCustomShortcutsContainerViewer.create(this);this.append(this._shortcutsContainer)},_addCustomGroups:function(namesList){const logHead="SettingsBsTabViewer::_addCustomGroups():";this._log(logHead,namesList);namesList.forEach(function(name){let customGroup=Classes.SettingsCustomGroupViewer.create(name);this._customGroupsContainer.append(customGroup);this._customGroupsByName[name]=customGroup}.bind(this))},_delCustomGroups:function(namesList){const logHead="SettingsBsTabViewer::_delCustomGroups():";this._log(logHead,namesList);let promisesList=[];namesList.forEach(function(name){promisesList.push(this._customGroupsByName[name].closeCard());delete this._customGroupsByName[name]}.bind(this));if(namesList.length!=0&&Object.keys(this._customGroupsByName).length==0){Promise.all(promisesList).then(this._customGroupsContainer.clear.bind(this._customGroupsContainer))}},_updatedCb:function(ev){const logHead="SettingsBsTabViewer::_updatedCb():";if(ev.detail.key!="customGroups"){this._log(logHead,"ignoring key",ev.detail.key);return}this._log(logHead,"key",ev.detail.key,"processing change",ev.detail);let newNames=settingsStore.getCustomGroupsManager().getCustomGroupNames().sort();let oldNames=Object.keys(this._customGroupsByName).sort();let toBeDeleted=[];let toBeAdded=[];let nn=0;let on=0;while(nn<newNames.length&&on<oldNames.length){let cmp=newNames[nn].localeCompare(oldNames[on]);if(cmp==0){nn++;on++}else{if(cmp<0){toBeAdded.push(newNames[nn++])}else{toBeDeleted.push(oldNames[on++])}}}while(nn<newNames.length){toBeAdded.push(newNames[nn++])}while(on<oldNames.length){toBeDeleted.push(oldNames[on++])}this._delCustomGroups(toBeDeleted);this._addCustomGroups(toBeAdded)},_bsTabActivatedCb:function(ev){const logHead="SettingsBsTabViewer::_bsTabActivatedCb():";this._log(logHead,"tab activated",ev.target.id,ev);this._shortcutsContainer.updateShortcutText()}});Classes.BootstrapTabsViewer=Classes.Viewer.subclass({_headingElem:null,_buttonBarElem:null,_menuElem:null,_bodyElem:null,_menuViewer:null,_init:function(){Classes.Viewer._init.apply(this,arguments);this._renderTabsContainer()},_dockToggleCb:function(ev){popupDocker.dockToggle();ev.preventDefault()},_renderTabsContainer:function(){const logHead="BootstrapTabsViewer::_renderTabsContainer(): ";const headingId=this._id+"-heading";const buttonBarId=this._id+"-buttonbar";const menuId=this._id+"-menu";const bodyId=this._id+"-body";const headingHtml=`
	<div class="d-flex tm-cursor-default tm-select-none">
		<div class="flex-grow-1">
			<!-- https://getbootstrap.com/docs/5.0/components/navs-tabs/ -->
			<ul class="nav nav-tabs nav-justified tm-tiny-hide" id="${headingId}" role="tablist">
			</ul>
		</div>
		<div id="${buttonBarId}" class="ms-2">
		</div>
		<div id="${menuId}">
		</div>
	</div>
	`;const bodyHtml=`
	<div class="tab-content h-100" id="${bodyId}" style="min-height: 0;">
	</div>
	`;const rootHtml=`
	<div class="d-flex flex-column h-100" id=${this._id}>
		${headingHtml}
		${bodyHtml}
	</div>
	`;this._rootElem=this._elementGen(rootHtml);this._headingElem=this.getElementById(headingId);this._buttonBarElem=this.getElementById(buttonBarId);this._menuElem=this.getElementById(menuId);this._bodyElem=this.getElementById(bodyId);this._menuElem=this.getElementById(menuId);this._menuViewer=null},_attachMenu:function(menuViewer){this._menuViewer=menuViewer;this._menuViewer.attachInParentElement(this._menuElem)},append:function(bsTabViewer){this._headingElem.append(bsTabViewer.getHeadingElement());Classes.Viewer.append.apply(this,arguments)},replace:function(oldBsTabViewer,newBsTabViewer){let oldHeadingElem=oldBsTabViewer.getHeadingElement();oldHeadingElem.replaceWith(newBsTabViewer.getHeadingElement());let oldRootElem=oldBsTabViewer.getRootElement();oldRootElem.replaceWith(newBsTabViewer.getRootElement())},appendButton:function(viewer){this._buttonBarElem.append(viewer.getRootElement())}});Classes.PopupViewer=Classes.BootstrapTabsViewer.subclass({_bsTabViewersDict:null,_activeBsTabId:null,_bsTabActivatedCbBound:null,_splitIncognito:null,_bsTabInstanceCnt:null,_popupMenuViewer:null,_init:function(parentElem){Classes.BootstrapTabsViewer._init.apply(this,arguments);this._bsTabInstanceCnt=0;this._bsTabViewersDict={};this._bsTabActivatedCbBound=this._bsTabActivatedCb.bind(this);this._popupMenuViewer=Classes.PopupMenuViewer.create(this);this._attachMenu(this._popupMenuViewer);this._populateTabs();perfProf.mark("popupViewerEnd");this.prependInParentElement(parentElem);perfProf.mark("attachEnd");this._initActiveTabId();popupMsgServer.addCmd("tabsList",this._tabsListNotificationCb.bind(this),false);settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._settingsStoreUpdatedCb.bind(this))},_settingsStoreUpdatedCb:function(ev){const logHead="PopupViewer::_settingsStoreUpdatedCb("+ev.detail.key+"):";if(ev.detail.key!="options"){this._log(logHead,"ignoring key",ev.detail);return}let newSplitIncognito=settingsStore.getOptionIncognitoBsTab()&&localStore.isAllowedIncognitoAccess();if(newSplitIncognito===this._splitIncognito){this._log(logHead,"this._splitIncognito has not changed, nothing to do",this._splitIncognito);return}this._log(logHead,"processing change in this._splitIncognito, now set to",this._splitIncognito);this._splitIncognito=newSplitIncognito;this._replaceBsTab("home",Classes.TabsBsTabViewer,{labelHtml:"Home",standardTabs:true,incognitoTabs:!this._splitIncognito});this._replaceBsTab("incognito",Classes.TabsBsTabViewer,{labelHtml:"Incognito",standardTabs:false,incognitoTabs:this._splitIncognito},!this._splitIncognito)},_initActiveTabId:function(results){const logHead="PopupViewer::_initActiveTabId(): ";let activeBsTabId=localStore.getActiveBsTabId();if(activeBsTabId!=null){this._log(logHead+"initializing active Bootstrap tabId to stored value:",activeBsTabId);if(this.activateBsTabById(activeBsTabId)){return}else{this._log(logHead+"stored Bootstrap tabId not found:",activeBsTabId)}}activeBsTabId=this.getBsTabIdByLabel("home");this._log(logHead+"initializing Bootstrap tabId to default:",activeBsTabId);this.activateBsTabById(activeBsTabId)},_bsTabActivatedCb:function(ev){const bsTabId=this.getBsTabIdFromBsTabInstanceId(ev.target.id);const logHead="PopupViewer::_bsTabActivatedCb("+bsTabId+", "+ev.target.id+"):";this._log(logHead,"tab activated",ev);this._activeBsTabId=bsTabId;localStore.setActiveBsTabId(bsTabId)},_createBsTabInner:function(bsTabLabel,bsTabViewerSubclass,initOptions,startHidden=false){const bsTabId=this.getBsTabIdByLabel(bsTabLabel);const bsTabInstanceId=bsTabId+this._bsTabInstanceCnt++;let newBsTab=bsTabViewerSubclass.createAs(bsTabInstanceId,initOptions);newBsTab.addBsTabActivationStartListener(this._bsTabActivatedCbBound);if(startHidden){newBsTab.hide()}this._bsTabViewersDict[bsTabId]=newBsTab;return newBsTab},_createBsTab:function(bsTabLabel,bsTabViewerSubclass,initOptions,startHidden){let newBsTab=this._createBsTabInner.apply(this,arguments);this.append(newBsTab);this._popupMenuViewer.addBsTabMenuItem(bsTabLabel,initOptions.labelHtml,startHidden)},_replaceBsTab:function(bsTabLabel,bsTabViewerSubclass,initOptions,startHidden){let oldBsTabViewer=this.getBsTabByLabel(bsTabLabel);oldBsTabViewer.removeBsTabActivationStartListener(this._bsTabActivatedCbBound);let newBsTabViewer=this._createBsTabInner.apply(this,arguments);this.replace(oldBsTabViewer,newBsTabViewer);oldBsTabViewer.discard();this._popupMenuViewer.updateBsTabMenuItem(bsTabLabel,initOptions.labelHtml,startHidden??false)},_populateTabs:function(){this._splitIncognito=settingsStore.getOptionIncognitoBsTab()&&localStore.isAllowedIncognitoAccess();this._createBsTab("home",Classes.TabsBsTabViewer,{labelHtml:"Home",standardTabs:true,incognitoTabs:!this._splitIncognito});this._createBsTab("incognito",Classes.TabsBsTabViewer,{labelHtml:"Incognito",standardTabs:false,incognitoTabs:this._splitIncognito},!this._splitIncognito);this._createBsTab("settings",Classes.SettingsBsTabViewer,{labelHtml:"Settings"})},_tabsListNotificationCb:function(notification,sender){const logHead="PopupViewer::_tabsListNotificationCb(): ";this._log(logHead,notification.data)},attachInParentElement:function(){Classes.Viewer.attachInParentElement.apply(this,arguments)},activateBsTabById:function(bsTabId){if(!(bsTabId in this._bsTabViewersDict)){const logHead="PopupViewer::activateBsTabById("+bsTabId+"): ";this._log(logHead+"Bootstrap tabId not found");return false}this._activeBsTabId=bsTabId;this.getBsTabById(this._activeBsTabId).activate();return true},activateBsTabByLabel:function(bsTabLabel){return this.activateBsTabById(this.getBsTabIdByLabel(bsTabLabel))},getBsTabIdByLabel:function(bsTabLabel){return this._id+"-"+bsTabLabel},getBsTabById:function(bsTabId){return this._bsTabViewersDict[bsTabId]},getActiveBsTabId:function(){return this._activeBsTabId},getActiveBsTab:function(){return this.getBsTabById(this.getActiveBsTabId())},getBsTabIdFromBsTabInstanceId:function(bsTabInstanceId){return bsTabInstanceId.split(/[0-9]/,1)?.[0]},getBsTabByLabel:function(bsTabLabel){let bsTabId=this.getBsTabIdByLabel(bsTabLabel);return this.getBsTabById(bsTabId)},getHomeBsTab:function(){return this.getBsTabByLabel("home")},isIncognitoBsTabActive:function(){return this.getActiveBsTabId()==this.getBsTabIdByLabel("incognito")},isSettingsBsTabActive:function(){return this.getActiveBsTabId()==this.getBsTabIdByLabel("settings")},isSearchActive:function(){if(this.isSettingsBsTabActive()){return false}return this.getActiveBsTab().isSearchActive()},getSearchQuery:function(){if(!this.isSearchActive()){return null}return this.getActiveBsTab().getSearchQuery()},updateMultiSelectMenuItem:function(){this._menuViewer.updateMultiSelectMenuItem(this.getActiveBsTabId())}});Classes.TabsTitleMonitor=Classes.Base.subclass({_titlesDict:null,_timeSensitivity:1e4,_minTransitionsCountForAttention:4,_init:function(){Classes.Base._init.call(this);this.debug();this._titlesDict={}},remove:function(tabId){delete this._titlesDict[tabId]},_timeoutCb:function(ctxTitleObj){let tabTitles=this._titlesDict[ctxTitleObj.tabId];if(tabTitles==null){return}let mostRecentTitleObj=tabTitles[tabTitles.length-1];if(mostRecentTitleObj.timerHandle!=ctxTitleObj.timerHandle){return}delete this._titlesDict[ctxTitleObj.tabId];ctxTitleObj.stopFn(ctxTitleObj.tabId)},update:function(tab,stopFn){let newTitleObj={tabId:tab.id,timestamp:performance.now(),timerHandle:null,stopFn:null,title:tab.title,url:tab.url};let tabTitles=this._titlesDict[tab.id];if(tabTitles==null){this._titlesDict[tab.id]=[newTitleObj];tab.tm.wantsAttention=false;return false}let lastTitleObj=tabTitles[tabTitles.length-1];if(newTitleObj.timestamp-lastTitleObj.timestamp>this._timeSensitivity||newTitleObj.url!=lastTitleObj.url){this._titlesDict[tab.id]=[newTitleObj];tab.tm.wantsAttention=false;return false}if(newTitleObj.title!=lastTitleObj.title){tabTitles.push(newTitleObj)}else{newTitleObj=null}tab.tm.wantsAttention=this._wantsAttention(tab.id);if(tab.tm.wantsAttention&&newTitleObj!=null){newTitleObj.stopFn=stopFn;newTitleObj.timerHandle=setTimeout(this._timeoutCb.bind(this,newTitleObj),this._timeSensitivity)}return tab.tm.wantsAttention},_wantsAttention:function(tabId){let tabTitles=this._titlesDict[tabId];if(tabTitles==null){return false}if(tabTitles.length<=this._minTransitionsCountForAttention){return false}if(performance.now()-tabTitles[tabTitles.length-1].timestamp>this._timeSensitivity){delete this._titlesDict[tabId];return false}return true}});Classes.Base.roDef(window,"tabsTitleMonitor",Classes.TabsTitleMonitor.create());Classes.TilesGroupViewer=Classes.CollapsibleContainerViewer.subclass({__idPrefix:"TilesGroupViewer",_tabGroup:null,groupName:null,_expandedGroups:null,_init:function(tabGroup,expandedGroups,incognitoStyle=false){this._tabGroup=tabGroup;this._groupName=tabGroup.title;this._expandedGroups=expandedGroups;this._incognitoStyle=incognitoStyle;this.debug();let emptyExtraClasses=[];if(incognitoStyle){emptyExtraClasses.push("text-white-50")}else{emptyExtraClasses.push("text-muted")}let options={startExpanded:this._expandedGroups.has(this._groupName),htmlWhenEmpty:`<i class="small ${emptyExtraClasses.join(" ")}">No tabs</i>`,border:false,bodyExtraClasses:["tm-indent-right"],incognitoStyle:this._incognitoStyle,selectable:this._tabGroup.tabs.length!=0};Classes.CollapsibleContainerViewer._init.call(this,options);this._TilesGroupViewer_render()},_TilesGroupViewer_renderHeading:function(){let lightIconClass="text-secondary";let badgeBgClass="bg-dark";let badgeTextClass="";if(this._incognitoStyle){lightIconClass="text-white-50";badgeBgClass="tm-bg-incognito-white";badgeTextClass="tm-text-incognito-dark"}let iconBadgeHtml=`
		<div class="tm-overlay tm-full-size">
			<div class="tm-icon-badge-pos small">
				<span class="badge tm-icon-badge ${badgeTextClass} ${badgeBgClass}">${this._tabGroup.tabs.length}</span>
			</div>
		</div>
	`;if(this._tabGroup.tabs.length==0){iconBadgeHtml=""}let pinnedIconHtml="";if(this._tabGroup.tm.pinned){let extraClasses=[];if(!settingsStore.isGroupPinned(this._groupName)){extraClasses.push(lightIconClass)}pinnedIconHtml=`
		<p class="m-0 pe-2">
			<span>${icons.thumbtack("tm-fa-thumbtack-group",...extraClasses)}</span>
		</p>`}const favIconContainerId=this._id+"-favIcon";let groupHeadingHtml=`
		<div class="tm-stacked-below" style="width: 95%;">
			<div class="d-flex align-items-center">
				<div class="flex-grow-1 m-0 ps-2 text-nowrap text-truncate" style="text-align: left;">
					<span id="${favIconContainerId}" class="pe-2"><!-- The favicon goes here --></span>
					<span>${this._groupName}</span>
					${iconBadgeHtml}
				</div>
				${pinnedIconHtml}
			</div>
		</div>
	`;this.setHeadingHtml(groupHeadingHtml);this._selectElem?.addEventListener("click",this._selectClickedCb.bind(this),false);let favIconContainerElem=this.getElementById(favIconContainerId);let favIconOptions={src:this._tabGroup.favIconUrl,srcBackup:this._tabGroup.cachedFavIconUrl,extraClasses:["tm-favicon-16"]};let favIconViewer=Classes.ImageViewer.create(favIconOptions);favIconViewer.attachInParentElement(favIconContainerElem)},_TilesGroupViewer_render:function(){if(this._incognitoStyle){this.addClasses("tm-bg-incognito","tm-text-incognito","border-dark")}this._TilesGroupViewer_renderHeading();this.addExpandedStartListener(this._containerExpandedCb.bind(this));this.addCollapsedStartListener(this._containerCollapsedCb.bind(this));let headingOuterClasses=["tm-customgroup-header"];if(this._tabGroup.type==Classes.GroupsBuilder.Type.CUSTOM){let cgm=settingsStore.getCustomGroupsManager();let colorCss=cgm.getCustomGroupCss(this._groupName);if(colorCss!=""){headingOuterClasses.push("tm-callout",colorCss)}}this.addHeadingOuterClasses(...headingOuterClasses)},_storeExpandedGroup:function(expanded){expanded=optionalWithDefault(expanded,true);if(expanded){this._expandedGroups.add(this._groupName)}else{this._expandedGroups.del(this._groupName)}},_containerExpandedCb:function(ev){const logHead="TilesGroupViewer._containerExpandedCb("+this._groupName+", "+ev.target.id+"):";this._log(logHead,"container expanded",ev);this._storeExpandedGroup()},_containerCollapsedCb:function(ev){const logHead="TilesGroupViewer._containerCollapsedCb("+this._groupName+", "+ev.target.id+"):";this._log(logHead,"container collapsed",ev);this._storeExpandedGroup(false)},_selectClickedCb:function(ev){if(!this.isSelectMode()){return}const logHead="TilesGroupViewer._selectClickedCb():";if(this._selectElem.checked){this._log(logHead,"all selected",ev)}else{this._log(logHead,"all unselected",ev)}this.setSelected(this._selectElem.checked)},setSelected:function(flag=true,options={}){const logHead="TilesGroupViewer.setSelected():";this._log(logHead,"working with children",this._bodyElem.children);options.notifyParent=false;for(let i=0;i<this._bodyElem.children.length;i++){let tile=Classes.Viewer.getViewerByElement(this._bodyElem.children[i]);if(tile==null){this._log(logHead,"no tile found at index",i);continue}this._log(logHead,"processing index",i,tile);tile.setSelected(flag,options)}this.computeMultiSelectState()},isSelectMode:function(){return this.isSelectable()&&this._selectMode},_setSelectedInner:function(flag=true,indeterminate=false){if(!this.isSelectable()){return}this._selectElem.checked=flag;this._selectElem.indeterminate=indeterminate},computeMultiSelectState:function(hint){if(!this.isSelectable()){return}const logHead="TilesGroupViewer.computeMultiSelectState():";let atLeastOneSelected=false;this._log(logHead,"working with children",this._bodyElem.children);for(let i=0;i<this._bodyElem.children.length;i++){let tile=Classes.Viewer.getViewerByElement(this._bodyElem.children[i]);if(tile==null){this._log(logHead,"no tile found at index",i);continue}this._log(logHead,"processing index",i,tile);if(tile.isSelected()){atLeastOneSelected=true;if(hint===false){this._setSelectedInner(true,true);return}}else{if(atLeastOneSelected||hint===true){this._setSelectedInner(true,true);return}}}this._setSelectedInner(atLeastOneSelected)}});Classes.TabsManager=Classes.AsyncBase.subclass({_eventManager:null,_queryJob:null,_queryDelay:200,_issue01WorkaroundJob:null,_issue01WorkaroundInterval:5e3,_normTabs:null,_options:null,_stats:null,_elw:null,_chromeElw:null,_queryCycleNo:null,_init:function({standardTabs,incognitoTabs}){this.debug();this._elw=Classes.EventListenersWrapper.create();this._chromeElw=Classes.EventListenersWrapper.create("addListener","removeListener");this._queryCycleNo=0;this._options={};this._options.standardTabs=standardTabs??true;this._options.incognitoTabs=incognitoTabs??true;this._resetStats();this._eventManager=Classes.EventManager.createAs(this.getId()+".eventManager");this._eventManager.attachRegistrationFunctions(this);this._queryJob=Classes.ScheduledJob.createAs(this._id+".queryJob",this._queryTabs.bind(this));this._queryJob.debug();this._issue01WorkaroundJob=Classes.ScheduledJob.createAs(this._id+".issue01WorkaroundJob",this._issue01Workaround.bind(this));this._issue01WorkaroundJob.debug();Classes.AsyncBase._init.apply(this,arguments)},_asyncInit:function(){const logHead="TabsManager::_asyncInit():";let parentPromise=Classes.AsyncBase._asyncInit.call(this);let thisPromise=this._queryTabs().then(function(){if(this._elw==null){this._log(logHead,"discard() called before initialization completed, giving up");return}this._elw.listen(bookmarksManager,Classes.EventManager.Events.UPDATED,this._bookmarkUpdatedCb.bind(this));this._registerChromeCallbacks();this._elw.listen(settingsStore,Classes.EventManager.Events.UPDATED,this._settingsStoreUpdatedCb.bind(this))}.bind(this));return Promise.all([parentPromise,thisPromise])},_resetStats:function(){this._stats={issue01Hit:0}},_registerChromeCallbacks:function(){this._chromeElw.listen(chrome.tabs.onCreated,this._tabCreatedCb.bind(this));this._chromeElw.listen(chrome.tabs.onUpdated,this._tabUpdatedCb.bind(this));this._chromeElw.listen(chrome.tabs.onRemoved,this._tabRemovedCb.bind(this));this._chromeElw.listen(chrome.tabs.onHighlighted,this._tabHighlightedCb.bind(this));this._chromeElw.listen(chrome.tabs.onActivated,this._tabActivatedCb.bind(this));this._chromeElw.listen(chrome.tabs.onMoved,this._tabActivatedHighlightedMovedAttachedCb.bind(this,Classes.TabsManager.Events.MOVED));this._chromeElw.listen(chrome.tabs.onAttached,this._tabActivatedHighlightedMovedAttachedCb.bind(this,Classes.TabsManager.Events.ATTACHED))},_ignoreTab:function(tab){if(tab.incognito===undefined||!tab.incognito){if(this._options.standardTabs){return false}}else{if(this._options.incognitoTabs){return false}}return true},_issue01Workaround:function(){const logHead="TabsManager::_issue01Workaround(): ";if(this._normTabs==null){this._log(logHead+"no _normTabs");this._issue01WorkaroundJob.stop();return}let tabsLoading=this._normTabs.getTabsLoading();let tabIdList=Object.keys(tabsLoading);if(tabIdList.length==0){this._log(logHead+'no tabs in "loading" status, nothing to do, stopping job');this._issue01WorkaroundJob.stop();return}this._log(logHead+"checking "+tabIdList.length+' tabs in "loading" status',tabsLoading);let tabPromises=new Array(tabIdList.length);for(let i=0;i<tabIdList.length;i++){tabPromises[i]=chromeUtils.wrap(chrome.tabs.get,logHead,+tabIdList[i])}Promise.all(tabPromises).then(function(tabs){this._log(logHead+"got these results:",tabs);for(let i=0;i<tabs.length;i++){let tab=tabs[i];if(tab==null){this._log(logHead+"at least one tab disappeared, refreshing all",tab);this._stats.issue01Hit++;this._queryJob.run(this._queryDelay);return}if(tab.status!="loading"){this._log(logHead+"at least one tab has changed status, refreshing all",tab);this._stats.issue01Hit++;this._queryJob.run(this._queryDelay);return}this._log(logHead+'all tabs are still in "loading" status')}}.bind(this))},_processTabUpdateInner:function(tab){this._normTabs.update(tab);if(this._options.standardTabs&&!tab.incognito){settingsStore.getShortcutsManager().updateTabs(this._normTabs.get())}},_processTabCreation:function(tab){const logHead="TabsManager::_processTabCreation("+tab.id+"): ";if(tab.url==""&&tab.pendingUrl==null){this._log(logHead+"still no URL info in new tab, giving up");return}if(this._normTabs.getById(tab.id)!=null){this._err(logHead+"tab already exists, suppressing call");return}this._log(logHead+"entering",tab);this._processTabUpdateInner(tab);this._eventManager.notifyListeners(Classes.TabsManager.Events.CREATED,{tab:tab})},_stopAttentionCb:function(tabId){const logHead="TabsManager::_stopAttentionCb("+tabId+"): ";let tab=this._normTabs.getById(tabId);if(tab==null){this._log(logHead+"tab not found, ignoring event");return}this._log(logHead+"entering");tab.tm.wantsAttention=false;this._eventManager.notifyListeners(Classes.TabsManager.Events.UPDATED,{tabs:[tab]})},_processTabUpdate:function(tabId,tab){this._processTabUpdateInner(tab);tabsTitleMonitor.update(tab,this._stopAttentionCb.bind(this));this._eventManager.notifyListeners(Classes.TabsManager.Events.UPDATED,{tabs:[tab]})},_tabCreatedCb:function(tab){const logHead="TabsManager::_tabCreatedCb(tabId = "+tab.id+"): ";if(this._ignoreTab(tab)){this._log(logHead+"filtering out tab",tab);return}if(tab.id==popupDocker.getOwnTabId()){this._log(logHead+"filtering out our own tab ID");return}if(tab.url==""&&tab.pendingUrl==null){this._log(logHead+"URL missing, delaying processing");chromeUtils.wrap(chrome.tabs.get,logHead,tab.id).then(this._processTabCreation.bind(this));return}this._processTabCreation(tab)},_tabUpdatedCb:function(tabId,changeInfo,tab){const logHead="TabsManager::_tabUpdatedCb("+tabId+"): ";if(this._ignoreTab(tab)){this._log(logHead+"filtering out tab",tab);return}if(this._normTabs.getById(tabId)==null){this._log(logHead+"tab not found, simulating onCreated event",tab);this._processTabCreation(tab);return}this._log(logHead+"entering",changeInfo,tab);this._processTabUpdate(tabId,tab)},_tabRemovedCb:function(tabId,removeInfo){const logHead="TabsManager::_tabRemovedCb("+tabId+"): ";let tabRemoved=this._normTabs.removeById(tabId);if(tabRemoved==null){this._log(logHead+"tab not tracked");return}this._log(logHead+"tab removed",tabRemoved);tabsTitleMonitor.remove(tabId);if(this._options.standardTabs){settingsStore.getShortcutsManager().updateTabs(this._normTabs.get())}this._eventManager.notifyListeners(Classes.TabsManager.Events.REMOVED,{tab:tabRemoved,removeInfo:removeInfo});this._log(logHead+"triggering a full refresh");this._queryJob.run(this._queryDelay)},_tabHighlightedCb:function(highlightInfo){let tabId=null;if(highlightInfo.tabIds.length==1){tabId=highlightInfo.tabIds[0];let tab=this._normTabs.getById(tabId);if(tab!=null&&tab.highlighted){const logHead="TabsManager::_tabHighlightedCb("+tabId+"): ";this._log(logHead+"suppressing redundant event",highlightInfo);return}}this._tabActivatedHighlightedMovedAttachedCb(Classes.TabsManager.Events.HIGHLIGHTED,tabId,highlightInfo)},_tabActivatedCb:function(activeInfo){this._tabActivatedHighlightedMovedAttachedCb(Classes.TabsManager.Events.ACTIVATED,activeInfo.tabId,activeInfo)},_tabActivatedHighlightedMovedAttachedCb:function(eventId,tabId,activeHighlightMoveAttachInfo){const logHead="TabsManager::_tabActivatedHighlightedMovedAttachedCb("+eventId+", "+tabId+"): ";if(tabId!=null){if(this._normTabs.getById(tabId)==null){this._log(logHead+"tab not found, ignoring event",activeHighlightMoveAttachInfo);return}}this._log(logHead+"scheduling a full refresh",activeHighlightMoveAttachInfo);this._queryJob.run(this._queryDelay)},_bookmarkUpdatedCb:function(ev){this._queryJob.run(this._queryDelay)},_generateDiffEvents:function(oldTabList){const logHead="TabsManager::_generateDiffEvents(): ";let[added,deleted,changed]=this._normTabs.diff(oldTabList);this._log(logHead,added,deleted,changed);for(let i=0;i<added.length;i++){this._eventManager.notifyListeners(Classes.TabsManager.Events.CREATED,{tab:added[i]})}for(let i=0;i<deleted.length;i++){this._eventManager.notifyListeners(Classes.TabsManager.Events.REMOVED,{tab:deleted[i]})}if(changed.length>0){this._eventManager.notifyListeners(Classes.TabsManager.Events.UPDATED,{tabs:changed})}},_settingsStoreUpdatedCb:function(ev){const logHead="TabsManager::_settingsStoreUpdatedCb("+ev.detail.key+"): ";if(["pinnedGroups"].includes(ev.detail.key)){this._log(logHead+"ignoring key");return}this._log(logHead+"entering");let oldTabList=this._normTabs.cloneTabs();this._normTabs.normalizeAll({oldTabsDict:this._normTabs.getDict()});this._generateDiffEvents(oldTabList)},_tabsAsyncQuery:function(){const logHead="TabsManager::_tabsAsyncQuery(): ";return chromeUtils.queryTabs({},logHead).then(function(tabs){if(window.tmStaging!==undefined){this._err(logHead+"entering staging path");tabs=tmStaging.tabList}if(this._options.standardTabs&&this._options.incognitoTabs){return tabs}let retVal=[];let ignored=[];for(let i=0;i<tabs.length;i++){if(!this._ignoreTab(tabs[i])){retVal.push(tabs[i])}else{ignored.push(tabs[i])}}if(ignored.length!=0){this._log(logHead+"list of tabs ignored:",ignored)}return retVal}.bind(this))},_queryTabs:function(){const logHead="TabsManager::_queryTabs():";this._log(logHead,"entering");this._queryCycleNo++;let savedQueryCycleNo=this._queryCycleNo;perfProf.mark("queryStart");return this._tabsAsyncQuery().then(function(tabs){perfProf.mark("queryEnd");if(savedQueryCycleNo!=this._queryCycleNo){this._log(logHead,"old query cycle now obsolete, giving up");return}this._log(logHead,"tabs received, processing");this._issue01WorkaroundJob.start(this._issue01WorkaroundInterval,false);let oldTabList=null;let oldTabDict=null;if(this._normTabs!=null){oldTabList=this._normTabs.get();oldTabDict=this._normTabs.getDict();this._normTabs.discard();this._normTabs=null}try{perfProf.mark("normalizeStart");this._normTabs=Classes.TabsStore.createAs(this.getId()+".normTabs"+this._queryCycleNo,tabs,oldTabDict);perfProf.mark("shortcutsStart");if(this._options.standardTabs){settingsStore.getShortcutsManager().updateTabs(this._normTabs.get());this._normTabs.addShortcutBadges()}perfProf.mark("shortcutsEnd");if(oldTabList!=null){this._log(logHead,"comparing with oldTabList");this._generateDiffEvents(oldTabList)}else{this._log(logHead,"no oldTabList, nothing to compare (popup just bootstrapped?)")}perfProf.mark("diffEventsEnd");perfProf.measure("Query","queryStart","queryEnd");perfProf.measure("Normalize","normalizeStart","shortcutsStart");perfProf.measure("Shortcuts","shortcutsStart","shortcutsEnd");perfProf.measure("DiffEvents","shortcutsEnd","diffEventsEnd")}catch(e){this._err(e)}}.bind(this))},getTabs:function(){return this._normTabs.get()},getTabByTabId:function(tabId){return this._normTabs.getById(tabId)},getPinnedBookmarkIdsFromTabs:function(){return this._normTabs.getPinnedBookmarkIdsFromTabs()},discard:function(){this._queryCycleNo++;this._elw.discard();this._elw=null;this._chromeElw.discard();this._chromeElw=null;this._queryJob.discard();this._queryJob=null;this._issue01WorkaroundJob.discard();this._issue01WorkaroundJob=null;this._eventManager.discard();this._eventManager=null;this._normTabs.discard();this._normTabs=null;gcChecker.add(this)}});Classes.Base.roDef(Classes.TabsManager,"Events",{});Classes.Base.roDef(Classes.TabsManager.Events,"CREATED","tmCreated");Classes.Base.roDef(Classes.TabsManager.Events,"ACTIVATED","tmActivated");Classes.Base.roDef(Classes.TabsManager.Events,"HIGHLIGHTED","tmHighlighted");Classes.Base.roDef(Classes.TabsManager.Events,"UPDATED","tmUpdated");Classes.Base.roDef(Classes.TabsManager.Events,"REMOVED","tmRemoved");Classes.Base.roDef(Classes.TabsManager.Events,"ATTACHED","tmAttached");Classes.Base.roDef(Classes.TabsManager.Events,"MOVED","tmMoved");Classes.SearchManager=Classes.AsyncBase.subclass({_tabsManager:null,_historyFinder:null,_incognitoBsTab:null,_searchQuery:null,_searchResults:null,_init:function({tabsManager,historyFinder,incognitoBsTab}){this.debug();this._tabsManager=tabsManager;this._historyFinder=historyFinder;this._incognitoBsTab=incognitoBsTab;this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.apply(this,arguments)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];promiseArray.push(this._tabsManager.getInitPromise());return Promise.all(promiseArray)},queryTabs:async function(){const logHead="SearchManager::_queryTabs():";let rcPromise=null;let bmPromise=null;let historyPromise=null;if(this._incognitoBsTab){rcPromise=Promise.resolve([]);if(settingsStore.getOptionBookmarksInIncognitoSearch()){bmPromise=bookmarksManager.find(this._searchQuery)}else{bmPromise=Promise.resolve([])}historyPromise=Promise.resolve([])}else{rcPromise=this._historyFinder._getRecentlyClosedTabs();bmPromise=bookmarksManager.find(this._searchQuery);historyPromise=this._historyFinder.find(this._searchQuery)}[rcTabs,bmNodes,hItems]=await Promise.all([rcPromise,bmPromise,historyPromise]);if(!this.isSearchActive()){this._log(logHead,"got out of search mode, discarding results");return}let tabs=this._tabsManager.getTabs().concat(rcTabs,hItems);perfProf.mark("searchFilterStart");let searchResults=this._searchQuery.search(tabs,logHead);perfProf.mark("searchFilterEnd");return this._searchResults=searchResults.concat(bmNodes)},isSearchActive:function(){return this.isInitialized()&&this._searchQuery!=null},isTabInSearch:function(tab){if(!this.isSearchActive()){return false}return this._searchQuery.isTabInSearch(tab)},updateQuery:function(value){if(this._searchQuery==null){this._searchQuery=Classes.SearchQuery.create()}perfProf.mark("parseQueryStart");this._searchQuery.update(value);perfProf.mark("parseQueryEnd")},getTabs:function(){return this._searchResults},getErrors:function(){return this._searchQuery.getErrors()},reset:function(){this._searchQuery=null;this._searchResults=null}});Classes.TabsBsTabViewer=Classes.SearchableBsTabViewer.subclass({_emptyContainerString:"No tabs",_containerViewer:null,_groupsBuilder:null,_expandedGroups:null,_queryAndRenderJob:null,_queryAndRenderDelay:200,_maxUpdatedTabs:50,_tabsManager:null,_historyFinder:null,_searchManager:null,_queryCycleNo:null,_tilesAsyncQueue:null,_tilesByTabId:null,_tilesGroups:null,_cachedTilesByTabId:null,_recycledTilesCnt:null,_cachedTilesUpdateNeededCnt:null,_currentSearchResults:null,_selectMode:null,_listSelectedMode:null,_multiSelectPanel:null,_init:function({labelHtml,standardTabs,incognitoTabs}){this._options={};this._options.labelHtml=labelHtml;this._options.standardTabs=standardTabs??true;this._options.incognitoTabs=incognitoTabs??true;Classes.SearchableBsTabViewer._init.call(this,{labelHtml:this._options.labelHtml});const logHead="TabsBsTabViewer::_init():";this.debug();this._queryCycleNo=0;this._selectMode=false;this._listSelectedMode=false;if(!this._isIncognito()){this._expandedGroups=localStore.standardTabsBsTabExpandedGroups}else{if(this._options.incognitoTabs){this._emptyContainerString="No incognito tabs";this._expandedGroups=localStore.incognitoTabsBsTabExpandedGroups}else{this._log(logHead,"neither standard nor incognito tabs to render, going idle");return}}let tabsManagerOptions={standardTabs:this._options.standardTabs,incognitoTabs:this._options.incognitoTabs};this._tabsManager=Classes.TabsManager.createAs(this._id+".tabsManager",tabsManagerOptions);this._historyFinder=this._isIncognito()?null:Classes.HistoryFinder.create();let searchManagerOptions={tabsManager:this._tabsManager,historyFinder:this._historyFinder,incognitoBsTab:this._isIncognito()};this._searchManager=Classes.SearchManager.createAs(this._id+".searchManager",searchManagerOptions);this._queryAndRenderJob=Classes.ScheduledJob.createAs(this._id+".queryAndRenderJob",this._queryAndRenderTabs.bind(this));this._queryAndRenderJob.debug();this._groupsBuilder=Classes.GroupsBuilder.create();this._TabsBsTabViewer_searchBoxInactiveInner();this._tabsManager.getInitPromise().then(this._asyncInitCb.bind(this))},_asyncInitCb:function(){const logHead="TabsBsTabViewer::_asyncInitCb():";if(this._queryCycleNo!=0){if(this._elw==null){this._log(logHead,"discard() called before initialization completed, giving up");return}this._err(logHead,"unexpected, _queryCycleNo updated before initialization completed",this._queryCycleNo)}this._registerTabsManagerCallbacks();this._elw.listen(bookmarksManager,Classes.EventManager.Events.UPDATED,this._bookmarkUpdatedCb.bind(this));if(this._historyFinder!=null){this._elw.listen(this._historyFinder,Classes.EventManager.Events.UPDATED,this._historyUpdatedCb.bind(this))}this._elw.listen(settingsStore,Classes.EventManager.Events.UPDATED,this._settingsStoreUpdatedCb.bind(this));this._TabsBsTabViewer_render()},_registerTabsManagerCallbacks:function(){this._elw.listen(this._tabsManager,Classes.TabsManager.Events.CREATED,this._tabCreatedCb.bind(this));this._elw.listen(this._tabsManager,Classes.TabsManager.Events.REMOVED,this._tabRemovedCb.bind(this));this._elw.listen(this._tabsManager,Classes.TabsManager.Events.UPDATED,this._tabUpdatedCb.bind(this))},_tabCreatedCb:function(ev){let tab=ev.detail.tab;const logHead="TabsBsTabViewer::_tabCreatedCb(tabId = "+tab.id+"):";this._log(logHead,"entering",ev.detail);if(this.isSearchActive()){return}this._queryAndRenderJob.run()},_tabRemovedCb:function(ev){const logHead="TabsBsTabViewer::_tabRemovedCb(tabId = "+ev.detail.tab.id+"):";this._log(logHead,"entering",ev.detail);this._queryAndRenderJob.run(this._queryAndRenderDelay)},_processTabUpdate:function(tab,scheduledFullRender){const logHead="TabsBsTabViewer._processTabUpdate(tabId = "+tab.id+"):";this._log(logHead,"entering",tab);let tile=this._tilesByTabId[tab.id];if(tile==null){if(this.isListSelectedMode()){this._log(logHead,"tile not found, ignoring in list-selected mode",tab);return false}if(this.isSearchActive()){if(this._searchManager.isTabInSearch(tab)){this._log(logHead,"tile not found, triggering re-render in search mode",tab);this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}this._log(logHead,"tile not found, ignoring in search mode",tab);return false}this._err(logHead,"tile not found and not in search mode",tab,this._tilesByTabId[tab.id]);return false}this._log(logHead,"tile found",tile);if(this.isSearchActive()&&!this._searchManager.isTabInSearch(tab)){this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}let oldRenderState=tile.getRenderState();tile.update(tab);if(scheduledFullRender){return true}let renderState=tile.getRenderState();if(renderState.wantsAttention){if(!oldRenderState.wantsAttention){this._log(logHead,"wantsAttention transitioned to on");this._containerViewer.moveToTop(tile)}}else{if(oldRenderState.wantsAttention){this._log(logHead,"wantsAttention transitioned to off");this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}}if(oldRenderState.sortTitle!=renderState.sortTitle){this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}if(this.isSearchActive()){if(oldRenderState.title!=renderState.title){this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}}if(oldRenderState.url!=renderState.url){if(this.isSearchActive()||renderState.tabGroupTitle!=null&&renderState.customGroupName==null){this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}}if(oldRenderState.customGroupName!=renderState.customGroupName){this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}if(oldRenderState.pinned!=renderState.pinned){this._queryAndRenderJob.run(this._queryAndRenderDelay);return true}return false},_tabUpdatedCb:function(ev){let tabId="[multi]";if(ev.detail.tabs.length==1){tabId=ev.detail.tabs[0].id}const logHead="TabsBsTabViewer::_tabUpdatedCb(tabId = "+tabId+"):";if(ev.detail.tabs.length>this._maxUpdatedTabs){this._log(logHead,"many changes, just doing full refresh",ev.detail);this._queryAndRenderJob.run(this._queryAndRenderDelay);return}this._log(logHead,"entering",ev.detail);let scheduledFullRender=false;for(let i=0;i<ev.detail.tabs.length;i++){scheduledFullRender=this._processTabUpdate(ev.detail.tabs[i],scheduledFullRender)||scheduledFullRender}this._log(logHead,"scheduledFullRender =",scheduledFullRender);if(!scheduledFullRender){this.blink()}},_bookmarkUpdatedCb:function(ev){const logHead="TabsBsTabViewer::_bookmarkUpdatedCb():";this._log(logHead,"entering",ev.detail);this._queryAndRenderJob.run(this._queryAndRenderDelay)},_settingsStoreUpdatedCb:function(ev){const logHead="TabsBsTabViewer::_settingsStoreUpdatedCb("+ev.detail.key+"):";if(!this.isSearchActive()&&!["pinnedGroups","customGroups"].includes(ev.detail.key)){this._log(logHead,"ignoring key",ev.detail);return}this._log(logHead,"entering",ev.detail);this._queryAndRenderJob.run(this._queryAndRenderDelay)},_historyUpdatedCb:function(ev){const logHead="TabsBsTabViewer._historyUpdatedCb():";if(!this.isSearchActive()){return}this._log(logHead,"entering",ev.detail);this._queryAndRenderJob.run(this._queryAndRenderDelay)},_isIncognito:function(){return!this._options.standardTabs},isSelectMode:function(){return this._selectMode},setSelectMode:function(flag=true){if(this._selectMode===flag){return}this._selectMode=flag;this._multiSelectPanel.activate(flag);this.setListSelectedMode(false,true);popupViewer.updateMultiSelectMenuItem();for(const[tabId,tile]of Object.entries(this._tilesByTabId)){tile.setSelectMode(flag)}for(let i=0;i<this._tilesGroups.length;i++){this._tilesGroups[i].setSelectMode(flag)}},toggleSelectMode:function(){this.setSelectMode(!this.isSelectMode())},_tileSelectedCb:function(tab,flag,options){if(flag){this._multiSelectPanel.addTab(tab)}else{this._multiSelectPanel.removeTab(tab)}if(!options.bsTabTriggered){this._computeMultiSelectState(flag)}},_multiSelectSelectedCb:function(ev){const logHead="TabsBsTabViewer._multiSelectSelectedCb():";if(ev.detail.selected){this._log(logHead,"all selected",ev)}else{this._log(logHead,"all unselected",ev)}let containerChildren=this._containerViewer.getBodyElement().children;for(let i=0;i<containerChildren.length;i++){let tileOrGroup=Classes.Viewer.getViewerByElement(containerChildren[i]);if(tileOrGroup==null){this._log(logHead,"no selectable viewer found at index",i);continue}if(!tileOrGroup.isSelectable()){this._log(logHead,"non-selectable selectable viewer found at index",i);continue}this._log(logHead,"processing index",i,tileOrGroup);tileOrGroup.setSelected(ev.detail.selected,{bsTabTriggered:true})}this._computeMultiSelectState()},_multiSelectClosedCb:function(ev){this.setSelectMode(false)},_multiSelectListedCb:function(ev){this.toggleListSelectedMode()},_computeMultiSelectState:function(hint){let atLeastOneSelected=false;for(const[tabId,tile]of Object.entries(this._tilesByTabId)){if(tile.isSelected()){atLeastOneSelected=true;if(hint===false){this._multiSelectPanel.setSelected(true,true);return}}else{if(atLeastOneSelected||hint===true){this._multiSelectPanel.setSelected(true,true);return}}}this._multiSelectPanel.setSelected(atLeastOneSelected)},setListSelectedMode:function(flag=true,force=false){const logHead="TabsBsTabViewer.setListSelectedMode():";if(this._listSelectedMode==flag){this._log(logHead,"nothing to do");return}this._log(logHead,"entering");this._listSelectedMode=flag;this._multiSelectPanel.setListSelectedMode(this._listSelectedMode);if(!this.isSelectMode()&&!force){this._log(logHead,"skipping further actions");return}if(this.isSearchActive()){if(this._listSelectedMode){this._activateSearchBox(false)}}else{this._queryAndRenderJob.run()}},toggleListSelectedMode:function(){this.setListSelectedMode(!this.isListSelectedMode())},isListSelectedMode:function(){if(!this.isSelectMode()){return false}return this._listSelectedMode},_disableContextMenuOnTouchEnd:function(){let touchEndRecentlyFired=false;let monitorTouchEndCb=function(ev){touchEndRecentlyFired=true;delay(100).then(function(){touchEndRecentlyFired=false})};let monitorContextMenuCb=function(ev){if(touchEndRecentlyFired){const logHead="TabsBsTabViewer::monitorContextMenuCb():";this._log(logHead,"suppressing 'contextmenu' event after 'touchend' event");ev.preventDefault()}}.bind(this);let rootElem=this.getRootElement();this._elw.listen(rootElem,"touchend",monitorTouchEndCb,false);this._elw.listen(rootElem,"contextmenu",monitorContextMenuCb,false)},_TabsBsTabViewer_render:function(){this.addClasses("tm-select-none");this._disableContextMenuOnTouchEnd();if(this._isIncognito()){this.addClasses("bg-secondary","text-light","border-dark")}let multiSelectOptions={tabsManager:this._tabsManager,historyFinder:this._historyFinder,incognitoBsTab:this._isIncognito()};this._multiSelectPanel=Classes.MultiSelectPanelViewer.create(multiSelectOptions);this.addBefore(this._multiSelectPanel);this._elw.listen(this._multiSelectPanel,Classes.MultiSelectPanelViewer.Events.SELECTED,this._multiSelectSelectedCb.bind(this));this._elw.listen(this._multiSelectPanel,Classes.MultiSelectPanelViewer.Events.CLOSED,this._multiSelectClosedCb.bind(this));this._elw.listen(this._multiSelectPanel,Classes.MultiSelectPanelViewer.Events.LISTED,this._multiSelectListedCb.bind(this));this._containerViewer=Classes.ContainerViewer.create(this._emptyContainerString);this._queryAndRenderTabs();perfProf.mark("attachContainerStart");this.append(this._containerViewer);perfProf.mark("attachContainerEnd");perfProf.measure("Attach tiles cont.","attachContainerStart","attachContainerEnd")},_resetAsyncQueue:function(respawn=true){if(this._tilesAsyncQueue!=null){this._tilesAsyncQueue.discard()}if(respawn){this._tilesAsyncQueue=Classes.AsyncQueue.create()}else{this._tilesAsyncQueue=null}},_prepareForNewCycle:function(){this._queryCycleNo++;this._recycledTilesCnt=0;this._cachedTilesUpdateNeededCnt=0;this._cachedTilesByTabId=this._tilesByTabId;this._tilesByTabId={};this._tilesGroups=[];this._resetAsyncQueue();this._currentSearchResults=null},_getAllTabGroups:function(){const logHead="TabsBsTabViewer::_getAllTabGroups():";return chromeUtils.wrap(chrome.tabGroups.query,logHead,{})},_processTabGroupsCb:function(tabGroups){const logHead="TabsBsTabViewer::_processTabGroupsCb():";this._log(logHead,tabGroups)},_queryTabsFullMode:async function(){let tabs=this._tabsManager.getTabs();let pinnedBookmarksIdsFromTabs=this._tabsManager.getPinnedBookmarkIdsFromTabs();let pinnedBookmarks=bookmarksManager.getPinnedBookmarks(pinnedBookmarksIdsFromTabs);return tabs.concat(pinnedBookmarks)},_queryTabsSearchMode:async function(){this._setSearchBoxCountBlinking();return await this._searchManager.queryTabs()},_queryAndRenderTabs:function(newSearch=false){const logHead="TabsBsTabViewer::_queryAndRenderTabs("+newSearch+"):";this._log(logHead,"entering");this.blink();this._prepareForNewCycle();let savedQueryCycleNo=this._queryCycleNo;let queryPromise=null;if(this.isSearchActive()){queryPromise=this._queryTabsSearchMode()}else{queryPromise=this._queryTabsFullMode()}queryPromise.then(function(tabs){if(savedQueryCycleNo!=this._queryCycleNo){this._log(logHead,"old query cycle now obsolete, giving up");return}if(this.isSelectMode()){this._multiSelectPanel.resetView()}perfProf.mark("renderStart");if(this.isSearchActive()){this._renderTabsSearchMode(tabs,newSearch)}else{if(this.isListSelectedMode()){this._renderTabsListSelectedMode(this._multiSelectPanel.getTabs())}else{this._renderTabsFullMode(tabs)}}perfProf.mark("renderEnd");perfProf.measure("Rendering","renderStart","renderEnd");if(this.isSelectMode()){perfProf.mark("multiSelectStart");this._computeMultiSelectState();perfProf.mark("multiSelectEnd");perfProf.measure("multiSelect","multiSelectStart","multiSelectEnd")}}.bind(this))},_getCachedTile:function(tab,tabGroup){if(this._cachedTilesByTabId==null){return null}let tile=this._cachedTilesByTabId[tab.id];if(tile==null){return null}this._recycledTilesCnt++;delete this._cachedTilesByTabId[tab.id];tile.updateAsyncQueue(this._tilesAsyncQueue);if(tile.update(tab,tabGroup,Classes.AsyncQueue.priority.LOW)){this._cachedTilesUpdateNeededCnt++}return tile},_renderTile:function(containerViewer,tabGroup,tab){let tile=this._getCachedTile(tab,tabGroup);if(tile==null){tile=Classes.TabTileViewer.create(tab,tabGroup,this._tilesAsyncQueue,this._isIncognito());tile.initSelectMode(this._tileSelectedCb.bind(this),this.setSelectMode.bind(this,true))}tile.setSelectMode(this.isSelectMode());if(this.isSelectMode()){if(tile.isSelected()){this._multiSelectPanel.addTab(tab)}else{tile.setSelected(this._multiSelectPanel.hasTab(tab))}}if(tab.tm.wantsAttention){this._containerViewer.moveToTop(tile)}else{containerViewer.append(tile)}this._tilesByTabId[tab.id]=tile},_renderTabsFlatInner:function(containerViewer,tabs,tabGroup){const logHead="TabsBsTabViewer::_renderTabsFlatInner():";tabs.forEach(safeFnWrapper(this._renderTile.bind(this,containerViewer,tabGroup),null,function(e,tab){this._err(logHead,"iterating through tabs, at tabId",tab!=null?tab.tm.extId:"undefined obj",tab,e)}.bind(this)))},_renderTabsByGroup:function(tabGroups){const logHead="TabsBsTabViewer::_renderTabsByGroup():";tabGroups.forEach(function(tabGroup){let tabs=tabGroup.tabs;if(tabGroup.type==Classes.GroupsBuilder.Type.TAB){this._renderTabsFlatInner(this._containerViewer,tabs)}else{let tilesGroupViewer=Classes.TilesGroupViewer.create(tabGroup,this._expandedGroups,this._isIncognito());tilesGroupViewer.setSelectMode(this.isSelectMode());this._containerViewer.append(tilesGroupViewer);this._renderTabsFlatInner(tilesGroupViewer,tabs,tabGroup);this._tilesGroups.push(tilesGroupViewer);if(this.isSelectMode()){tilesGroupViewer.computeMultiSelectState()}}}.bind(this))},_logCachedTilesStats:function(logHead){if(this._cachedTilesByTabId==null){this._log(logHead,"no cache, no stats");return}this._log(logHead,"reused",this._recycledTilesCnt,"tiles,",Object.keys(this._cachedTilesByTabId).length,"tiles still in cache");this._log(logHead,this._cachedTilesUpdateNeededCnt,"cached tiles needed a re-render")},_renderTabsFullMode:function(tabs){const logHead="TabsBsTabViewer::_renderTabsFullMode():";if(tabs.length==0){this._log(logHead,"no tabs");this._containerViewer.clear();return}perfProf.mark("groupStart");let[pinnedGroups,unpinnedGroups]=this._groupsBuilder.groupByHostname(tabs);perfProf.mark("groupEnd");this._log(logHead,"pinnedGroups =",pinnedGroups,"unpinnedGroups =",unpinnedGroups);this._containerViewer.clear();perfProf.mark("tilesStart");this._renderTabsByGroup(pinnedGroups);this._renderTabsByGroup(unpinnedGroups);this._logCachedTilesStats(logHead);perfProf.mark("tilesEnd");perfProf.measure("Create groups","groupStart","groupEnd");perfProf.measure("Render tiles","tilesStart","tilesEnd")},_renderTabsSearchMode:function(tabs,newSearch){const logHead="TabsBsTabViewer::_renderTabsSearchMode():";perfProf.mark("searchSortStart");tabs=tabs.sort(Classes.TabNormalizer.compareTabsFn);perfProf.mark("searchSortEnd");this._containerViewer.clear();this._setSearchBoxCountBlinking(false);this._setSearchBoxCount(tabs.length);if(newSearch){this._bodyElem.scrollTo(0,0)}if(tabs.length==0){this._log(logHead,"no results");return}this._currentSearchResults=tabs;perfProf.mark("searchRenderStart");this._renderTabsFlatInner(this._containerViewer,tabs);perfProf.mark("searchRenderEnd");this._logCachedTilesStats(logHead)},_renderTabsListSelectedMode:function(tabs){const logHead="TabsBsTabViewer::_renderTabsListSelectedMode():";perfProf.mark("listSelectedSortStart");tabs=tabs.sort(Classes.TabNormalizer.compareTabsFn);perfProf.mark("listSelectedSortEnd");this._containerViewer.clear();this._bodyElem.scrollTo(0,0);if(tabs.length==0){this._log(logHead,"no tabs");return}perfProf.mark("listSelectedRenderStart");this._renderTabsFlatInner(this._containerViewer,tabs);perfProf.mark("listSelectedRenderEnd");this._logCachedTilesStats(logHead)},getTabInfo:function(tabId){return[this._tabsManager.getTabByTabId(tabId),this._tilesByTabId[tabId]]},activateTab:function(tab,incognito=false){const logHead="Classes.TabsBsTabViewer.activateTab():";if(tab.tm.type==Classes.TabNormalizer.type.TAB){chromeUtils.activateTab(tab);return}if(tab.tm.type==Classes.TabNormalizer.type.RCTAB){chromeUtils.wrap(chrome.sessions.restore,logHead,tab.sessionId);return}chromeUtils.queryTabs({url:tab.url,incognito:incognito},logHead).then(function(tabList){if(tabList.length==0){chromeUtils.loadUrl(tab.url,{incognito:incognito})}else{chromeUtils.activateTab(tabList[0])}})},discard:function(){if(!this._options.standardTabs&&!this._options.incognitoTabs){Classes.BsTabViewer.discard.call(this);return}this._resetAsyncQueue(false);this._queryCycleNo++;this._queryAndRenderJob.discard();this._queryAndRenderJob=null;if(this._multiSelectPanel!=null){this._multiSelectPanel.discard();this._multiSelectPanel=null}Classes.BsTabViewer.discard.call(this);this._tabsManager.discard();this._tabsManager=null},_TabsBsTabViewer_searchBoxInactiveInner:function(){this._currentSearchResults=null;this._searchManager.reset();this.setMessage()},_activateSearchBox:function(active=true){Classes.SearchableBsTabViewer._activateSearchBox.apply(this,arguments);const logHead="TabsBsTabViewer::_activateSearchBox("+active+"):";if(!active){this._log(logHead,"switching to full render");this._TabsBsTabViewer_searchBoxInactiveInner();this._queryAndRenderTabs()}else{this._log(logHead,"switching to search render");this._currentSearchResults=null;this._setSearchBoxCount();this.setListSelectedMode(false)}},_reportSearchParseErrors:function(errors){let htmlMsgs=[];for(let i=0;i<errors.length;i++){htmlMsgs.push(`<p class="m-0">${this._safeText(errors[i])}</p>`)}this.setMessage(htmlMsgs.join("\n"),true)},_searchBoxProcessData:function(value){this._assert(value.length!=0);this._searchManager.updateQuery(value);let errors=this._searchManager.getErrors();if(errors==null){this.setMessage()}else{this._reportSearchParseErrors(errors)}perfProf.mark("searchStart");this._queryAndRenderTabs(true);perfProf.mark("searchEnd")},_respondToEnterKey:function(searchBoxText){const logHead="TabsBsTabViewer::_respondToEnterKey("+searchBoxText+"):";if(this._currentSearchResults==null){this._log(logHead,"no search results, nothing to do");return}this._log(logHead,"activating tab Id",this._currentSearchResults[0].id,"(",this._currentSearchResults[0].tm.type,")");Classes.TabsBsTabViewer.activateTab(this._currentSearchResults[0],this._isIncognito())},getSearchParserInfo:function(){if(this._searchQuery==null||!this._searchQuery.isInitialized()){return null}let unoptimizedStats="";if(!isProd()){unoptimizedStats="\nUnoptimized stats:\n"+this._searchQuery.getUnoptimizedStats()}return"Optimized parsed query: "+this._searchQuery.getParsedQuery(Classes.SearchParser.rebuildMode.MIN)+"\n"+"Unoptimized parsed query: "+this._searchQuery.getUnoptimizedParsedQuery(Classes.SearchParser.rebuildMode.MIN)+"\n"+"Unoptimized parsed query (verbose): "+this._searchQuery.getUnoptimizedParsedQuery(Classes.SearchParser.rebuildMode.MAX)+"\n"+"Simplified parsed query: "+this._searchQuery.getSimplifiedQuery()+"\n"+"Optimizer info: "+JSON.stringify(this._searchQuery.getOptimizerInfo(),null,2)+"\n"+"Optimized stats:\n"+this._searchQuery.getOptimizedStats()+unoptimizedStats}});Classes.MenuViewer=Classes.Viewer.subclass({__idPrefix:"MenuViewer",_rootElem:null,_bodyElem:null,_menuElem:null,_options:null,_dropdownBsObj:null,_init:function(options={}){this._options={};this._options.label=options.label??"";this._options.showToggle=options.showToggle??true;this._options.btnClasses=options.btnClasses??["btn","btn-secondary"];this._options.menuExtraClasses=options.menuExtraClasses??[];Classes.Viewer._init.call(this);this._MenuViewer_render()},_MenuViewer_render:function(){const menuId=this._id+"-menu";const menuItemsContainerId=this._id+"-menuitems";let dropdownClasses=[];let menuClasses=["dropdown-menu"];if(this._options.showToggle){if(this._options.label==""){dropdownClasses.push("tm-dropdown-toggle")}dropdownClasses.push("dropdown-toggle")}dropdownClasses.push(...this._options.btnClasses);menuClasses.push(...this._options.menuExtraClasses);let menuButtonHtml=`
	<div class="dropdown h-100">
		<a class="${dropdownClasses.join(" ")}" role="button"
				id="${menuId}" data-bs-toggle="dropdown" aria-expanded="false">
			${this._options.label}
		</a>
		<ul id=${menuItemsContainerId} class="${menuClasses.join(" ")}" aria-labelledby="${menuId}">
		</ul>
	</div>
	`;this._rootElem=this._elementGen(menuButtonHtml);this._bodyElem=this.getElementById(menuItemsContainerId);this._menuElem=this.getElementById(menuId);this._dropdownBsObj=new bootstrap.Dropdown(this._menuElem);this._rootElem.addEventListener("click",function(ev){ev.stopPropagation();this._dropdownBsObj.hide()}.bind(this),false)},_formatDate:function(dateData){let dateObj=dayjs(dateData);return dateObj.fromNow()+" ("+dateObj.format("ddd, MMM D YYYY [at] h:mmA")+")"},appendDivider:function(){this.append(Classes.HtmlViewer.create(`<li><hr class="dropdown-divider"></li>`))},close:function(){this._dropdownBsObj.hide()},open:function(){this._dropdownBsObj.show()},discard:function(){this._rootElem.remove();this._rootElem=null;this._bodyElem=null;this._menuElem=null;this._dropdownBsObj.dispose();this._dropdownBsObj=null;gcChecker.add(this)}});Classes.MenuItemViewer=Classes.Viewer.subclass({__idPrefix:"MenuItemViewer",_rootElem:null,_bodyElem:null,_options:null,_actionFn:null,_init:function(options={}){Classes.Viewer._init.call(this);this.debug();this._options={};this._options.label=options.label??"";this._options.labelText=options.labelText??"";this._options.actionFn=options.actionFn??null;this._options.extraClasses=options.extraClasses??[];this._renderMenuItem();this._actionFn=null;if(this._options.actionFn!=null){this.setAction(this._options.actionFn)}},_renderMenuItem:function(){const bodyId=this._id;let itemClasses=["dropdown-item","tm-dropdown-item"];itemClasses.push(...this._options.extraClasses);const rootHtml=`
		<li class="position-relative">
			<div id="${bodyId}" class="${itemClasses.join(" ")}"></div>
		</li>
	`;this._rootElem=this._elementGen(rootHtml);this._bodyElem=this.getElementById(bodyId);if(this._options.label!=""){this.setHtml(this._options.label)}else{if(this._options.labelText!=""){this.setText(this._options.labelText)}}},setAction:function(fn){if(this._actionFn!=null){this._bodyElem.removeEventListener("click",this._actionFn,false)}this._actionFn=fn;this._bodyElem.addEventListener("click",this._actionFn,false)},selected:function(flag=true){if(flag){this._bodyElem.classList.add("tm-selected");this._bodyElem.setAttribute("aria-current","true")}else{this._bodyElem.classList.remove("tm-selected");this._bodyElem.removeAttribute("aria-current")}},enable:function(flag=true){if(flag){this._bodyElem.classList.remove("disabled")}else{this._bodyElem.classList.add("disabled")}}});Classes.MultiSelectPanelMenuViewer=Classes.MenuViewer.subclass({__idPrefix:"MultiSelectPanelMenuViewer",_eventManager:null,_useIncognitoStyle:null,_listMenuItem:null,_exitMenuItem:null,_pinMenuItem:null,_moveMenuItem:null,_closeMenuItem:null,_init:function(useIncognitoStyle=false){this._useIncognitoStyle=useIncognitoStyle;Classes.MenuViewer._init.call(this,{btnClasses:["mx-2","text-dark"],menuExtraClasses:["tm-dropdown-tile-menu"]});this.debug();this._eventManager=Classes.EventManager.createAs(this.getId()+".eventManager");this._eventManager.attachRegistrationFunctions(this);this._initMenuItems()},_actionCb:function(notifEventName,ev){const logHead="MultiSelectPanelMenuViewer._actionCb():";this._log(logHead,"entering",notifEventName,ev);this._eventManager.notifyListeners(notifEventName)},_addMenuItem:function(labelText,notifEventName){let options={labelText:labelText,actionFn:this._actionCb.bind(this,notifEventName)};let retVal=Classes.MenuItemViewer.create(options);this.append(retVal);return retVal},_initMenuItems:function(){this._listMenuItem=this._addMenuItem("Show selection",Classes.MultiSelectPanelViewer.Events.LISTED);this._exitMenuItem=this._addMenuItem("Exit select mode",Classes.MultiSelectPanelViewer.Events.CLOSED);this.appendDivider();this._pinMenuItem=this._addMenuItem("Pin/unpin selection",Classes.MultiSelectPanelMenuViewer.Events.TABSPINNED);this._moveMenuItem=this._addMenuItem("Move/open selection in new window",Classes.MultiSelectPanelMenuViewer.Events.TABSMOVED);this._closeMenuItem=this._addMenuItem("Close/delete selection",Classes.MultiSelectPanelMenuViewer.Events.TABSCLOSED)},setListSelectedMode:function(flag=true){this._listMenuItem.selected(flag)},discard:function(){this._eventManager.discard();this._eventManager=null;Classes.MenuViewer.discard.call(this)},enableActions:function(flag=true){this._pinMenuItem.enable(flag);this._moveMenuItem.enable(flag);this._closeMenuItem.enable(flag)}});Classes.Base.roDef(Classes.MultiSelectPanelMenuViewer,"Events",{});Classes.Base.roDef(Classes.MultiSelectPanelMenuViewer.Events,"TABSCLOSED","tmTabsClosed");Classes.Base.roDef(Classes.MultiSelectPanelMenuViewer.Events,"TABSMOVED","tmTabsMoved");Classes.Base.roDef(Classes.MultiSelectPanelMenuViewer.Events,"TABSPINNED","tmTabsPinned");Classes.MultiSelectPanelViewer=Classes.Viewer.subclass({__idPrefix:"MultiSelectPanelViewer",_active:null,_elw:null,_tabsElw:null,_eventManager:null,_tabsManager:null,_historyFinder:null,_incognitoBsTab:null,_tabsStoreAll:null,_tabsStoreInView:null,_refreshBookmarksJob:null,_refreshBookmarksDelay:200,_cntAllElem:null,_cntInViewElem:null,_selectElem:null,_menuElem:null,_listCheckboxElem:null,_closeElem:null,_menuViewer:null,_init:function({tabsManager,historyFinder,incognitoBsTab}){Classes.Viewer._init.call(this);this.debug();this._tabsStoreAll=Classes.TabsStoreBase.createAs(this.getId()+".tabsStoreAll");this._tabsStoreInView=Classes.TabsStoreBase.createAs(this.getId()+".tabsStoreInView");this._active=false;this._elw=Classes.EventListenersWrapper.create();this._tabsElw=Classes.EventListenersWrapper.create();this._eventManager=Classes.EventManager.createAs(this.getId()+".eventManager");this._eventManager.attachRegistrationFunctions(this);this._refreshBookmarksJob=Classes.ScheduledJob.createAs(this._id+".refreshBookmarksJob",this._refreshBookmarks.bind(this));this._refreshBookmarksJob.debug();this._tabsManager=tabsManager;this._historyFinder=historyFinder;this._incognitoBsTab=incognitoBsTab;this._renderPanel();this.activate(false)},_setTabsListeners:function(){const logHead="MultiSelectPanelViewer._setTabsListeners():";this._assert(this._tabsManager.isInitialized(),logHead);this._tabsElw.listen(this._tabsManager,Classes.TabsManager.Events.REMOVED,this._tabRemovedCb.bind(this));this._tabsElw.listen(this._tabsManager,Classes.TabsManager.Events.UPDATED,this._tabUpdatedCb.bind(this));this._tabsElw.listen(bookmarksManager,Classes.EventManager.Events.UPDATED,this._bookmarkUpdatedCb.bind(this));if(this._historyFinder!=null){this._tabsElw.listen(this._historyFinder,Classes.EventManager.Events.UPDATED,this._historyUpdatedCb.bind(this))}},_tabRemovedCb:function(ev){const logHead="MultiSelectPanelViewer._tabRemovedCb():";this._log(logHead,"entering",ev.detail.tab.id,ev.detail);this.removeTab(ev.detail.tab)},_tabUpdatedCbInner:function(tab){this._tabsStoreAll.update(tab);if(this._tabsStoreInView.hasById(tab.id)){this._tabsStoreInView.update(tab)}},_tabUpdatedCb:function(ev){const logHead="MultiSelectPanelViewer._tabUpdatedCb():";let changed=0;for(let i=0;i<ev.detail.tabs.length;i++){let tab=ev.detail.tabs[i];if(!this._tabsStoreAll.hasById(tab.id)){continue}this._tabUpdatedCbInner(tab);changed++}this._log(logHead,"changed",changed,ev.detail)},_refreshBookmarks:function(){const logHead="MultiSelectPanelViewer._refreshBookmarks():";let changed=0;let removed=0;let selectedTabs=this._tabsStoreAll.get();for(let i=0;i<selectedTabs.length;i++){let tab=selectedTabs[i];if(tab.tm.type!=Classes.TabNormalizer.type.BOOKMARK){continue}let bm=bookmarksManager.getBmNode(tab.bookmarkId);if(bm==null){this.removeTab(tab,false);removed++;continue}this._tabUpdatedCbInner(bm);changed++}this._log(logHead,"changed",changed,", removed",removed);this._updateCounts()},_bookmarkUpdatedCb:function(ev){const logHead="MultiSelectPanelViewer._bookmarkUpdatedCb():";this._log(logHead,"entering",ev.detail);this._refreshBookmarksJob.run(this._refreshBookmarksDelay)},_refreshHistory:function(urls,removeAll){const logHead="MultiSelectPanelViewer._refreshHistory():";let removed=0;let selectedTabs=[].concat(this._tabsStoreAll.get());this._log(logHead,"selectedTabs:",selectedTabs);for(let i=0;i<selectedTabs.length;i++){let tab=selectedTabs[i];if(![Classes.TabNormalizer.type.HISTORY,Classes.TabNormalizer.type.RCTAB].includes(tab.tm.type)){continue}if(removeAll||urls.includes(tab.url)){this.removeTab(tab,false);removed++}else{}}this._log(logHead,"removed",removed,"of",selectedTabs.length);this._updateCounts()},_historyUpdatedCb:function(ev){const logHead="MultiSelectPanelViewer._historyUpdatedCb():";if(ev.detail.event!=Classes.HistoryFinder.event.REMOVED){this._log(logHead,"ignoring event",ev.detail);return}this._log(logHead,"entering",ev.detail.data.urls,ev.detail);this._refreshHistory(ev.detail.data.urls,ev.detail.data.allHistory)},_renderPanel:function(){const cntInViewId=this._id+"-cnt-view";const cntAllId=this._id+"-cnt-all";const selectId=this._id+"-select";const menuId=this._id+"-menu";const listCheckboxId=this._id+"-list";const closeId=this._id+"-close";const bodyHtml=`
	<div class="card tm-cursor-default text-dark">
		<div class="d-flex align-items-center">
			<input id="${selectId}" class="form-check-input mt-0 ms-1" type="checkbox" value="" style="min-width: 1em;">
			<div id="${menuId}" class=""></div>
			<div>
				<input type="checkbox" class="btn-check" id="${listCheckboxId}" autocomplete="off">
				<label class="tm-btn tm-checkbox-btn me-2 tm-xxs-hide" for="${listCheckboxId}">${icons.list}</label>
			</div>
			<div class="flex-fill me-2 fst-italic fw-light"><span id="${cntAllId}">-1</span><span class="tm-xxs-hide"> total</span> (<span id="${cntInViewId}">-1</span><span class="tm-xxs-hide"> in view</span>)</div>
			<div>
				${icons.closeHtml(closeId,["ps-0"],["tm-close-icon","align-middle"])}
			</div>
		</div>
	</div>
	`;this._rootElem=this._elementGen(bodyHtml);this._cntAllElem=this.getElementById(cntAllId);this._cntInViewElem=this.getElementById(cntInViewId);this._selectElem=this.getElementById(selectId);this._elw.listen(this._selectElem,"click",this._selectAllCb.bind(this),false);this._menuElem=this.getElementById(menuId);this._menuViewer=Classes.MultiSelectPanelMenuViewer.create();this._menuViewer.attachInParentElement(this._menuElem);this._elw.listen(this._menuViewer,Classes.MultiSelectPanelViewer.Events.CLOSED,this._forwardEventCb.bind(this),false);this._elw.listen(this._menuViewer,Classes.MultiSelectPanelViewer.Events.LISTED,this._forwardEventCb.bind(this),false);this._elw.listen(this._menuViewer,Classes.MultiSelectPanelMenuViewer.Events.TABSPINNED,this._tabsPinnedCb.bind(this),false);this._elw.listen(this._menuViewer,Classes.MultiSelectPanelMenuViewer.Events.TABSCLOSED,this._tabsClosedCb.bind(this),false);this._elw.listen(this._menuViewer,Classes.MultiSelectPanelMenuViewer.Events.TABSMOVED,this._tabsMovedCb.bind(this),false);this._listCheckboxElem=this.getElementById(listCheckboxId);this._elw.listen(this._listCheckboxElem,"click",this._listCb.bind(this),false);this._closeElem=this.getElementById(closeId);this._elw.listen(this._closeElem,"click",this._closeCb.bind(this),false)},_selectAllCb:function(ev){const logHead="MultiSelectPanelViewer._selectAllCb():";this._log(logHead,"entering",ev);this._eventManager.notifyListeners(Classes.MultiSelectPanelViewer.Events.SELECTED,{selected:this._selectElem.checked})},_forwardEventCb:function(ev){const logHead="MultiSelectPanelViewer._forwardEventCb():";this._log(logHead,"entering",ev);this._eventManager.notifyListeners(ev.type)},_listCb:function(ev){const logHead="MultiSelectPanelViewer._listCb():";this._log(logHead,"entering",ev);this._eventManager.notifyListeners(Classes.MultiSelectPanelViewer.Events.LISTED)},_closeCb:function(ev){const logHead="MultiSelectPanelViewer._closeCb():";this._log(logHead,"entering",ev);this._eventManager.notifyListeners(Classes.MultiSelectPanelViewer.Events.CLOSED)},_groupSelectedTabs:function(){let retVal={};let selectedTabs=this._tabsStoreAll.get();if(selectedTabs==null){return retVal}for(let i=0;i<selectedTabs.length;i++){let tab=selectedTabs[i];let tabList=retVal[tab.tm.type];if(tabList==null){retVal[tab.tm.type]=tabList=[]}tabList.push(tab)}return retVal},_tabsPinnedCb:function(ev){const logHead="MultiSelectPanelViewer._tabsPinnedCb():";let anyPinned=false;let tabGroups=this._groupSelectedTabs();let tabs=tabGroups[Classes.TabNormalizer.type.TAB]??[];let bookmarks=tabGroups[Classes.TabNormalizer.type.BOOKMARK]??[];if(tabs.length==0&&bookmarks.length==0){this._log(logHead,"empty selection, nothing to do",tabGroups);return}for(let i=0;i<tabs.length&&!anyPinned;i++){if(tabs[i].pinned){anyPinned=true}}for(let i=0;i<bookmarks.length&&!anyPinned;i++){if(bookmarks[i].pinned){anyPinned=true}}this._log(logHead,anyPinned?"unpinning":"pinning",tabs,bookmarks);for(let i=0;i<tabs.length;i++){chromeUtils.wrap(chrome.tabs.update,logHead,tabs[i].id,{pinned:!anyPinned})}if(bookmarks.length==0){return}let bmIds=bookmarks.map(bm=>bm.bookmarkId);if(anyPinned){settingsStore.unpinManyBookmarks(bmIds)}else{settingsStore.pinManyBookmarks(bmIds)}},_confirmClosing:function(tabGroups){let tabCount=tabGroups[Classes.TabNormalizer.type.TAB]?.length;let bmCount=tabGroups[Classes.TabNormalizer.type.BOOKMARK]?.length;let historyCount=tabGroups[Classes.TabNormalizer.type.HISTORY]?.length;let outerList=[];if(tabCount!=null){outerList.push("close "+tabCount+" tab"+(tabCount>1?"s":""))}let innerList=[];if(bmCount!=null){innerList.push(bmCount+" bookmark"+(bmCount>1?"s":""))}if(historyCount!=null){innerList.push(historyCount+" history item"+(historyCount>1?"s":""))}if(innerList.length>0){outerList.push("delete "+innerList.join(" and "))}let msg="Are you sure you want to "+outerList.join(" and ")+"?";return window.confirm(msg)},_tabsClosedCb:function(ev){const logHead="MultiSelectPanelViewer._tabsClosedCb():";let tabGroups=this._groupSelectedTabs();if(tabGroups[Classes.TabNormalizer.type.TAB]==null&&tabGroups[Classes.TabNormalizer.type.BOOKMARK]==null&&tabGroups[Classes.TabNormalizer.type.HISTORY]==null){this._log(logHead,"empty selection, nothing to do",tabGroups);return}if(!this._confirmClosing(tabGroups)){this._log(logHead,"the user cancelled the operation",tabGroups);return}let tabs=tabGroups[Classes.TabNormalizer.type.TAB];if(tabs!=null&&tabs.length!=0){let tabIds=tabs.map(tab=>tab.id);this._log(logHead,"closing standard tabs",tabIds,tabs);chromeUtils.wrap(chrome.tabs.remove,logHead,tabIds)}tabs=tabGroups[Classes.TabNormalizer.type.BOOKMARK];if(tabs!=null&&tabs.length!=0){this._log(logHead,"deleting bookmarks",tabs);for(let i=0;i<tabs.length;i++){chromeUtils.wrap(chrome.bookmarks.remove,logHead,tabs[i].bookmarkId)}}tabs=tabGroups[Classes.TabNormalizer.type.HISTORY];if(tabs!=null&&tabs.length!=0){this._log(logHead,"deleting history items",tabs);for(let i=0;i<tabs.length;i++){chromeUtils.wrap(chrome.history.deleteUrl,logHead,{url:tabs[i].url})}}},_tabsMovedCb:async function(ev){const logHead="MultiSelectPanelViewer._tabsMovedCb():";let window=null;let createData={focused:true,incognito:this._incognitoBsTab};let tabGroups=this._groupSelectedTabs();let tabs=tabGroups[Classes.TabNormalizer.type.TAB];if(tabs!=null){tabs.sort(Classes.TabNormalizer.compareTitlesFn);createData.tabId=tabs.shift().id,window=await chromeUtils.createWindow(createData);if(tabs.length!=0){let moveProperties={index:-1,windowId:window.id};await chromeUtils.wrap(chrome.tabs.move,logHead,tabs.map(tab=>tab.id),moveProperties)}}let urls=[];tabs=tabGroups[Classes.TabNormalizer.type.BOOKMARK];if(tabs!=null){tabs.sort(Classes.TabNormalizer.compareTitlesFn);urls=urls.concat(tabs.map(tab=>tab.url))}tabs=tabGroups[Classes.TabNormalizer.type.HISTORY];if(tabs!=null){tabs.sort(Classes.TabNormalizer.compareTitlesFn);urls=urls.concat(tabs.map(tab=>tab.url))}if(urls.length==0){return}if(window==null){createData.url=urls;window=await chromeUtils.createWindow(createData)}else{let createProperties={active:false,windowId:window.id};for(let i=0;i<urls.length;i++){createProperties.url=urls[i];chromeUtils.wrap(chrome.tabs.create,logHead,createProperties)}}},_updateCounts:function(){const logHead="MultiSelectPanelViewer._updateCounts():";let oldCount=this._cntAllElem.textContent;let newCount=this._tabsStoreAll.getCount();this._cntAllElem.textContent=newCount;this._cntInViewElem.textContent=this._tabsStoreInView.getCount();if(newCount==0&&oldCount!=0){this._log(logHead,"disabling actions");this._menuViewer.enableActions(false)}if(newCount!=0&&oldCount==0){this._log(logHead,"enabling actions");this._menuViewer.enableActions(true)}},discard:function(){if(this.isActive()){this.activate(false)}this._elw.discard();this._elw=null;this._tabsElw.discard();this._tabsElw=null;this._menuViewer.discard();this._menuViewer=null;this._eventManager.discard();this._eventManager=null;this._refreshBookmarksJob.discard();this._refreshBookmarksJob=null;this._tabsManager=null;this._historyFinder=null;this._rootElem.remove();this._rootElem=null;this._tabsStoreAll.discard();this._tabsStoreAll=null;this._tabsStoreInView.discard();this._tabsStoreInView=null;gcChecker.add(this)},activate:function(flag=true){const logHead="MultiSelectPanelViewer.activate():";this._log(logHead,"entering",flag);this._active=flag;if(flag){this._setTabsListeners();this.show()}else{this.hide();this._tabsElw.clear();this._tabsStoreAll.reset();this._tabsStoreInView.reset();this._updateCounts();this.setSelected(false)}},isActive:function(){return this._active},addTab:function(tab){const logHead="MultiSelectPanelViewer.addTab():";this._log(logHead,"adding tab",tab);this._tabsStoreAll.update(tab);let isNewTab=this._tabsStoreInView.update(tab)==null;this._updateCounts();return isNewTab},_removeTabById:function(tabId,updateCounts=true){const logHead="MultiSelectPanelViewer._removeTabById():";this._log(logHead,"removing tab",tabId);this._tabsStoreAll.removeById(tabId);let tabPresent=this._tabsStoreInView.removeById(tabId)!=null;if(updateCounts){this._updateCounts()}return tabPresent},removeTab:function(tab,updateCounts){return this._removeTabById(tab.id)},getTabs:function(){return this._tabsStoreAll.get()},hasTab:function(tab){return this._tabsStoreAll.hasById(tab.id)},resetView:function(){const logHead="MultiSelectPanelViewer.resetView():";this._log(logHead,"entering");this._tabsStoreInView.reset();this._cntInViewElem.textContent=this._tabsStoreInView.getCount()},setSelected:function(flag=true,indeterminate=false){this._selectElem.checked=flag;this._selectElem.indeterminate=indeterminate},setListSelectedMode:function(flag=true){const logHead="MultiSelectPanelViewer.setListSelectedMode():";this._log(logHead,"entering",flag);this._listCheckboxElem.checked=flag;this._menuViewer.setListSelectedMode(flag)}});Classes.Base.roDef(Classes.MultiSelectPanelViewer,"Events",{});Classes.Base.roDef(Classes.MultiSelectPanelViewer.Events,"SELECTED","tmSelected");Classes.Base.roDef(Classes.MultiSelectPanelViewer.Events,"CLOSED","tmClosed");Classes.Base.roDef(Classes.MultiSelectPanelViewer.Events,"LISTED","tmListed");Classes.TabTileViewer=Classes.Viewer.subclass({__idPrefix:"TabTileViewer",_rootElem:null,_bodyElem:null,_selectElem:null,_overlayElem:null,_menuElem:null,_closeElem:null,_renderState:null,_tileColor:null,_renderBodyCompleted:null,_tab:null,_tabGroup:null,_asyncQueue:null,_menuViewer:null,_overlayVisible:false,_touchHoverSerialPromises:null,_pointerUpCancelRecentlyFired:0,_forceIncognitoStyle:null,_selectMode:null,_selectSetSelectedFn:null,_selectModeStartFn:null,_init:function(tab,tabGroup,asyncQueue,forceIncognitoStyle=false){Classes.Viewer._init.apply(this,arguments);this.debug();this._renderBodyCompleted=false;this._touchHoverSerialPromises=Classes.SerialPromises.createAs(this._id+"._touchHoverSerialPromises");this._tab=tab;this._asyncQueue=asyncQueue;this._forceIncognitoStyle=forceIncognitoStyle;this._renderEmptyTile(this._tab.id);this.setSelectMode(false);this.update(tab,tabGroup)},_pointerOverCb:function(ev){if(ev.pointerType=="mouse"){return}const logHead="TabTileViewer._pointerOverCb():";if(this._menuViewer==null){this._log(logHead,"no _menuViewer, can't proceed",ev);return}let openFn=function(){if(this._pointerUpCancelRecentlyFired!=0){this._log(logHead,"suppressing auto-opening dropdown",performance.now()-this._pointerUpCancelRecentlyFired,"ms after 'pointerup'/'pointercancel' event");this._pointerUpCancelRecentlyFired=0;return Promise.resolve()}this._log(logHead,"opening menu",ev);this._menuViewer.open();return Promise.resolve()}.bind(this);this._touchHoverSerialPromises.reset();this._touchHoverSerialPromises.next(delay.bind(null,700),"delay");this._touchHoverSerialPromises.next(openFn,"openFn")},_pointerUpCancelCb:function(ev){if(ev.pointerType=="mouse"){return}const logHead="TabTileViewer._pointerUpCancelCb():";this._log(logHead,"entering");this._pointerUpCancelRecentlyFired=performance.now();delay(500).then(function(){this._pointerUpCancelRecentlyFired=0})},_hoverTransitionEndCb:function(ev){const logHead="TabTileViewer._hoverTransitionEndCb():";if(ev.propertyName!="visibility"){return}this._overlayVisible=window.getComputedStyle(ev.target).visibility!=="hidden";this._log(logHead,"entering, this._overlayVisible:",this._overlayVisible,ev);if(!this._overlayVisible){this._touchHoverSerialPromises.reset();if(this._menuViewer==null){this._log(logHead,"no _menuViewer, can't proceed")}else{this._menuViewer.close()}}},_isIncognito:function(tab){tab=optionalWithDefault(tab,this._tab);return tab.incognito||this._forceIncognitoStyle},_selectMenuCb:function(ev){if(this._selectModeStartFn==null){return}this._selectModeStartFn();this.toggleSelected()},isSelectMode:function(){return this._selectMode},isSelectable:function(){return true},setSelectMode:function(flag=true){if(this._selectMode===flag){return}this._selectMode=flag;this._overlayElem.classList[flag?"add":"remove"]("d-none");this._selectElem.classList[flag?"remove":"add"]("d-none");this._selectElem.checked=false},setSelected:function(flag=true,options={}){let notifyParent=options.notifyParent??true;if(this._selectElem.checked==flag){return}this._selectElem.checked=flag;this._selectSetSelectedFn(this._tab,this._selectElem.checked,options);if(notifyParent){let parentViewer=Classes.Viewer.getViewerByElement(this._rootElem.parentElement);if(parentViewer!=null&&parentViewer.computeMultiSelectState!=null){parentViewer.computeMultiSelectState(flag)}}},toggleSelected:function(flag){if(!this.isSelectMode()){return}this._selectElem.focus();this.setSelected(!this._selectElem.checked)},isSelected:function(){return this._selectElem.checked},initSelectMode:function(setSelectedFn,selectModeStartFn){this._selectSetSelectedFn=setSelectedFn;this._selectModeStartFn=selectModeStartFn},_renderEmptyTile:function(tabId){const bodyId=this._id+"-body";const overlayId=this._id+"-overlay";const selectId=this._id+"-select";const menuId=this._id+"-menu";const closeId=this._id+"-close";const closeIconClass=this._isIncognito()?"tm-close-icon-light":"tm-close-icon";const rootHtml=`
	<div style="min-height: 3em;" class="card tm-hover tm-cursor-default" data-tab-id="${tabId}">
		<div class="d-flex align-items-center">
			<input id="${selectId}" class="form-check-input mt-0 ms-1 d-none" type="checkbox" value="" style="min-width: 1em;">
			<div id="${bodyId}" class="card-body px-2 py-1 text-nowrap tm-stacked-below" style="min-width: 0;">
			</div>
		</div>
		<div id="${overlayId}" class="tm-overlay tm-full-size tm-hover-target">
			<div id="${menuId}" class="tm-tile-toggle-center">
			</div>
			<div class="tm-float-right">
				${icons.closeHtml(closeId,[],[closeIconClass])}
			</div>
		</div>
	</div>
	`;this._setRootElem(this._elementGen(rootHtml));this._bodyElem=this.getElementById(bodyId);this._selectElem=this.getElementById(selectId);this._overlayElem=this.getElementById(overlayId);this._menuElem=this.getElementById(menuId);this._closeElem=this.getElementById(closeId);this.setClickHandler(this._onTileClickCb.bind(this));this.setClickCloseHandler(this._onTileCloseCb.bind(this));this._rootElem.addEventListener("pointerover",this._pointerOverCb.bind(this));this._rootElem.addEventListener("pointerup",this._pointerUpCancelCb.bind(this));this._rootElem.addEventListener("pointercancel",this._pointerUpCancelCb.bind(this));this._menuElem.parentElement.addEventListener("transitionend",this._hoverTransitionEndCb.bind(this))},_colorToCss:{none:{bg:"tm-bg-dark",text:"tm-text-white"},gray:{bg:"tm-bg-gray",text:"tm-text-white"},blue:{bg:"tm-bg-blue",text:"tm-text-white"},red:{bg:"tm-bg-red",text:"tm-text-white"},yellow:{bg:"tm-bg-yellow",text:"tm-text-white"},green:{bg:"tm-bg-green",text:"tm-text-white"},pink:{bg:"tm-bg-pink",text:"tm-text-dark"},purple:{bg:"tm-bg-purple",text:"tm-text-white"},cyan:{bg:"tm-bg-cyan",text:"tm-text-dark"}},_colorToCssIncognito:{none:{bg:"tm-bg-incognito-white",text:"tm-text-incognito-dark"},pink:{bg:"tm-bg-pink",text:"tm-text-incognito-dark"},cyan:{bg:"tm-bg-cyan",text:"tm-text-incognito-dark"}},_getCssByColor:function(color){let retVal=null;if(this._renderState.incognito){retVal=this._colorToCssIncognito[color]}if(retVal!=null){return retVal}return this._colorToCss[color]},_badgeHtml:function(txt,bgColor){let badgeColorDict=this._getCssByColor(bgColor??"none");let extraClasses=[];extraClasses.push(badgeColorDict.bg,badgeColorDict.text);if(txt.length>20){txt=txt.substring(0,20)+"..."}return`<span class="badge tm-text-badge ${extraClasses.join(" ")}">${txt}</span>`},_addBadgesHtml:function(visibleBadgesHtml,badgesList,secondary){badgesList.forEach(function(badge){visibleBadgesHtml.push(this._badgeHtml(badge,secondary?"gray":null))}.bind(this))},_renderMenuInner:function(){switch(this._renderState.tmType){case Classes.TabNormalizer.type.TAB:this._menuViewer=Classes.TabTileMenuViewer.create(this._tab,this._renderState.incognito);break;case Classes.TabNormalizer.type.BOOKMARK:this._menuViewer=Classes.BookmarkTileMenuViewer.create(this._tab,this._renderState.incognito);break;case Classes.TabNormalizer.type.HISTORY:this._menuViewer=Classes.HistoryTileMenuViewer.create(this._tab,this._renderState.incognito);break;default:const logHead="TabTileViewer._renderMenuInner(tile "+this._id+"):";this._err(logHead,"unknown tmType",this._renderState.tmType);return}this._menuViewer.attachInParentElement(this._menuElem);this._menuViewer.setSelectCb(this._selectMenuCb.bind(this))},_renderMenu:function(){const logHead="TabTileViewer._renderMenu(tile "+this._id+"):";this._asyncQueue.enqueue(this._renderMenuInner.bind(this),logHead,Classes.AsyncQueue.priority.LOW)},_updateMenu:function(){if(this._menuViewer==null){return}this._asyncQueue.enqueue(this._menuViewer.update.bind(this._menuViewer,this._tab),"TabTileViewer._updateMenu(tile "+this._id+")",Classes.AsyncQueue.priority.LOW)},_processMenuViewer:function(){if(this._menuViewer==null){this._renderMenu()}else{this._updateMenu()}},_setTileColor:function(color){const logHead="TabTileViewer._setTileColor():";this._assert(color!=null,logHead);if(this._tileColor==color){this._log(logHead,"nothing to do",color,this._tileColor);return}let cgm=settingsStore.getCustomGroupsManager();if(this._tileColor!=null&&this._tileColor!="none"){this._log(logHead,"removing old color",this._tileColor);this.removeClasses("tm-callout",cgm.getCustomGroupCssByColor(this._tileColor))}if(color!="none"){this._log(logHead,"adding color",color);this.addClasses("tm-callout",cgm.getCustomGroupCssByColor(color))}this._tileColor=color},_renderBodyInner:function(){const logHead="TabTileViewer._renderBodyInner():";let visibleBadgesHtml=[];let titleExtraClasses=[];let textMutedClass="text-muted";let lightIconClass="text-secondary";const favIconContainerId=this._id+"-favicon";let favIconClasses=["align-text-bottom"];let favIconParentClasses=[];if(this._renderState.incognito){this.addClasses("tm-bg-incognito","tm-text-incognito","border-dark");textMutedClass="text-white-50";lightIconClass="text-white-50"}switch(this._renderState.audio){case"audible-muted":visibleBadgesHtml.push(icons.volumeMuted());break;case"audible":visibleBadgesHtml.push(icons.volumeAudible);break;case"muted":visibleBadgesHtml.push(icons.volumeMuted(lightIconClass));break;default:if(this._renderState.audio!=null){this._err(logHead,"unknown this._renderState.audio =",this._renderState.audio)}break}if(this._renderState.customGroupName!=null){let cgm=settingsStore.getCustomGroupsManager();visibleBadgesHtml.push(this._badgeHtml(this._renderState.customGroupName,this._renderState.customGroupColor))}this._setTileColor(this._renderState.customGroupColor);this._addBadgesHtml(visibleBadgesHtml,this._renderState.primaryShortcutBadges);this._addBadgesHtml(visibleBadgesHtml,this._renderState.secondaryShortcutBadges,true);this._addBadgesHtml(visibleBadgesHtml,this._renderState.visualBadges);if(this._renderState.pinned){visibleBadgesHtml.push(icons.thumbtack())}else{if(this._renderState.pinInherited){visibleBadgesHtml.push(icons.thumbtack("tm-fa-thumbtack-tile",lightIconClass))}}if(this._renderState.status!=null){switch(this._renderState.status){case"unloaded":titleExtraClasses.push("fst-italic");favIconClasses.push("tm-favicon-bw");break;case"loading":case"complete":break;default:this._err(logHead,"unknown this._renderState.status =",this._renderState.status);break}}let specialIcon="";let urlLine=this._renderState.url;switch(this._renderState.tmType){case Classes.TabNormalizer.type.BOOKMARK:specialIcon=icons.bookmark;if(this._renderState.folder!=""){urlLine=this._renderState.folder+" | "+urlLine}break;case Classes.TabNormalizer.type.RCTAB:specialIcon=icons.history("tm-fa-recently-closed");break;case Classes.TabNormalizer.type.HISTORY:specialIcon=icons.history("tm-fa-history");break;case Classes.TabNormalizer.type.TAB:break;default:this._err(logHead,"unknown this._renderState.tmType =",this._renderState.tmType);break}let throbberHtml="";if(this._renderState.status=="loading"){favIconClasses.push("tm-favicon-16-shrunk");favIconParentClasses.push("tm-favicon-shrunk-parent");throbberHtml=`
		<span class="position-absolute" style="top: 3px; left: 0px; z-index:2;">
			<span class="tm-throbber tm-throbber-params">
				<span class="tm-throbber-arc-mask">
					<span class="tm-throbber-arc"></span>
				</span>
				<span class="tm-throbber-arc-mask tm-throbber-arc-mask-mirrored">
					<span class="tm-throbber-arc"></span>
				</span>
			</span>
		</span>`}else{favIconClasses.push("tm-favicon-16");if(specialIcon==""){favIconParentClasses.push("pe-2")}if(this._renderState.wantsAttention){favIconClasses.push("tm-favicon-pulse")}}const bodyHtml=`
		<p class="card-title text-truncate tm-tile-title mb-0">
			<span id="${favIconContainerId}" class="${favIconParentClasses.join(" ")}" style="position: relative;">
				${throbberHtml}
				<!-- The favicon goes here -->
			</span>${specialIcon}<span class="${textMutedClass} ${titleExtraClasses.join(" ")}">${this._safeText(this._renderState.title)}</span>
		</p>
		<div class="d-flex lh-1">
			<p class="flex-grow-1 align-self-center text-truncate tm-tile-url">
				<small class="lh-base ${textMutedClass}">${this._safeText(urlLine)}</small>
			</p>
			<p class="align-self-center card-text small" style="text-align: right;">
				${visibleBadgesHtml.join(" ")}
			</p>
		</div>
	`;this.setHtml(bodyHtml);let favIconContainerElem=this.getElementById(favIconContainerId);let favIconOptions={src:this._renderState.imgUrl,srcBackup:this._renderState.imgUrlBackup,extraClasses:favIconClasses};let favIconViewer=Classes.ImageViewer.create(favIconOptions);favIconViewer.appendInParentElement(favIconContainerElem);if(this._renderState.showCloseButton){this._closeElem.classList.remove("d-none")}else{this._closeElem.classList.add("d-none")}if(this._renderState.showMenu){this._menuElem.classList.remove("d-none");this._processMenuViewer()}else{this._menuElem.classList.add("d-none")}},_getTabMetaTags:function(){const logHead="TabTileViewer._getTabMetaTags("+this._tab.id+"):";if(["chrome:","chrome-extension:","chrome-error:"].includes(this._tab.tm.protocol)){this._log(logHead,"can't access URL with protocol \""+this._tab.tm.protocol+'"',this._tab.url);return Promise.resolve(null)}if(this._tab.status=="unloaded"||this._tab.discarded){return Promise.resolve(null)}return chromeUtils.inject(this._tab.id,"content-gen/inject-getMeta.js").then(function(result){if(result==null){return null}if(result.length==1){if(result[0]==null){this._err(logHead,"the injected script failed to generate a return value",result);return null}return result[0].parsed}this._err(logHead,"unknown format for result =",result);return null}.bind(this),function(chromeLastError){this._err(logHead,"unknown error:",chromeLastError.message,this._tab);return chromeLastError}.bind(this))},_renderBody:function(queuePriority){this._renderBodyCompleted=false;this._asyncQueue.enqueue(function(){this._renderBodyInner();this._renderBodyCompleted=true}.bind(this),"tile "+this._id+": ",queuePriority)},_onTileClickCb:function(ev){if(this.isSelectMode()){this.toggleSelected()}else{Classes.TabsBsTabViewer.activateTab(this._tab,this._forceIncognitoStyle)}},_onTileCloseCb:function(ev){const logHead="TabTileViewer._onTileCloseCb("+this._tab.id+"):";let removeFn=chrome.tabs.remove;let fnParam=this._tab.id;let completionMsg="completed";switch(this._tab.tm.type){case Classes.TabNormalizer.type.BOOKMARK:removeFn=chrome.bookmarks.remove;fnParam=this._tab.bookmarkId;completionMsg="bookmark deleted";break;case Classes.TabNormalizer.type.HISTORY:removeFn=chrome.history.deleteUrl;fnParam={url:this._tab.url};completionMsg="history item deleted";break;case Classes.TabNormalizer.type.TAB:break;default:this._err(logHead,"unknown tab type",this_tab.tm.type);break}chromeUtils.wrap(removeFn,logHead,fnParam).then(function(){this._log(logHead,completionMsg,fnParam)}.bind(this));ev.stopPropagation()},_isThisPopupTab:function(tab){return tab.id==popupDocker.getOwnTabId()},_cleanupUrl:function(tab){let url=tab.url;if(url=="chrome://newtab/"){return"New tab"}if(this._isThisPopupTab(tab)){return"This popup window"}if(url.startsWith("https://")){return url.substring(8)}return url},updateAsyncQueue:function(asyncQueue){this._asyncQueue=asyncQueue},_createRenderState:function(tab,tabGroup){let renderState={};renderState.id=tab.id;renderState.tmType=tab.tm.type;renderState.title=tab.title;renderState.sortTitle=tab.tm.sortTitle;renderState.url=this._cleanupUrl(tab);if(tabGroup!=null){renderState.tabGroupTitle=tabGroup.title}else{renderState.tabGroupTitle=null}if(tab.favIconUrl!=null){renderState.imgUrl=tab.favIconUrl;renderState.imgUrlBackup=tab.tm.cachedFavIconUrl}else{if(tabGroup!=null&&tabGroup.favIconUrl!=null){renderState.imgUrl=tabGroup.favIconUrl;renderState.imgUrlBackup=tab.tm.cachedFavIconUrl}else{renderState.imgUrl=tabNormalizer.buildCachedFavIconUrl("");renderState.imgUrlBackup=renderState.imgUrl}}renderState.networkOnline=window.navigator.onLine;renderState.wantsAttention=tab.tm.wantsAttention;renderState.incognito=this._isIncognito(tab);if(tab.audible){if(tab.mutedInfo!=null&&tab.mutedInfo.muted){renderState.audio="audible-muted"}else{renderState.audio="audible"}}else{if(tab.mutedInfo!=null&&tab.mutedInfo.muted){renderState.audio="muted"}else{renderState.audio=null}}if(tab.tm.customGroupName!=null){renderState.customGroupName=tab.tm.customGroupName;let cgm=settingsStore.getCustomGroupsManager();renderState.customGroupColor=cgm.getCustomGroupColor(tab.tm.customGroupName)}else{renderState.customGroupName=null;renderState.customGroupColor="none"}renderState.primaryShortcutBadges=tmUtils.deepCopy(tab.tm.primaryShortcutBadges);renderState.secondaryShortcutBadges=tmUtils.deepCopy(tab.tm.secondaryShortcutBadges);renderState.visualBadges=tmUtils.deepCopy(tab.tm.visualBadges);renderState.pinned=tab.pinned;renderState.pinInherited=tab.tm.pinInherited!=null;renderState.status=tab.status;renderState.showMenu=true;renderState.showCloseButton=true;if(this._isThisPopupTab(tab)||tab.tm.type==Classes.TabNormalizer.type.RCTAB){renderState.showMenu=false;renderState.showCloseButton=false}if(tab.tm.type==Classes.TabNormalizer.type.BOOKMARK){renderState.folder=tab.tm.folder;if(tab.unmodifiable!=null){renderState.showCloseButton=false}}return renderState},_isRenderCompleted:function(){if(this._menuViewer==null){return false}},update:function(tab,tabGroup,queuePriority){const logHead="TabTileViewer.update():";if(tab==null){this._tab.activated=true;tab=this._tab}else{this._assert(this._tab.id==tab.id,logHead,"tab.id changed from",this._tab.id,"to",tab.id);this._assert(this._tab.tm.type==tab.tm.type,logHead,"type changed from",this._tab.tm.type,"to",tab.tm.type,"for tab",this._tab.tm.extId);this._tab=tab}if(tabGroup!=null){this._tabGroup=tabGroup}let pastRenderState=this._renderState;this._renderState=this._createRenderState(tab,this._tabGroup);if(!this._renderBodyCompleted){this._renderBody();return true}this._assert(pastRenderState!=null);if(tmUtils.isEqual(pastRenderState,this._renderState)){if(this._renderState.showMenu){this._processMenuViewer()}return false}this._renderBody();return true},getTabId:function(){return this._tab.id},getTabInfo:function(){return this._tab},getRenderState:function(){return this._renderState},setClickCloseHandler:function(fn){this._closeElem.addEventListener("click",fn,false)},setClickHandler:function(fn){this._rootElem.addEventListener("click",fn,false);this._selectElem.addEventListener("click",fn,false)}});Classes.TileMenuViewer=Classes.MenuViewer.subclass({__idPrefix:"TileMenuViewer",_useIncognitoStyle:null,_selectCb:null,_selectMenuItem:null,_init:function(useIncognitoStyle=false){this._useIncognitoStyle=useIncognitoStyle;Classes.MenuViewer._init.call(this,{btnClasses:["btn",this._useIncognitoStyle?"btn-light":"btn-secondary"],menuExtraClasses:["tm-dropdown-tile-menu"]});this.debug()},_actionSelectCb:function(ev){if(this._selectCb!=null){this._selectCb(ev)}},_initSelectMenuItem:function(){options={labelText:"Select",actionFn:this._actionSelectCb.bind(this)};this._selectMenuItem=Classes.MenuItemViewer.create(options);this.append(this._selectMenuItem)},setSelectCb:function(fn){this._selectCb=fn}});Classes.TabTileMenuViewer=Classes.TileMenuViewer.subclass({__idPrefix:"TabTileMenuViewer",_tab:null,_titleMenuItem:null,_pinMenuItem:null,_unpinByBookmarkMenuItem:null,_muteMenuItem:null,_highlightMenuItem:null,_playMenuItem:null,_suspendMenuItem:null,_closeMenuItem:null,_shortcutMenuItems:null,_init:function(tab,useIncognitoStyle){Classes.TileMenuViewer._init.call(this,useIncognitoStyle);this.debug();this._tab=tab;this._assert(this._tab.tm.type==Classes.TabNormalizer.type.TAB);this._initMenuItems()},_setShortcutMenuItems:function(){let sm=settingsStore.getShortcutsManager();let scKeys=sm.getShortcutKeysForTab(this._tab,false);this._shortcutMenuItems=[];scKeys.forEach(function(key){let options={labelText:"Move tab to match shortcut "+sm.keyToUiString(key),actionFn:this._actionSetCandidateCb.bind(this,key)};let item=Classes.MenuItemViewer.create(options);this._shortcutMenuItems.push(item);this.append(item)}.bind(this))},_updateShortcutMenuItems:function(){for(let i=0;i<this._shortcutMenuItems.length;i++){this._shortcutMenuItems[i].detach()}this._shortcutMenuItems=[];this._setShortcutMenuItems()},_initMenuItems:function(){let options={actionFn:this._actionActivateCb.bind(this),extraClasses:["text-wrap"]};this._titleMenuItem=Classes.MenuItemViewer.create(options);this._titleMenuItem.setHtml("<b>"+this._safeText(this._tab.title)+"</b>");this.append(this._titleMenuItem);this._initSelectMenuItem();options={labelText:this._tab.pinned?"Unpin":"Pin",actionFn:this._actionPinToggleCb.bind(this)};this._pinMenuItem=Classes.MenuItemViewer.create(options);this.append(this._pinMenuItem);options={labelText:"Unpin bookmark",actionFn:this._actionUnpinByBookmarkCb.bind(this)};this._unpinByBookmarkMenuItem=Classes.MenuItemViewer.create(options);if(this._tab.tm.pinInherited==null){this._unpinByBookmarkMenuItem.hide()}this.append(this._unpinByBookmarkMenuItem);options={labelText:this._tab.mutedInfo.muted?"Unmute":"Mute",actionFn:this._actionMuteToggleCb.bind(this)};this._muteMenuItem=Classes.MenuItemViewer.create(options);this.append(this._muteMenuItem);options={labelText:this._tab.highlighted?"Remove highlight":"Highlight",actionFn:this._actionHighlightToggleCb.bind(this)};this._highlightMenuItem=Classes.MenuItemViewer.create(options);this.append(this._highlightMenuItem);options={labelText:"Move to least tabbed window",actionFn:this._actionMoveToLeastTabbedCb.bind(this)};this._moveToLeastTabbedMenuItem=Classes.MenuItemViewer.create(options);this.append(this._moveToLeastTabbedMenuItem);options={labelText:"Suspend (discard from memory)",actionFn:this._actionSuspendCb.bind(this)};this._suspendMenuItem=Classes.MenuItemViewer.create(options);if(this._tab.discarded||this._tab.status=="unloaded"){this._suspendMenuItem.enable(false)}this.append(this._suspendMenuItem);options={labelText:"Close",actionFn:this._actionCloseCb.bind(this)};this._closeMenuItem=Classes.MenuItemViewer.create(options);this.append(this._closeMenuItem);this._setShortcutMenuItems()},_updateMenuItems:function(){this._titleMenuItem.setHtml("<b>"+this._safeText(this._tab.title)+"</b>");this._pinMenuItem.setText(this._tab.pinned?"Unpin":"Pin");if(this._tab.tm.pinInherited!=null){this._unpinByBookmarkMenuItem.show()}else{this._unpinByBookmarkMenuItem.hide()}if(this._tab.discarded||this._tab.status=="unloaded"){this._suspendMenuItem.enable(false)}else{this._suspendMenuItem.enable()}this._muteMenuItem.setText(this._tab.mutedInfo.muted?"Unmute":"Mute");this._highlightMenuItem.setText(this._tab.highlighted?"Remove highlight":"Highlight");this._updateShortcutMenuItems()},_actionActivateCb:function(ev){Classes.TabsBsTabViewer.activateTab(this._tab,this._useIncognitoStyle)},_actionPinToggleCb:function(ev){const logHead="TabTileMenuViewer._actionPinToggleCb("+this._tab.id+"):";chromeUtils.wrap(chrome.tabs.update,logHead,this._tab.id,{pinned:!this._tab.pinned}).then(function(){this._log(logHead,"completed")}.bind(this))},_actionUnpinByBookmarkCb:function(ev){const logHead="TabTileMenuViewer._actionUnpinByBookmarkCb():";settingsStore.unpinBookmark(this._tab.tm.pinInherited.id);this._log(logHead,"completed for bm",this._tab.id)},_actionMuteToggleCb:function(ev){const logHead="TabTileMenuViewer._actionMuteToggleCb("+this._tab.id+"):";chromeUtils.wrap(chrome.tabs.update,logHead,this._tab.id,{muted:!this._tab.mutedInfo.muted}).then(function(){this._log(logHead,"completed")}.bind(this))},_actionHighlightToggleCb:function(ev){const logHead="TabTileMenuViewer._actionHighlightToggleCb("+this._tab.id+"):";chromeUtils.wrap(chrome.tabs.update,logHead,this._tab.id,{highlighted:!this._tab.highlighted}).then(function(){this._log(logHead,"completed")}.bind(this))},_actionPlayToggleCb:function(ev){const logHead="TabTileMenuViewer._actionPlayToggleCb("+this._tab.id+"):";chromeUtils.inject(this._tab.id,"content-gen/inject-togglePlay.js").then(function(result){if(result==null){return null}this._log(logHead,result);if(result.length==1){if(result[0]==null){this._err(logHead,"the injected script failed to generate a return value",result);return null}return result[0]}this._err(logHead,"unknown format for result =",result);return null}.bind(this),function(chromeLastError){this._err(logHead,"unknown error:",chromeLastError.message,this._tab);return chromeLastError}.bind(this))},_actionMoveToLeastTabbedCb:function(ev){const logHead="TabTileMenuViewer._actionMoveToLeastTabbedCb("+this._tab.id+"):";chromeUtils.moveTabToLeastTabbedWindow(this._tab,false).then(function(result){if(result!=null){this._log(logHead,"completed")}else{this._log(logHead,"no action taken")}}.bind(this))},_actionSuspendCb:function(ev){chromeUtils.discardTab(this._tab)},_actionCloseCb:function(ev){const logHead="TabTileMenuViewer._actionCloseCb("+this._tab.id+"):";chromeUtils.wrap(chrome.tabs.remove,logHead,this._tab.id).then(function(){this._log(logHead,"completed")}.bind(this))},_actionSetCandidateCb:function(key,ev){const logHead="TabTileMenuViewer._actionSetCandidateCb("+this._tab.id+", "+key+"):";let sm=settingsStore.getShortcutsManager();let candidateTabs=sm.getShortcutInfo(key).candidateTabs;this._assert(candidateTabs!=null);this._log(logHead,"entering, first candidate is:",candidateTabs[0]);chromeUtils.wrap(chrome.tabs.move,logHead,this._tab.id,{index:candidateTabs[0].index,windowId:candidateTabs[0].windowId})},update:function(tab){this._tab=tab;this._updateMenuItems()}});Classes.BookmarkTileMenuViewer=Classes.TileMenuViewer.subclass({__idPrefix:"BookmarkTileMenuViewer",_bm:null,_titleMenuItem:null,_titleElem:null,_subtitleElem:null,_openBookmarkManagerMenuItem:null,_pinMenuItem:null,_deleteMenuItem:null,_init:function(bm,useIncognitoStyle){Classes.TileMenuViewer._init.call(this,useIncognitoStyle);this.debug();this._bm=bm;this._assert(this._bm.tm.type==Classes.TabNormalizer.type.BOOKMARK);this._initMenuItems()},_renderSubtitleHtml:function(folder){let createdText=this._formatDate(this._bm.dateAdded);let typeHtml="Bookmark";if(this._bm.unmodifiable!=null){typeHtml=`Read-only bookmark (reason: "${this._safeText(this._bm.unmodifiable)}")`}return`
	${typeHtml} at <i>${folder}</i><br>Created ${createdText}
	`},_renderTitle:function(){const titleId=this._id+"-title";const subtitleId=this._id+"-subtitle";let titleHtml=`
		<div id="${titleId}"></div>
		<div id="${subtitleId}"></div>
	`;this._titleMenuItem=Classes.MenuItemViewer.create({actionFn:this._actionActivateCb.bind(this)});this._titleMenuItem.setHtml(titleHtml);this.append(this._titleMenuItem);this._titleElem=this.getElementById(titleId);this._subtitleElem=this.getElementById(subtitleId);this._updateTitleMenuItem()},_updateTitleMenuItem:function(){this._titleElem.innerHTML=`<b>${this._safeText(this._bm.title)}</b>`;let folder=this._bm.tm.folder;if(folder!=""){this._subtitleElem.innerHTML=this._renderSubtitleHtml(folder);return}folder=bookmarksManager.getBmFolderSync(this._bm);if(folder!=null){this._subtitleElem.innerHTML=this._renderSubtitleHtml(folder);return}bookmarksManager.getBmFolderAsync(this._bm).then(function(folder){this._subtitleElem.innerHTML=this._renderSubtitleHtml(folder)}.bind(this))},_initMenuItems:function(){this._renderTitle();let options=null;if(this._bm.parentId!=null){options={labelText:"Open folder in Chrome Bookmark manager",actionFn:this._actionBookmarkManagerCb.bind(this)};this._openBookmarkManagerMenuItem=Classes.MenuItemViewer.create(options);this.append(this._openBookmarkManagerMenuItem)}this._initSelectMenuItem();options={labelText:this._bm.pinned?"Unpin":"Pin",actionFn:this._actionPinToggleCb.bind(this)};this._pinMenuItem=Classes.MenuItemViewer.create(options);this.append(this._pinMenuItem);if(this._bm.unmodifiable==null){options={labelText:"Delete",actionFn:this._actionDeleteCb.bind(this)};this._deleteMenuItem=Classes.MenuItemViewer.create(options);this.append(this._deleteMenuItem)}},_updateMenuItems:function(){this._updateTitleMenuItem();this._pinMenuItem.setText(this._bm.pinned?"Unpin":"Pin")},_actionActivateCb:function(ev){Classes.TabsBsTabViewer.activateTab(this._bm,this._useIncognitoStyle)},_actionBookmarkManagerCb:function(ev){let url="chrome://bookmarks/?id="+this._bm.parentId;chromeUtils.loadUrl(url)},_actionPinToggleCb:function(ev){const logHead="BookmarkTileMenuViewer._actionPinToggleCb("+this._bm.id+"):";if(this._bm.pinned){this._log(logHead,"unpinning");settingsStore.unpinBookmark(this._bm.bookmarkId)}else{this._log(logHead,"pinning");settingsStore.pinBookmark(this._bm.bookmarkId)}},_actionDeleteCb:function(ev){const logHead="BookmarkTileMenuViewer._actionDeleteCb("+this._bm.id+"):";chromeUtils.wrap(chrome.bookmarks.remove,logHead,this._bm.bookmarkId).then(function(){this._log(logHead,"completed")}.bind(this))},update:function(bm){this._bm=bm;this._updateMenuItems()}});Classes.HistoryTileMenuViewer=Classes.TileMenuViewer.subclass({__idPrefix:"HistoryTileMenuViewer",_item:null,_titleMenuItem:null,_titleElem:null,_subtitleElem:null,_deleteMenuItem:null,_init:function(item,useIncognitoStyle){Classes.TileMenuViewer._init.call(this,useIncognitoStyle);this.debug();this._item=item;this._assert(this._item.tm.type==Classes.TabNormalizer.type.HISTORY);this._initMenuItems()},_renderTitle:function(){const titleId=this._id+"-title";const subtitleId=this._id+"-subtitle";let titleHtml=`
		<div id="${titleId}"></div>
		<div id="${subtitleId}"></div>
	`;this._titleMenuItem=Classes.MenuItemViewer.create({actionFn:this._actionActivateCb.bind(this)});this._titleMenuItem.setHtml(titleHtml);this.append(this._titleMenuItem);this._titleElem=this.getElementById(titleId);this._subtitleElem=this.getElementById(subtitleId);this._updateTitleMenuItem()},_updateTitleMenuItem:function(){this._titleElem.innerHTML=`<b>${this._safeText(this._item.title)}</b>`;let visitsCnt=this._item.visitCount+this._item.typedCount;let lastVisited=this._formatDate(this._item.lastVisitTime);let midString=`${visitsCnt} times, last`;if(visitsCnt==1){midString="once"}this._subtitleElem.innerHTML=`History item, visited ${midString} ${lastVisited}`},_initMenuItems:function(){this._renderTitle();this._initSelectMenuItem();let options={labelText:"Delete",actionFn:this._actionDeleteCb.bind(this)};this._deleteMenuItem=Classes.MenuItemViewer.create(options);this.append(this._deleteMenuItem)},_updateMenuItems:function(){this._updateTitleMenuItem()},_actionActivateCb:function(ev){Classes.TabsBsTabViewer.activateTab(this._item,this._useIncognitoStyle)},_actionDeleteCb:function(ev){const logHead="HistoryTileMenuViewer._actionDeleteCb("+this._item.url+"):";chromeUtils.wrap(chrome.history.deleteUrl,logHead,{url:this._item.url}).then(function(){this._log(logHead,"completed")}.bind(this))},update:function(item){this._item=item;this._updateMenuItems()}});Classes.PopupMenuViewer=Classes.MenuViewer.subclass({__idPrefix:"PopupMenuViewer",_popupViewer:null,_activeBsTabId:null,_bsTabMenuContainer:null,_bsTabMenuItems:null,_multiSelectMenuItem:null,_enterMultiSelectText:"Enter select mode",_exitMultiSelectText:"Exit select mode",_init:function(popupViewer){Classes.MenuViewer._init.call(this,{btnClasses:["btn","tm-menu-icon"],showToggle:false});this.addClasses("mx-2");this.debug();this._popupViewer=popupViewer;this._activeBsTabId=localStore.getActiveBsTabId();this._initMenuItems();localStore.addEventListener(Classes.EventManager.Events.UPDATED,this._localStoreUpdatedCb.bind(this))},_localStoreUpdatedCb:function(ev){const logHead="PopupMenuViewer._localStoreUpdatedCb():";let activeBsTabId=localStore.getActiveBsTabId();if(this._activeBsTabId==activeBsTabId){this._log(logHead,"activeBsTabId unchanged, ignoring key",ev.detail.key);return}this._activeBsTabId=activeBsTabId;this._selectBsTabMenuItem(activeBsTabId)},addBsTabMenuItem:function(bsTabLabel,menuText,startHidden=false){let bsTabId=this._popupViewer.getBsTabIdByLabel(bsTabLabel);let options={labelText:menuText,actionFn:this._actionActivateBsTab.bind(this,bsTabId)};let menuItem=Classes.MenuItemViewer.create(options);if(startHidden){menuItem.hide()}this._bsTabMenuContainer.append(menuItem);this._bsTabMenuItems[bsTabId]=menuItem;this._selectBsTabMenuItem(this._activeBsTabId);return menuItem},updateBsTabMenuItem:function(bsTabLabel,menuText,hide){const logHead="PopupMenuViewer.updateBsTabMenuItem():";let bsTabId=this._popupViewer.getBsTabIdByLabel(bsTabLabel);let menuItem=this._bsTabMenuItems[bsTabId];if(menuItem==null){this._err(logHead,"menu item not found:",bsTabId);return}if(menuText!=null){menuItem.setText(menuText)}if(hide!=null){if(hide){menuItem.hide()}else{menuItem.show()}}this._selectBsTabMenuItem(this._activeBsTabId);return menuItem},updateMultiSelectMenuItem:function(activeBsTabId){const logHead="PopupMenuViewer.updateMultiSelectMenuItem():";let activeBsTab=this._popupViewer.getBsTabById(activeBsTabId);if(activeBsTabId==this._popupViewer.getBsTabIdByLabel("settings")||activeBsTab==null){if(activeBsTab==null){this._log(logHead,"this._popupViewer not ready",activeBsTabId)}else{this._log(logHead,"disabling menu item for settings tab",activeBsTabId)}this._multiSelectMenuItem.enable(false);this._multiSelectMenuItem.setHtml(this._enterMultiSelectText);return}this._log(logHead,"entering, activeBsTabId =",activeBsTabId);this._multiSelectMenuItem.enable();this._multiSelectMenuItem.setHtml(activeBsTab.isSelectMode()?this._exitMultiSelectText:this._enterMultiSelectText)},_selectBsTabMenuItem:function(highlightBsTabId){for(let[bsTabId,bsTabMenuItem]of Object.entries(this._bsTabMenuItems)){if(bsTabId==highlightBsTabId){bsTabMenuItem.selected()}else{bsTabMenuItem.selected(false)}}this.updateMultiSelectMenuItem(highlightBsTabId)},_initMenuItems:function(){this._bsTabMenuItems=[];this._bsTabMenuContainer=Classes.ContainerViewer.create();this.append(this._bsTabMenuContainer);if(localStore.isPopupDocked()){this._bsTabMenuContainer.hide()}else{this.appendDivider()}this._multiSelectMenuItem=Classes.MenuItemViewer.create({actionFn:this._actionToggleSelectModeCb.bind(this)});this.updateMultiSelectMenuItem(this._activeBsTabId);this.append(this._multiSelectMenuItem)},_actionActivateBsTab:function(bsTabId,ev){this._popupViewer.activateBsTabById(bsTabId)},_actionToggleSelectModeCb:function(ev){this._popupViewer.getBsTabById(this._activeBsTabId).toggleSelectMode()},update:function(){}});Classes.NewTabAction=Classes.Base.subclass({_newTabButtonViewer:null,_init:function(){Classes.Base._init.call(this);let btnOptions={btnExtraClasses:["tm-plus-icon"]};this._newTabButtonViewer=Classes.ButtonViewer.create(btnOptions);this._newTabButtonViewer.onButtonClickCb=this._createNewTab.bind(this);popupViewer.appendButton(this._newTabButtonViewer)},_launchOrSearch:function(urlOrSearch,incognito){const logHead="NewTabAction::_launchOrSearch(): ";let searchUrl=optionalWithDefault(settingsStore.getOptionSearchUrl(),"https://www.google.com/search?q=%s");if(!isUrl(urlOrSearch)){this._log(logHead+"not a URL, opening a search page instead: "+urlOrSearch);urlOrSearch=searchUrl.replace("%s",urlOrSearch)}chromeUtils.loadUrl(urlOrSearch,{incognito:incognito})},_createNewTab:function(ev){const logHead="NewTabAction::_createNewTab():";let searchQuery=popupViewer.getSearchQuery();let incognito=popupViewer.isIncognitoBsTabActive();this._log(logHead,"the search query is:",searchQuery);if(searchQuery==null){chromeUtils.createTab({incognito:incognito});return}this._launchOrSearch(searchQuery,incognito)}});window.addEventListener("error",function(e){console.error("Unhandled exception: "+e.error.message,e);return false});window.addEventListener("load",init);var popupMsgServer=null;function testSettings(){settingsStore.setOptionSearchUrl("https://duckduckgo.com/?q=%s");settingsStore.setOptionAdvancedMenu(true);settingsStore.unpinGroup("Work");settingsStore.pinGroup("Tech news");settingsStore.getShortcutsManager().setShortcut(window.ExtCommands.SHORTCUT01,{title:"Gmail",hostname:"mail.google.com"});settingsStore.getShortcutsManager().setShortcut(window.ExtCommands.SHORTCUT02,{title:"Los Angeles Public Library",url:"https://lapl.overdrive.com/search?query=%s",useClipboard:true});settingsStore.getShortcutsManager().setShortcut(window.ExtCommands.SHORTCUT03,{title:"Wikipedia",url:"https://en.wikipedia.org/wiki/%s",useClipboard:true});settingsStore.getCustomGroupsManager().setCustomGroup("Microsoft",{favIconUrl:"https://azurecomcdn.azureedge.net/cvt-5a6d098bd41d86e10abc9c93a784dea7f4f9eccc980ab08c0ffe9f3c2412a6e8/images/icon/favicon.ico",color:"red",matchList:".microsoft.com"});settingsStore.getCustomGroupsManager().setCustomGroup("Work",{favIconUrl:"https://community.atlassian.com/html/assets/favicon-16x16.png",color:"blue",matchList:"jira.\n  wiki.    \n .sharepoint.com"});settingsStore.getCustomGroupsManager().setCustomGroup("Companies (very long name to see what happens with truncation)",{color:"green",matchList:"crunchbase.com\nowler.com"});settingsStore.getCustomGroupsManager().setCustomGroup("Wikipedia",{color:"purple",matchList:"wikipedia.org"});settingsStore.getCustomGroupsManager().setCustomGroup("News",{color:"cyan",matchList:`
	aeon.co
	getpocket.com
	glamour.com
	nautil.us
	npr.org
	nytimes.com
	vox.com
		`});settingsStore.getCustomGroupsManager().setCustomGroup("Tech news",{color:"yellow",matchList:`
	venturebeat.com
	techcrunch.com
		`});settingsStore.getCustomGroupsManager().setCustomGroup("Shopping",{color:"green",matchList:`
	amazon.com
	bestbuy.com
	houzz.com
	techradar.com
	wayfair.com
		`});settingsStore.getCustomGroupsManager().setCustomGroup("Searches",{color:"blue",matchList:`
	www.google.com
	bing.com
	duckduckgo.com
		`})}function init(){perfProf.mark("windowLoaded");dayjs.extend(window.dayjs_plugin_relativeTime);Promise.all([settingsStore.getInitPromise(),localStore.getInitPromise()]).then(function(){if(!isProd()){testSettings()}popupMsgServer=Classes.PopupMsgServer.create();popupMsgServer.start();let rootElem=document.body;Classes.Base.roDef(window,"bookmarksManager",Classes.BookmarksManager.create());perfProf.mark("popupViewerStart");Classes.Base.roDef(window,"popupViewer",Classes.PopupViewer.createAs("popup-bstabs",rootElem));Classes.NewTabAction.create();perfProf.measure("Loading window",undefined,"windowLoaded");perfProf.measure("Loading settings","settingsStarted","settingsLoaded");perfProf.measure("Loading localStore","localStoreStarted","localStoreLoaded");perfProf.measure("Creating popupViewer","popupViewerStart","popupViewerEnd");perfProf.measure("Attaching popupViewer","popupViewerEnd","attachEnd")})}