// AUTO-GENERATED FILE, do not edit, use 'npm run dist' to build
// Copyright and licensing information at https://github.com/marcodb26/TabMania/blob/main/LICENSE

function setProd(flag){Object.defineProperty(window,"productionCode",{value:flag,configurable:false,enumerable:false,writable:false})}setProd(true);function isProd(){return optionalWithDefault(window.productionCode,false)}Classes={};Classes.Base={_Base_:{lastId:0,_idGen:function(){return++this.lastId}},__idPrefix:null,roDef:function(obj,propName,propValue){Object.defineProperty(obj,propName,{value:propValue,configurable:true,enumerable:false,writable:false})},_genLogFn:function(consoleFn,setPrefix,consoleObj){setPrefix=optionalWithDefault(setPrefix,false);consoleObj=optionalWithDefault(consoleObj,console);if(!setPrefix){return Function.prototype.bind.call(consoleFn,consoleObj)}return Function.prototype.bind.call(consoleFn,consoleObj,"["+this._id+"]")},create:function(){return this.createAs(null,...arguments)},createAs:function(id,...restArgs){var retVal=Object.create(this);this.roDef(retVal,"_hiddenId",this._Base_._idGen());this.roDef(retVal,"_id",id==null?this._formatId(retVal._hiddenId):id);this.debug.call(retVal,false);this.roDef(retVal,"_err",this._genLogFn.call(retVal,console.error,true));let bgConsoleObj=chrome.extension.getBackgroundPage().console;this.roDef(retVal._err,"bg",this._genLogFn.call(retVal,bgConsoleObj.error,true,bgConsoleObj));this.roDef(retVal,"_assert",this._genLogFn.call(retVal,console.assert));retVal._init.apply(retVal,restArgs);return retVal},debug:function(flag){flag=optionalWithDefault(flag,true);if(flag&&!isProd()){this.roDef(this,"_log",this._genLogFn(console.log,true));this.roDef(this._log,"raw",this._genLogFn(console.log,false));this.roDef(this._log,"trace",this._genLogFn(console.trace,true));let bgConsoleObj=chrome.extension.getBackgroundPage().console;this.roDef(this._log,"bg",this._genLogFn(bgConsoleObj.log,true,bgConsoleObj))}else{this.roDef(this,"_log",emptyFn);this.roDef(this._log,"raw",emptyFn);this.roDef(this._log,"trace",emptyFn);this.roDef(this._log,"bg",emptyFn)}},subclass:function(extension){return Object.assign({},this,extension)},getId:function(){return this._id},_init:function(){},_formatId:function(hiddenId){if(this.__idPrefix==null){return hiddenId}return this.__idPrefix+"-"+hiddenId},_errorMustSubclass:function(){return Function.prototype.bind.call(console.error,console,"This method must be subclassed: ")}()};Classes.AsyncBase=Classes.Base.subclass({_initPromise:null,_initialized:null,_init:function(maxElements){Classes.Base._init.apply(this,arguments);this._initialized=false;this._initPromise=this._asyncInit().then(function(){this._initialized=true}.bind(this))},_asyncInit:function(){return Promise.resolve()},isInitialized:function(){return this._initialized},getInitPromise:function(){return this._initPromise}});Classes.EventManager=Classes.Base.subclass({_elem:null,_ownerObj:null,_init:function(){Classes.Base._init.call(this);this._elem=document.createElement("div");this.addEventListener=this._elem.addEventListener.bind(this._elem);this.removeEventListener=this._elem.removeEventListener.bind(this._elem)},dispatchEvent:function(eventName,detailObj){this._elem.dispatchEvent(new CustomEvent(eventName,{detail:detailObj}))},notifyListeners:function(eventId,extraData){extraData=optionalWithDefault(extraData,{});let detail=Object.assign({target:this._ownerObj},extraData);this.dispatchEvent(eventId,detail)},attachRegistrationFunctions:function(obj){obj.addEventListener=this.addEventListener;obj.removeEventListener=this.removeEventListener;this._assert(this._ownerObj==null);this._ownerObj=obj},addEventListener:function(){},removeEventListener:function(){}});Classes.Base.roDef(Classes.EventManager,"Events",{});Classes.Base.roDef(Classes.EventManager.Events,"UPDATED","tmUpdated");Classes.Error=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)}});Classes.Base.roDef(Classes.Error,"NOTRUNNING","Not running");function optionalWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null){return defaultValue}return value}function emptyFn(){}Classes.TmUtils=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.err=this._err},err:null,isEqual:function(objA,objB){const logHead="TmUtils::isEqual(): ";if(typeof objA!=typeof objB){return false}if(typeof objA!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead+'"'+typeof objA+'" is not supported');return objA===objB}if(Array.isArray(objA)){if(Array.isArray(objB)){if(objA.length!=objB.length){return false}for(let i=0;i<objA.length;i++){if(!this.isEqual(objA[i],objB[i])){return false}}return true}else{return false}}if(objA==null||objB==null){return objA===objB}let keysA=Object.keys(objA).sort();let keysB=Object.keys(objB).sort();if(keysA.length!=keysB.length){return false}for(let i=0;i<keysA.length;i++){if(keysA[i]!=keysB[i]){return false}if(!this.isEqual(objA[keysA[i]],objB[keysB[i]])){return false}}return true},deepClone:function(obj){const logHead="TmUtils::deepClone(): ";if(obj===undefined){return undefined}if(typeof obj!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead+'"'+typeof objA+'" is not supported');return obj}if(obj==null){return null}if(Array.isArray(obj)){let retVal=[];for(let i=0;i<obj.length;i++){retVal[i]=this.deepClone(obj[i])}return retVal}let retVal={};let keys=Object.keys(obj);for(let i=0;i<keys.length;i++){retVal[keys[i]]=this.deepClone(obj[keys[i]])}return retVal},clearStorage:function(){chrome.storage.local.clear();chrome.storage.sync.clear()},showStorage:function(){chrome.storage.local.get(function(result){console.log(result)});chrome.storage.sync.get(function(result){console.log(result)})}});Classes.Base.roDef(window,"tmUtils",Classes.TmUtils.create());tmUtils.debug();Classes.PersistentDict=Classes.AsyncBase.subclass({_storageObj:null,_dict:null,_eventManager:null,_initPromise:null,_initialized:null,_init:function(storageObj){this.debug();this._storageObj=optionalWithDefault(storageObj,chrome.storage.local);this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);chrome.storage.onChanged.addListener(this._onStorageChangedCb.bind(this));Classes.AsyncBase._init.apply(this,arguments)},_asyncInit:function(){let parentPromise=Classes.AsyncBase._asyncInit();let thisPromise=chromeUtils.storageGet(this._id,this._storageObj).then(function(results){const logHead="PersistentDict::_initDict().cb: ";this._dict={};if(this._id in results){this._dict=results[this._id];this._log(logHead+"initializing this._dict to ",this._dict)}else{this._log(logHead+"key "+this._id+" not found, initializing empty")}}.bind(this));return Promise.all([parentPromise,thisPromise])},_onStorageChangedCb:function(changes,areaName){const logHead="PersistentDict::_onStorageChangedCb("+areaName+"): ";if(!this.isInitialized()){this._log(logHead+"still initializing, ignoring event");return}if(chromeUtils.storageObjByAreaName(areaName)!=this._storageObj){this._log(logHead+"not my storage object, ignoring event");return}if(!(this._id in changes)){this._log(logHead+"not my storage key, ignoring event",changes);return}if(tmUtils.isEqual(this._dict,changes[this._id].newValue)){this._log(logHead+"the object has not changed, ignoring event",changes);return}this._log(logHead+"setting to ",changes[this._id]);this._dict=optionalWithDefault(changes[this._id].newValue,{});this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED)},_persist:function(){var items={};items[this._id]=this._dict;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED);return chromeUtils.storageSet(items,this._storageObj)},set:function(key,value){value=optionalWithDefault(value,null);let logHead="PersistentDict::set("+key+', "'+value+'"): ';this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(tmUtils.isEqual(this._dict[key],value)){this._log(logHead+"the key has not changed, ignoring call");return Promise.resolve()}this._dict[key]=tmUtils.deepClone(value);return this._persist()},get:function(key){let logHead="PersistentDict::get(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");return tmUtils.deepClone(this._dict[key])},has:function(key,ignoreCase){ignoreCase=optionalWithDefault(ignoreCase,false);let logHead="PersistentDict::has(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(!ignoreCase){return key in this._dict}let allKeys=Object.keys(this._dict);let searchKey=key.toLowerCase();let result=allKeys.findIndex(function(currKey){return currKey.toLowerCase()==searchKey});return result!=-1},rename:function(key,newKey){let logHead="PersistentDict::rename("+key+", "+newKey+"): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(!(key in this._dict)){this._log(logHead+"original key not in _dict, nothing to do");return Promise.resolve()}if(newKey in this._dict){this._err(logHead+"new key already in _dict, can't overwrite");return Promise.reject()}this._dict[newKey]=this._dict[key];delete this._dict[key];this._log(logHead+"completed",this._dict);return this._persist()},del:function(key){let logHead="PersistentDict::del(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(!(key in this._dict)){return Promise.resolve()}delete this._dict[key];return this._persist()},setAll:function(dict){let logHead="PersistentDict::setAll(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(tmUtils.isEqual(this._dict,dict)){this._log(logHead+"the object has not changed, ignoring call",dict,this._dict);return Promise.resolve()}this._dict=tmUtils.deepClone(dict);return this._persist()},getAll:function(){let logHead="PersistentDict::getAll(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");return tmUtils.deepClone(this._dict)},getAllKeys:function(){let logHead="PersistentSet::getAllKeys(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");return Object.keys(this._dict)}});Classes.PersistentSet=Classes.PersistentDict.subclass({add:function(key){return this.set(key)},getAll:function(){return this.getAllKeys()}});Classes.BoundArray=Classes.Base.subclass({_array:null,_maxElements:null,_init:function(maxElements){Classes.Base._init.apply(this,arguments);this._maxElements=maxElements;this._array=[];this.debug()},resize:function(){if(this._array.length>=this._maxElements){this._array.splice(0,this._maxElements-this._array.length)}return this._array.length},push:function(value){this._array.push(value);return this.resize()},pop:function(){return this._array.pop()},isEmpty:function(){return this._array.length==0},peek:function(cnt){if(this.isEmpty()){return null}if(cnt==null){return this._array[this._array.length-1]}if(cnt>this._array.length){cnt=this._array.length}return this._array.slice(-cnt)},append:function(value){this._array.splice(-1,0,...value);return this.resize()},removeValueOLD:function(value,matchFn){var nextIndex=0;while((nextIndex=this._array.indexOf(value,nextIndex))!=-1){this._array.splice(nextIndex,1)}},removeValue:function(value,matchFn){matchFn=optionalWithDefault(matchFn,function(a,b){return a==b});const logHead="BoundArray::removeValue("+value+"): ";let foundIdx=[];for(let i=0;i<this._array.length;i++){if(matchFn(value,this._array[i])){foundIdx.push(i)}}this._log(logHead+"need to remove these indices:",foundIdx);for(let i=foundIdx.length-1;i>=0;i--){this._log(logHead+"now removing index "+foundIdx[i]+" (value = "+this._array[foundIdx[i]]+")");this._array.splice(foundIdx[i],1)}},get:function(pos){if(pos!=undefined){return this._array[pos]}return this._array}});Classes.MsgServer=Classes.Base.subclass({_cmdMap:null,_init:function(){Classes.Base._init.apply(this,arguments);this._cmdMap={}},start:function(){chrome.runtime.onMessage.addListener(this._processMsgCb.bind(this))},_printTabInfo:function(tab){if(tab){return tab.id}return"[extension]"},_processMsgInner:function(request,sender,sendResponse){if(request.cmd in this._cmdMap){return this._cmdMap[request.cmd].fn.apply(this,arguments)}else{return this.formatErrMsg("unknown command: "+request.cmd)}},_processMsgCb:function(request,sender,sendResponse){const logHead="MsgServer::_processMsgCb(from tab "+this._printTabInfo(sender.tab)+"): ";this._log(logHead+JSON.stringify(request),sender);var response=this._processMsgInner.apply(this,arguments);if(response==null){if(this._cmdMap[request.cmd].needResponse){return true}sendResponse("");return false}sendResponse(response);return false},addCmd:function(cmd,fn,needResponse){needResponse=optionalWithDefault(needResponse,true);var cmdWrapper=safeFnWrapper(fn,null,function(e){this._err('cmd "'+cmd+'" generated an exception: ',e);return this.formatErrMsg(e.message,e.toString())}.bind(this));this._cmdMap[cmd]={fn:cmdWrapper,needResponse:needResponse}},formatErrMsg:function(msg,details){var retVal={status:"error",message:msg};if(details!=null){retVal.details=details}return retVal}});Classes.MsgClient=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)},_requestInner:function(request){const logHead="MsgClient::_requestInner("+JSON.stringify(request)+"): ";this._log(logHead+"entering");return chromeUtils.wrap(chrome.runtime.sendMessage,logHead,request)},_formatRequest:function(cmd,otherOptions){return{cmd:cmd,...otherOptions}},sendRequest:function(cmd,otherOptions){const request=this._formatRequest.apply(this,arguments);return this._requestInner(request).then(function(response){this._debugResponse(cmd,response);return response}.bind(this))},sendNotification:function(cmd,otherOptions){const notification=this._formatRequest.apply(this,arguments);return this._requestInner(notification)},_debugResponse:function(cmd,response){const logHead="MsgClient::_debugResponse("+cmd+"): ";if(response.status!="success"){this._err(logHead+"response failed: "+JSON.stringify(response))}}});function optArrayWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null||value.length==0){return defaultValue}return value}function delay(delayTime){return new Promise(function(resolve){setTimeout(resolve,delayTime)})}function safeFnWrapper(fnToWrap,errMsgPrefix,errFn){return function(){try{return fnToWrap(...arguments)}catch(e){if(errMsgPrefix!=null){tmUtils.err(errMsgPrefix+e.message,e)}if(errFn!=null){return errFn(e,...arguments)}}}}function isUrl(url){try{let urlObj=new URL(url);return true}catch(e){return false}}function stackTrace(){return(new Error).stack}function asyncFn(fn){return Promise.resolve().then(fn)}Classes.PerfProfiler=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},mark:function(mark){performance.mark(mark)},measure:function(name,startMark,endMark){try{performance.measure(...arguments)}catch(e){this._err(e)}},log:function(){const logHead="PerfProfiler::log(): ";this._log.raw("%c"+logHead+"type measure: %o","background-color: powderblue;",performance.getEntriesByType("measure"))},logAll:function(){const logHead="PerfProfiler::log(): ";this._log(logHead+"all types: ",performance.getEntries())},_sortEntries:function(a,b){if(a.startTime>b.startTime){return 1}if(a.startTime<b.startTime){return-1}return 0},_getMeasures:function(measuresTable){for(const[measureName,marks]of Object.entries(measuresTable)){this.measure(measureName,marks[0],marks[1])}let p=[];for(const measureName of Object.keys(measuresTable)){p=p.concat(performance.getEntriesByName(measureName,"measure"));performance.clearMeasures(measureName)}p.sort(this._sortEntries);return p},_getMarks:function(measuresTable){let p=[];for(const[measureName,marks]of Object.entries(measuresTable)){p=p.concat(performance.getEntriesByName(marks[0],"mark"));p=p.concat(performance.getEntriesByName(marks[1],"mark"))}p.sort(this._sortEntries);return p},_getMarksByPrefix:function(measuresTable){let allMarks=performance.getEntriesByType("mark");let markPrefixes=[];for(const[measureName,marks]of Object.entries(measuresTable)){markPrefixes.push(marks[0],marks[1])}let p=[];for(const[index,entry]of Object.entries(allMarks)){for(const[index,prefix]of Object.entries(markPrefixes)){if(entry.name.startsWith(prefix)){p.push(entry)}}}p.sort(this._sortEntries);return p},_showMeasures:function(measuresTable){console.table(this._getMarksByPrefix(measuresTable),["name","startTime"]);console.table(this._getMeasures(measuresTable),["name","duration","startTime"])},showSearch:function(){let toMeasure={"full search":["searchStart","searchEnd"],"chrome.bookmarks.search()":["bookmarksSearchStart","bookmarksSearchEnd"],"bookmarks reduce":["bookmarksReduceStart","bookmarksReduceEnd"],"chrome.history.search()":["historySearchStart","historySearchEnd"],"history reduce":["historyReduceStart","historyReduceEnd"],"filter tabs":["searchFilterStart","searchSortStart"],"sort tabs":["searchSortStart","searchSortEnd"],render:["searchRenderStart","searchRenderEnd"]};this._showMeasures(toMeasure)},showAsyncQueues:function(){let toMeasure={"discard batch":["discardAsyncQueueBatchStart","discardAsyncQueueBatchEnd"],"run batch":["runAsyncQueueBatchStart","runAsyncQueueBatchEnd"],"full run":["runAsyncQueueStart","runAsyncQueueEnd"]};console.table(this._getMarksByPrefix(toMeasure),["name","startTime"])},showStats:function(){chromeUtils.wrap(chrome.tabs.query,"PerfProfiler::tmStats(): ",{}).then(function(tabs){console.log("Total tabs count: "+tabs.length);console.table(performance.getEntriesByType("measure"),["name","duration","startTime"])})}});Classes.Base.roDef(window,"perfProf",Classes.PerfProfiler.create());Classes.AsyncQueue=Classes.Base.subclass({__idPrefix:"AsyncQueue",_eventManager:null,_queues:null,_batchSize:50,_running:null,_discarded:null,_init:function(){const logHead="AsyncQueue::_init(): ";Classes.Base._init.call(this);this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);this._initQueues();this._running=false;this._discarded=false},_isRunning:function(){return this._running},_isDiscarded:function(){return this._discarded},_initQueues:function(){this._queues={};this._queues[Classes.AsyncQueue.priority.HIGH]={name:Classes.AsyncQueue.priority.HIGH,delay:0,queue:[]};this._queues[Classes.AsyncQueue.priority.NORMAL]={name:Classes.AsyncQueue.priority.NORMAL,delay:0,queue:[]};this._queues[Classes.AsyncQueue.priority.LOW]={name:Classes.AsyncQueue.priority.LOW,delay:200,queue:[]}},_getQueue:function(priority){return this._queues[priority]},_getQueueToProcess:function(){const logHead="AsyncQueue::_getQueueToProcess(): ";let priorities=[Classes.AsyncQueue.priority.HIGH,Classes.AsyncQueue.priority.NORMAL,Classes.AsyncQueue.priority.LOW];for(priority of priorities){if(this._queues[priority].queue.length!=0){this._log(logHead+'queue of priority "'+priority+'" has pending work: '+this._queues[priority].queue.length);return this._queues[priority]}}this._log(logHead+"all queues are empty");return null},_getAllQueueLengths:function(){let retVal=[];for(const[priority,queue]of Object.entries(this._queues)){retVal.push(priority+": "+queue.queue.length)}return retVal},_processQueue:async function(perfLabel,processFn,resumeFn,cleanupFn){const logHead="AsyncQueue::_processQueue(): ";let processedCnt=this._batchSize;let firstRound=true;let queue=null;while((queue=this._getQueueToProcess())!=null){while(queue.queue.length>0){if(processedCnt>=this._batchSize){if(!firstRound){perfProf.mark(perfLabel+"AsyncQueueBatchEnd"+this._id);await delay(queue.delay)}else{firstRound=false}processedCnt=0;if(resumeFn!=null&&!resumeFn()){if(cleanupFn!=null){await cleanupFn()}return false}perfProf.mark(perfLabel+"AsyncQueueBatchStart"+this._id)}let entry=queue.queue.shift();processFn(entry);processedCnt++}}perfProf.mark(perfLabel+"AsyncQueueBatchEnd"+this._id);return true},_discardProcessFn:function(entry){if(entry.discardFn!=null){entry.discardFn()}},_runResumeFn:function(){return!this._isDiscarded()},_runProcessFn:function(entry){let retVal=entry.fn();entry.resolveFn(retVal)},_runCleanupFn:async function(){const logHead="AsyncQueue::_runCleanupFn(): ";this._log(logHead+"entering, queue lengths = ",this._getAllQueueLengths());await this._processQueue("discard",this._discardProcessFn.bind(this))},_runQueue:async function(){const logHead="AsyncQueue::_runQueue(): ";if(this._isRunning()){return}this._log(logHead+"entering");this._running=true;perfProf.mark("runAsyncQueueStart"+this._id);let normalState=true;try{while(this._getQueueToProcess()!=null&&normalState){normalState=await this._processQueue("run",this._runProcessFn.bind(this),this._runResumeFn.bind(this),this._runCleanupFn.bind(this))}}catch(e){this._err(logHead,e)}perfProf.mark("runAsyncQueueEnd"+this._id);this._running=false},_enqueueInner:function(queueEntry,priority){this._getQueue(priority).queue.push(queueEntry);this._runQueue()},enqueue:function(fn,fnSignature,priority){priority=optionalWithDefault(priority,Classes.AsyncQueue.priority.NORMAL);return new Promise(function(resolveFn,rejectFn){let queueEntry={fn:safeFnWrapper(fn,fnSignature,rejectFn),resolveFn:resolveFn,rejectFn:rejectFn,discardFn:null};this._enqueueInner(queueEntry,priority)}.bind(this))},discard:async function(){const logHead="AsyncQueue::discard(): ";this._discarded=true;if(!this._isRunning()){this._assert(this._getQueueToProcess()==null);if(this._getQueueToProcess()!=null){await this._runCleanupFn()}}}});Classes.Base.roDef(Classes.AsyncQueue,"priority",{});Classes.Base.roDef(Classes.AsyncQueue.priority,"HIGH","high");Classes.Base.roDef(Classes.AsyncQueue.priority,"NORMAL","normal");Classes.Base.roDef(Classes.AsyncQueue.priority,"LOW","low");Classes.ChromeUtils=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)},_wrapInner:function(verbose,chromeFn,debugCtx,...args){return new Promise(function(resolve,reject){chromeFn(...args,function(){const logHead="ChromeUtils::wrap().cb: "+(debugCtx!=null?debugCtx:"");if(chrome.runtime.lastError){if(verbose){this._err(logHead+"chrome.runtime.lastError = "+chrome.runtime.lastError.message)}reject(chrome.runtime.lastError)}else{resolve(...arguments)}}.bind(this))}.bind(this))},wrap:function(chromeFn,debugCtx,...args){return this._wrapInner(true,...arguments)},wrapQuiet:function(){return this._wrapInner(false,...arguments)},getExtensionId:function(){const logHead="chromeUtils::getExtensionId(): ";let retVal=chrome.runtime.getURL("");this._log(logHead,retVal);retVal=retVal.replace("chrome-extension://","");retVal=retVal.replace("/","");return retVal},getLeastTabbedWindowId:function(preferredWinId){const logHead="ChromeUtils::getLeastTabbedWindowId(): ";let options={populate:true,windowTypes:["normal"]};let preferredWinTabsCount=999999;function leastTabbedReducer(currentMinWin,winInfo){let tabsCount=winInfo.tabs.length;if(winInfo.id==preferredWinId){preferredWinTabsCount=tabsCount}if(currentMinWin==0||currentMinWin.tabsCount>tabsCount){return{winInfo:winInfo,tabsCount:tabsCount}}return currentMinWin}return this.wrap(chrome.windows.getAll,logHead,options).then(function(winList){if(winList.length==0){return null}let minWin=winList.reduce(leastTabbedReducer,0);if(minWin.tabsCount<preferredWinTabsCount-1){this._log(logHead+"Found: ",minWin);return minWin.winInfo.id}this._assert(minWin.tabsCount<=preferredWinTabsCount,logHead+"unexpected");this._log(logHead+"Found multiple matches, returning preferredWinId",preferredWinId,minWin);return preferredWinId}.bind(this))},getEmptyTabsList:function(){const logHead="ChromeUtils::getEmptyTabsList(): ";return chromeUtils.wrap(chrome.tabs.query,logHead,{url:"chrome://newtab/"})},focusWindow:function(tabId){return this.wrap(chrome.tabs.get,"ChromeUtils::focusWindow(): ",tabId).then(function(tab){const logHead="ChromeUtils::focusWindow().then(): ";this._log(logHead+tab.windowId,tab);this.wrap(chrome.windows.update,logHead,tab.windowId,{focused:true})}.bind(this))},activateTab:function(tabId){let promiseA=this.wrap(chrome.tabs.update,"ChromeUtils::activateTab(): ",tabId,{active:true});let promiseB=this.focusWindow(tabId);return Promise.all([promiseA,promiseB])},createTab:function(url,winId){winId=optionalWithDefault(winId,chrome.windows.WINDOW_ID_CURRENT);const logHead="ChromeUtils::createTab("+url+"): ";let promiseA=this.wrap(chrome.tabs.create,logHead,{url:url,windowId:winId});let promiseB=this.wrap(chrome.windows.update,logHead,winId,{focused:true});return Promise.all([promiseA,promiseB])},reuseOrCreateTab:function(url){return this.getEmptyTabsList().then(function(tabs){if(tabs.length!=0){return this.loadUrl(url,tabs[0].id)}return this.getLeastTabbedWindowId().then(function(winId){return this.createTab(url,winId)}.bind(this))}.bind(this))},loadUrl:function(url,tabId,winId){const logHead="ChromeUtils::loadUrl("+url+", "+tabId+", "+winId+"): ";tabId=optionalWithDefault(tabId,null);if(winId==chrome.windows.WINDOW_ID_NONE){this._assert(tabId==null);return this.wrap(chrome.windows.create,logHead,{focused:true,url:url})}if(tabId==null){if(winId==null){return this.reuseOrCreateTab(url)}return this.createTab(url,winId)}let promiseA=null;let promiseB=null;promiseA=chromeUtils.activateTab(tabId);promiseB=this.wrap(chrome.tabs.update,logHead,tabId,{url:url});return Promise.all([promiseA,promiseB])},moveTabToLeastTabbedWindow:function(tab,activate){activate=optionalWithDefault(activate,false);const logHead="chromeUtils::moveTabToLeastTabbedWindow(activate: "+activate+"): ";return this.getLeastTabbedWindowId(tab.windowId).then(function(winId){if(tab.windowId==winId){this._log(logHead+"tab "+tab.id+" is already in the least tabbed window "+winId);return null}let moveProperties={index:-1,windowId:winId};let movePromise=this.wrap(chrome.tabs.move,logHead,tab.id,moveProperties);let focusPromise=null;let activatePromise=null;if(activate){focusPromise=this.wrap(chrome.windows.update,logHead,winId,{focused:true});activatePromise=this.wrap(chrome.tabs.update,logHead,tab.id,{active:true})}else{focusPromise=Promise.resolve();activatePromise=Promise.resolve()}return Promise.all([movePromise,focusPromise,activatePromise])}.bind(this))},closeTab:function(tabId){return this.wrap(chrome.tabs.remove,"ChromeUtils::closeTab(): ",tabId)},inject:function(tabId,jsFile){const logHead="ChomeUtils::inject("+tabId+"): ";return this.wrapQuiet(chrome.tabs.executeScript,logHead,tabId,{file:jsFile}).catch(function(chromeLastError){switch(chromeLastError.message){case Classes.ChromeUtils.Error.INJECT_NOFRAME:return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_ERRORPAGE:this._log(logHead+"tab has an error (network down?)");return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_EXTGALLERY:this._log(logHead+"can't inject in the extensions gallery");return Promise.resolve(null);default:this._err(logHead+"unknown error: "+chromeLastError.message);return Promise.reject(chromeLastError)}}.bind(this))},getBookmarkPathList:async function(bmNode){const logHead="ChomeUtils::getBookmarkPathList("+bmNode.id+"): ";let pathList=[];while(bmNode!=null&&bmNode.parentId!=null){let result=await this.wrap(chrome.bookmarks.get,logHead,bmNode.parentId);if(result.length>0){bmNode=result[0];pathList.push(bmNode.title!=null?bmNode.title:"")}else{bmNode=null;this._err(logHead+"unexpected, it should not get here")}}pathList.reverse();return pathList},getBookmarksCount:function(){const logHead="ChomeUtils::getBookmarksCount("+bmNode.id+"): ";return this.wrap(chrome.bookmarks.getTree,logHead).then(function(nodesList){return nodesList.length}.bind(this))},storageGet:function(keys,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageGet(): ";return this.wrap(storageObj.get.bind(storageObj),logHead,keys)},storageSet:function(items,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageSet(): ";return this.wrap(storageObj.set.bind(storageObj),logHead,items)},_areaNamesDict:{sync:chrome.storage.sync,local:chrome.storage.local,managed:chrome.storage.managed},storageObjByAreaName:function(areaName){const logHead="ChromeUtils.storageObjByAreaName("+areaName+"): ";let retVal=this._areaNamesDict[areaName];this._assert(retVal!=null,logHead+"assertion failed");return retVal}});Classes.Base.roDef(Classes.ChromeUtils,"Error",{});Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_COMMUNICATION","Error when communicating with the native messaging host.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_EXITED","Native host has exited.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_NOTFOUND","Specified native messaging host not found.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_NOFRAME","The frame was removed.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_ERRORPAGE",'Cannot access contents of url "chrome-error://chromewebdata/". Extension manifest must request permission to access this host.');Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_EXTGALLERY","The extensions gallery cannot be scripted.");Classes.Base.roDef(window,"chromeUtils",Classes.ChromeUtils.create());chromeUtils.debug();Classes.NormalizedTabs=Classes.Base.subclass({_tabs:null,_init:function(tabs){Classes.Base._init.call(this);this._tabs=optionalWithDefault(tabs,[]);this.debug();this.normalizeAll()},compareTitlesFn:function(a,b){return a.tm.normTitle.localeCompare(b.tm.normTitle)},compareTabsFn:function(a,b){if(a.pinned&&!b.pinned){return-1}if(b.pinned&&!a.pinned){return 1}return Classes.NormalizedTabs.compareTitlesFn(a,b)},comparePositionFn:function(a,b){if(a.windowId<b.windowId){return-1}if(a.windowId>b.windowId){return 1}if(a.index<b.index){return-1}if(a.index>b.index){return 1}return 0},getProtocolHostname:function(url){try{var urlObj=new URL(url);return[urlObj.protocol,urlObj.hostname]}catch(e){return[null,null]}},normalizeLowerCaseTitle:function(lowerCaseTitle){if(lowerCaseTitle.startsWith("www.")){return lowerCaseTitle.substring(4)}return lowerCaseTitle},formatExtendedId:function(tab,objType){if(tab.tm!=null){objType=optionalWithDefault(objType,tab.tm.type)}objType=optionalWithDefault(objType,Classes.NormalizedTabs.type.TAB);switch(objType){case Classes.NormalizedTabs.type.TAB:return tab.windowId+":"+tab.id+"/"+tab.index;case Classes.NormalizedTabs.type.RCTAB:return"rc["+tab.sessionId+"]";case Classes.NormalizedTabs.type.BOOKMARK:return"bm["+(tab.parentId!=null?tab.parentId:"")+"."+tab.bookmarkId+"]";case Classes.NormalizedTabs.type.HISTORY:return"h["+tab.historyId+"]";default:const logHead="NormalizedTabs::formatExtendedId(): ";tmUtils.err(logHead+"unknown objType",objType,tab);break}return"[none]"},_addNormalizedShortcutBadges:function(tab,secondary){let sm=settingsStore.getShortcutsManager();let scKeys=sm.getShortcutKeysForTab(tab,!secondary);let array=tab.tm.primaryShortcutBadges;if(secondary){array=tab.tm.secondaryShortcutBadges}scKeys.forEach(function(key){let keyAsString=sm.keyToUiString(key);array.push(keyAsString);tab.tm.searchBadges.push(keyAsString.toLowerCase())}.bind(this))},updateShortcutBadges:function(tab){this._addNormalizedShortcutBadges(tab,false);this._addNormalizedShortcutBadges(tab,true)},_addNormalizedVisualBadge:function(tab,badge,visible){visible=optionalWithDefault(visible,true);if(visible){tab.tm.visualBadges.push(badge)}tab.tm.searchBadges.push(badge.toLowerCase())},updateSearchBadges:function(tab){if(tab.active){this._addNormalizedVisualBadge(tab,"active")}if(tab.audible){this._addNormalizedVisualBadge(tab,"audible",false)}if(tab.discarded){this._addNormalizedVisualBadge(tab,"suspended",false)}if(tab.tm.type==Classes.NormalizedTabs.type.RCTAB){this._addNormalizedVisualBadge(tab,"closed",false)}if(tab.highlighted){this._addNormalizedVisualBadge(tab,"highlighted",false)}if(tab.incognito){this._addNormalizedVisualBadge(tab,"incognito",false)}if(tab.mutedInfo!=null&&tab.mutedInfo.muted){this._addNormalizedVisualBadge(tab,"muted",false)}if(tab.status!=null){switch(tab.status){case"unloaded":this._addNormalizedVisualBadge(tab,tab.status,false);break;case"complete":this._addNormalizedVisualBadge(tab,"loaded",false);break;default:this._addNormalizedVisualBadge(tab,tab.status);break}}if(tab.pinned){this._addNormalizedVisualBadge(tab,"pinned",false)}if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false)}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},updateBookmarkBadges:function(tab){if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false)}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},updateHistoryBadges:function(tab){if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false)}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},getCachedFavIconUrl:function(url){return"chrome://favicon/size/16@1x/"+url},normalizeBookmarkId:function(id){return"b"+id},_initBookmarkAsTab:function(tab){tab.bookmarkId=tab.id;tab.id=Classes.NormalizedTabs.normalizeBookmarkId(tab.id);tab.status="unloaded"},normalizeHistoryItemId:function(id){return"h"+id},_initHistoryItemAsTab:function(tab){tab.historyId=tab.id;tab.id=Classes.NormalizedTabs.normalizeHistoryItemId(tab.id);tab.status="unloaded"},normalizeRecentlyClosedId:function(id){return"c"+id},_initRecentlyClosedAsTab:function(tab){tab.active=false;tab.id=Classes.NormalizedTabs.normalizeRecentlyClosedId(tab.sessionId);tab.status="unloaded"},normalizeTab:function(tab,objType){objType=optionalWithDefault(objType,Classes.NormalizedTabs.type.TAB);const logHead="NormalizedTabs::normalizeTab(): ";let thisObj=Classes.NormalizedTabs;switch(objType){case Classes.NormalizedTabs.type.TAB:break;case Classes.NormalizedTabs.type.RCTAB:thisObj._initRecentlyClosedAsTab(tab);break;case Classes.NormalizedTabs.type.BOOKMARK:thisObj._initBookmarkAsTab(tab);break;case Classes.NormalizedTabs.type.HISTORY:thisObj._initHistoryItemAsTab(tab);break;default:tmUtils.err(logHead+"unknown objType",objType);break}let url=optionalWithDefault(tab.url!=""?tab.url:tab.pendingUrl,"");let lowerCaseTitle=tab.title.toLowerCase();let[protocol,hostname]=thisObj.getProtocolHostname(url);let cachedFavIcon=false;if(tab.favIconUrl==null||tab.favIconUrl==""){tab.favIconUrl=Classes.NormalizedTabs.getCachedFavIconUrl(url);cachedFavIcon=true}tab.tm={type:objType,protocol:protocol,hostname:hostname,customGroupName:settingsStore.getCustomGroupsManager().getCustomGroupByHostname(hostname),lowerCaseUrl:url.toLowerCase(),lowerCaseTitle:lowerCaseTitle,normTitle:thisObj.normalizeLowerCaseTitle(lowerCaseTitle),cachedFavIcon:cachedFavIcon,extId:thisObj.formatExtendedId(tab,objType),visualBadges:[],searchBadges:[],primaryShortcutBadges:[],secondaryShortcutBadges:[]};switch(objType){case Classes.NormalizedTabs.type.TAB:thisObj.updateShortcutBadges(tab);thisObj.updateSearchBadges(tab);break;case Classes.NormalizedTabs.type.RCTAB:thisObj.updateSearchBadges(tab);break;case Classes.NormalizedTabs.type.BOOKMARK:thisObj.updateBookmarkBadges(tab);break;case Classes.NormalizedTabs.type.HISTORY:thisObj.updateHistoryBadges(tab);break;default:tmUtils.err(logHead+"unknown objType",objType);break}},normalizeAll:function(){perfProf.mark("normalizeStart");this._tabs.forEach(function(tab){this.normalizeTab(tab)}.bind(this));perfProf.mark("normalizeEnd");perfProf.measure("Normalize","normalizeStart","normalizeEnd")},getTabs:function(){return this._tabs},getTabIndexByTabId:function(searchTabId){return this._tabs.findIndex(function(tab){if(tab.id==searchTabId){return true}return false}.bind(this))},getTabByTabId:function(searchTabId){let tabIdx=this.getTabIndexByTabId(searchTabId);if(tabIdx==-1){return null}return this._tabs[tabIdx]},getTabByTabIndex:function(tabIdx){if(tabIdx==null||tabIdx<0||tabIdx>this._tabs.length){return null}return this._tabs[tabIdx]},updateTab:function(newTab,tabIdx){this.normalizeTab(newTab);tabIdx=optionalWithDefault(tabIdx,this.getTabIndexByTabId(newTab.id));if(tabIdx==-1){this._tabs.push(newTab)}else{this._tabs[tabIdx]=newTab}}});Classes.Base.roDef(Classes.NormalizedTabs,"type",{});Classes.Base.roDef(Classes.NormalizedTabs.type,"TAB","tab");Classes.Base.roDef(Classes.NormalizedTabs.type,"RCTAB","rctab");Classes.Base.roDef(Classes.NormalizedTabs.type,"BOOKMARK","bookmark");Classes.Base.roDef(Classes.NormalizedTabs.type,"HISTORY","history");Classes.Base.roDef(window,"ExtCommands",{});Classes.Base.roDef(window.ExtCommands,"BACK","00back");Classes.Base.roDef(window.ExtCommands,"FWD","01fwd");Classes.Base.roDef(window.ExtCommands,"LAUNCHORSEARCH","02los");Classes.Base.roDef(window.ExtCommands,"CLOSEBACK","03closeback");Classes.Base.roDef(window.ExtCommands,"CLOSEFWD","04closefwd");Classes.Base.roDef(window.ExtCommands,"SHORTCUT01","90shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT02","91shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT03","92shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT04","93shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT05","94shortcut");Classes.ShortcutsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_shortcutsStore:null,_tabs:null,_eventManager:null,_shortcutsInfo:null,_shortcutKeys:[window.ExtCommands.SHORTCUT01,window.ExtCommands.SHORTCUT02,window.ExtCommands.SHORTCUT03,window.ExtCommands.SHORTCUT04,window.ExtCommands.SHORTCUT05],_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this._shortcutsStore=null;this._shortcutsInfo=null;this._tabs=[];this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit()];this._shortcutsStore={};for(let i=0;i<this._shortcutKeys.length;i++){let persDict=this._shortcutsStore[this._shortcutKeys[i]]=Classes.PersistentDict.createAs(this._storageKeyPrefix+"shortcut0"+(i+1),chrome.storage.sync);promiseArray.push(persDict.getInitPromise());persDict.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this,this._shortcutKeys[i]))}return Promise.all(promiseArray).then(this._computeShortcutsInfo.bind(this))},_onUpdatedCb:function(key,ev){this._computeInfo(key);this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_propertySearch:function(key,value){let retVal=this._tabs.reduce(function(res,tab){if(tab.tm[key]==value){res.push(tab)}return res},[]);return retVal.sort(Classes.NormalizedTabs.comparePositionFn)},_computeByHostname:function(hostname){const logHead="ShortcutsManager::_computeByHostname("+hostname+"): ";let tabs=this._propertySearch("hostname",hostname);if(tabs.length==0){this._log(logHead+"setting as URL");return{url:"https://"+hostname}}return{tab:tabs[0]}},_computeByUrlNoSearch:function(sc,forceNewTab){if(forceNewTab){return{url:sc.get("url")}}let tabs=this._propertySearch("lowerCaseUrl",sc.get("url").toLowerCase());if(tabs.length==0){return{url:sc.get("url")}}return{tab:tabs[0]}},_computeByUrl:function(sc){let forceNewTab=optionalWithDefault(sc.get("alwaysNewTab"),false);let useClipboard=optionalWithDefault(sc.get("useClipboard"),false);if(!useClipboard){return this._computeByUrlNoSearch(sc,forceNewTab)}if(!sc.get("url").includes("%s")){return this._computeByUrlNoSearch(sc,forceNewTab)}if(forceNewTab){return{searchUrl:sc.get("url")}}let retVal={searchUrl:sc.get("url")};let[protocol,hostname]=Classes.NormalizedTabs.getProtocolHostname(retVal.searchUrl);let tabs=this._propertySearch("hostname",hostname);if(tabs.length!=0){retVal.candidateTabs=tabs}return retVal},_computeInfo:function(shortcutKey){let sc=this._shortcutsStore[shortcutKey];if(sc.get("hostname")!=null){this._shortcutsInfo[shortcutKey]=this._computeByHostname(sc.get("hostname"));return}if(sc.get("url")==null){this._shortcutsInfo[shortcutKey]={empty:true};return}this._shortcutsInfo[shortcutKey]=this._computeByUrl(sc)},_computeShortcutsInfo:function(){this._shortcutsInfo={};this._shortcutKeys.forEach(this._computeInfo.bind(this))},updateTabs:function(tabs){this._assert(this.isInitialized());this._tabs=optionalWithDefault(tabs,[]);this._computeShortcutsInfo()},_isTabInCandidateTabs:function(tabId,candidateTabs,firstCandidate){if(candidateTabs==null){return false}if(firstCandidate){return candidateTabs[0].id==tabId}let idx=candidateTabs.findIndex(function(elem,index){if(index==0){return false}if(elem.id==tabId){return true}return false});return idx!=-1},getShortcutKeys:function(){return this._shortcutKeys},getSearchShortcutKeys:function(){let retVal=[];this._shortcutKeys.forEach(function(key){if(this._shortcutsInfo[key].searchUrl!=null){retVal.push(key)}}.bind(this));return retVal},getShortcutKeysForTab:function(tab,firstCandidate){firstCandidate=optionalWithDefault(firstCandidate,true);let retVal=[];this._shortcutKeys.forEach(function(key){if(this._shortcutsInfo[key].tab!=null&&this._shortcutsInfo[key].tab.id==tab.id&&firstCandidate){retVal.push(key)}if(this._isTabInCandidateTabs(tab.id,this._shortcutsInfo[key].candidateTabs,firstCandidate)){retVal.push(key)}}.bind(this));return retVal},getShortcutInfo:function(shortcutKey){const logHead="ShortcutsManager::getShortcutInfo("+shortcutKey+"): ";this._log(logHead+"entering ",this._shortcutsInfo);return this._shortcutsInfo[shortcutKey]},setShortcut:function(shortcutKey,shortcutStoreDict){return this._shortcutsStore[shortcutKey].setAll(shortcutStoreDict)},setShortcutProp:function(shortcutKey,prop,value){return this._shortcutsStore[shortcutKey].set(prop,value)},delShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].del(prop)},getShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].get(prop)},setShortcutTitle:function(shortcutKey,value){return this.setShortcutProp(shortcutKey,"title",value)},getShortcutTitle:function(shortcutKey){return optionalWithDefault(this.getShortcutProp(shortcutKey,"title"),"")},setShortcutHostnameOrUrl:function(shortcutKey,value){const logHead="ShortcutsManager::setShortcutHostnameOrUrl("+shortcutKey+', "'+value+'"): ';let currDict=this._shortcutsStore[shortcutKey].getAll();if(value==""){this._log(logHead+"clearing both hostname and URL");delete currDict["hostname"];delete currDict["url"];return this.setShortcut(shortcutKey,currDict)}let toSet="hostname";let toDel="url";if(isUrl(value)){toSet="url";toDel="hostname";this._log(logHead+"setting as URL")}else{this._log(logHead+"setting as hostname")}currDict[toSet]=value;delete currDict[toDel];return this.setShortcut(shortcutKey,currDict)},getShortcutHostnameOrUrl:function(shortcutKey){let hostname=this.getShortcutProp(shortcutKey,"hostname");if(hostname==null||hostname==""){return this.getShortcutProp(shortcutKey,"url")}return hostname},isShortcutKey:function(key){return this._shortcutKeys.includes(key)},keyToUiString:function(shortcutKey){let idx=this._shortcutKeys.indexOf(shortcutKey);if(idx==-1){return"SC-err"}return"SC"+(idx+1)}});Classes.CustomGroupsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_customGroupsStore:null,_parsedCustomGroups:null,_eventManager:null,_regexEscapePatternObj:/[-\/\\^$*+?.()|[\]{}]/g,_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit()];this._customGroupsStore=Classes.PersistentDict.createAs(this._storageKeyPrefix+"customGroups",chrome.storage.sync);promiseArray.push(this._customGroupsStore.getInitPromise());this._customGroupsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(this._buildCustomGroups.bind(this))},_onUpdatedCb:function(ev){let key=ev.detail.target.getId();const logHead="CustomGroupsManager::_onUpdatedCb("+key+"): ";this._log(logHead+"processing update");this._buildCustomGroups();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_regexEscape:function(simpleRegEx){return simpleRegEx.replace(this._regexEscapePatternObj,"\\$&")},_parseRegex:function(matchList){const logHead="CustomGroupsManager::_parseRegex("+matchList+"): ";if(matchList==null){return null}let list=matchList.split("\n");let trimmedList=[];list.forEach(function(regex){let trimmedRegex=regex.trim();if(trimmedRegex!=""){trimmedList.push("("+this._regexEscape(trimmedRegex)+")")}}.bind(this));let fullExpr=trimmedList.join("|");this._log(logHead+"after split: ",fullExpr);try{return new RegExp(fullExpr)}catch(e){this._err(logHead+"unable to parse regex",e);return null}},_buildCustomGroups:function(){const logHead="CustomGroupsManager::_buildCustomGroups(): ";this._parsedCustomGroups={};let groupTitles=this.getCustomGroupNames();groupTitles.forEach(function(title){this._parsedCustomGroups[title]=this.getCustomGroup(title);this._log(logHead+'processing group "'+title+'": ',this._parsedCustomGroups[title]);this._parsedCustomGroups[title].parsedRegex=this._parseRegex(this._parsedCustomGroups[title].matchList)}.bind(this))},getCustomGroupByHostname:function(hostname){let titles=this.getCustomGroupNames();for(let i=0;i<titles.length;i++){if(this._parsedCustomGroups[titles[i]].parsedRegex!=null&&this._parsedCustomGroups[titles[i]].parsedRegex.test(hostname)){return titles[i]}}return null},hasCustomGroup:function(name,ignoreCase){return this._customGroupsStore.has(name,ignoreCase)},getCustomGroupNames:function(){return this._customGroupsStore.getAllKeys()},getCustomGroup:function(name){return this._customGroupsStore.get(name)},setCustomGroup:function(name,obj){return this._customGroupsStore.set(name,obj)},renameCustomGroup:function(name,newName){return this._customGroupsStore.rename(name,newName)},delCustomGroup:function(name){return this._customGroupsStore.del(name)},getCustomGroupProp:function(name,prop){if(!this._customGroupsStore.has(name)){return null}return this._customGroupsStore.get(name)[prop]},setCustomGroupProp:function(name,prop,value){const logHead="CustomGroupsManager::setCustomGroupProp("+name+", "+prop+"): ";if(!this._customGroupsStore.has(name)){this._err(logHead+"custom group not found");return Promise.reject()}this._log(logHead+"setting value: ",value);let groupInfo=this.getCustomGroup(name);groupInfo[prop]=value;return this.setCustomGroup(name,groupInfo)},_colorToCalloutCss:{none:"tm-callout-none",grey:"tm-callout-grey",blue:"tm-callout-blue",red:"tm-callout-red",yellow:"tm-callout-yellow",green:"tm-callout-green",cyan:"tm-callout-cyan"},getCustomGroupCssByColor:function(color){return this._colorToCalloutCss[color]},getCustomGroupColor:function(groupName){return optionalWithDefault(this.getCustomGroupProp(groupName,"color"),"none")},getCustomGroupCss:function(groupName){let color=this.getCustomGroupColor(groupName);return this.getCustomGroupCssByColor(color)}});Classes.SettingsStore=Classes.AsyncBase.subclass({_storageKeyPrefix:"",_options:null,_customGroups:null,_pinnedGroups:null,_shortcutsManager:null,_eventManager:null,_init:function(storageKeyPrefix){this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit()];this._options=Classes.PersistentDict.createAs(this._storageKeyPrefix+"options",chrome.storage.sync);promiseArray.push(this._options.getInitPromise());this._options.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._customGroupsManager=Classes.CustomGroupsManager.create(this._storageKeyPrefix);promiseArray.push(this._customGroupsManager.getInitPromise());this._customGroupsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._pinnedGroups=Classes.PersistentSet.createAs(this._storageKeyPrefix+"pinnedGroups",chrome.storage.sync);promiseArray.push(this._pinnedGroups.getInitPromise());this._pinnedGroups.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._shortcutsManager=Classes.ShortcutsManager.create(this._storageKeyPrefix);promiseArray.push(this._shortcutsManager.getInitPromise());this._shortcutsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(function(){perfProf.mark("settingsLoaded")})},_onUpdatedCb:function(ev){let key=ev.detail.key;if(key==null){key=ev.detail.target.getId()}this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},getAllOptions:function(){this._assert(this.isInitialized());return this._options},_getOption:function(prop){this._assert(this.isInitialized());return this._options.get(prop)},_getBooleanOption:function(prop,defaultValue){defaultValue=optionalWithDefault(defaultValue,false);let retVal=this._getOption(prop);if(retVal==null){return defaultValue}return retVal},_setOption:function(prop,value){this._assert(this.isInitialized());return this._options.set(prop,value)},getOptionRecentlyClosedInSearch:function(){return this._getBooleanOption("recentlyClosedInSearch",true)},setOptionRecentlyClosedInSearch:function(value){return this._setOption("recentlyClosedInSearch",value)},getOptionBookmarksInSearch:function(){return this._getBooleanOption("bookmarksInSearch",true)},setOptionBookmarksInSearch:function(value){return this._setOption("bookmarksInSearch",value)},getOptionHistoryInSearch:function(){return this._getBooleanOption("historyInSearch")},setOptionHistoryInSearch:function(value){return this._setOption("historyInSearch",value)},getOptionShowTabId:function(){if(!this._getBooleanOption("devMode")){return false}return this._getBooleanOption("showTabId")},setOptionShowTabId:function(value){return this._setOption("showTabId",value)},getOptionDevMode:function(){return this._getBooleanOption("devMode")},setOptionDevMode:function(value){return this._setOption("devMode",value)},getOptionAdvancedMenu:function(){return this._getBooleanOption("advancedMenu")},setOptionAdvancedMenu:function(value){return this._setOption("advancedMenu",value)},getOptionSearchUrl:function(){return this._getOption("searchUrl")},setOptionSearchUrl:function(value){return this._setOption("searchUrl",value)},getPinnedGroups:function(){this._assert(this.isInitialized());return this._pinnedGroups},isGroupPinned:function(groupName){return this._pinnedGroups.has(groupName)},pinGroup:function(groupName){return this._pinnedGroups.add(groupName)},unpinGroup:function(groupName){return this._pinnedGroups.del(groupName)},getCustomGroupsManager:function(){this._assert(this.isInitialized());return this._customGroupsManager},getShortcutsManager:function(){this._assert(this.isInitialized());return this._shortcutsManager}});perfProf.mark("settingsStarted");Classes.Base.roDef(window,"settingsStore",Classes.SettingsStore.create());settingsStore.debug();Classes.ScheduledJob=Classes.Base.subclass({_handle:null,_recurInterval:null,_init:function(jobFn){Classes.Base._init.call(this);if(jobFn!=null){this._jobFn=jobFn}else{this._jobFn=this._job}},run:function(delay){const logHead="ScheduledJob::run(delay = "+delay+", now = "+Date.now()+"): ";if(delay==null||delay==0){this.skip();this._jobFn();return}if(this._handle!=null){this._log(logHead+"already scheduled, handleId = "+this._handle);return}this._handle=setTimeout(function(){this._jobFn();this._handle=null}.bind(this),delay)},start:function(interval,runOnceNow){runOnceNow=optionalWithDefault(runOnceNow,true);const logHead="ScheduledJob::start("+interval+"): ";if(this._handle!=null){this._err(logHead+"already scheduled, handleId = "+this._handle);return}this._log(logHead+"starting");if(runOnceNow){this._jobFn()}this._recurInterval=interval;this._handle=this._safeSetInterval(this._jobFn.bind(this),interval)},stop:function(){const logHead="ScheduledJob::stop(): ";if(this._handle==null){this._log(logHead+"not scheduled");return}if(this._recurInterval==null){clearInterval(this._handle);this._recurInterval=null}else{clearTimeout(this._handle)}this._handle=null},skip:function(){const logHead="ScheduledJob::skip(): ";if(this._handle==null){this._log(logHead+"not scheduled");return}let savedRecurInterval=this._recurInterval;this.stop();if(savedRecurInterval!=null){this.start(savedRecurInterval,false)}},isRunning:function(){return this._handle!=null},_job:function(){this._errorMustSubclass("ScheduledJob::_job()")},_safeSetInterval:function(fn,interval){const logHead="ScheduledJob::_safeSetInterval(): ";if(typeof interval!=="number"){this._err(logHead+"interval is not a number ("+interval+"), bypassing setInterval() to avoid trouble");return}if(interval<1e3){this._err(logHead+"interval is too small ("+interval+"), bypassing setInterval() to avoid trouble");return}return setInterval(fn,interval)}});Classes.PopupDockerBase=Classes.Base.subclass({_undockedInitWidth:420,_undockedInitHeight:800,_init:function(){Classes.Base._init.call(this);this.debug()},getPopupUrl:function(undocked){undocked=optionalWithDefault(undocked,false);let urlSearch="";if(undocked){urlSearch="?undocked"}return chrome.runtime.getURL(isProd()?"popup.html"+urlSearch:"popup/popup.html"+urlSearch)},_launchUndocked:function(){const logHead="PopupDockerBase::_launchUndocked(): ";let storedSize=optionalWithDefault(localStore.getPopupSize(),{});let createData={url:this.getPopupUrl(true),focused:true,type:"popup",left:storedSize.posX,top:storedSize.posY,width:optionalWithDefault(storedSize.width,this._undockedInitWidth),height:optionalWithDefault(storedSize.height,this._undockedInitHeight)};chromeUtils.wrap(chrome.windows.create,logHead,createData).then(function(){this._log(logHead+"launched",createData)}.bind(this))},_openUndocked:function(){const logHead="PopupDockerBase::_openUndocked(): ";this._log(logHead+"entering");chromeUtils.wrap(chrome.tabs.query,logHead,{url:this.getPopupUrl(true)}).then(function(tabs){if(tabs.length==0){this._log(logHead+"undocked tab not found, launching it");this._launchUndocked();return}if(tabs.length>1){this._log(logHead+"unexpected, multiple undocked popups found")}chromeUtils.activateTab(tabs[0].id).then(function(){const extTabId=Classes.NormalizedTabs.formatExtendedId(tabs[0]);this._log(logHead+"activated tab "+extTabId)}.bind(this))}.bind(this))},_setDocked:function(docked){docked=optionalWithDefault(docked,true);const logHead="PopupDockerBase::_setDocked("+docked+"): ";localStore.setPopupDocked(docked);let popupUrl="";if(docked){popupUrl=this.getPopupUrl()}chromeUtils.wrap(chrome.browserAction.setPopup,logHead,{popup:popupUrl}).then(function(){this._log(logHead+"chrome.browserAction.setPopup() succeeded")}.bind(this))},showState:function(){const logHead="PopupDockerBase::showState(): ";chromeUtils.wrap(chrome.browserAction.getPopup,logHead,{}).then(function(result){this._log(logHead+'chrome.browserAction.getPopup() returned "'+result+'" (empty means "undocked")')}.bind(this))}});Classes.LocalStore=Classes.AsyncBase.subclass({_storageKeyPrefix:"",allTabsTabExpandedGroups:null,_bootstrapTabs:null,_eventManager:null,_init:function(storageKeyPrefix){this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit()];this.allTabsTabExpandedGroups=Classes.PersistentSet.createAs("allTabsTab_expanded");promiseArray.push(this.allTabsTabExpandedGroups.getInitPromise());this._bootstrapTabs=Classes.PersistentDict.createAs("bootstrapTabs");promiseArray.push(this._bootstrapTabs.getInitPromise());this._bootstrapTabs.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(function(){perfProf.mark("localStoreLoaded")})},_onUpdatedCb:function(ev){let key=ev.detail.target.getId();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},getActiveBsTab:function(){return this._bootstrapTabs.get("activeTabId")},setActiveBsTab:function(bsTabName){return this._bootstrapTabs.set("activeTabId",bsTabName)},isPopupDocked:function(){return optionalWithDefault(this._bootstrapTabs.get("docked"),false)},setPopupDocked:function(docked){return this._bootstrapTabs.set("docked",docked)},getPopupSize:function(){return this._bootstrapTabs.get("popupSize")},setPopupSize:function(posX,posY,width,height){size={posX:posX,posY:posY,width:width,height:height};return this._bootstrapTabs.set("popupSize",size)}});perfProf.mark("localStoreStarted");Classes.Base.roDef(window,"localStore",Classes.LocalStore.create());localStore.debug();Classes.BookmarksFinder=Classes.Base.subclass({_bookmarkImportInProgress:null,_eventManager:null,_maxBookmarkNodes:500,_init:function(){Classes.Base._init.call(this);this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);chrome.bookmarks.onChanged.addListener(this._bookmarkUpdatedCb.bind(this));chrome.bookmarks.onCreated.addListener(this._bookmarkCreatedCb.bind(this));chrome.bookmarks.onRemoved.addListener(this._bookmarkUpdatedCb.bind(this));chrome.bookmarks.onImportBegan.addListener(this._bookmarkImportBeganCb.bind(this));chrome.bookmarks.onImportEnded.addListener(this._bookmarkImportEndedCb.bind(this))},_bookmarkCreatedCb:function(id,bmNode){if(this._bookmarkImportInProgress){return}this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{id:Classes.NormalizedTabs.normalizeBookmarkId(id)})},_bookmarkUpdatedCb:function(id,changeRemoveInfo){this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{id:Classes.NormalizedTabs.normalizeBookmarkId(id)})},_bookmarkImportBeganCb:function(){this._bookmarkImportInProgress=true},_bookmarkImportEndedCb:function(){this._bookmarkImportInProgress=false;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{})},_processBookmarkTreeNodes:function(nodes){perfProf.mark("bookmarksSearchEnd");const logHead="BookmarksFinder::_processBookmarkTreeNodes(): ";this._log(logHead+"received: ",nodes);let bmCount=0;let bmSkipped=0;let foldersCount=0;perfProf.mark("bookmarksReduceStart");let retVal=nodes.reduce(function(result,node){if(node.url==null){foldersCount++;return result}if(bmCount>=this._maxBookmarkNodes){bmSkipped++;return result}Classes.NormalizedTabs.normalizeTab(node,Classes.NormalizedTabs.type.BOOKMARK);bmCount++;result.push(node);return result}.bind(this),[]);perfProf.mark("bookmarksReduceEnd");this._log(logHead+"processed "+bmCount+", skipped: "+bmSkipped+", folders: "+foldersCount);return retVal},find:function(searchString){const logHead="BookmarksFinder::find("+searchString+"): ";if(!settingsStore.getOptionBookmarksInSearch()){this._log(logHead+"bookmarks are disabled in search, nothing to do");return Promise.resolve([])}this._log(logHead+"processing bookmarks");perfProf.mark("bookmarksSearchStart");return chromeUtils.wrap(chrome.bookmarks.search,logHead,searchString).then(this._processBookmarkTreeNodes.bind(this))}});Classes.HistoryFinder=Classes.Base.subclass({_eventManager:null,_maxHistoryItems:500,_hasHistoryPermission:null,_init:function(){const logHead="HistoryFinder::_init(): ";Classes.Base._init.call(this);this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);chrome.permissions.onAdded.addListener(this._permissionAddedCb.bind(this));chrome.permissions.onRemoved.addListener(this._permissionRemovedCb.bind(this));chrome.sessions.onChanged.addListener(this._recentlyClosedChangedCb.bind(this));chromeUtils.wrap(chrome.permissions.contains,logHead,{permissions:["history"]}).then(function(hasPermission){if(hasPermission){this._hasHistoryPermission=true;this._addHistoryEventsListeners()}else{this._hasHistoryPermission=false;this._log(logHead+"permission not set, starting without event listeners")}}.bind(this))},_addHistoryEventsListeners:function(){const logHead="HistoryFinder::_addHistoryEventsListeners(): ";this._log(logHead+"initializing history event listeners");chrome.history.onVisitRemoved.addListener(this._visitRemovedCb.bind(this));chrome.history.onVisited.addListener(this._visitedCb.bind(this))},_removeHistoryEventsListeners:function(){const logHead="HistoryFinder::_removeHistoryEventsListeners(): ";this._log(logHead+"removing history event listeners");chrome.history.onVisitRemoved.removeListener(this._visitRemovedCb.bind(this));chrome.history.onVisited.removeListener(this._visitedCb.bind(this))},_permissionAddedCb:function(permissions){const logHead="HistoryFinder::_permissionAddedCb(): ";if(permissions.permissions.includes("history")){this._log(logHead+'granted "history" permission',permissions);this._hasHistoryPermission=true;this._addHistoryEventsListeners()}else{this._log(logHead+'no "history" in permissions, ignoring',permissions)}},_permissionRemovedCb:function(permissions){const logHead="HistoryFinder::_permissionRemovedCb(): ";if(permissions.permissions.includes("history")){this._hasHistoryPermission=false;this._log(logHead+'revoked "history" permission',permissions);this._removeHistoryEventsListeners()}else{this._log(logHead+'no "history" in permissions, ignoring',permissions)}},_visitRemovedCb:function(removed){let extraDetail={event:Classes.HistoryFinder.event.REMOVED,data:removed};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,extraDetail)},_visitedCb:function(historyItem){let extraDetail={event:Classes.HistoryFinder.event.VISITED,data:historyItem};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,extraDetail)},_recentlyClosedChangedCb:function(){let extraDetail={event:Classes.HistoryFinder.event.RCTAB};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,extraDetail)},_processHistoryItems:function(items){perfProf.mark("historySearchEnd");const logHead="HistoryFinder::_processHistoryItems(): ";this._log(logHead+"received: ",items);perfProf.mark("historyReduceStart");let popupUrl=popupDocker.getPopupUrl(true);let retVal=items.reduce(function(result,tab){if(tab.url!=popupUrl){Classes.NormalizedTabs.normalizeTab(tab,Classes.NormalizedTabs.type.HISTORY);result.push(tab)}return result}.bind(this),[]);perfProf.mark("historyReduceEnd");return retVal},find:function(searchString){const logHead="HistoryFinder::find("+searchString+"): ";if(!settingsStore.getOptionHistoryInSearch()){this._log(logHead+"history is disabled in search, nothing to do");return Promise.resolve([])}this._log(logHead+"processing history");perfProf.mark("historySearchStart");let query={maxResults:this._maxHistoryItems,startTime:0,text:searchString};return chromeUtils.wrap(chrome.history.search,logHead,query).then(this._processHistoryItems.bind(this))},_processRecentlyClosedTabs:function(sessions){const logHead="HistoryFinder::_processRecentlyClosedTabs(): ";let tabs=[];let popupUrl=popupDocker.getPopupUrl(true);for(let i=0;i<sessions.length;i++){let session=sessions[i];if(session.tab==null){let window=session.window;for(let j=0;window.tabs!=null&&j<window.tabs.length;j++){let tab=window.tabs[j];if(tab.url!=popupUrl&&tab.index!=-1){this._assert(!tab.active,logHead+"recently closed tabs can't be active",tab);Classes.NormalizedTabs.normalizeTab(tab,Classes.NormalizedTabs.type.RCTAB);tab.tm.windowSessionId=window.sessionId;tabs.push(tab)}}}else{let tab=session.tab;if(tab.url!=popupUrl){this._assert(!tab.active,logHead+"recently closed tabs can't be active",tab);Classes.NormalizedTabs.normalizeTab(tab,Classes.NormalizedTabs.type.RCTAB);tabs.push(tab)}}}return tabs},_getRecentlyClosedTabs:function(){const logHead="HistoryFinder::_getRecentlyClosedTabs(): ";if(!settingsStore.getOptionRecentlyClosedInSearch()){this._log(logHead+"recently closed tabs are disabled in search, nothing to do");return Promise.resolve([])}return chromeUtils.wrap(chrome.sessions.getRecentlyClosed,logHead,null).then(function(session){this._log(logHead+"sessions.getRecentlyClosed() returned: ",session);return this._processRecentlyClosedTabs(session)}.bind(this))}});Classes.Base.roDef(Classes.HistoryFinder,"event",{});Classes.Base.roDef(Classes.HistoryFinder.event,"REMOVED","removed");Classes.Base.roDef(Classes.HistoryFinder.event,"VISITED","visited");Classes.Base.roDef(Classes.HistoryFinder.event,"RCTAB","rctab");Classes.PopupDocker=Classes.PopupDockerBase.subclass({_dockedInitBodyWidth:400,_dockedInitBodyHeight:542,_ownTabId:null,_ownWindowId:null,_savePopupSizeJob:null,_savePopupSizeDelay:1e3,_init:function(){const logHead="PopupDocker::_init(): ";Classes.PopupDockerBase._init.call(this);this.debug();this._savePopupSizeJob=Classes.ScheduledJob.create(this._savePopupSize.bind(this));this._savePopupSizeJob.debug();window.addEventListener("load",this._loadCb.bind(this));localStore.addEventListener(Classes.EventManager.Events.UPDATED,this._updatedCb.bind(this));if(!this.isPopupDocked()){chromeUtils.wrap(chrome.tabs.query,logHead,{currentWindow:true}).then(function(tabs){this._assert(tabs.length==1);this._log(logHead+"chrome.tabs.query() returned:",tabs);this._ownTabId=tabs[0].id;this._ownWindowId=tabs[0].windowId;chrome.tabs.onCreated.addListener(this._popupDefenderCb.bind(this));window.addEventListener("resize",this._onResizeCb.bind(this));window.addEventListener("unload",this._onUnloadCb.bind(this))}.bind(this))}},_loadCb:function(ev){if(this.isPopupDocked()){document.body.style.width=this._dockedInitBodyWidth+"px";document.body.style.height=this._dockedInitBodyHeight+"px"}},_updatedCb:function(ev){const logHead="PopupDocker::_updatedCb("+ev.detail.key+"): ";if(localStore.isPopupDocked()&&!this.isPopupDocked()){this._log(logHead+"the popup is now configured docked, need to close myself");this._log.bg(logHead+"the popup is now configured docked, need to close myself");window.close();return}if(!localStore.isPopupDocked()&&this.isPopupDocked()){this._log(logHead+"the popup is now configured undocked, need to close myself");this._log.bg(logHead+"the popup is now configured undocked, need to close myself");window.close();return}this._log(logHead+"docking state unchanged")},_popupDefenderCb:function(tab){const logHead="PopupDocker::_popupDefenderCb(): ";if(tab.windowId!=this._ownWindowId){return}this._err(logHead+"need to relocate invader",tab);chromeUtils.moveTabToLeastTabbedWindow(tab)},_onResizeCb:function(ev){this._savePopupSizeJob.run(this._savePopupSizeDelay)},_onUnloadCb:function(ev){this._savePopupSize()},_savePopupSize:function(){const logHead="PopupDocker::_savePopupSize(): ";this._log(logHead+"saving window size: ",window.screenLeft,window.screenTop,window.outerWidth,window.outerHeight);localStore.setPopupSize(window.screenLeft,window.screenTop,window.outerWidth,window.outerHeight)},isPopupDocked:function(){if(window.location.search==""){return true}return false},undock:function(){const logHead="PopupDocker::undock(): ";if(!this.isPopupDocked()){this._log(logHead+"already undocked");this._log.bg(logHead+"already undocked");return}this._setDocked(false);this._openUndocked();window.close()},dock:function(){const logHead="PopupDocker::dock(): ";if(this.isPopupDocked()){this._log(logHead+"already docked");this._log.bg(logHead+"already docked");return}this._setDocked(true);window.close()},dockToggle:function(){if(this.isPopupDocked()){this.undock();return}this.dock()},getOwnTabId:function(){if(this.isPopupDocked()){return-1}if(this._ownTabId==null){const logHead="PopupDocker::getOwnTabId(): ";this._err(logHead+"still waiting for initialization");return-2}return this._ownTabId}});Classes.Base.roDef(window,"popupDocker",Classes.PopupDocker.create());Classes.PopupMsgServer=Classes.MsgServer.subclass({_init:function(){Classes.MsgServer._init.apply(this,arguments)}});icons={searchBox:`
	<svg class="tm-fa-magnifier-align" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
`,thumbtack:function(...args){let classes=optArrayWithDefault(args,["tm-fa-thumbtack-tile"]);return`
	<svg class="${classes.join(" ")}" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M298.028 214.267L285.793 96H328c13.255 0 24-10.745 24-24V24c0-13.255-10.745-24-24-24H56C42.745 0 32 10.745 32 24v48c0 13.255 10.745 24 24 24h42.207L85.972 214.267C37.465 236.82 0 277.261 0 328c0 13.255 10.745 24 24 24h136v104.007c0 1.242.289 2.467.845 3.578l24 48c2.941 5.882 11.364 5.893 14.311 0l24-48a8.008 8.008 0 0 0 .845-3.578V352h136c13.255 0 24-10.745 24-24-.001-51.183-37.983-91.42-85.973-113.733z"></path></svg>
	`},volumeMuted:function(...args){return`
	<svg class="tm-fa-volume-align ${args.join(" ")}" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M215.03 71.05L126.06 160H24c-13.26 0-24 10.74-24 24v144c0 13.25 10.74 24 24 24h102.06l88.97 88.95c15.03 15.03 40.97 4.47 40.97-16.97V88.02c0-21.46-25.96-31.98-40.97-16.97zM461.64 256l45.64-45.64c6.3-6.3 6.3-16.52 0-22.82l-22.82-22.82c-6.3-6.3-16.52-6.3-22.82 0L416 210.36l-45.64-45.64c-6.3-6.3-16.52-6.3-22.82 0l-22.82 22.82c-6.3 6.3-6.3 16.52 0 22.82L370.36 256l-45.63 45.63c-6.3 6.3-6.3 16.52 0 22.82l22.82 22.82c6.3 6.3 16.52 6.3 22.82 0L416 301.64l45.64 45.64c6.3 6.3 16.52 6.3 22.82 0l22.82-22.82c6.3-6.3 6.3-16.52 0-22.82L461.64 256z"></path></svg>
	`},volumeAudible:`
	<svg class="tm-fa-volume-align" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M215.03 71.05L126.06 160H24c-13.26 0-24 10.74-24 24v144c0 13.25 10.74 24 24 24h102.06l88.97 88.95c15.03 15.03 40.97 4.47 40.97-16.97V88.02c0-21.46-25.96-31.98-40.97-16.97zm233.32-51.08c-11.17-7.33-26.18-4.24-33.51 6.95-7.34 11.17-4.22 26.18 6.95 33.51 66.27 43.49 105.82 116.6 105.82 195.58 0 78.98-39.55 152.09-105.82 195.58-11.17 7.32-14.29 22.34-6.95 33.5 7.04 10.71 21.93 14.56 33.51 6.95C528.27 439.58 576 351.33 576 256S528.27 72.43 448.35 19.97zM480 256c0-63.53-32.06-121.94-85.77-156.24-11.19-7.14-26.03-3.82-33.12 7.46s-3.78 26.21 7.41 33.36C408.27 165.97 432 209.11 432 256s-23.73 90.03-63.48 115.42c-11.19 7.14-14.5 22.07-7.41 33.36 6.51 10.36 21.12 15.14 33.12 7.46C447.94 377.94 480 319.54 480 256zm-141.77-76.87c-11.58-6.33-26.19-2.16-32.61 9.45-6.39 11.61-2.16 26.2 9.45 32.61C327.98 228.28 336 241.63 336 256c0 14.38-8.02 27.72-20.92 34.81-11.61 6.41-15.84 21-9.45 32.61 6.43 11.66 21.05 15.8 32.61 9.45 28.23-15.55 45.77-45 45.77-76.88s-17.54-61.32-45.78-76.86z"></path></svg>
`,bookmark:`
	<svg class="tm-fa-bookmark" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M0 512V48C0 21.49 21.49 0 48 0h288c26.51 0 48 21.49 48 48v464L192 400 0 512z"></path></svg>
`,history:function(...args){return`
	<svg class="${args.join(" ")}" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 18"><path fill="currentColor" d="M3 9a8 8 0 113.73 6.77L8.2 14.3A6 6 0 105 9l3.01-.01-4 4-4-4h3L3 9zm7-4h1.01L11 9.36l3.22 2.1-.6.93L10 10V5z"></path></svg>
	`}};Classes.Viewer=Classes.Base.subclass({_rootElem:null,_bodyElem:null,_init:function(){Classes.Base._init.call(this)},_elementGen:function(html){var tmpElem=document.createElement("div");tmpElem.innerHTML=html;return tmpElem.firstElementChild},_getBodyElem:function(){if(this._bodyElem!=null){return this._bodyElem}if(this._rootElem!=null){return this._rootElem}return null},_safeText:function(text){var tmpElem=document.createElement("div");tmpElem.textContent=text;return tmpElem.innerHTML},getRootElement:function(){return this._rootElem},getBodyElement:function(){return this._getBodyElem()},getElementById:function(domId){return this._rootElem.querySelector("#"+domId)},addClasses:function(...args){this._rootElem.classList.add(...args)},removeClasses:function(...args){this._rootElem.classList.remove(...args)},setHtml:function(html){const logHead="Viewer::setHtml(): ";var bodyElem=this._getBodyElem();try{bodyElem.innerHTML=html}catch(e){this._err(logHead,e)}},setText:function(text){const logHead="Viewer::setText(): ";var bodyElem=this._getBodyElem();try{bodyElem.textContent=text}catch(e){this._err(logHead,e)}},append:function(viewer){this._getBodyElem().append(viewer.getRootElement())},addBefore:function(viewer){let parentNode=viewer.getRootElement().parentNode;this._assert(parentNode!=null);parentNode.insertBefore(this._rootElem,viewer.getRootElement())},detach:function(){this.getRootElement().remove()},attachToElement:function(parentDomElem){parentDomElem.textContent="";this.appendToElement(parentDomElem)},appendToElement:function(parentDomElem){parentDomElem.append(this._rootElem)},clear:function(){const logHead="Viewer::clear(): ";var bodyElem=this._getBodyElem();if(bodyElem==null){log._err(logHead+"no body or root element, can't take action");return}bodyElem.textContent=""},show:function(){this._rootElem.classList.remove("tm-hide")},hide:function(){this._rootElem.classList.add("tm-hide")},isInDocumentDom:function(){if(this._rootElem.id==null){return null}return document.getElementById(this._rootElem.id)!=null},isInViewport:function(){let clientRect=this._rootElem.getBoundingClientRect();return clientRect.top<window.innerHeight&&clientRect.bottom>=0},runAnimation:function(animClass,elem){elem=optionalWithDefault(elem,this._rootElem);let resolveFn=null;let retVal=new Promise(function(resolve,reject){resolveFn=resolve;elem.addEventListener("animationend",resolveFn)}.bind(this)).then(function(){elem.removeEventListener("animationend",resolveFn);elem.classList.remove(animClass)}.bind(this));elem.classList.add(animClass);return retVal}});Classes.HtmlViewer=Classes.Viewer.subclass({_rootElem:null,_init:function(html){Classes.Viewer._init.call(this);this._rootElem=this._elementGen(html)}});Classes.ButtonViewer=Classes.HtmlViewer.subclass({__idPrefix:"btn",_buttonElem:null,_init:function(options){options=optionalWithDefault(options,{});options.labelHtml=optionalWithDefault(options.labelHtml,"");options.fullWidth=optionalWithDefault(options.fullWidth,false);options.btnExtraClasses=optionalWithDefault(options.btnExtraClasses,[]);this._options=options;const logHead="ButtonViewer::_init(): ";const buttonId=this._id+"-button";let fullWidthHtmlBefore="";let fullWidthHtmlAfter="";if(this._options.fullWidth){fullWidthHtmlBefore=`<div class="d-grid gap-2">`;fullWidthHtmlAfter=`</div>`}const buttonHtml=`
	<div class="tm-btnbar-btn tm-full-height">
		${fullWidthHtmlBefore}
			<a class="btn ${this._options.btnExtraClasses.join(" ")}" role="button"	id="${buttonId}">
				${this._options.labelHtml}
			</a>
		${fullWidthHtmlAfter}
	</div>
	`;Classes.HtmlViewer._init.call(this,buttonHtml);this.debug();this._log(logHead,this);this._buttonElem=this.getElementById(buttonId);this._buttonElem.addEventListener("click",this._onButtonClickCbWrapper.bind(this),false)},_onButtonClickCbWrapper:function(ev){this.onButtonClickCb(ev)},onButtonClickCb:function(ev){this._errorMustSubclass("ButtonViewer::onButtonClickCb()")}});Classes.TabViewer=Classes.Viewer.subclass({_headingElem:null,_triggerElem:null,_rootElem:null,_init:function(tabLabelHtml){Classes.Viewer._init.apply(this,arguments);this._createTab(tabLabelHtml)},_createTab:function(tabLabelHtml){const headingId=this._id;const bodyId=this._id+"-body";const headingHtml=`
		<li class="nav-item bg-light" role="presentation">
			<a class="nav-link tm-nav-link" id="${headingId}" data-bs-toggle="tab" href="#${bodyId}" role="tab" aria-controls="${bodyId}" aria-selected="false">${tabLabelHtml}</a>
		</li>
	`;const bodyHtml=`
		<div class="tab-pane fade tm-scrollable-bstab-body" id="${bodyId}" role="tabpanel" aria-labelledby="${headingId}">
		</div>
	`;this._headingElem=this._elementGen(headingHtml);this._triggerElem=this._headingElem.querySelector("#"+headingId);this._rootElem=this._elementGen(bodyHtml)},addBsTabActivationStartListener:function(fn){this._triggerElem.addEventListener("show.bs.tab",fn)},addBsTabActivationEndListener:function(fn){this._triggerElem.addEventListener("shown.bs.tab",fn)},addBsTabDeactivationStartListener:function(fn){this._triggerElem.addEventListener("hide.bs.tab",fn)},addBsTabDeactivationEndListener:function(fn){this._triggerElem.addEventListener("hidden.bs.tab",fn)},activate:function(){const logHead="TabViewer::activate(): ";this._log(logHead+"entering");let tab=new bootstrap.Tab(this._triggerElem);tab.show()},isTabActive:function(){return this._triggerElem.classList.contains("active")},getHeadingElement:function(){return this._headingElem},OLDblink:function(){this._triggerElem.classList.add("tm-blink");setTimeout(this._removeBlinkCb.bind(this),400)},blink:function(){this.runAnimation("tm-blink",this._triggerElem)},_removeBlinkCb:function(){this._triggerElem.classList.remove("tm-blink")}});Classes.SearchableTabViewer=Classes.TabViewer.subclass({_searchBoxElem:null,_searchBoxCountElem:null,_searchActive:null,_standardViewScrollTop:null,_bodyElem:null,_activateSearchCbBoundFn:null,_init:function(tabLabelHtml){Classes.TabViewer._init.apply(this,arguments);this._activateSearchCbBoundFn=this._activateSearchCb.bind(this);this._SearchableTabViewer_initBodyElem();this._SearchableTabViewer_searchBoxInactiveInner()},_searchBoxProcessData:function(value){},_SearchableTabViewer_initBodyElem:function(){const bodyId=this._id+"-body-inner";const searchBoxId=this._id+"-searchbox";const searchBoxCountId=this._id+"-searchbox-count";const bodyHtml=`
		<div class="m-1 tm-stacked-below tm-hide">
			<input type="search" id="${searchBoxId}" incremental class="form-control tm-searchbox" placeholder="Type to start searching">
			<div class="tm-overlay tm-vertical-center tm-searchbox-icon">${icons.searchBox}</div>
			<div class="tm-overlay tm-vertical-center tm-searchbox-count">
				<span id="${searchBoxCountId}" class="tm-shaded badge tm-number-badge bg-secondary"></span>
			</div>
		</div>

		<div class="tm-fit-bottom" id="${bodyId}" style="overflow: auto;">
		</div>
	`;this.setHtml(bodyHtml);this._searchBoxElem=this.getElementById(searchBoxId);this._searchBoxCountElem=this.getElementById(searchBoxCountId);this.addSearchEventListener(this._searchBoxInputListenerCb.bind(this));this._bodyElem=this.getElementById(bodyId);this.addBsTabActivationEndListener(this._bsTabActivatedCb.bind(this));this.addBsTabDeactivationEndListener(this._bsTabDeactivatedCb.bind(this))},_bsTabActivatedCb:function(ev){const logHead="SearchableTabViewer::_bsTabActivatedCb(): ";this._log(logHead+"searchable tab activated");window.addEventListener("keydown",this._activateSearchCbBoundFn,true);if(this._searchActive){this._searchBoxElem.focus()}},_bsTabDeactivatedCb:function(ev){const logHead="SearchableTabViewer::_bsTabDeactivatedCb(): ";this._log(logHead+"searchable tab deactivated");window.removeEventListener("keydown",this._activateSearchCbBoundFn,true)},_SearchableTabViewer_searchBoxInactiveInner:function(){const logHead="SearchableTabViewer::_SearchableTabViewer_searchBoxInactiveInner(): ";this._searchBoxElem.parentElement.classList.add("tm-hide");this._bodyElem.classList.remove("tm-fit-after-search");this._searchActive=false;this._log(logHead+"about to call scrollTo(0, "+this._standardViewScrollTop+")");this._bodyElem.scrollTo(0,this._standardViewScrollTop)},_activateSearchBox:function(active){active=optionalWithDefault(active,true);if(active){this._standardViewScrollTop=this._bodyElem.scrollTop;this._searchBoxElem.parentElement.classList.remove("tm-hide");this._bodyElem.classList.add("tm-fit-after-search");this._searchActive=true;this._searchBoxElem.focus()}else{this._SearchableTabViewer_searchBoxInactiveInner()}},_respondToEnterKey:function(searchBoxText){this._errorMustSubclass("SearchableTabViewer::_respondToEnterKey(): ")},_modifierToString:function(ev){if(ev.altKey){return"Alt"}if(ev.ctrlKey){return"Control"}if(ev.metaKey){return"Meta"}return null},_isPasteKeyboardShortcut:function(ev,modifier){return(modifier=="Control"||modifier=="Meta")&&ev.key=="v"},_activateSearchCb:function(ev){const logHead="SearchableTabViewer::_activateSearchCb(key = "+ev.key+"): ";if(ev.defaultPrevented){this._log(logHead+"defaultPrevented == true, event already processed");return}if(this._searchActive){if(ev.key=="Enter"){this._respondToEnterKey(this._searchBoxElem.value)}return}if(ev.key.length>1){this._log(logHead+"ignoring key");return}let modifier=this._modifierToString(ev);if(modifier!=null){if(this._isPasteKeyboardShortcut(ev,modifier)){this._log(logHead+"identified 'paste' shortcut")}else{this._log(logHead+"ignoring key with key modifier "+modifier+" active");return}}this._log(logHead+"starting search");this._activateSearchBox()},_searchBoxInputListenerCb:function(ev){const logHead='SearchableTabViewer::_searchBoxInputListenerCb(value: "'+ev.target.value+'", '+"time: "+Date.now()+"): ";this._log(logHead+"searchbox changed");if(ev.target.value==""){this._activateSearchBox(false);return}this._searchBoxProcessData(ev.target.value)},_setSearchBoxCount:function(cnt){if(cnt==null){this._searchBoxCountElem.innerHTML="Searching..."}else{this._searchBoxCountElem.textContent=cnt<1e4?cnt:"9999+"}},_setSearchBoxCountBlinking:function(flag){flag=optionalWithDefault(flag,true);const logHead="SearchableTabViewer::_setSearchBoxCountBlinking("+flag+"): ";this._log(logHead+"entering");if(flag){this._searchBoxCountElem.classList.add("tm-blink-loop")}else{this._searchBoxCountElem.classList.remove("tm-blink-loop")}},isSearchActive:function(){return this._searchActive},getSearchQuery:function(){if(!this.isSearchActive()){return null}return this._searchBoxElem.value},addSearchEventListener:function(fn){this._searchBoxElem.addEventListener("search",fn,true)}});Classes.GroupsBuilder=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},_getHostname:function(tab){return tab.tm.hostname},_getWindowId:function(tab){return tab.windowId},_findFavIconUrl:function(groupName,tabs){let favIconUrl=settingsStore.getCustomGroupsManager().getCustomGroupProp(groupName,"favIconUrl");if(favIconUrl!=null){return favIconUrl}let secondChoice=null;for(var i=0;i<tabs.length;i++){if(tabs[i].favIconUrl!=null){if(tabs[i].tm.cachedFavIcon){secondChoice=tabs[i].favIconUrl}else{return tabs[i].favIconUrl}}}if(secondChoice!=null){return secondChoice}return""},_tabGroupEntryToObj:function(groupName,data,pinned){pinned=optionalWithDefault(pinned,false);let retVal={tabs:data.tabs.sort(Classes.NormalizedTabs.compareTabsFn),tm:{}};if(data.type==Classes.GroupsBuilder.Type.HOSTNAME&&data.tabs.length==1&&!settingsStore.isGroupPinned(groupName)){retVal.type=Classes.GroupsBuilder.Type.TAB;retVal.title=data.tabs[0].title;retVal.favIconUrl=data.tabs[0].favIconUrl}else{retVal.type=data.type;retVal.title=groupName;retVal.favIconUrl=this._findFavIconUrl(groupName,data.tabs)}retVal.tm.lowerCaseTitle=retVal.title.toLowerCase();retVal.tm.normTitle=Classes.NormalizedTabs.normalizeLowerCaseTitle(retVal.tm.lowerCaseTitle);retVal.tm.pinned=pinned;return retVal},_tabsHasPinnedTab:function(tabs){for(let i=0;i<tabs.length;i++){if(tabs[i].pinned){return true}}return false},_tabGroupsToArrays:function(tabGroups){const logHead="GroupsBuilder::_tabGroupsToArrays(): ";let pinned=[];let unpinned=[];for(const[groupName,data]of Object.entries(tabGroups)){switch(data.type){case Classes.GroupsBuilder.Type.HOSTNAME:if(settingsStore.isGroupPinned(groupName)||this._tabsHasPinnedTab(data.tabs)){pinned.push(this._tabGroupEntryToObj(groupName,data,true))}else{unpinned.push(this._tabGroupEntryToObj(groupName,data))}break;case Classes.GroupsBuilder.Type.CUSTOM:if(settingsStore.isGroupPinned(groupName)||this._tabsHasPinnedTab(data.tabs)){pinned.push(this._tabGroupEntryToObj(groupName,data,true))}else{unpinned.push(this._tabGroupEntryToObj(groupName,data))}break;case Classes.GroupsBuilder.Type.PINNEDEMPTY:pinned.push(this._tabGroupEntryToObj(groupName,data,true));break;default:log._err(logHead+"unknown type "+data.type);break}}this._log(logHead+"unpinned = ",unpinned);return[pinned.sort(Classes.NormalizedTabs.compareTitlesFn),unpinned.sort(Classes.NormalizedTabs.compareTitlesFn)]},_groupByCriterion:function(tabs,criterionFn,type){const logHead="GroupsBuilder::_groupByCriterion(): ";let tabGroups={};tabs.forEach(function(tab){var key=criterionFn(tab);if(key==null){this._err(logHead+"unable to generate key for tab ",tab);return}if(key in tabGroups){tabGroups[key].tabs.push(tab)}else{tabGroups[key]={type:type,tabs:[tab]}}}.bind(this));return tabGroups},_addCustomGroups:function(inputTabGroups){const logHead="GroupsBuilder::_addCustomGroups(): ";let retVal={};let cgm=settingsStore.getCustomGroupsManager();for(const[key,data]of Object.entries(inputTabGroups)){let tabs=data.tabs;let title=cgm.getCustomGroupByHostname(key);let type=Classes.GroupsBuilder.Type.CUSTOM;if(title==null){title=key;type=data.type}if(title in retVal){retVal[title].tabs.push(...tabs);if(retVal[title].type==Classes.GroupsBuilder.Type.HOSTNAME&&type==Classes.GroupsBuilder.Type.CUSTOM){retVal[title].type=Classes.GroupsBuilder.Type.CUSTOM}}else{retVal[title]={type:type,tabs:tabs}}}return retVal},_addEmptyPinnedGroups:function(tabGroups){settingsStore.getPinnedGroups().getAll().forEach(function(groupName){if(groupName in tabGroups){return}tabGroups[groupName]={type:Classes.GroupsBuilder.Type.PINNEDEMPTY,tabs:[]}});return tabGroups},groupByHostname:function(tabs){let tabGroups=this._groupByCriterion(tabs,this._getHostname.bind(this),Classes.GroupsBuilder.Type.HOSTNAME);return this._tabGroupsToArrays(this._addEmptyPinnedGroups(this._addCustomGroups(tabGroups)))},groupByWindowId:function(tabs){return this._tabGroupsToArrays(this._groupByCriterion(tabs,this._getWindowId.bind(this),Classes.GroupsBuilder.Type.WINDOWID))},getGroupProperties:function(title){return this._groups[title]}});Classes.Base.roDef(Classes.GroupsBuilder,"Type",{});Classes.Base.roDef(Classes.GroupsBuilder.Type,"HOSTNAME","hostname");Classes.Base.roDef(Classes.GroupsBuilder.Type,"WINDOWID","windowid");Classes.Base.roDef(Classes.GroupsBuilder.Type,"CUSTOM","custom");Classes.Base.roDef(Classes.GroupsBuilder.Type,"PINNEDEMPTY","pinnedempty");Classes.Base.roDef(Classes.GroupsBuilder.Type,"TAB","tab");Classes.ContainerViewer=Classes.Viewer.subclass({__idPrefix:"ContainerViewer",_rootElem:null,_htmlWhenEmpty:null,_appendedCnt:null,_init:function(htmlWhenEmpty){Classes.Viewer._init.apply(this,arguments);const logHead="ContainerViewer::_init(): ";this._htmlWhenEmpty=htmlWhenEmpty;this._containerViewerRender()},_containerViewerRender:function(){const logHead="ContainerViewer::_containerViewerRender(): ";const bodyHtml=`
	<div id="${this._id}">
	</div>
	`;this._rootElem=this._elementGen(bodyHtml);this._renderEmptyContainer()},_renderEmptyContainer:function(){const html=`
	<div class="tm-all-center text-center">
		<span>${this._htmlWhenEmpty}</span>
	</div>
	`;this._appendedCnt=0;this.setHtml(html)},append:function(viewer){if(this._appendedCnt==0){this._getBodyElem().textContent=""}this._appendedCnt++;Classes.Viewer.append.apply(this,arguments)},clear:function(){this._renderEmptyContainer()}});Classes.CollapsibleContainerViewer=Classes.ContainerViewer.subclass({__idPrefix:"CollapsibleContainerViewer",_rootElem:null,_bodyElem:null,_headingElem:null,_options:null,_init:function(options){options=optionalWithDefault(options,{});options.startExpanded=optionalWithDefault(options.startExpanded,false);options.htmlWhenEmpty=optionalWithDefault(options.htmlWhenEmpty,"");options.border=optionalWithDefault(options.border,true);this._options=options;Classes.ContainerViewer._init.call(this,this._options.htmlWhenEmpty);this._renderHeadingAndBody()},_renderHeadingAndBody:function(){const logHead="CollapsibleContainerViewer::_renderHeadingAndBody(): ";const headingId=this._id+"-heading";const headingInnerId=this._id+"-heading-inner";const bodyId=this._id+"-body";const bodyInnerId=this._id+"-body-inner";this._rootElem.classList.add("accordion");var headingExtraClasses=[];var bodyExtraClasses=[];var bodyInnerExtraClasses=[];if(this._options.border){bodyExtraClasses.push("accordion-collapse");bodyInnerExtraClasses.push("tm-indent-right")}if(this._options.startExpanded){bodyExtraClasses.push("show")}else{headingExtraClasses.push("collapsed")}const headingHtml=`
		<h2 class="accordion-header" id="${headingId}">
			<button id=${headingInnerId} class="accordion-button ${headingExtraClasses.join(" ")} p-2" type="button" data-bs-toggle="collapse"
						data-bs-target="#${bodyId}"	aria-expanded="true" aria-controls="${bodyId}">
			</button>
		</h2>
	`;const bodyHtml=`
		<div id="${bodyId}" class="collapse tm-min-empty-container ${bodyExtraClasses.join(" ")}" aria-labelledby="${headingId}" data-bs-parent="#${this._id}">
			<div id="${bodyInnerId}" class="${bodyInnerExtraClasses.join(" ")}">
			</div>
		</div>
	`;const outerHtml=`
		<div class="accordion-item">
			${headingHtml}
			${bodyHtml}
		</div>
	`;this.setHtml(outerHtml);this._headingElem=this.getElementById(headingInnerId);this._bodyElem=this.getElementById(bodyInnerId);this._renderEmptyContainer()},setHeadingHtml:function(html){this._headingElem.innerHTML=html},addHeadingClasses:function(...args){this._headingElem.classList.add(...args)},addCollapsedStartListener:function(fn){this._bodyElem.parentElement.addEventListener("hide.bs.collapse",fn)},addExpandedStartListener:function(fn){this._bodyElem.parentElement.addEventListener("show.bs.collapse",fn)}});Classes.SettingsItemViewer=Classes.HtmlViewer.subclass({__idPrefix:"SettingsItemViewer",_rootElem:null,_inputElem:null,_setFn:null,_getFn:null,_rootHtml:`
		<div class="mx-2 mt-3">
		</div>
	`,_trackedUpdateKey:null,_init:function({setFn:setFn,getFn:getFn,label:label,updateKey:updateKey}){Classes.HtmlViewer._init.call(this,this._rootHtml);this.debug();this._assert(setFn!=getFn);this._setFn=setFn;this._getFn=getFn;this._label=label;this._trackedUpdateKey=updateKey;this._enabled=true;this._startListeners()},_startListeners:function(){settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,function(ev){if(this._trackedUpdateKey==null||this._trackedUpdateKey==ev.detail.key){this.setValue(this._getFn())}}.bind(this))},_setAttributesHtml:function(extraAttrs){if(!this._enabled){extraAttrs.push(`disabled`)}},setEnabled:function(flag){this._enabled=flag;this._assert(this._inputElem!=null);if(flag){this._inputElem.removeAttribute("disabled")}else{this._inputElem.setAttribute("disabled","")}},setValue:function(value){value=optionalWithDefault(value,"");const logHead='SettingsItemViewer::setValue("'+value+'"): ';if(this._inputElem==null){this._log(logHead+"_inputElem not ready, nothing to do");return}this._log(logHead+"setting value");this._inputElem.value=value},setFocus:function(){this._inputElem.focus()}});Classes.SettingsTextItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsTextItemViewer",_placeholderText:null,_helpHtml:null,_inputElem:null,_helpElem:null,_setFn:null,_getFn:null,_init:function({setFn:setFn,getFn:getFn,label:label,placeholderText:placeholderText,helpHtml:helpHtml,updateKey:updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();if(placeholderText==null||placeholderText==""){this._placeholderText=" "}else{this._placeholderText=this._safeText(placeholderText)}this._helpHtml=helpHtml;this._renderTextItem()},_setAttributesHtml:function(extraAttrs){const currentText=this._getFn();if(currentText!=null&&currentText!=""){extraAttrs.push(`value="${this._safeText(currentText)}"`)}if(this._placeholderText!=null&&this._placeholderText!=""){extraAttrs.push(`placeholder="${this._placeholderText}"`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_renderTextItem:function(){const inputId=this._id+"input";const helpId=this._id+"help";let extraAttrs=[];this._setAttributesHtml(extraAttrs);const bodyHtml=`
	<div class="form-floating">
		<input type="search" id="${inputId}" class="form-control text-truncate" ${extraAttrs.join(" ")}
				aria-describedby="${helpId}">
		<label for="${inputId}" class="form-label pt-2 text-truncate w-100">${this._label}</label>
	</div>
    <div id="${helpId}" class="form-text ms-2">${this._helpHtml}</div>
	`;this.setHtml(bodyHtml);this._inputElem=this.getElementById(inputId);this._helpElem=this.getElementById(helpId);this._inputElem.addEventListener("change",this._onInputChangedCb.bind(this),true);this._inputElem.addEventListener("keydown",this._onKeydownCb.bind(this),true)},_onInputChangedCb:function(ev){const logHead='SettingsTextItemViewer::_onInputChangedCb(value: "'+ev.target.value+'"): ';this._log(logHead+"change event");this._setFn(ev.target.value)},_onKeydownCb:function(ev){const logHead='SettingsTextItemViewer::_onKeydownCb(value: "'+ev.target.value+'"): ';if(ev.key=="Enter"){this._log(logHead+"Enter pressed");this._inputElem.blur();ev.preventDefault()}},setInvalid:function(msgHtml){msgHtml=optionalWithDefault(msgHtml,null);this._inputElem.classList.add("is-invalid");if(msgHtml!=null){this._helpElem.classList.add("tm-invalid-feedback");this._helpElem.innerHTML=msgHtml}return delay(3e3).then(function(){this._inputElem.classList.remove("is-invalid");this._helpElem.classList.remove("tm-invalid-feedback");this._helpElem.innerHTML=this._helpHtml}.bind(this))}});Classes.SettingsTextAreaItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsTextAreaItemViewer",_placeholderText:null,_helpHtml:null,_inputElem:null,_setFn:null,_getFn:null,_init:function({setFn:setFn,getFn:getFn,label:label,placeholderText:placeholderText,helpHtml:helpHtml,updateKey:updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();if(placeholderText==null||placeholderText==""){this._placeholderText=" "}else{this._placeholderText=this._safeText(placeholderText)}this._helpHtml=helpHtml;this._renderTextAreaItem()},_setAttributesHtml:function(extraAttrs){if(this._placeholderText!=null&&this._placeholderText!=""){extraAttrs.push(`placeholder="${this._placeholderText}"`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_renderTextAreaItem:function(){const inputId=this._id+"input";const helpId=this._id+"help";let currentText=this._getFn();if(currentText==null){currentText=""}let extraAttrs=[];this._setAttributesHtml(extraAttrs);const bodyHtml=`
	<div class="tm-autosize form-floating" data-replicated-value="${this._safeText(currentText)}">
		<textarea id="${inputId}" class="form-control" ${extraAttrs.join(" ")} style="height: auto;"
				aria-describedby="${helpId}">${this._safeText(currentText)}</textarea>
		<label for="${inputId}" class="form-label pt-2 text-truncate w-100">${this._label}</label>
	</div>
	<div id="${helpId}" class="form-text ms-2">${this._helpHtml}</div>
	`;this.setHtml(bodyHtml);this._inputElem=this.getElementById(inputId);this._inputElem.addEventListener("change",this._onInputChangedCb.bind(this),true);this._inputElem.addEventListener("input",this._onInputCb.bind(this),true)},_onInputChangedCb:function(ev){const logHead='SettingsTextAreaItemViewer::_onInputChangedCb(value: "'+ev.target.value+'"): ';this._log(logHead+"change event");this._setFn(ev.target.value)},_onInputCb:function(ev){ev.target.parentNode.dataset.replicatedValue=ev.target.value}});Classes.SettingsCheckboxItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsCheckboxItemViewer",_inputElem:null,_setFn:null,_getFn:null,_init:function({setFn:setFn,getFn:getFn,label:label,updateKey:updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();this._renderCheckboxItem()},_setAttributesHtml:function(extraAttrs){const currentlyChecked=this._getFn();if(currentlyChecked!=null&&currentlyChecked){extraAttrs.push(`checked`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_renderCheckboxItem:function(){const checkboxId=this._id+"checkbox";let extraAttrs=[];this._setAttributesHtml(extraAttrs);const bodyHtml=`
	<div class="form-check form-switch">
	  <input class="form-check-input tm-align-checkbox" type="checkbox" id="${checkboxId}" ${extraAttrs}>
	  <label class="form-check-label" for="${checkboxId}">${this._label}</label>
	</div>
	`;this.setHtml(bodyHtml);this._inputElem=this.getElementById(checkboxId);this._inputElem.addEventListener("change",this._onInputChangedCb.bind(this),true)},_onInputChangedCb:function(ev){const logHead='SettingsCheckboxItemViewer::_onInputChangedCb(value: "'+ev.target.checked+'"): ';this._log(logHead+"change event",ev);this._setFn(ev.target.checked)},setValue:function(value){if(this._inputElem==null){return}value=optionalWithDefault(value,false);this._inputElem.checked=value}});Classes.SettingsCheckboxPermViewer=Classes.SettingsCheckboxItemViewer.subclass({__idPrefix:"SettingsCheckboxPermViewer",_permission:null,_init:function({permission:permission}){this._permission=permission;Classes.SettingsCheckboxItemViewer._init.apply(this,arguments);this.debug()},_requestPermission:function(ev){const logHead="SettingsCheckboxPermViewer::_requestPermission(): ";chromeUtils.wrap(chrome.permissions.request,logHead,{permissions:[this._permission]}).then(function(granted){if(granted){this._log(logHead+"permission granted");Classes.SettingsCheckboxItemViewer._onInputChangedCb.call(this,ev)}else{this._log(logHead+"permission refused");this._inputElem.checked=false}}.bind(this))},_removePermission:function(ev){const logHead="SettingsCheckboxPermViewer::_removePermission(): ";chromeUtils.wrap(chrome.permissions.remove,logHead,{permissions:[this._permission]}).then(function(removed){if(removed){this._log(logHead+"permission removed")}else{this._err(logHead+"failed")}}.bind(this))},_onInputChangedCb:function(ev){const logHead='SettingsCheckboxPermViewer::_onInputChangedCb(value: "'+ev.target.checked+'"): ';this._log(logHead+"change event",ev);if(ev.target.checked){this._requestPermission(ev)}else{this._removePermission(ev);Classes.SettingsCheckboxItemViewer._onInputChangedCb.call(this,ev)}}});Classes.SettingsColorsItemViewer=Classes.SettingsItemViewer.subclass({__idPrefix:"SettingsColorsItemViewer",_setFn:null,_getFn:null,_eventManager:null,_radioElemByColor:null,_init:function({setFn:setFn,getFn:getFn,updateKey:updateKey}){Classes.SettingsItemViewer._init.apply(this,arguments);this.debug();this.removeClasses("mt-3");this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);this._renderColorsItem()},_setAttributesHtml:function(extraAttrs){const currentlyChecked=this._getFn();if(currentlyChecked!=null&&currentlyChecked){extraAttrs.push(`checked`)}Classes.SettingsItemViewer._setAttributesHtml.call(this,extraAttrs)},_colorData:{none:["bg-light","tm-check-reversed"],grey:["bg-secondary",""],blue:["bg-primary",""],red:["bg-danger",""],yellow:["bg-warning",""],green:["bg-success",""],cyan:["bg-info",""]},_colorNameToCss:function(colorName){colorName=optionalWithDefault(colorName,"none");if(!(colorName in this._colorData)){return null}return this._colorData[colorName]},_colorToHtml:function(radioHtmlList,radioIdList,colorChecked,color){const radioGroupId=this._id+"-radio";const id=this._id+"-"+color;const bgColor=this._colorNameToCss(color).join(" ");let extraAttrs="";if(color==colorChecked){extraAttrs="checked"}if(color=="none"&&colorChecked==null){extraAttrs="checked"}radioIdList.push([id,color]);radioHtmlList.push(`<input class="form-check-input ${bgColor}" type="radio" name="${radioGroupId}" id="${id}" value="" aria-label="${color}" ${extraAttrs}>`)},_renderColorsItem:function(){const colorChecked=this._getFn();this._radioElemByColor=[];let extraAttrs=[];this._setAttributesHtml(extraAttrs);let radioHtmlList=[];let radioIdList=[];let colorList=Object.keys(this._colorData);colorList.forEach(this._colorToHtml.bind(this,radioHtmlList,radioIdList,colorChecked));const bodyHtml=`
	<div class="form-check-inline">
		${radioHtmlList.join("\n")}
	</div>
	`;this.setHtml(bodyHtml);radioIdList.forEach(function([id,color]){let elem=this.getElementById(id);elem.addEventListener("change",this._onInputChangedCb.bind(this,color),true);this._radioElemByColor[color]=elem}.bind(this))},_onInputChangedCb:function(color,ev){const logHead="SettingsColorsItemViewer::_onInputChangedCb("+color+', value: "'+ev.target.checked+'"): ';this._log(logHead+"change event",ev);if(color=="none"){color=null}if(ev.target.checked){this._setFn(color);this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{color:color})}},setEnabled:function(flag){this._enabled=flag;if(this._radioElemByColor==null){return}let colorList=Object.keys(this._radioElemByColor);colorList.forEach(function(color){if(flag){this._radioElemByColor[color].removeAttribute("disabled")}else{this._radioElemByColor[color].setAttribute("disabled","")}}.bind(this))},setValue:function(color){if(this._radioElemByColor==null){return}let mappedColor=optionalWithDefault(color,"none");this._radioElemByColor[mappedColor].checked=true;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{color:color})}});Classes.SettingsCardViewer=Classes.HtmlViewer.subclass({__idPrefix:"SettingsCardViewer",_bodyElem:null,_titleElem:null,_cardColor:null,_init:function(titleHtml,canClose){this.debug();this._canClose=optionalWithDefault(canClose,false);const bodyId=this._id+"-body";const titleId=this._id+"-title";const closeId=this._id+"-close";let closeHtml="";if(this._canClose){closeHtml=`
		<div class="tm-overlay tm-full-size tm-hover-target tm-pointer-no">
			<div class="tm-float-right">
				<button type="button" id="${closeId}" class="tm-pointer-all tm-close-icon-button mt-1" aria-label="Close">
					<span aria-hidden="true" class="tm-close-icon"></span>
				</button>
			</div>
		</div>
		`}const rootHtml=`
	<div class="tm-callout tm-callout-settings-card tm-hover tm-stacked-below">
		<div id="${titleId}" class="ms-2 fw-bold">${titleHtml}</div>
		<div id="${bodyId}"></div>
		${closeHtml}
	</div>
	`;Classes.HtmlViewer._init.call(this,rootHtml);this._bodyElem=this.getElementById(bodyId);this._titleElem=this.getElementById(titleId);if(this._canClose){this._closeElem=this.getElementById(closeId)}else{this._closeElem=null}},setCardColor:function(color){const logHead="SettingsCardViewer::setCardColor("+color+"): ";if(this._cardColor==color){this._log(logHead+"nothing to do");return}let cgm=settingsStore.getCustomGroupsManager();if(this._cardColor!=null){this._log(logHead+"removing old color "+this._cardColor);this.removeClasses(cgm.getCustomGroupCssByColor(this._cardColor))}if(color!=null){this._log(logHead+"adding color");this.addClasses(cgm.getCustomGroupCssByColor(color))}this._cardColor=color},setTitle:function(titleHtml){this._titleElem.innerHTML=titleHtml},closeCard:function(useAnimation){useAnimation=optionalWithDefault(useAnimation,true);const logHead="SettingsCardViewer::closeCard("+useAnimation+"): ";if(!useAnimation){this._log(logHead+"closing without animation");this.detach();return Promise.resolve()}return this.runAnimation("tm-shrink").then(function(){this._log(logHead+"animation ended, removing self from DOM");this.detach()}.bind(this))}});Classes.SettingsButtonViewer=Classes.HtmlViewer.subclass({__idPrefix:"SettingsButtonViewer",_buttonElem:null,_init:function(labelHtml){labelHtml=optionalWithDefault(labelHtml,"");const logHead="SettingsButtonViewer::_init(): ";const buttonId=this._id+"-button";const buttonHtml=`
	<div class="mx-2 mt-3">
		<div class="d-grid gap-2">
			<button id="${buttonId}" type="button" class="btn btn-primary">${labelHtml}</button>
		</div>
	</div>
	`;Classes.HtmlViewer._init.call(this,buttonHtml);this.debug();this._log(logHead,this);this._buttonElem=this.getElementById(buttonId);this._buttonElem.addEventListener("click",this._onButtonClickCb.bind(this),false)},_onButtonClickCb:function(ev){this._errorMustSubclass("SettingsButtonViewer::_onButtonClickCb(): ")}});Classes.SettingsAddCustomGroupViewer=Classes.SettingsButtonViewer.subclass({__idPrefix:"SettingsAddCustomGroupViewer",_customGroupsContainer:null,_init:function(customGroupsContainer){Classes.SettingsButtonViewer._init.call(this,"+ add custom group");this.debug();this._customGroupsContainer=customGroupsContainer},_onButtonClickCb:function(ev){let newCustomGroup=Classes.SettingsCustomGroupViewer.create();this._customGroupsContainer.append(newCustomGroup);newCustomGroup.focusOnName()}});Classes.SettingsCustomGroupViewer=Classes.SettingsCardViewer.subclass({__idPrefix:"SettingsCustomGroupViewer",_groupName:null,_groupNameInput:null,_allInputsCanDisable:null,_init:function(groupName,htmlTitle){groupName=optionalWithDefault(groupName,"");htmlTitle=optionalWithDefault(htmlTitle,this._formatDefaultTitle(groupName));this.debug();Classes.SettingsCardViewer._init.call(this,htmlTitle,true);this._groupName=groupName;if(groupName!=""){this.setCardColor(settingsStore.getCustomGroupsManager().getCustomGroupProp(groupName,"color"))}this._renderCustomGroupSettings();this._closeElem.addEventListener("click",this._onCloseClickCb.bind(this),false)},_formatDefaultTitle:function(groupName){if(groupName!=""){return`Custom group "${groupName}"`}return"*New custom group"},_onCloseClickCb:function(ev){const logHead='SettingsCustomGroupViewer::_onCloseClickCb("'+this._groupName+'"): ';this._log(logHead+"closing");this.closeCard();if(this._groupName!=""){settingsStore.unpinGroup(this._groupName);settingsStore.getCustomGroupsManager().delCustomGroup(this._groupName)}},_applyColorChange:function(color){if(this._groupName==""){return}settingsStore.getCustomGroupsManager().setCustomGroupProp(this._groupName,"color",color)},_getGroupName:function(){return this._groupName},_showGroupNameError:function(msgHtml){this._groupNameInput.setInvalid(msgHtml);this._groupNameInput.setValue(this._groupName)},_enableSettings:function(flag){const logHead="SettingsCustomGroupViewer::_enableSettings(): ";flag=optionalWithDefault(flag,true);this._allInputsCanDisable.forEach(function(inputViewer){this._log(logHead,inputViewer);inputViewer.setEnabled(flag)}.bind(this))},_renameCustomGroup:function(newName){const logHead="SettingsCustomGroupViewer::_renameCustomGroup("+newName+"): ";if(newName==""){this._showGroupNameError(`A group must have a non-empty name`);this._log(logHead+"user error: the title is an empty string");return}newName=newName.trim();if(newName==""){this._showGroupNameError(`A group name can't be only made of whitespaces`);this._log(logHead+"user error: the title is a string of whitespaces");return}let cgm=settingsStore.getCustomGroupsManager();if(cgm.hasCustomGroup(newName,true)){this._showGroupNameError(`A group named <i>${newName}</i> already exists`);this._log(logHead+"user error: the title already exists");return}let isPinned=this._isCustomGroupPinned();this._pinCustomGroup(false);let oldName=this._groupName;this._groupName=newName;if(oldName!=""){cgm.renameCustomGroup(oldName,newName)}else{cgm.setCustomGroup(newName,{});this.closeCard(false)}this._pinCustomGroup(isPinned);this.setTitle(this._formatDefaultTitle(newName))},_getProp:function(prop){return settingsStore.getCustomGroupsManager().getCustomGroupProp(this._groupName,prop)},_setProp:function(prop,value){return settingsStore.getCustomGroupsManager().setCustomGroupProp(this._groupName,prop,value)},_colorUpdatedCb:function(ev){this.setCardColor(ev.detail.color)},_pinCustomGroup:function(flag){if(this._groupName==""){return}if(flag){settingsStore.pinGroup(this._groupName)}else{settingsStore.unpinGroup(this._groupName)}},_isCustomGroupPinned:function(){if(this._groupName==""){return false}return settingsStore.isGroupPinned(this._groupName)},_renderCustomGroupSettings:function(){this._allInputsCanDisable=[];let color=Classes.SettingsColorsItemViewer.create({setFn:this._applyColorChange.bind(this),getFn:this._getProp.bind(this,"color"),updateKey:"customGroups"});this.append(color);this._allInputsCanDisable.push(color);color.addEventListener(Classes.EventManager.Events.UPDATED,this._colorUpdatedCb.bind(this));let help="";if(this._groupName==""){help="Assign a unique name and press <i>Enter</i> to start using this custom group"}this._groupNameInput=Classes.SettingsTextItemViewer.create({setFn:this._renameCustomGroup.bind(this),getFn:this._getGroupName.bind(this),label:"Group name",placeholderText:"",helpHtml:help,updateKey:"customGroups"});this.append(this._groupNameInput);let pinnedInput=Classes.SettingsCheckboxItemViewer.create({setFn:this._pinCustomGroup.bind(this),getFn:this._isCustomGroupPinned.bind(this),label:"Pin group",updateKey:"pinnedGroups"});this.append(pinnedInput);this._allInputsCanDisable.push(pinnedInput);let favIconUrl=Classes.SettingsTextItemViewer.create({setFn:this._setProp.bind(this,"favIconUrl"),getFn:this._getProp.bind(this,"favIconUrl"),label:"Icon URL for this group",placeholderText:"",helpHtml:"Optional, if not specified, one will be taken from tabs in the custom group",updateKey:"customGroups"});this.append(favIconUrl);this._allInputsCanDisable.push(favIconUrl);let matchList=Classes.SettingsTextAreaItemViewer.create({setFn:this._setProp.bind(this,"matchList"),getFn:this._getProp.bind(this,"matchList"),label:"List of hostnames to match the group",placeholderText:"",helpHtml:"One hostname match expression per line",updateKey:"customGroups"});this.append(matchList);this._allInputsCanDisable.push(matchList);if(this._groupName==""){this._enableSettings(false)}},focusOnName:function(){this._groupNameInput.setFocus()}});Classes.SettingsShortcutCardViewer=Classes.SettingsCardViewer.subclass({__idPrefix:"SettingsShortcutCardViewer",_shortcutKeyViewer:null,_shortcutUnsetText:"Not set",_settingsTabViewerObj:null,_init:function(title,settingsTabViewerObj){this.debug();Classes.SettingsCardViewer._init.call(this,title);this._settingsTabViewerObj=settingsTabViewerObj;this._shortcutKeyViewer=Classes.HtmlViewer.create(`<div></div>`);this.append(this._shortcutKeyViewer)},setShortcutText:function(text){const buttonId=this._id+"scTextBtn";let bgColorClass="bg-dark";if(text==null||text==""){bgColorClass="bg-secondary";text=this._shortcutUnsetText}const targetUrl="chrome://extensions/shortcuts";let html=`
	<div class="ms-2">
		<span id=${buttonId} class="badge tm-text-badge ${bgColorClass}" style="cursor: pointer">${text}</span>
	</div>
	`;this._shortcutKeyViewer.setHtml(html);let buttonElem=this._shortcutKeyViewer.getElementById(buttonId);buttonElem.addEventListener("click",function(ev){this._settingsTabViewerObj.loadUrlThroughBackground(targetUrl);ev.preventDefault()}.bind(this),false)}});Classes.SettingsLosShortcutViewer=Classes.SettingsShortcutCardViewer.subclass({__idPrefix:"SettingsLosShortcutViewer",_init:function(title){this.debug();Classes.SettingsShortcutCardViewer._init.call(this,title);this._renderShortcutSettings()},_renderShortcutSettings:function(){let searchUrl=Classes.SettingsTextItemViewer.create({setFn:settingsStore.setOptionSearchUrl.bind(settingsStore),getFn:settingsStore.getOptionSearchUrl.bind(settingsStore),label:"Search URL for launch/search shortcut",placeholderText:"https://www.google.com/search?q=%s",helpHtml:this._safeText("Use %s to indicate where the text from the clipboard should get pasted"),updateKey:"options"});this.append(searchUrl)}});Classes.SettingsCustomShortcutViewer=Classes.SettingsShortcutCardViewer.subclass({__idPrefix:"SettingsCustomShortcutViewer",_shortcutKey:null,_init:function(shortcutKey,title,settingsTabViewerObj){this.debug();Classes.SettingsShortcutCardViewer._init.call(this,title,settingsTabViewerObj);this._shortcutKey=shortcutKey;this._renderShortcutSettings()},_renderShortcutSettings:function(){let sm=settingsStore.getShortcutsManager();let shortcutTitle=Classes.SettingsTextItemViewer.create({setFn:sm.setShortcutTitle.bind(sm,this._shortcutKey),getFn:sm.getShortcutTitle.bind(sm,this._shortcutKey),label:"Title",helpHtml:this._safeText("If you enable search, this title will be used for the context menu item associated to this shortcut"),updateKey:this._shortcutKey});this.append(shortcutTitle);let hostnameOrUrl=Classes.SettingsTextItemViewer.create({setFn:sm.setShortcutHostnameOrUrl.bind(sm,this._shortcutKey),getFn:sm.getShortcutHostnameOrUrl.bind(sm,this._shortcutKey),label:"Hostname or URL",placeholderText:"e.g.: www.google.com",helpHtml:this._safeText("If you enable search, use %s to indicate where the text from the clipboard should get pasted"),updateKey:this._shortcutKey});this.append(hostnameOrUrl);let alwaysNewTab=Classes.SettingsCheckboxItemViewer.create({setFn:sm.setShortcutProp.bind(sm,this._shortcutKey,"alwaysNewTab"),getFn:sm.getShortcutProp.bind(sm,this._shortcutKey,"alwaysNewTab"),label:"Always open shortcut in new tab",updateKey:this._shortcutKey});this.append(alwaysNewTab);let useClipboard=Classes.SettingsCheckboxItemViewer.create({setFn:sm.setShortcutProp.bind(sm,this._shortcutKey,"useClipboard"),getFn:sm.getShortcutProp.bind(sm,this._shortcutKey,"useClipboard"),label:"Enable search of clipboard contents",updateKey:this._shortcutKey});this.append(useClipboard)}});Classes.SettingsCustomShortcutsContainerViewer=Classes.CollapsibleContainerViewer.subclass({_shortcutViewers:null,_settingsTabViewerObj:null,_init:function(settingsTabViewerObj){Classes.CollapsibleContainerViewer._init.call(this,{border:false});this.debug();this._settingsTabViewerObj=settingsTabViewerObj;this._shortcutViewers=[];this.setHeadingHtml(`<div class="fw-bold">Shortcuts settings</div>`);this.addExpandedStartListener(this._containerExpandedCb.bind(this));this.addClasses("mt-3");let losShortcut=Classes.SettingsLosShortcutViewer.create("Shortcut launch/search");this._shortcutViewers[window.ExtCommands.LAUNCHORSEARCH]=losShortcut;this.append(losShortcut);let sm=settingsStore.getShortcutsManager();sm.getShortcutKeys().forEach(function(key){this._shortcutViewers[key]=Classes.SettingsCustomShortcutViewer.create(key,"Custom shortcut "+sm.keyToUiString(key),settingsTabViewerObj);this.append(this._shortcutViewers[key])}.bind(this));this.updateShortcutText()},updateShortcutText:function(){const logHead="SettingsCustomShortcutViewer::updateShortcutText(): ";chromeUtils.wrap(chrome.commands.getAll,logHead).then(function(commands){this._log(logHead+"received",commands);commands.forEach(function(cmd){if(this._shortcutViewers[cmd.name]!=null){this._shortcutViewers[cmd.name].setShortcutText(cmd.shortcut)}else{this._log(logHead+'ignoring command "'+cmd.name+'"')}}.bind(this))}.bind(this))},_containerExpandedCb:function(ev){const logHead="SettingsCustomShortcutViewer::_containerExpandedCb("+ev.target.id+"): ";this._log(logHead+"container expanded",ev);this.updateShortcutText()}});Classes.SettingsTabViewer=Classes.TabViewer.subclass({_bodyElem:null,_manifest:null,_generalSettingsContainer:null,_customGroupsContainer:null,_shortcutsContainer:null,_customGroupsByName:null,_msgClient:null,_init:function(tabLabelHtml){Classes.TabViewer._init.apply(this,arguments);const logHead="SettingsTabViewer::_init(): ";this.debug();this._manifest=chrome.runtime.getManifest();this._log(logHead+"the manifest object:",this._manifest);this._msgClient=Classes.MsgClient.create();this._setBody();this._renderSettings();settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._updatedCb.bind(this));this.addBsTabActivationStartListener(this._bsTabActivatedCb.bind(this))},loadUrlThroughBackground:function(url){this._msgClient.sendRequest("launchUrl",{url:url}).then(function(response){const logHead="SettingsTabViewer::loadUrlThroughBackground().response(): ";if(response.status=="success"){this._log(logHead+"received ",response)}else{this._err(logHead+"response failed: ",response)}}.bind(this))},_setBody:function(){let bodyId=this._id+"-settingsBody";let html=`
		<div id="${bodyId}" class="mx-auto px-2 py-3" style="max-width: 800px;">
		</div>
	`;this.setHtml(html);this._bodyElem=this.getElementById(bodyId)},_renderTitle:function(){let version=this._safeText(this._manifest.version);if(!isProd()){version+="-DEV"}const bodyHtml=`
	<div class="mb-3">
		<b>${this._safeText(this._manifest.name)}</b> <small>(v. ${version})</small>
	</div>
	`;this.setHtml(bodyHtml)},_renderIncognitoInfo:function(){const logHead="SettingsTabViewer::_renderIncognitoInfo(): ";const linkId=this._id+"-extSettingsLink";const extensionId=chromeUtils.getExtensionId();const targetUrl=`chrome://extensions/?id=${extensionId}`;const footnote=`
		<div class="small">You can enable/disable access to incognito tabs in
		the <a id="${linkId}" href="${targetUrl}" target="_blank">Chrome extension settings</a>
	`;const bodyHtml=`
	<div class="mx-2 my-3">
		Loading...
	</div>
	`;let viewer=Classes.HtmlViewer.create(bodyHtml);this._generalSettingsContainer.append(viewer);chromeUtils.wrap(chrome.extension.isAllowedIncognitoAccess,logHead).then(function(isAllowedAccess){if(isAllowedAccess){viewer.setHtml("<div>Access to Incognito tabs is enabled<div>"+footnote)}else{viewer.setHtml("<div>Access to Incognito tabs is disabled<div>"+footnote)}let linkElem=viewer.getElementById(linkId);linkElem.addEventListener("click",function(ev){this.loadUrlThroughBackground(targetUrl);ev.preventDefault()}.bind(this),false)}.bind(this))},_renderSettings:function(){this._renderTitle();this._generalSettingsContainer=Classes.CollapsibleContainerViewer.create({startExpanded:true,border:false});this._generalSettingsContainer.setHeadingHtml(`<div class="fw-bold">General settings</div>`);this.append(this._generalSettingsContainer);let recentlyClosedInSearch=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionRecentlyClosedInSearch.bind(settingsStore),getFn:settingsStore.getOptionRecentlyClosedInSearch.bind(settingsStore),label:"Include recently closed tabs in search results",updateKey:"options"});this._generalSettingsContainer.append(recentlyClosedInSearch);let bookmarksInSearch=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionBookmarksInSearch.bind(settingsStore),getFn:settingsStore.getOptionBookmarksInSearch.bind(settingsStore),label:"Include bookmarks in search results",updateKey:"options"});this._generalSettingsContainer.append(bookmarksInSearch);let historyInSearch=Classes.SettingsCheckboxPermViewer.create({setFn:settingsStore.setOptionHistoryInSearch.bind(settingsStore),getFn:settingsStore.getOptionHistoryInSearch.bind(settingsStore),label:"Include browsing history in search results",updateKey:"options",permission:"history"});this._generalSettingsContainer.append(historyInSearch);if(settingsStore.getOptionDevMode()){let showTabId=Classes.SettingsCheckboxItemViewer.create({setFn:settingsStore.setOptionShowTabId.bind(settingsStore),getFn:settingsStore.getOptionShowTabId.bind(settingsStore),label:"Display extended tab ID badge (dev-mode)",updateKey:"options"});this._generalSettingsContainer.append(showTabId)}this._renderIncognitoInfo();let outerCustomGroupsContainer=Classes.CollapsibleContainerViewer.create({border:false});outerCustomGroupsContainer.setHeadingHtml(`<div class="fw-bold">Custom groups settings</div>`);outerCustomGroupsContainer.addClasses("mt-3");this.append(outerCustomGroupsContainer);this._customGroupsContainer=Classes.ContainerViewer.create("No custom groups defined");this._customGroupsContainer.addClasses("tm-min-empty-container");outerCustomGroupsContainer.append(this._customGroupsContainer);this._customGroupsByName=[];this._addCustomGroups(settingsStore.getCustomGroupsManager().getCustomGroupNames());let addCustomGroupButton=Classes.SettingsAddCustomGroupViewer.create(this._customGroupsContainer);outerCustomGroupsContainer.append(addCustomGroupButton);this._shortcutsContainer=Classes.SettingsCustomShortcutsContainerViewer.create(this);this.append(this._shortcutsContainer)},_addCustomGroups:function(namesList){const logHead="SettingsTabViewer::_addCustomGroups(): ";this._log(logHead,namesList);namesList.forEach(function(name){let customGroup=Classes.SettingsCustomGroupViewer.create(name);this._customGroupsContainer.append(customGroup);this._customGroupsByName[name]=customGroup}.bind(this))},_delCustomGroups:function(namesList){const logHead="SettingsTabViewer::_delCustomGroups(): ";this._log(logHead,namesList);let promisesList=[];namesList.forEach(function(name){promisesList.push(this._customGroupsByName[name].closeCard());delete this._customGroupsByName[name]}.bind(this));if(namesList.length!=0&&Object.keys(this._customGroupsByName).length==0){Promise.all(promisesList).then(this._customGroupsContainer.clear.bind(this._customGroupsContainer))}},_updatedCb:function(ev){const logHead="SettingsTabViewer::_updatedCb("+ev.detail.key+"): ";if(ev.detail.key!="customGroups"){this._log(logHead+"ignoring key");return}this._log(logHead+"processing change",ev.detail);let newNames=settingsStore.getCustomGroupsManager().getCustomGroupNames().sort();let oldNames=Object.keys(this._customGroupsByName).sort();let toBeDeleted=[];let toBeAdded=[];let nn=0;let on=0;while(nn<newNames.length&&on<oldNames.length){let cmp=newNames[nn].localeCompare(oldNames[on]);if(cmp==0){nn++;on++}else{if(cmp<0){toBeAdded.push(newNames[nn++])}else{toBeDeleted.push(oldNames[on++])}}}while(nn<newNames.length){toBeAdded.push(newNames[nn++])}while(on<oldNames.length){toBeDeleted.push(oldNames[on++])}this._delCustomGroups(toBeDeleted);this._addCustomGroups(toBeAdded)},_bsTabActivatedCb:function(ev){const logHead="SettingsTabViewer::_bsTabActivatedCb("+ev.target.id+"): ";this._log(logHead+"tab activated",ev);this._shortcutsContainer.updateShortcutText()}});Classes.BootstrapTabsViewer=Classes.Viewer.subclass({_headingElem:null,_buttonBarElem:null,_menuElem:null,_bodyElem:null,_menuViewer:null,_init:function(){Classes.Viewer._init.apply(this,arguments);this._renderTabsContainer()},_dockToggleCb:function(ev){popupDocker.dockToggle();ev.preventDefault()},_renderTabsContainer:function(){const logHead="BootstrapTabsViewer::_renderTabsContainer(): ";const headingId=this._id+"-heading";const buttonBarId=this._id+"-buttonbar";const menuId=this._id+"-menu";const bodyId=this._id+"-body";const headingHtml=`
	<div class="d-flex" style="cursor: default">
		<div class="flex-grow-1">
			<!-- https://getbootstrap.com/docs/5.0/components/navs-tabs/ -->
			<ul class="nav nav-tabs nav-justified" id="${headingId}" role="tablist">
			</ul>
		</div>
		<div id="${buttonBarId}" class="ms-2">
		</div>
		<div id="${menuId}">
		</div>
	</div>
	`;const bodyHtml=`
	<div class="tab-content tm-fit-bottom tm-fit-after-bstabs" id="${bodyId}">
	</div>
	`;this._rootElem=this._elementGen(`<div id=${this._id}>`+headingHtml+bodyHtml+"</div>");this._headingElem=this.getElementById(headingId);this._buttonBarElem=this.getElementById(buttonBarId);this._menuElem=this.getElementById(menuId);this._bodyElem=this.getElementById(bodyId);this._menuElem=this.getElementById(menuId);this._menuViewer=Classes.PopupMenuViewer.create();this._menuViewer.attachToElement(this._menuElem)},append:function(tabViewer){this._headingElem.append(tabViewer.getHeadingElement());Classes.Viewer.append.apply(this,arguments)},appendButton:function(viewer){this._buttonBarElem.append(viewer.getRootElement())}});Classes.PopupViewer=Classes.BootstrapTabsViewer.subclass({_tabViewersDict:null,_activeBsTabId:null,_init:function(parentElem){Classes.BootstrapTabsViewer._init.apply(this,arguments);this._tabViewersDict={};this._populateTabs();perfProf.mark("popupViewerEnd");this.attachToElement(parentElem);perfProf.mark("attachEnd");this._initActiveTabId();popupMsgServer.addCmd("tabsList",this._tabsListNotificationCb.bind(this),false)},_initActiveTabId:function(results){const logHead="PopupViewer::_initActiveTabId(): ";let activeTabId=localStore.getActiveBsTab();this._activeBsTabId=this._id+"-home";if(activeTabId!=null){this._log(logHead+"initializing active Bootstrap tabId to stored "+activeTabId);if(activeTabId in this._tabViewersDict){this._activeBsTabId=activeTabId}else{this._log(logHead+"Bootstrap tabId not found, initializing to default: "+this._activeBsTabId)}}this._log(logHead+"_activeBsTabId = "+this._activeBsTabId);this.getTabViewerById(this._activeBsTabId).activate()},_bsTabActivatedCb:function(ev){const logHead="PopupViewer::_bsTabActivatedCb("+ev.target.id+"): ";this._log(logHead+"tab activated",ev);this._activeBsTabId=ev.target.id;localStore.setActiveBsTab(ev.target.id)},_createTab:function(suffix,htmlLabel,tabViewerSubclass){tabViewerSubclass=optionalWithDefault(tabViewerSubclass,Classes.TabViewer);const bsTabId=this._id+"-"+suffix;this._tabViewersDict[bsTabId]=tabViewerSubclass.createAs(bsTabId,htmlLabel);this._tabViewersDict[bsTabId].addBsTabActivationStartListener(this._bsTabActivatedCb.bind(this));this.append(this._tabViewersDict[bsTabId]);return this._tabViewersDict[bsTabId]},_populateTabs:function(){this._createTab("home","Home",Classes.AllTabsTabViewer);this._createTab("settings","Settings",Classes.SettingsTabViewer)},_tabsListNotificationCb:function(notification,sender){const logHead="PopupViewer::_tabsListNotificationCb(): ";this._log(logHead,notification.data)},attachToElement:function(){Classes.Viewer.attachToElement.apply(this,arguments)},getTabViewerById:function(bsTabId){return this._tabViewersDict[bsTabId]},getActiveBsTabId:function(){return this._activeBsTabId},_getHomeBsTabId:function(){return this._id+"-home"},isSearchActive:function(){let homeBsTabId=this._getHomeBsTabId();if(this.getTabViewerById(homeBsTabId).isSearchActive()&&this.getActiveBsTabId()==homeBsTabId){return true}return false},getSearchQuery:function(){if(!this.isSearchActive()){return null}let homeBsTabId=this._getHomeBsTabId();return this.getTabViewerById(homeBsTabId).getSearchQuery()}});Classes.TilesGroupViewer=Classes.CollapsibleContainerViewer.subclass({__idPrefix:"TilesGroupViewer",_tabGroup:null,groupName:null,_expandedGroups:null,_init:function(tabGroup,expandedGroups){this._tabGroup=tabGroup;this._groupName=tabGroup.title;this._expandedGroups=expandedGroups;let options={startExpanded:this._expandedGroups.has(this._groupName),htmlWhenEmpty:`<i class="text-muted small">No tabs</i>`,border:true};Classes.CollapsibleContainerViewer._init.call(this,options);const logHead="TilesGroupViewer::_init(): ";this._TilesGroupViewer_render()},_groupHeadingHtml:function(){let iconBadgeHtml=`
		<div class="tm-overlay tm-full-size">
			<div class="tm-icon-badge-pos small">
				<span class="badge tm-icon-badge bg-dark">${this._tabGroup.tabs.length}</span>
			</div>
		</div>
	`;if(this._tabGroup.tabs.length==0){iconBadgeHtml=""}let pinnedIconHtml="";if(this._tabGroup.tm.pinned){let extraClasses=[];if(!settingsStore.isGroupPinned(this._groupName)){extraClasses.push("text-secondary")}pinnedIconHtml=`
		<p class="m-0 pe-2">
			<span>${icons.thumbtack("tm-fa-thumbtack-group",...extraClasses)}</span>
		</p>`}let retVal=`
		<div class="tm-stacked-below" style="width: 95%;">
			<div class="d-flex">
				<p class="flex-grow-1 m-0 text-nowrap text-truncate" style="text-align: left;">
					<span class="pe-2"><img class="tm-favicon-16" src="${this._tabGroup.favIconUrl}"></span>
					<span>${this._groupName}</span>
				</p>
				${pinnedIconHtml}
			</div>
			${iconBadgeHtml}
		</div>
	`;return retVal},_TilesGroupViewer_render:function(){this.setHeadingHtml(this._groupHeadingHtml());this.addExpandedStartListener(this._containerExpandedCb.bind(this));this.addCollapsedStartListener(this._containerCollapsedCb.bind(this));if(this._tabGroup.type==Classes.GroupsBuilder.Type.CUSTOM){let cgm=settingsStore.getCustomGroupsManager();this.addHeadingClasses("tm-customgroup-header","tm-callout",cgm.getCustomGroupCss(this._groupName))}else{this.addHeadingClasses("tm-customgroup-header")}},_storeExpandedGroup:function(expanded){expanded=optionalWithDefault(expanded,true);if(expanded){this._expandedGroups.add(this._groupName)}else{this._expandedGroups.del(this._groupName)}},_containerExpandedCb:function(ev){const logHead="TilesGroupViewer::_containerExpandedCb("+this._groupName+", "+ev.target.id+"): ";this._log(logHead+"container expanded",ev);this._storeExpandedGroup()},_containerCollapsedCb:function(ev){const logHead="TilesGroupViewer::_containerCollapsedCb("+this._groupName+", "+ev.target.id+"): ";this._log(logHead+"container collapsed",ev);this._storeExpandedGroup(false)}});Classes.TabsTabViewer=Classes.SearchableTabViewer.subclass({_containerViewer:null,_groupsBuilder:null,_expandedGroups:null,_currentSearchResults:null,_emptyContainerString:null,_currentSearchInput:null,_currentSearchMode:null,_queryAndRenderJob:null,_queryAndRenderDelay:200,_tilesByTabId:null,_cachedTilesByTabId:null,_recycledTilesCnt:null,_cachedTilesUpdateNeededCnt:null,_tilesAsyncQueue:null,_normTabs:null,_bookmarksFinder:null,_historyFinder:null,_init:function(tabLabelHtml){Classes.SearchableTabViewer._init.apply(this,arguments);const logHead="TabsTabViewer::_init(): ";this.debug();this._assert(this._expandedGroups!=null,logHead+"subclasses must define _expandedGroups");this._queryAndRenderJob=Classes.ScheduledJob.create(this._queryAndRenderTabs.bind(this));this._queryAndRenderJob.debug();this._bookmarksFinder=Classes.BookmarksFinder.create();this._bookmarksFinder.addEventListener(Classes.EventManager.Events.UPDATED,this._bookmarkUpdatedCb.bind(this));this._historyFinder=Classes.HistoryFinder.create();this._historyFinder.addEventListener(Classes.EventManager.Events.UPDATED,this._historyUpdatedCb.bind(this));this._groupsBuilder=Classes.GroupsBuilder.create();this._TabsTabViewer_searchBoxInactiveInner();this._TabsTabViewer_render();this._registerChromeCallbacks();settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._settingsStoreUpdatedCb.bind(this))},_registerChromeCallbacks:function(){chrome.tabs.onCreated.addListener(this._tabCreatedCb.bind(this));chrome.tabs.onUpdated.addListener(this._tabUpdatedCb.bind(this,Classes.TabsTabViewer.CbType.UPDATED));chrome.tabs.onActivated.addListener(this._tabActivatedHighlightedCb.bind(this,Classes.TabsTabViewer.CbType.ACTIVATED));chrome.tabs.onHighlighted.addListener(this._tabActivatedHighlightedCb.bind(this,Classes.TabsTabViewer.CbType.HIGHLIGHTED));chrome.tabs.onRemoved.addListener(this._tabUpdatedCb.bind(this,Classes.TabsTabViewer.CbType.REMOVED));chrome.tabs.onAttached.addListener(this._tabUpdatedCb.bind(this,Classes.TabsTabViewer.CbType.ATTACHED));chrome.tabs.onMoved.addListener(this._tabUpdatedCb.bind(this,Classes.TabsTabViewer.CbType.MOVED))},_tabCreatedCb:function(tab){const logHead="TabsTabViewer::_tabCreatedCb(tabId = "+tab.id+"): ";if(tab.id==popupDocker.getOwnTabId()){this._log(logHead+"suppressing notification for our own tab ID");return}this._log(logHead+"entering");if(this.isSearchActive()){return}this._queryAndRenderJob.run()},_tabActivatedHighlightedCb:function(cbType,activeHighlightInfo){this._tabUpdatedCb(cbType,activeHighlightInfo.tabId,activeHighlightInfo)},_renderTileBodies:function(){try{for(const[tabId,tile]of Object.entries(this._tilesByTabId)){let tab=this._normTabs.getTabByTabId(tabId);if(tab!=null){tile.update(tab)}else{const logHead="TabsTabViewer::_renderTileBodies(): ";this._err(logHead+"unexpected, tile tracks non-existing tabId = "+tabId)}}}catch(e){this._err(e,"this._tilesByTabId: ",this._tilesByTabId)}},_settingsStoreUpdatedCb:function(ev){const logHead="TabsTabViewer::_settingsStoreUpdatedCb("+ev.detail.key+"): ";if(this._normTabs==null){this._log(logHead+"_normTabs not initialized ye, skipping event");return}this._log(logHead+"entering");if(this.isSearchActive()||ev.detail.key=="customGroups"||ev.detail.key=="pinnedGroups"){this._queryAndRenderJob.run(this._queryAndRenderDelay);return}this._normTabs.normalizeAll();this._renderTileBodies()},_setTabProp:function(prop,tabId){const logHead="TabsTabViewer::_setTabProp("+tabId+"): ";if(!(tabId in this._tilesByTabId)){this._log(logHead+"skipping processing, no tile for this tab");return}let tabIdx=this._normTabs.getTabIndexByTabId(tabId);let tab=this._normTabs.getTabByTabIndex(tabIdx);this._assert(tab!=null);tab[prop]=true;this._normTabs.updateTab(tab,tabIdx);this._tilesByTabId[tabId].update(tab)},_tabUpdatedCb:function(cbType,tabId,activeChangeRemoveInfo,tab){const logHead="TabsTabViewer::_tabUpdatedCb("+cbType+", "+tabId+"): ";if(this._tilesByTabId==null){this._log(logHead+"ignoring while running first rendering cycle",activeChangeRemoveInfo,tab);return}this._log(logHead+"entering",activeChangeRemoveInfo,tab);switch(cbType){case Classes.TabsTabViewer.CbType.REMOVED:this._queryAndRenderJob.run();break;case Classes.TabsTabViewer.CbType.UPDATED:if(this._queryAndRenderDelay!=null&&this._queryAndRenderDelay!=0){if(tabId in this._tilesByTabId){this._normTabs.updateTab(tab);settingsStore.getShortcutsManager().updateTabs(this._normTabs.getTabs());this._tilesByTabId[tabId].update(tab)}else{this._log(logHead+"skipping processing, no tile for this tab")}}this._queryAndRenderJob.run(this._queryAndRenderDelay);break;case Classes.TabsTabViewer.CbType.ACTIVATED:if(this._queryAndRenderDelay!=null&&this._queryAndRenderDelay!=0){this._setTabProp("active",tabId)}this._queryAndRenderJob.run(this._queryAndRenderDelay);break;case Classes.TabsTabViewer.CbType.HIGHLIGHTED:if(this._queryAndRenderDelay!=null&&this._queryAndRenderDelay!=0){activeChangeRemoveInfo.tabIds.forEach(this._setTabProp.bind(this,"highlighted"))}this._queryAndRenderJob.run(this._queryAndRenderDelay);break;case Classes.TabsTabViewer.CbType.MOVED:case Classes.TabsTabViewer.CbType.ATTACHED:{let tabIdx=this._normTabs.getTabIndexByTabId(tabId);let tab=this._normTabs.getTabByTabIndex(tabIdx);if(tab!=null&&this._queryAndRenderDelay!=null&&this._queryAndRenderDelay!=0){if(cbType==Classes.TabsTabViewer.CbType.ATTACHED){tab.index=activeChangeRemoveInfo.newPosition;tab.windowId=activeChangeRemoveInfo.newWindowId}else{tab.index=activeChangeRemoveInfo.toIndex;tab.windowId=activeChangeRemoveInfo.windowId}this._normTabs.updateTab(tab,tabIdx);settingsStore.getShortcutsManager().updateTabs(this._normTabs.getTabs());if(tabId in this._tilesByTabId){this._tilesByTabId[tabId].update(tab)}}this._queryAndRenderJob.run(this._queryAndRenderDelay)}break;default:this._err(logHead+"unknown callback type");break}},_bookmarkUpdatedCb:function(ev){if(!this.isSearchActive()){return}this._updateSearchResults()},_historyUpdatedCb:function(ev){if(!this.isSearchActive()){return}this._updateSearchResults()},_TabsTabViewer_render:function(){this._containerViewer=Classes.ContainerViewer.create(this._emptyContainerString);this._queryAndRenderTabs().then(function(){perfProf.mark("attachContStart");this.append(this._containerViewer);perfProf.mark("attachContEnd");perfProf.measure("Attach tiles cont.","attachContStart","attachContEnd")}.bind(this))},_tabsAsyncQuery:function(){this._errorMustSubclass("TabsTabViewer::_tabsAsyncQuery()");throw new Error("must subclass")},_logCachedTilesStats:function(logHead){if(this._cachedTilesByTabId==null){this._log(logHead+"no cache, no stats");return}this._log(logHead+"reused "+this._recycledTilesCnt+" tiles, "+Object.keys(this._cachedTilesByTabId).length+" tiles still in cache");this._log(logHead+this._cachedTilesUpdateNeededCnt+" cached tiles needed a re-render")},_resetAsyncQueue:function(){if(this._tilesAsyncQueue!=null){this._tilesAsyncQueue.discard()}this._tilesAsyncQueue=Classes.AsyncQueue.create()},_prepareForNewCycle:function(){this._recycledTilesCnt=0;this._cachedTilesUpdateNeededCnt=0;this._cachedTilesByTabId=this._tilesByTabId;this._tilesByTabId={};this._resetAsyncQueue()},_queryAndRenderTabs:function(){const logHead="TabsTabViewer::_queryAndRenderTabs(): ";this._log(logHead+"entering");this.blink();perfProf.mark("queryStart");return this._tabsAsyncQuery().then(function(tabs){perfProf.mark("queryEnd");if(window.tmStaging!==undefined){this._err(logHead+"entering staging path");tabs=tmStaging.tabList}this._log(logHead+"tabs received, processing");this._prepareForNewCycle();try{this._normTabs=Classes.NormalizedTabs.create(tabs);perfProf.mark("shortcutsStart");settingsStore.getShortcutsManager().updateTabs(this._normTabs.getTabs());this._normTabs.normalizeAll();perfProf.mark("renderStart");this._renderTabs(this._normTabs.getTabs());perfProf.mark("renderEnd");perfProf.measure("Query","queryStart","queryEnd");perfProf.measure("Shortcuts","shortcutsStart","renderStart");perfProf.measure("Rendering","renderStart","renderEnd")}catch(e){this._err(e)}}.bind(this))},_renderTabs:null,_standardRenderTabs:function(tabs){const logHead="TabsTabViewer::_standardRenderTabs(): ";this._containerViewer.clear();perfProf.mark("groupStart");let[pinnedGroups,unpinnedGroups]=this._groupsBuilder.groupByHostname(tabs);perfProf.mark("groupEnd");this._log(logHead+"pinnedGroups = ",pinnedGroups);this._log(logHead+"unpinnedGroups = ",unpinnedGroups);perfProf.mark("tilesStart");if(tabs==null||tabs.length==0){this._log(logHead+"no tabs")}else{this._renderTabsByGroup(pinnedGroups);this._renderTabsByGroup(unpinnedGroups)}this._logCachedTilesStats(logHead);perfProf.mark("tilesEnd");perfProf.measure("Create groups","groupStart","groupEnd");perfProf.measure("Render tiles","tilesStart","tilesEnd")},_renderTabsFlatInner:function(containerViewer,tabs,tabGroup){const logHead="TabsTabViewer::_renderTabsFlatInner(): ";tabs.forEach(safeFnWrapper(this._renderTile.bind(this,containerViewer,tabGroup),null,function(e,tab){this._err(logHead+"iterating through tabs, at tabId "+(tab!=null?tab.tm.extId:"undefined obj"),tab,e)}.bind(this)))},_renderTabsByGroup:function(tabGroups){const logHead="TabsTabViewer::_renderTabsByGroup(): ";tabGroups.forEach(function(tabGroup){let tabs=tabGroup.tabs;if(tabGroup.type==Classes.GroupsBuilder.Type.TAB){this._renderTabsFlatInner(this._containerViewer,tabs)}else{let tilesGroupViewer=Classes.TilesGroupViewer.create(tabGroup,this._expandedGroups);this._containerViewer.append(tilesGroupViewer);this._renderTabsFlatInner(tilesGroupViewer,tabs,tabGroup)}}.bind(this))},_getCachedTile:function(tab,tabGroup){if(this._cachedTilesByTabId==null){return null}let tile=this._cachedTilesByTabId[tab.id];if(tile==null){return null}this._recycledTilesCnt++;delete this._cachedTilesByTabId[tab.id];tile.updateAsyncQueue(this._tilesAsyncQueue);if(tile.update(tab,tabGroup,Classes.AsyncQueue.priority.LOW)){this._cachedTilesUpdateNeededCnt++}return tile},_renderTile:function(containerViewer,tabGroup,tab){let tile=this._getCachedTile(tab,tabGroup);if(tile==null){tile=Classes.TabTileViewer.create(tab,tabGroup,this._tilesAsyncQueue)}containerViewer.append(tile);this._tilesByTabId[tab.id]=tile},_getAllTabGroups:function(){const logHead="TabsTabViewer::_getAllTabGroups(): ";return chromeUtils.wrap(chrome.tabGroups.query,logHead,{})},_processTabGroupsCb:function(tabGroups){const logHead="TabsTabViewer::_processTabGroupsCb(): ";this._log(logHead,tabGroups)},_TabsTabViewer_searchBoxInactiveInner:function(){this._currentSearchResults=null;this._currentSearchInput="";this._currentSearchMode="[ uninitialized ]";this._renderTabs=this._standardRenderTabs},_activateSearchBox:function(active){Classes.SearchableTabViewer._activateSearchBox.apply(this,arguments);active=optionalWithDefault(active,true);const logHead="TabsTabViewer::_activateSearchBox("+active+"): ";if(!active){this._log(logHead,"switching to standard render");this._TabsTabViewer_searchBoxInactiveInner();this._queryAndRenderTabs()}else{this._log(logHead,"switching to search render");this._currentSearchResults=null;this._setSearchBoxCount();this._renderTabs=this._searchRenderTabs}},_updateSearchResults:function(newSearch){newSearch=optionalWithDefault(newSearch,false);perfProf.mark("searchStart");this._prepareForNewCycle();this._searchRenderTabs(this._normTabs.getTabs(),newSearch);perfProf.mark("searchEnd")},_searchBoxProcessData:function(value){this._assert(value.length!=0);let searchMode=[];this._isTabInCurrentSearch=this._isTabInCurrentSearchPositive.bind(this);if(value[0]=="!"){searchMode.push("neg");this._isTabInCurrentSearch=this._isTabInCurrentSearchNegative.bind(this);value=value.substring(1)}if(value.length!=0&&value[0]=="^"){searchMode.push("startsWith");this._searchCompareFn=this._searchCompareFnInner.bind(this,"startsWith");value=value.substring(1)}else{searchMode.push("includes");this._searchCompareFn=this._searchCompareFnInner.bind(this,"includes")}this._currentSearchMode=searchMode.join("-");this._currentSearchInput=value.toLowerCase();this._updateSearchResults(true)},activateTab:function(tab){const logHead="Classes.TabsTabViewer.activateTab(): ";if(tab.tm.type==Classes.NormalizedTabs.type.TAB){chromeUtils.activateTab(tab.id);return}if(tab.tm.type==Classes.NormalizedTabs.type.RCTAB){chromeUtils.wrap(chrome.sessions.restore,logHead,tab.sessionId);return}chromeUtils.wrap(chrome.tabs.query,logHead,{url:tab.url}).then(function(tabList){if(tabList.length==0){chromeUtils.loadUrl(tab.url)}else{chromeUtils.activateTab(tabList[0].id)}})},_respondToEnterKey:function(searchBoxText){const logHead="TabsTabViewer::_respondToEnterKey("+searchBoxText+"): ";if(this._currentSearchResults==null){this._log(logHead+"no search results, nothing to do");return}this._log(logHead+"activating tab Id "+this._currentSearchResults[0].id+" ("+this._currentSearchResults[0].tm.type+")");Classes.TabsTabViewer.activateTab(this._currentSearchResults[0])},_searchCompareFnInner:function(fnName,targetString,searchString){return targetString[fnName](searchString)},_searchCompareFn:null,_isTabInCurrentSearchPositive:function(tab){const logHead="TabsTabViewer::_isTabInCurrentSearchPositive(): ";if(this._searchCompareFn(tab.tm.lowerCaseTitle,this._currentSearchInput)){return true}if(this._searchCompareFn(tab.tm.lowerCaseUrl,this._currentSearchInput)){return true}for(let i=0;i<tab.tm.searchBadges.length;i++){if(this._searchCompareFn(tab.tm.searchBadges[i],this._currentSearchInput)){return true}}return false},_isTabInCurrentSearchNegative:function(tab){if(tab.tm.type==Classes.NormalizedTabs.type.BOOKMARK||tab.tm.type==Classes.NormalizedTabs.type.HISTORY){return false}return!this._isTabInCurrentSearchPositive(tab)},_isTabInCurrentSearch:null,_filterByCurrentSearch:function(inputTabs){const logHead='TabsTabViewer::_filterByCurrentSearch(value: "'+this._currentSearchInput+'", mode: '+this._currentSearchMode+"): ";this._log(logHead+"inputTabs = ",inputTabs);return inputTabs.reduce(function(result,tab){if(this._isTabInCurrentSearch(tab)){result.push(tab);return result}return result}.bind(this),[])},_searchRenderTabsInner:function(tabs,bmNodes,hItems,newSearch){const logHead="TabsTabViewer::_searchRenderTabsInner(): ";let objects=tabs.concat(bmNodes,hItems);perfProf.mark("searchFilterStart");objects=this._filterByCurrentSearch(objects);perfProf.mark("searchSortStart");objects=objects.sort(Classes.NormalizedTabs.compareTabsFn);perfProf.mark("searchSortEnd");this._containerViewer.clear();this._setSearchBoxCountBlinking(false);this._setSearchBoxCount(objects.length);if(newSearch){this._bodyElem.scrollTo(0,0)}if(objects.length==0){this._log(logHead+"no tabs in search results");this._currentSearchResults=null}else{this._currentSearchResults=objects;perfProf.mark("searchRenderStart");this._renderTabsFlatInner(this._containerViewer,objects);perfProf.mark("searchRenderEnd");this._logCachedTilesStats(logHead)}},_searchRenderTabs:function(tabs,newSearch){const logHead="TabsTabViewer::_searchRenderTabs(newSearch: "+newSearch+"): ";this._setSearchBoxCountBlinking();let merge=true;Promise.all([this._historyFinder._getRecentlyClosedTabs(),this._bookmarksFinder.find(this._currentSearchInput),this._historyFinder.find(this._currentSearchInput)]).then(function([rcTabs,bmNodes,hItems]){let mergedTabs=tabs.concat(rcTabs);this._searchRenderTabsInner(mergedTabs,bmNodes,hItems,newSearch)}.bind(this))}});Classes.Base.roDef(Classes.TabsTabViewer,"CbType",{});Classes.Base.roDef(Classes.TabsTabViewer.CbType,"ACTIVATED","activated");Classes.Base.roDef(Classes.TabsTabViewer.CbType,"HIGHLIGHTED","highlighted");Classes.Base.roDef(Classes.TabsTabViewer.CbType,"UPDATED","updated");Classes.Base.roDef(Classes.TabsTabViewer.CbType,"REMOVED","removed");Classes.Base.roDef(Classes.TabsTabViewer.CbType,"ATTACHED","attached");Classes.Base.roDef(Classes.TabsTabViewer.CbType,"MOVED","moved");Classes.AllTabsTabViewer=Classes.TabsTabViewer.subclass({_emptyContainerString:"No tabs",_init:function(tabLabelHtml){this._expandedGroups=localStore.allTabsTabExpandedGroups;Classes.TabsTabViewer._init.apply(this,arguments)},_tabsAsyncQuery:function(){const logHead="AllTabsTabViewer::_tabsAsyncQuery(): ";return chromeUtils.wrap(chrome.tabs.query,logHead,{})}});Classes.TabTileViewer=Classes.Viewer.subclass({__idPrefix:"TabTileViewer",_rootElem:null,_bodyElem:null,_menuElem:null,_closeElem:null,_renderState:null,_renderBodyCompleted:null,_tab:null,_tabGroup:null,_asyncQueue:null,_menuViewer:null,_init:function(tab,tabGroup,asyncQueue){Classes.Viewer._init.apply(this,arguments);this.debug();this._renderBodyCompleted=false;this._tab=tab;this._asyncQueue=asyncQueue;this._renderEmptyTile();this.update(tab,tabGroup)},_renderEmptyTile:function(){const bodyId=this._id+"-body";const menuId=this._id+"-menu";const closeId=this._id+"-close";const closeIconClass=this._tab.incognito?"tm-close-icon-light":"tm-close-icon";const closeIcon=`<span aria-hidden="true" class="${closeIconClass}"></span>`;const rootHtml=`
	<div style="cursor: default; min-height: 3em;" class="card tm-hover">
		<div id="${bodyId}" class="card-body px-2 py-1 text-nowrap tm-stacked-below">
		</div>
		<div class="tm-overlay tm-full-size tm-hover-target">
			<div id="${menuId}" class="tm-tile-toggle-center">
			</div>
			<div class="tm-float-right">
				<button type="button" id="${closeId}" class="tm-close-icon-button" aria-label="Close">
					${closeIcon}
				</button>
			</div>
		</div>
	</div>
	`;this._rootElem=this._elementGen(rootHtml);this._bodyElem=this.getElementById(bodyId);this._menuElem=this.getElementById(menuId);this._closeElem=this.getElementById(closeId);if(this._tab.tm.type==Classes.NormalizedTabs.type.RCTAB){this._closeElem.classList.add("tm-hide")}this.setClickHandler(this._onTileClickCb.bind(this));this.setClickCloseHandler(this._onTileCloseCb.bind(this))},_colorToBgCss:{none:"bg-light",grey:"bg-secondary",blue:"bg-primary",red:"bg-danger",yellow:"bg-warning",green:"bg-success",cyan:"bg-info"},_badgeHtml:function(txt,bgColor){let extraClasses=[];extraClasses.push(optionalWithDefault(this._colorToBgCss[bgColor],"bg-dark"));if(txt.length>20){txt=txt.substring(0,20)+"..."}return`<span class="badge tm-text-badge ${extraClasses.join(" ")}">${txt}</span>`},_addBadgesHtml:function(visibleBadgesHtml,badgesList,secondary){badgesList.forEach(function(badge){visibleBadgesHtml.push(this._badgeHtml(badge,secondary?"grey":null))}.bind(this))},_renderMenuInner:function(){switch(this._renderState.tmType){case Classes.NormalizedTabs.type.TAB:this._menuViewer=Classes.TileTabMenuViewer.create(this._tab);this._menuViewer.attachToElement(this._menuElem);break;case Classes.NormalizedTabs.type.BOOKMARK:this._menuViewer=Classes.TileBookmarkMenuViewer.create(this._tab);this._menuViewer.attachToElement(this._menuElem);break;case Classes.NormalizedTabs.type.HISTORY:this._menuViewer=Classes.TileHistoryMenuViewer.create(this._tab);this._menuViewer.attachToElement(this._menuElem);break;default:const logHead="TabTileViewer::_renderMenuInner(tile "+this._id+"): ";this._err(logHead+"unknown tmType",this._renderState.tmType);break}},_renderMenu:function(){if(this._renderState.tmType==Classes.NormalizedTabs.type.RCTAB){this._menuViewer=null;return}this._asyncQueue.enqueue(this._renderMenuInner.bind(this),"TabTileViewer::_renderMenu(tile "+this._id+")",Classes.AsyncQueue.priority.LOW)},_updateMenu:function(){if(this._menuViewer==null){return}this._asyncQueue.enqueue(this._menuViewer.update.bind(this._menuViewer,this._tab),"TabTileViewer::_updateMenu(tile "+this._id+")",Classes.AsyncQueue.priority.LOW)},_renderBodyInner:function(){const logHead="TabTileViewer::_renderBodyInner(): ";let visibleBadgesHtml=[];let titleExtraClasses=[];let textMuted="text-muted";let imgExtraClasses=[];switch(this._renderState.audio){case"audible-muted":visibleBadgesHtml.push(icons.volumeMuted());break;case"audible":visibleBadgesHtml.push(icons.volumeAudible);break;case"muted":if(!this._renderState.incognito){visibleBadgesHtml.push(icons.volumeMuted("text-secondary"))}else{visibleBadgesHtml.push(icons.volumeMuted("text-white-50"))}break;default:if(this._renderState.audio!=null){this._err(logHead+"unknown this._renderState.audio = ",this._renderState.audio)}break}if(this._renderState.customGroupName!=null){let cgm=settingsStore.getCustomGroupsManager();this.addClasses("tm-callout",cgm.getCustomGroupCssByColor(this._renderState.customGroupColor));visibleBadgesHtml.push(this._badgeHtml(this._renderState.customGroupName,this._renderState.customGroupColor))}this._addBadgesHtml(visibleBadgesHtml,this._renderState.primaryShortcutBadges);this._addBadgesHtml(visibleBadgesHtml,this._renderState.secondaryShortcutBadges,true);this._addBadgesHtml(visibleBadgesHtml,this._renderState.visualBadges);if(this._renderState.pinned){visibleBadgesHtml.push(icons.thumbtack())}if(this._renderState.incognito){this.addClasses("bg-secondary","text-light","border-dark");textMuted=""}if(this._renderState.status!=null){switch(this._renderState.status){case"unloaded":titleExtraClasses.push("fst-italic");imgExtraClasses.push("tm-favicon-bw");break;case"loading":case"complete":break;default:this._err(logHead+"unknown this._renderState.status = ",this._renderState.status);break}}let specialIcon="";switch(this._renderState.tmType){case Classes.NormalizedTabs.type.BOOKMARK:specialIcon=icons.bookmark;break;case Classes.NormalizedTabs.type.RCTAB:specialIcon=icons.history("tm-fa-recently-closed");break;case Classes.NormalizedTabs.type.HISTORY:specialIcon=icons.history("tm-fa-history");break;case Classes.NormalizedTabs.type.TAB:break;default:this._err(logHead+"unknown this._renderState.tmType = ",this._renderState.tmType);break}let imgHtml="";if(this._imgUrl!=""){imgHtml=`
			<span class="pe-1"><img class="tm-favicon-16 ${imgExtraClasses.join(" ")}" src="${this._renderState.imgUrl}"></span>
		`}const bodyHtml=`
		<p class="card-title text-truncate tm-tile-title mb-0">
			${imgHtml}
			${specialIcon}
			<span class="align-middle ${textMuted} ${titleExtraClasses.join(" ")}">${this._safeText(this._renderState.title)}</span>
		</p>
		<div class="d-flex">
			<p class="flex-grow-1 align-self-center text-truncate tm-tile-url">
				<small class="${textMuted}">${this._safeText(this._renderState.url)}</small>
			</p>
			<p> </p>
			<p class="align-self-center card-text small" style="text-align: right;">
				${visibleBadgesHtml.join(" ")}
			</p>
		</div>
	`;this.setHtml(bodyHtml);if(this._menuViewer==null){this._renderMenu()}else{this._updateMenu()}},_getTabMetaTags:function(){const logHead="TabTileViewer::_getTabMetaTags("+this._tab.id+"): ";if(["chrome:","chrome-extension:","chrome-error:"].includes(this._tab.tm.protocol)){this._log(logHead+"can't access URL with protocol \""+this._tab.tm.protocol+'"',this._tab.url);return Promise.resolve(null)}if(this._tab.status=="unloaded"||this._tab.discarded){return Promise.resolve(null)}return chromeUtils.inject(this._tab.id,"content-gen/inject-getMeta.js").then(function(result){if(result==null){return null}if(result.length==1){if(result[0]==null){this._err(logHead+"the injected script failed to generate a return value",result);return null}return result[0].parsed}this._err(logHead+"unknown format for result = ",result);return null}.bind(this),function(chromeLastError){this._err(logHead+"unknown error: "+chromeLastError.message,this._tab);return chromeLastError}.bind(this))},_renderBody:function(queuePriority){this._renderBodyCompleted=false;this._asyncQueue.enqueue(function(){this._renderBodyInner();this._renderBodyCompleted=true}.bind(this),"tile "+this._id,queuePriority)},_onTileClickCb:function(ev){Classes.TabsTabViewer.activateTab(this._tab)},_onTileCloseCb:function(ev){const logHead="TabTileViewer::_onTileCloseCb("+this._tab.id+"): ";let removeFn=chrome.tabs.remove;let fnParam=this._tab.id;let completionMsg="completed";switch(this._tab.tm.type){case Classes.NormalizedTabs.type.BOOKMARK:removeFn=chrome.bookmarks.remove;fnParam=this._tab.bookmarkId;completionMsg="bookmark deleted";break;case Classes.NormalizedTabs.type.HISTORY:removeFn=chrome.history.deleteUrl;fnParam={url:this._tab.url};completionMsg="history item deleted";break;case Classes.NormalizedTabs.type.TAB:break;default:this._err(logHead+"unknown tab type",this_tab.tm.type);break}chromeUtils.wrap(removeFn,logHead,fnParam).then(function(){this._log(logHead+completionMsg,fnParam)}.bind(this));ev.stopPropagation()},_cleanupUrl:function(url){if(url=="chrome://newtab/"){return"New tab"}if(url==popupDocker.getPopupUrl(true)&&this._tab.id==popupDocker.getOwnTabId()){return"This popup window"}if(url.startsWith("https://")){return url.substring(8)}return url},updateAsyncQueue:function(asyncQueue){this._asyncQueue=asyncQueue},_createRenderState:function(tab,tabGroup){let renderState={};renderState.id=tab.id;renderState.tmType=tab.tm.type;renderState.title=tab.title;renderState.url=this._cleanupUrl(tab.url);if(tab.favIconUrl!=null){renderState.imgUrl=tab.favIconUrl}else{if(tabGroup!=null&&tabGroup.favIconUrl!=null){renderState.imgUrl=tabGroup.favIconUrl}else{renderState.imgUrl=""}}renderState.incognito=tab.incognito;if(tab.audible){if(tab.mutedInfo!=null&&tab.mutedInfo.muted){renderState.audio="audible-muted"}else{renderState.audio="audible"}}else{if(tab.mutedInfo!=null&&tab.mutedInfo.muted){renderState.audio="muted"}else{renderState.audio=null}}if(tab.tm.customGroupName!=null){renderState.customGroupName=tab.tm.customGroupName;let cgm=settingsStore.getCustomGroupsManager();renderState.customGroupColor=cgm.getCustomGroupColor(tab.tm.customGroupName)}else{renderState.customGroupName=null;renderState.customGroupColor=null}renderState.primaryShortcutBadges=tmUtils.deepClone(tab.tm.primaryShortcutBadges);renderState.secondaryShortcutBadges=tmUtils.deepClone(tab.tm.secondaryShortcutBadges);renderState.visualBadges=tmUtils.deepClone(tab.tm.visualBadges);renderState.pinned=tab.pinned;renderState.status=tab.status;return renderState},_isRenderCompleted:function(){if(this._menuViewer==null){return false}},update:function(tab,tabGroup,queuePriority){const logHead="TabTileViewer::update(): ";if(tab==null){this._tab.activated=true;tab=this._tab}else{this._assert(this._tab.id==tab.id,logHead+`tab.id changed from ${this._tab.id} to ${tab.id}`);this._assert(this._tab.tm.type==tab.tm.type,logHead+`type changed from ${this._tab.tm.type} to ${tab.tm.type} for tab ${this._tab.tm.extId}`);this._tab=tab}if(tabGroup!=null){this._tabGroup=tabGroup}let pastRenderState=this._renderState;this._renderState=this._createRenderState(tab,this._tabGroup);if(!this._renderBodyCompleted){this._renderBody();return true}this._assert(pastRenderState!=null);if(tmUtils.isEqual(pastRenderState,this._renderState)){this._updateMenu();return false}this._renderBody();return true},getTabId:function(){return this._tab.id},setClickCloseHandler:function(fn){this._closeElem.addEventListener("click",fn,false)},setClickHandler:function(fn){this._rootElem.addEventListener("click",fn,false)}});Classes.MenuViewer=Classes.Viewer.subclass({__idPrefix:"MenuViewer",_rootElem:null,_bodyElem:null,_options:null,_init:function(options){options=optionalWithDefault(options,{});options.label=optionalWithDefault(options.label,"");options.showToggle=optionalWithDefault(options.showToggle,true);options.btnExtraClasses=optionalWithDefault(options.btnExtraClasses,["btn-secondary"]);this._options=options;Classes.Viewer._init.call(this);this._MenuViewer_render()},_MenuViewer_render:function(){const menuId=this._id+"-menu";const menuItemsContainerId=this._id+"-menuitems";let dropdownExtraClasses=[];if(this._options.showToggle){if(this._options.label==""){dropdownExtraClasses.push("tm-dropdown-toggle")}dropdownExtraClasses.push("dropdown-toggle")}if(this._options.btnExtraClasses.length>0){dropdownExtraClasses.push(...this._options.btnExtraClasses)}let menuButtonHtml=`
	<div class="dropdown tm-full-height">
		<a class="btn ${dropdownExtraClasses.join(" ")}" role="button"
				id="${menuId}" data-bs-toggle="dropdown" aria-expanded="false">
			${this._options.label}
		</a>
		<ul id=${menuItemsContainerId} class="dropdown-menu tm-dropdown-menu" aria-labelledby="${menuId}">
		</ul>
	</div>
	`;this._rootElem=this._elementGen(menuButtonHtml);this._bodyElem=this.getElementById(menuItemsContainerId);let menuElem=this.getElementById(menuId);let bootstrapObj=new bootstrap.Dropdown(menuElem);this._rootElem.addEventListener("click",function(ev){ev.stopPropagation();bootstrapObj.hide()},false)}});Classes.MenuItemViewer=Classes.Viewer.subclass({__idPrefix:"MenuItemViewer",_rootElem:null,_bodyElem:null,_actionFn:null,_init:function(text,actionFn){Classes.Viewer._init.call(this);this.debug();this._renderMenuItem(optionalWithDefault(text,""));this._actionFn=null;if(actionFn!=null){this.setAction(actionFn)}},_renderMenuItem:function(text){const logHead="MenuItemViewer::_renderMenuItem(): ";const bodyId=this._id+"-item";const rootHtml=`
		<li id="${this._id}">
			<div id="${bodyId}" class="dropdown-item tm-dropdown-item"></div>
		</li>
	`;this._rootElem=this._elementGen(rootHtml);this._bodyElem=this.getElementById(bodyId);this.setText(text)},setAction:function(fn){if(this._actionFn!=null){this._bodyElem.removeEventListener("click",this._actionFn,false)}this._actionFn=fn;this._bodyElem.addEventListener("click",this._actionFn,false)}});Classes.TileTabMenuViewer=Classes.MenuViewer.subclass({__idPrefix:"TileTabMenuViewer",_tab:null,_titleMenuItem:null,_pinMenuItem:null,_muteMenuItem:null,_highlightMenuItem:null,_playMenuItem:null,_suspendMenuItem:null,_closeMenuItem:null,_shortcutMenuItems:null,_init:function(tab){Classes.MenuViewer._init.call(this,{btnExtraClasses:[tab.incognito?"btn-light":"btn-secondary"]});this.debug();this._tab=tab;this._assert(this._tab.tm.type==Classes.NormalizedTabs.type.TAB);this._initMenuItems()},_setShortcutMenuItems:function(){let sm=settingsStore.getShortcutsManager();let scKeys=sm.getShortcutKeysForTab(this._tab,false);this._shortcutMenuItems=[];scKeys.forEach(function(key){let item=Classes.MenuItemViewer.create("Move tab to match shortcut "+sm.keyToUiString(key),this._actionSetCandidateCb.bind(this,key));this._shortcutMenuItems.push(item);this.append(item)}.bind(this))},_updateShortcutMenuItems:function(){const logHead="TileTabMenuViewer::_updateShortcutMenuItems("+this._tab.id+"): ";for(let i=0;i<this._shortcutMenuItems.length;i++){this._shortcutMenuItems[i].detach()}this._shortcutMenuItems=[];this._setShortcutMenuItems()},_initMenuItems:function(){this._titleMenuItem=Classes.MenuItemViewer.create("",this._actionActivateCb.bind(this));this._titleMenuItem.setHtml("<b>"+this._safeText(this._tab.title)+"</b>");this.append(this._titleMenuItem);this._pinMenuItem=Classes.MenuItemViewer.create(this._tab.pinned?"Unpin":"Pin",this._actionPinToggleCb.bind(this));this.append(this._pinMenuItem);this._muteMenuItem=Classes.MenuItemViewer.create(this._tab.mutedInfo.muted?"Unmute":"Mute",this._actionMuteToggleCb.bind(this));this.append(this._muteMenuItem);this._highlightMenuItem=Classes.MenuItemViewer.create(this._tab.highlighted?"Remove highlight":"Highlight",this._actionHighlightToggleCb.bind(this));this.append(this._highlightMenuItem);this._moveToLeastTabbedMenuItem=Classes.MenuItemViewer.create("Move to least tabbed window",this._actionMoveToLeastTabbedCb.bind(this));this.append(this._moveToLeastTabbedMenuItem);this._suspendMenuItem=Classes.MenuItemViewer.create("Suspend (discard from memory)",this._actionSuspendCb.bind(this));this.append(this._suspendMenuItem);this._closeMenuItem=Classes.MenuItemViewer.create("Close",this._actionCloseCb.bind(this));this.append(this._closeMenuItem);this._setShortcutMenuItems()},_updateMenuItems:function(){this._titleMenuItem.setHtml("<b>"+this._safeText(this._tab.title)+"</b>");this._pinMenuItem.setText(this._tab.pinned?"Unpin":"Pin");this._muteMenuItem.setText(this._tab.mutedInfo.muted?"Unmute":"Mute");this._highlightMenuItem.setText(this._tab.highlighted?"Remove highlight":"Highlight");this._updateShortcutMenuItems()},_actionActivateCb:function(ev){chromeUtils.activateTab(this._tab.id)},_actionPinToggleCb:function(ev){const logHead="TileTabMenuViewer::_actionPinToggleCb("+this._tab.id+"): ";chromeUtils.wrap(chrome.tabs.update,logHead,this._tab.id,{pinned:!this._tab.pinned}).then(function(){this._log(logHead+"completed")}.bind(this))},_actionMuteToggleCb:function(ev){const logHead="TileTabMenuViewer::_actionMuteToggleCb("+this._tab.id+"): ";chromeUtils.wrap(chrome.tabs.update,logHead,this._tab.id,{muted:!this._tab.mutedInfo.muted}).then(function(){this._log(logHead+"completed")}.bind(this))},_actionHighlightToggleCb:function(ev){const logHead="TileTabMenuViewer::_actionHighlightToggleCb("+this._tab.id+"): ";chromeUtils.wrap(chrome.tabs.update,logHead,this._tab.id,{highlighted:!this._tab.highlighted}).then(function(){this._log(logHead+"completed")}.bind(this))},_actionPlayToggleCb:function(ev){const logHead="TileTabMenuViewer::_actionPlayToggleCb("+this._tab.id+"): ";chromeUtils.inject(this._tab.id,"content-gen/inject-togglePlay.js").then(function(result){if(result==null){return null}this._log(logHead,result);if(result.length==1){if(result[0]==null){this._err(logHead+"the injected script failed to generate a return value",result);return null}return result[0]}this._err(logHead+"unknown format for result = ",result);return null}.bind(this),function(chromeLastError){this._err(logHead+"unknown error: "+chromeLastError.message,this._tab);return chromeLastError}.bind(this))},_actionMoveToLeastTabbedCb:function(ev){const logHead="TileTabMenuViewer::_actionMoveToLeastTabbedCb("+this._tab.id+"): ";chromeUtils.moveTabToLeastTabbedWindow(this._tab,false).then(function(result){if(result!=null){this._log(logHead+"completed")}else{this._log(logHead+"no action taken")}}.bind(this))},_actionSuspendCb:function(ev){const logHead="TileTabMenuViewer::_actionSuspendCb("+this._tab.id+"): ";chromeUtils.wrap(chrome.tabs.discard,logHead,this._tab.id).then(function(){this._log(logHead+"completed")}.bind(this))},_actionCloseCb:function(ev){const logHead="TileTabMenuViewer::_actionCloseCb("+this._tab.id+"): ";chromeUtils.wrap(chrome.tabs.remove,logHead,this._tab.id).then(function(){this._log(logHead+"completed")}.bind(this))},_actionSetCandidateCb:function(key,ev){const logHead="TileTabMenuViewer::_actionSetCandidateCb("+this._tab.id+", "+key+"): ";let sm=settingsStore.getShortcutsManager();let candidateTabs=sm.getShortcutInfo(key).candidateTabs;this._assert(candidateTabs!=null);this._log(logHead+"entering, first candidate is: ",candidateTabs[0]);chromeUtils.wrap(chrome.tabs.move,logHead,this._tab.id,{index:candidateTabs[0].index,windowId:candidateTabs[0].windowId})},update:function(tab){this._tab=tab;this._updateMenuItems()}});Classes.TileBookmarkMenuViewer=Classes.MenuViewer.subclass({__idPrefix:"TileBookmarkMenuViewer",_bm:null,_titleMenuItem:null,_titleElem:null,_subtitleElem:null,_openBookmarkManagerMenuItem:null,_deleteMenuItem:null,_init:function(bm){Classes.MenuViewer._init.call(this);this.debug();this._bm=bm;this._assert(this._bm.tm.type==Classes.NormalizedTabs.type.BOOKMARK);this._initMenuItems()},_renderPathHtml:function(pathList){return`
	Bookmark from <i>${pathList.join("/")}</i>
	`},_renderTitle:function(){const titleId=this._id+"-title";const subtitleId=this._id+"-subtitle";let titleHtml=`
		<div id="${titleId}"></div>
		<div id="${subtitleId}"></div>
	`;this._titleMenuItem=Classes.MenuItemViewer.create("",this._actionActivateCb.bind(this));this._titleMenuItem.setHtml(titleHtml);this.append(this._titleMenuItem);this._titleElem=this.getElementById(titleId);this._subtitleElem=this.getElementById(subtitleId);this._updateTitleMenuItem()},_updateTitleMenuItem:function(){this._titleElem.innerHTML=`<b>${this._safeText(this._bm.title)}</b>`;chromeUtils.getBookmarkPathList(this._bm).then(function(pathList){this._subtitleElem.innerHTML=this._renderPathHtml(pathList)}.bind(this))},_initMenuItems:function(){this._renderTitle();if(this._bm.parentId!=null){this._openBookmarkManagerMenuItem=Classes.MenuItemViewer.create("Open folder in Chrome Bookmark manager",this._actionBookmarkManagerCb.bind(this));this.append(this._openBookmarkManagerMenuItem)}this._deleteMenuItem=Classes.MenuItemViewer.create("Delete",this._actionDeleteCb.bind(this));this.append(this._deleteMenuItem)},_updateMenuItems:function(){this._updateTitleMenuItem()},_actionActivateCb:function(ev){Classes.TabsTabViewer.activateTab(this._bm)},_actionBookmarkManagerCb:function(ev){let url="chrome://bookmarks/?id="+this._bm.parentId;chromeUtils.loadUrl(url)},_actionPinToggleCb:function(ev){const logHead="TileBookmarkMenuViewer::_actionPinToggleCb("+this._bm.id+"): "},_actionDeleteCb:function(ev){const logHead="TileBookmarkMenuViewer::_actionDeleteCb("+this._bm.id+"): ";chromeUtils.wrap(chrome.bookmarks.remove,logHead,this._bm.bookmarkId).then(function(){this._log(logHead+"completed")}.bind(this))},update:function(bm){this._bm=bm;this._updateMenuItems()}});Classes.TileHistoryMenuViewer=Classes.MenuViewer.subclass({__idPrefix:"TileHistoryMenuViewer",_item:null,_titleMenuItem:null,_titleElem:null,_subtitleElem:null,_deleteMenuItem:null,_init:function(item){Classes.MenuViewer._init.call(this);this.debug();this._item=item;this._assert(this._item.tm.type==Classes.NormalizedTabs.type.HISTORY);this._initMenuItems()},_renderTitle:function(){const titleId=this._id+"-title";const subtitleId=this._id+"-subtitle";let titleHtml=`
		<div id="${titleId}"></div>
		<div id="${subtitleId}"></div>
	`;this._titleMenuItem=Classes.MenuItemViewer.create("",this._actionActivateCb.bind(this));this._titleMenuItem.setHtml(titleHtml);this.append(this._titleMenuItem);this._titleElem=this.getElementById(titleId);this._subtitleElem=this.getElementById(subtitleId);this._updateTitleMenuItem()},_updateTitleMenuItem:function(){this._titleElem.innerHTML=`<b>${this._safeText(this._item.title)}</b>`;let visitsCnt=this._item.visitCount+this._item.typedCount;let lastVisited=new Date(this._item.lastVisitTime).toString();let midString=`${visitsCnt} times, last`;if(visitsCnt==1){midString="once"}this._subtitleElem.innerHTML=`History item, visited ${midString} on ${lastVisited}`},_initMenuItems:function(){this._renderTitle();this._deleteMenuItem=Classes.MenuItemViewer.create("Delete",this._actionDeleteCb.bind(this));this.append(this._deleteMenuItem)},_updateMenuItems:function(){this._updateTitleMenuItem()},_actionActivateCb:function(ev){Classes.TabsTabViewer.activateTab(this._item)},_actionDeleteCb:function(ev){const logHead="TileHistoryMenuViewer::_actionDeleteCb("+this._item.url+"): ";chromeUtils.wrap(chrome.history.deleteUrl,logHead,{url:this._item.url}).then(function(){this._log(logHead+"completed")}.bind(this))},update:function(item){this._item=item;this._updateMenuItems()}});Classes.PopupMenuViewer=Classes.MenuViewer.subclass({__idPrefix:"PopupMenuViewer",_tab:null,_dockToggleMenuItem:null,_init:function(){Classes.MenuViewer._init.call(this,{btnExtraClasses:["tm-menu-icon"],showToggle:false});this.addClasses("mx-2");this.debug();this._initMenuItems()},_setDockToggleText:function(){const dockToggleText=(popupDocker.isPopupDocked()?"Undock":"Dock")+" popup";this._dockToggleMenuItem.setHtml(dockToggleText)},_initMenuItems:function(){this._dockToggleMenuItem=Classes.MenuItemViewer.create("",this._actionDockToggleCb.bind(this));this._setDockToggleText();this.append(this._dockToggleMenuItem)},_updateMenuItems:function(){this._setDockToggleText()},_actionDockToggleCb:function(ev){popupDocker.dockToggle()},update:function(){this._updateMenuItems()}});Classes.NewTabAction=Classes.Base.subclass({_newTabButtonViewer:null,_init:function(){Classes.Base._init.call(this);let btnOptions={btnExtraClasses:["tm-plus-icon"]};this._newTabButtonViewer=Classes.ButtonViewer.create(btnOptions);this._newTabButtonViewer.onButtonClickCb=this._createNewTab.bind(this);popupViewer.appendButton(this._newTabButtonViewer)},_launchOrSearch:function(urlOrSearch){const logHead="NewTabAction::_launchOrSearch(): ";let searchUrl=optionalWithDefault(settingsStore.getOptionSearchUrl(),"https://www.google.com/search?q=%s");if(!isUrl(urlOrSearch)){this._log(logHead+"not a URL, opening a search page instead: "+urlOrSearch);urlOrSearch=searchUrl.replace("%s",urlOrSearch)}chromeUtils.loadUrl(urlOrSearch)},_createNewTab:function(ev){const logHead="NewTabAction::_createNewTab(): ";let searchQuery=popupViewer.getSearchQuery();if(searchQuery==null){chromeUtils.reuseOrCreateTab();return}this._launchOrSearch(searchQuery)}});window.addEventListener("error",function(e){console.error("Unhandled exception: "+e.error.message,e);return false});window.addEventListener("load",init);var popupMsgServer=null;function testSettings(){settingsStore.setOptionSearchUrl("https://duckduckgo.com/?q=%s");settingsStore.setOptionAdvancedMenu(true);settingsStore.unpinGroup("Work");settingsStore.pinGroup("Tech news");settingsStore.getShortcutsManager().setShortcut(window.ExtCommands.SHORTCUT01,{title:"Gmail",hostname:"mail.google.com"});settingsStore.getShortcutsManager().setShortcut(window.ExtCommands.SHORTCUT02,{title:"Los Angeles Public Library",url:"https://lapl.overdrive.com/search?query=%s",useClipboard:true});settingsStore.getShortcutsManager().setShortcut(window.ExtCommands.SHORTCUT03,{title:"Wikipedia",url:"https://en.wikipedia.org/wiki/%s",useClipboard:true});settingsStore.getCustomGroupsManager().setCustomGroup("Microsoft",{favIconUrl:"https://azurecomcdn.azureedge.net/cvt-5a6d098bd41d86e10abc9c93a784dea7f4f9eccc980ab08c0ffe9f3c2412a6e8/images/icon/favicon.ico",color:"red",matchList:".microsoft.com"});settingsStore.getCustomGroupsManager().setCustomGroup("Work",{favIconUrl:"https://community.atlassian.com/html/assets/favicon-16x16.png",color:"blue",matchList:"jira.\n  wiki.    \n .sharepoint.com"});settingsStore.getCustomGroupsManager().setCustomGroup("Companies (very long name to see what happens with truncation)",{color:"green",matchList:"crunchbase.com\nowler.com"});settingsStore.getCustomGroupsManager().setCustomGroup("Wikipedia",{color:"cyan",matchList:"wikipedia.org"});settingsStore.getCustomGroupsManager().setCustomGroup("News",{color:"cyan",matchList:`
	aeon.co
	getpocket.com
	glamour.com
	nautil.us
	npr.org
	nytimes.com
	vox.com
		`});settingsStore.getCustomGroupsManager().setCustomGroup("Tech news",{color:"yellow",matchList:`
	venturebeat.com
	techcrunch.com
		`});settingsStore.getCustomGroupsManager().setCustomGroup("Shopping",{color:"green",matchList:`
	amazon.com
	bestbuy.com
	houzz.com
	techradar.com
	wayfair.com
		`});settingsStore.getCustomGroupsManager().setCustomGroup("Searches",{color:"blue",matchList:`
	www.google.com
	bing.com
	duckduckgo.com
		`})}function init(){perfProf.mark("windowLoaded");Promise.all([settingsStore.getInitPromise(),localStore.getInitPromise()]).then(function(){if(!isProd()){testSettings()}popupMsgServer=Classes.PopupMsgServer.create();popupMsgServer.start();let rootElem=document.getElementById("popup-tabs-div");perfProf.mark("popupViewerStart");Classes.Base.roDef(window,"popupViewer",Classes.PopupViewer.createAs("popup-tabs",rootElem));Classes.NewTabAction.create();perfProf.measure("Loading window",undefined,"windowLoaded");perfProf.measure("Loading settings","settingsStarted","settingsLoaded");perfProf.measure("Loading localStore","localStoreStarted","localStoreLoaded");perfProf.measure("Creating popupViewer","popupViewerStart","popupViewerEnd");perfProf.measure("Attaching popupViewer","popupViewerEnd","attachEnd")})}