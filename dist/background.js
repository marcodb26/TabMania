function setProd(flag){Object.defineProperty(window,"productionCode",{value:flag,configurable:false,enumerable:false,writable:false})}setProd(true);function isProd(){return optionalWithDefault(window.productionCode,false)}Classes={};Classes.Base={_Base_:{lastId:0,_idGen:function(){return++this.lastId}},__idPrefix:null,roDef:function(obj,propName,propValue){Object.defineProperty(obj,propName,{value:propValue,configurable:true,enumerable:false,writable:false})},_genLogFn:function(consoleFn,setPrefix){setPrefix=optionalWithDefault(setPrefix,false);if(!setPrefix){return Function.prototype.bind.call(consoleFn,console)}return Function.prototype.bind.call(consoleFn,console,"["+this._id+"]")},create:function(){return this.createAs(null,...arguments)},createAs:function(id,...restArgs){var retVal=Object.create(this);this.roDef(retVal,"_hiddenId",this._Base_._idGen());this.roDef(retVal,"_id",id==null?this._formatId(retVal._hiddenId):id);this.debug.call(retVal,false);this.roDef(retVal,"_err",this._genLogFn.call(retVal,console.error,true));this.roDef(retVal,"_assert",this._genLogFn.call(retVal,console.assert));retVal._init.apply(retVal,restArgs);return retVal},debug:function(flag){flag=optionalWithDefault(flag,true);if(flag&&!isProd()){this.roDef(this,"_log",this._genLogFn(console.log,true));this.roDef(this._log,"raw",this._genLogFn(console.log,false));this.roDef(this._log,"trace",this._genLogFn(console.trace,true))}else{this.roDef(this,"_log",emptyFn);this.roDef(this._log,"raw",emptyFn);this.roDef(this._log,"trace",emptyFn)}},subclass:function(extension){return Object.assign({},this,extension)},getId:function(){return this._id},_init:function(){},_formatId:function(hiddenId){if(this.__idPrefix==null){return hiddenId}return this.__idPrefix+"-"+hiddenId},_errorMustSubclass:function(signature){return Function.prototype.bind.call(console.error,console,"This method must be subclassed: "+signature)}()};Classes.AsyncBase=Classes.Base.subclass({_initPromise:null,_initialized:null,_init:function(maxElements){Classes.Base._init.apply(this,arguments);this._initialized=false;this._initPromise=this._asyncInit().then(function(){this._initialized=true}.bind(this))},_asyncInit:function(){return Promise.resolve()},isInitialized:function(){return this._initialized},getInitPromise:function(){return this._initPromise}});Classes.BoundArray=Classes.Base.subclass({_array:null,_maxElements:null,_init:function(maxElements){Classes.Base._init.apply(this,arguments);this._maxElements=maxElements;this._array=[]},resize:function(){if(this._array.length>=this._maxElements){this._array.splice(0,this._maxElements-this._array.length)}return this._array.length},push:function(value){this._array.push(value);return this.resize()},pop:function(){return this._array.pop()},isEmpty:function(){return this._array.length==0},peek:function(cnt){if(this.isEmpty()){return null}if(cnt==null){return this._array[this._array.length-1]}if(cnt>this._array.length){cnt=this._array.length}return this._array.slice(-cnt)},append:function(value){this._array.splice(-1,0,...value);return this.resize()},removeValue:function(value){var nextIndex=0;while((nextIndex=this._array.indexOf(value,nextIndex))!=-1){this._array.splice(nextIndex,1)}},get:function(pos){if(pos!=undefined){return this._array[pos]}return this._array}});Classes.EventManager=Classes.Base.subclass({_elem:null,_ownerObj:null,_init:function(){Classes.Base._init.call(this);this._elem=document.createElement("div");this.addEventListener=this._elem.addEventListener.bind(this._elem);this.removeEventListener=this._elem.removeEventListener.bind(this._elem)},dispatchEvent:function(eventName,detailObj){this._elem.dispatchEvent(new CustomEvent(eventName,{detail:detailObj}))},notifyListeners:function(eventId,extraData){extraData=optionalWithDefault(extraData,{});let detail=Object.assign({target:this._ownerObj},extraData);this.dispatchEvent(eventId,detail)},attachRegistrationFunctions:function(obj){obj.addEventListener=this.addEventListener;obj.removeEventListener=this.removeEventListener;this._assert(this._ownerObj==null);this._ownerObj=obj},addEventListener:function(){},removeEventListener:function(){}});Classes.Base.roDef(Classes.EventManager,"Events",{});Classes.Base.roDef(Classes.EventManager.Events,"UPDATED","tmUpdated");Classes.PersistentDict=Classes.AsyncBase.subclass({_storageObj:null,_dict:null,_eventManager:null,_initPromise:null,_initialized:null,_init:function(storageObj){this.debug();this._storageObj=optionalWithDefault(storageObj,chrome.storage.local);this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);chrome.storage.onChanged.addListener(this._onStorageChangedCb.bind(this));Classes.AsyncBase._init.apply(this,arguments)},_asyncInit:function(){let parentPromise=Classes.AsyncBase._asyncInit();let thisPromise=chromeUtils.storageGet(this._id,this._storageObj).then(function(results){const logHead="PersistentDict::_initDict().cb: ";this._dict={};if(this._id in results){this._dict=results[this._id];this._log(logHead+"initializing this._dict to ",this._dict)}else{this._log(logHead+"key "+this._id+" not found, initializing empty")}}.bind(this));return Promise.all([parentPromise,thisPromise])},_isEqual:function(objA,objB){const logHead="PersistentDict::_isEqual(): ";if(typeof objA!=typeof objB){return false}if(typeof objA!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead+'"'+typeof objA+'" is not supported');return objA===objB}this._assert(!Array.isArray(objA),logHead+"arrays are not supported");if(objA==null||objB==null){return objA===objB}let keysA=Object.keys(objA).sort();let keysB=Object.keys(objB).sort();if(keysA.length!=keysB.length){return false}for(let i=0;i<keysA.length;i++){if(keysA[i]!=keysB[i]){return false}if(!this._isEqual(objA[keysA[i]],objB[keysB[i]])){return false}}return true},_deepClone:function(obj){const logHead="PersistentDict::_deepClone(): ";if(obj===undefined){return undefined}if(typeof obj!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead+'"'+typeof objA+'" is not supported');return obj}if(obj==null){return null}this._assert(!Array.isArray(obj),logHead+"arrays are not supported");let retVal={};let keys=Object.keys(obj);for(let i=0;i<keys.length;i++){retVal[keys[i]]=this._deepClone(obj[keys[i]])}return retVal},_onStorageChangedCb:function(changes,areaName){const logHead="PersistentDict::_onStorageChangedCb("+areaName+"): ";if(!this.isInitialized()){this._log(logHead+"still initializing, ignoring event");return}if(chromeUtils.storageObjByAreaName(areaName)!=this._storageObj){this._log(logHead+"not my storage object, ignoring event");return}if(!(this._id in changes)){this._log(logHead+"not my storage key, ignoring event",changes);return}if(this._isEqual(this._dict,changes[this._id].newValue)){this._log(logHead+"the object has not changed, ignoring event",changes);return}this._log(logHead+"setting to ",changes[this._id]);this._dict=optionalWithDefault(changes[this._id].newValue,{});this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED)},_persist:function(){var items={};items[this._id]=this._dict;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED);return chromeUtils.storageSet(items,this._storageObj)},set:function(key,value){value=optionalWithDefault(value,null);let logHead="PersistentDict::set("+key+', "'+value+'"): ';this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(this._isEqual(this._dict[key],value)){this._log(logHead+"the key has not changed, ignoring call");return Promise.resolve()}this._dict[key]=this._deepClone(value);return this._persist()},get:function(key){let logHead="PersistentDict::get(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");return this._deepClone(this._dict[key])},has:function(key,ignoreCase){ignoreCase=optionalWithDefault(ignoreCase,false);let logHead="PersistentDict::has(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(!ignoreCase){return key in this._dict}let allKeys=Object.keys(this._dict);let searchKey=key.toLowerCase();let result=allKeys.findIndex(function(currKey){return currKey.toLowerCase()==searchKey});return result!=-1},rename:function(key,newKey){let logHead="PersistentDict::rename("+key+", "+newKey+"): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(!(key in this._dict)){this._log(logHead+"original key not in _dict, nothing to do");return Promise.resolve()}if(newKey in this._dict){this._err(logHead+"new key already in _dict, can't overwrite");return Promise.reject()}this._dict[newKey]=this._dict[key];delete this._dict[key];this._log(logHead+"completed",this._dict);return this._persist()},del:function(key){let logHead="PersistentDict::del(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(!(key in this._dict)){return Promise.resolve()}delete this._dict[key];return this._persist()},setAll:function(dict){let logHead="PersistentDict::setAll(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");if(this._isEqual(this._dict,dict)){this._log(logHead+"the object has not changed, ignoring call",dict,this._dict);return Promise.resolve()}this._dict=this._deepClone(dict);return this._persist()},getAll:function(){let logHead="PersistentDict::getAll(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");return this._deepClone(this._dict)},getAllKeys:function(){let logHead="PersistentSet::getAllKeys(): ";this._assert(this.isInitialized(),logHead+"still waiting for initialization");return Object.keys(this._dict)}});Classes.PersistentSet=Classes.PersistentDict.subclass({add:function(key){return this.set(key)},getAll:function(){return this.getAllKeys()}});Classes.MsgServer=Classes.Base.subclass({_cmdMap:null,_init:function(){Classes.Base._init.apply(this,arguments);this._cmdMap={}},start:function(){chrome.runtime.onMessage.addListener(this._processMsgCb.bind(this))},_printTabInfo:function(tab){if(tab){return tab.id}return"[extension]"},_processMsgInner:function(request,sender,sendResponse){if(request.cmd in this._cmdMap){return this._cmdMap[request.cmd].fn.apply(this,arguments)}else{return this.formatErrMsg("unknown command: "+request.cmd)}},_processMsgCb:function(request,sender,sendResponse){const logHead="MsgServer::_processMsgCb(from tab "+this._printTabInfo(sender.tab)+"): ";this._log(logHead+JSON.stringify(request),sender);var response=this._processMsgInner.apply(this,arguments);if(response==null){if(this._cmdMap[request.cmd].needResponse){return true}sendResponse("");return false}sendResponse(response);return false},addCmd:function(cmd,fn,needResponse){needResponse=optionalWithDefault(needResponse,true);var cmdWrapper=safeFnWrapper(fn,null,function(e){this._err('cmd "'+cmd+'" generated an exception: ',e);return this.formatErrMsg(e.message,e.toString())}.bind(this));this._cmdMap[cmd]={fn:cmdWrapper,needResponse:needResponse}},formatErrMsg:function(msg,details){var retVal={status:"error",message:msg};if(details!=null){retVal.details=details}return retVal}});Classes.MsgClient=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)},_requestInner:function(request){const logHead="MsgClient::_requestInner("+JSON.stringify(request)+"): ";this._log(logHead+"entering");return chromeUtils.wrap(chrome.runtime.sendMessage,logHead,request)},_formatRequest:function(cmd,otherOptions){return{cmd:cmd,...otherOptions}},sendRequest:function(cmd,otherOptions){const request=this._formatRequest.apply(this,arguments);return this._requestInner(request).then(function(response){this._debugResponse(cmd,response);return response}.bind(this))},sendNotification:function(cmd,otherOptions){const notification=this._formatRequest.apply(this,arguments);return this._requestInner(notification)},_debugResponse:function(cmd,response){const logHead="MsgClient::_debugResponse("+cmd+"): ";if(response.status!="success"){this._err(logHead+"response failed: "+JSON.stringify(response))}}});Classes.Error=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)}});Classes.Base.roDef(Classes.Error,"NOTRUNNING","Not running");Classes.PerfProfiler=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},mark:function(mark){performance.mark(mark)},measure:function(name,startMark,endMark){performance.measure(...arguments)},log:function(){const logHead="PerfProfiler::log(): ";this._log.raw("%c"+logHead+"type measure: %o","background-color: powderblue;",performance.getEntriesByType("measure"))},logAll:function(){const logHead="PerfProfiler::log(): ";this._log(logHead+"all types: ",performance.getEntries())}});Classes.Base.roDef(window,"perfProf",Classes.PerfProfiler.create());function tmStats(){chromeUtils.wrap(chrome.tabs.query,"tmStats(): ",{}).then(function(tabs){console.log("Total tabs count: "+tabs.length);console.table(performance.getEntriesByType("measure"),["name","duration","startTime"])})}function tmStorage(){chrome.storage.local.get(function(result){console.log(result)});chrome.storage.sync.get(function(result){console.log(result)})}function optionalWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null){return defaultValue}return value}function optArrayWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null||value.length==0){return defaultValue}return value}function emptyFn(){}function delay(delayTime){return new Promise(function(resolve){setTimeout(resolve,delayTime)})}function safeFnWrapper(fnToWrap,errMsgPrefix,errFn){return function(){try{return fnToWrap(...arguments)}catch(e){if(errMsgPrefix!=null){log.error(errMsgPrefix+e.message,e)}if(errFn!=null){return errFn(e,...arguments)}}}}function isUrl(url){try{let urlObj=new URL(url);return true}catch(e){return false}}function stackTrace(){return(new Error).stack}function asyncFn(fn){return Promise.resolve().then(fn)}Classes.ChromeUtils=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)},_wrapInner:function(verbose,chromeFn,debugCtx,...args){return new Promise(function(resolve,reject){chromeFn(...args,function(){const logHead="ChromeUtils::wrap().cb: "+(debugCtx!=null?debugCtx:"");if(chrome.runtime.lastError){if(verbose){this._err(logHead+"chrome.runtime.lastError = "+chrome.runtime.lastError.message)}reject(chrome.runtime.lastError)}else{resolve(...arguments)}}.bind(this))}.bind(this))},wrap:function(chromeFn,debugCtx,...args){return this._wrapInner(true,...arguments)},wrapQuiet:function(){return this._wrapInner(false,...arguments)},focusWindow:function(tabId){return this.wrap(chrome.tabs.get,"ChromeUtils::focusWindow(): ",tabId).then(function(tab){const logHead="ChromeUtils::focusWindow().then(): ";this._log(logHead+tab.windowId,tab);this.wrap(chrome.windows.update,logHead,tab.windowId,{focused:true})}.bind(this))},activateTab:function(tabId){let promiseA=this.wrap(chrome.tabs.update,"ChromeUtils::activateTab(): ",tabId,{active:true});let promiseB=this.focusWindow(tabId);return Promise.all([promiseA,promiseB])},loadUrl:function(url,tabId){const logHead="ChromeUtils::loadUrl(): ";tabId=optionalWithDefault(tabId,null);let promiseA=null;let promiseB=null;if(tabId!=null){if(tabId!=-1){promiseA=chromeUtils.activateTab(tabId);promiseB=this.wrap(chrome.tabs.update,logHead,tabId,{url:url})}else{return this.wrap(chrome.windows.create,logHead,{focused:true,url:url})}}else{promiseA=this.wrap(chrome.tabs.create,logHead,{url:url});promiseB=this.wrap(chrome.windows.update,logHead,chrome.windows.WINDOW_ID_CURRENT,{focused:true})}return Promise.all([promiseA,promiseB])},closeTab:function(tabId){return this.wrap(chrome.tabs.remove,"ChromeUtils::closeTab(): ",tabId)},inject:function(tabId,jsFile){const logHead="ChomeUtils::inject("+tabId+"): ";return this.wrapQuiet(chrome.tabs.executeScript,logHead,tabId,{file:jsFile}).catch(function(chromeLastError){switch(chromeLastError.message){case Classes.ChromeUtils.Error.INJECT_NOFRAME:return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_ERRORPAGE:this._log(logHead+"tab has an error (network down?)");return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_EXTGALLERY:this._log(logHead+"can't inject in the extensions gallery");return Promise.resolve(null);default:this._err(logHead+"unknown error: "+chromeLastError.message);return Promise.reject(chromeLastError)}}.bind(this))},getExtensionId:function(){const logHead="chromeUtils::getExtensionId(): ";let retVal=chrome.runtime.getURL("");this._log(logHead,retVal);retVal=retVal.replace("chrome-extension://","");retVal=retVal.replace("/","");return retVal},storageGet:function(keys,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageGet(): ";return this.wrap(storageObj.get.bind(storageObj),logHead,keys)},storageSet:function(items,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageSet(): ";return this.wrap(storageObj.set.bind(storageObj),logHead,items)},_areaNamesDict:{sync:chrome.storage.sync,local:chrome.storage.local,managed:chrome.storage.managed},storageObjByAreaName:function(areaName){const logHead="ChromeUtils.storageObjByAreaName("+areaName+"): ";let retVal=this._areaNamesDict[areaName];this._assert(retVal!=null,logHead+"assertion failed");return retVal}});Classes.Base.roDef(Classes.ChromeUtils,"Error",{});Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_COMMUNICATION","Error when communicating with the native messaging host.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_EXITED","Native host has exited.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_NOTFOUND","Specified native messaging host not found.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_NOFRAME","The frame was removed.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_ERRORPAGE",'Cannot access contents of url "chrome-error://chromewebdata/". Extension manifest must request permission to access this host.');Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_EXTGALLERY","The extensions gallery cannot be scripted.");Classes.Base.roDef(window,"chromeUtils",Classes.ChromeUtils.create());chromeUtils.debug();Classes.Base.roDef(window,"ExtCommands",{});Classes.Base.roDef(window.ExtCommands,"BACK","00back");Classes.Base.roDef(window.ExtCommands,"FWD","01fwd");Classes.Base.roDef(window.ExtCommands,"LAUNCHORSEARCH","02los");Classes.Base.roDef(window.ExtCommands,"CLOSEBACK","03closeback");Classes.Base.roDef(window.ExtCommands,"CLOSEFWD","04closefwd");Classes.Base.roDef(window.ExtCommands,"SHORTCUT01","90shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT02","91shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT03","92shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT04","93shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT05","94shortcut");Classes.NormalizedTabs=Classes.Base.subclass({_tabs:null,_init:function(tabs){Classes.Base._init.call(this);this._tabs=optionalWithDefault(tabs,[]);this.debug();this.normalizeAll()},compareTitlesFn:function(a,b){return a.tm.normTitle.localeCompare(b.tm.normTitle)},compareTabsFn:function(a,b){if(a.pinned&&!b.pinned){return-1}if(b.pinned&&!a.pinned){return 1}return Classes.NormalizedTabs.compareTitlesFn(a,b)},comparePositionFn:function(a,b){if(a.windowId<b.windowId){return-1}if(a.windowId>b.windowId){return 1}if(a.index<b.index){return-1}if(a.index>b.index){return 1}return 0},getProtocolHostname:function(url){try{var urlObj=new URL(url);return[urlObj.protocol,urlObj.hostname]}catch(e){return[null,null]}},normalizeLowerCaseTitle:function(lowerCaseTitle){if(lowerCaseTitle.startsWith("www.")){return lowerCaseTitle.substring(4)}return lowerCaseTitle},formatExtendedId:function(tab){return tab.windowId+":"+tab.id+"/"+tab.index},_addNormalizedShortcutBadges:function(tab,secondary){let sm=settingsStore.getShortcutsManager();let scKeys=sm.getShortcutKeysForTab(tab,!secondary);let array=tab.tm.primaryShortcutBadges;if(secondary){array=tab.tm.secondaryShortcutBadges}scKeys.forEach(function(key){let keyAsString=sm.keyToUiString(key);array.push(keyAsString);tab.tm.searchBadges.push(keyAsString.toLowerCase())}.bind(this))},updateShortcutBadges:function(tab){this._addNormalizedShortcutBadges(tab,false);this._addNormalizedShortcutBadges(tab,true)},_addNormalizedVisualBadge:function(tab,badge,visible){visible=optionalWithDefault(visible,true);if(visible){tab.tm.visualBadges.push(badge)}tab.tm.searchBadges.push(badge.toLowerCase())},updateSearchBadges:function(tab){if(tab.active){this._addNormalizedVisualBadge(tab,"active")}if(tab.audible){this._addNormalizedVisualBadge(tab,"audible",false)}if(tab.discarded){this._addNormalizedVisualBadge(tab,"discarded",false)}if(tab.highlighted){this._addNormalizedVisualBadge(tab,"highlighted",false)}if(tab.incognito){this._addNormalizedVisualBadge(tab,"incognito",false)}if(tab.mutedInfo.muted){this._addNormalizedVisualBadge(tab,"muted",false)}if(tab.status!=null){switch(tab.status){case"unloaded":this._addNormalizedVisualBadge(tab,tab.status,false);break;case"complete":this._addNormalizedVisualBadge(tab,"loaded",false);break;default:this._addNormalizedVisualBadge(tab,tab.status);break}}if(tab.pinned){this._addNormalizedVisualBadge(tab,"pinned",false)}if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false)}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},normalizeTab:function(tab){let url=optionalWithDefault(tab.url!=""?tab.url:tab.pendingUrl,"");let lowerCaseTitle=tab.title.toLowerCase();let[protocol,hostname]=Classes.NormalizedTabs.getProtocolHostname(url);tab.tm={protocol:protocol,hostname:hostname,customGroupName:settingsStore.getCustomGroupsManager().getCustomGroupByHostname(hostname),lowerCaseUrl:url.toLowerCase(),lowerCaseTitle:lowerCaseTitle,normTitle:Classes.NormalizedTabs.normalizeLowerCaseTitle(lowerCaseTitle),extId:Classes.NormalizedTabs.formatExtendedId(tab),visualBadges:[],searchBadges:[],primaryShortcutBadges:[],secondaryShortcutBadges:[]};this.updateShortcutBadges(tab);this.updateSearchBadges(tab)},normalizeAll:function(){perfProf.mark("normalizeStart");this._tabs.forEach(this.normalizeTab.bind(this));perfProf.mark("normalizeEnd");perfProf.measure("Normalize","normalizeStart","normalizeEnd")},getTabs:function(){return this._tabs},getTabIndexByTabId:function(searchTabId){return this._tabs.findIndex(function(tab){if(tab.id==searchTabId){return true}return false}.bind(this))},getTabByTabId:function(searchTabId){let tabIdx=this.getTabIndexByTabId(searchTabId);if(tabIdx==-1){return null}return this._tabs[tabIdx]},getTabByTabIndex:function(tabIdx){if(tabIdx==null||tabIdx<0||tabIdx>this._tabs.length){return null}return this._tabs[tabIdx]},updateTab:function(newTab,tabIdx){this.normalizeTab(newTab);tabIdx=optionalWithDefault(tabIdx,this.getTabIndexByTabId(newTab.id));if(tabIdx==-1){this._tabs.push(newTab)}else{this._tabs[tabIdx]=newTab}}});Classes.CustomGroupsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_customGroupsStore:null,_parsedCustomGroups:null,_eventManager:null,_regexEscapePatternObj:/[-\/\\^$*+?.()|[\]{}]/g,_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit()];this._customGroupsStore=Classes.PersistentDict.createAs(this._storageKeyPrefix+"customGroups",chrome.storage.sync);promiseArray.push(this._customGroupsStore.getInitPromise());this._customGroupsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(this._buildCustomGroups.bind(this))},_onUpdatedCb:function(ev){let key=ev.detail.target.getId();const logHead="CustomGroupsManager::_onUpdatedCb("+key+"): ";this._log(logHead+"processing update");this._buildCustomGroups();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_regexEscape:function(simpleRegEx){return simpleRegEx.replace(this._regexEscapePatternObj,"\\$&")},_parseRegex:function(matchList){const logHead="CustomGroupsManager::_parseRegex("+matchList+"): ";if(matchList==null){return null}let list=matchList.split("\n");let trimmedList=[];list.forEach(function(regex){let trimmedRegex=regex.trim();if(trimmedRegex!=""){trimmedList.push("("+this._regexEscape(trimmedRegex)+")")}}.bind(this));let fullExpr=trimmedList.join("|");this._log(logHead+"after split: ",fullExpr);try{return new RegExp(fullExpr)}catch(e){this._err(logHead+"unable to parse regex",e);return null}},_buildCustomGroups:function(){const logHead="CustomGroupsManager::_buildCustomGroups(): ";this._parsedCustomGroups={};let groupTitles=this.getCustomGroupNames();groupTitles.forEach(function(title){this._parsedCustomGroups[title]=this.getCustomGroup(title);this._log(logHead+'processing group "'+title+'": ',this._parsedCustomGroups[title]);this._parsedCustomGroups[title].parsedRegex=this._parseRegex(this._parsedCustomGroups[title].matchList)}.bind(this))},getCustomGroupByHostname:function(hostname){let titles=this.getCustomGroupNames();for(let i=0;i<titles.length;i++){if(this._parsedCustomGroups[titles[i]].parsedRegex!=null&&this._parsedCustomGroups[titles[i]].parsedRegex.test(hostname)){return titles[i]}}return null},hasCustomGroup:function(name,ignoreCase){return this._customGroupsStore.has(name,ignoreCase)},getCustomGroupNames:function(){return this._customGroupsStore.getAllKeys()},getCustomGroup:function(name){return this._customGroupsStore.get(name)},setCustomGroup:function(name,obj){return this._customGroupsStore.set(name,obj)},renameCustomGroup:function(name,newName){return this._customGroupsStore.rename(name,newName)},delCustomGroup:function(name){return this._customGroupsStore.del(name)},getCustomGroupProp:function(name,prop){if(!this._customGroupsStore.has(name)){return null}return this._customGroupsStore.get(name)[prop]},setCustomGroupProp:function(name,prop,value){const logHead="CustomGroupsManager::setCustomGroupProp("+name+", "+prop+"): ";if(!this._customGroupsStore.has(name)){this._err(logHead+"custom group not found");return Promise.reject()}this._log(logHead+"setting value: ",value);let groupInfo=this.getCustomGroup(name);groupInfo[prop]=value;return this.setCustomGroup(name,groupInfo)},_colorToCalloutCss:{none:"tm-callout-none",grey:"tm-callout-grey",blue:"tm-callout-blue",red:"tm-callout-red",yellow:"tm-callout-yellow",green:"tm-callout-green",cyan:"tm-callout-cyan"},getCustomGroupCssByColor:function(color){return this._colorToCalloutCss[color]},getCustomGroupCss:function(groupName){let color=optionalWithDefault(this.getCustomGroupProp(groupName,"color"),"none");return this.getCustomGroupCssByColor(color)}});Classes.ShortcutsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_shortcutsStore:null,_tabs:null,_eventManager:null,_shortcutsInfo:null,_shortcutKeys:[window.ExtCommands.SHORTCUT01,window.ExtCommands.SHORTCUT02,window.ExtCommands.SHORTCUT03,window.ExtCommands.SHORTCUT04,window.ExtCommands.SHORTCUT05],_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this._shortcutsStore=null;this._shortcutsInfo=null;this._tabs=[];this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit()];this._shortcutsStore={};for(let i=0;i<this._shortcutKeys.length;i++){let persDict=this._shortcutsStore[this._shortcutKeys[i]]=Classes.PersistentDict.createAs(this._storageKeyPrefix+"shortcut0"+(i+1),chrome.storage.sync);promiseArray.push(persDict.getInitPromise());persDict.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this,this._shortcutKeys[i]))}return Promise.all(promiseArray).then(this._computeShortcutsInfo.bind(this))},_onUpdatedCb:function(key,ev){this._computeInfo(key);this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_propertySearch:function(key,value){let retVal=this._tabs.reduce(function(res,tab){if(tab.tm[key]==value){res.push(tab)}return res},[]);return retVal.sort(Classes.NormalizedTabs.comparePositionFn)},_computeByHostname:function(hostname){const logHead="ShortcutsManager::_computeByHostname("+hostname+"): ";let tabs=this._propertySearch("hostname",hostname);if(tabs.length==0){this._log(logHead+"setting as URL");return{url:"https://"+hostname}}return{tab:tabs[0]}},_computeByUrlNoSearch:function(sc,forceNewTab){if(forceNewTab){return{url:sc.get("url")}}let tabs=this._propertySearch("lowerCaseUrl",sc.get("url").toLowerCase());if(tabs.length==0){return{url:sc.get("url")}}return{tab:tabs[0]}},_computeByUrl:function(sc){let forceNewTab=optionalWithDefault(sc.get("alwaysNewTab"),false);let useClipboard=optionalWithDefault(sc.get("useClipboard"),false);if(!useClipboard){return this._computeByUrlNoSearch(sc,forceNewTab)}if(!sc.get("url").includes("%s")){return this._computeByUrlNoSearch(sc,forceNewTab)}if(forceNewTab){return{searchUrl:sc.get("url")}}let retVal={searchUrl:sc.get("url")};let[protocol,hostname]=Classes.NormalizedTabs.getProtocolHostname(retVal.searchUrl);let tabs=this._propertySearch("hostname",hostname);if(tabs.length!=0){retVal.candidateTabs=tabs}return retVal},_computeInfo:function(shortcutKey){let sc=this._shortcutsStore[shortcutKey];if(sc.get("hostname")!=null){this._shortcutsInfo[shortcutKey]=this._computeByHostname(sc.get("hostname"));return}if(sc.get("url")==null){this._shortcutsInfo[shortcutKey]={};return}this._shortcutsInfo[shortcutKey]=this._computeByUrl(sc)},_computeShortcutsInfo:function(){this._shortcutsInfo={};this._shortcutKeys.forEach(this._computeInfo.bind(this))},updateTabs:function(tabs){this._assert(this.isInitialized());this._tabs=optionalWithDefault(tabs,[]);this._computeShortcutsInfo()},_isTabInCandidateTabs:function(tabId,candidateTabs,firstCandidate){if(candidateTabs==null){return false}if(firstCandidate){return candidateTabs[0].id==tabId}let idx=candidateTabs.findIndex(function(elem,index){if(index==0){return false}if(elem.id==tabId){return true}return false});return idx!=-1},getShortcutKeys:function(){return this._shortcutKeys},getShortcutKeysForTab:function(tab,firstCandidate){firstCandidate=optionalWithDefault(firstCandidate,true);let retVal=[];this._shortcutKeys.forEach(function(key){if(this._shortcutsInfo[key].tab!=null&&this._shortcutsInfo[key].tab.id==tab.id&&firstCandidate){retVal.push(key)}if(this._isTabInCandidateTabs(tab.id,this._shortcutsInfo[key].candidateTabs,firstCandidate)){retVal.push(key)}}.bind(this));return retVal},getShortcutInfo:function(shortcutKey){const logHead="ShortcutsManager::getShortcutInfo("+shortcutKey+"): ";this._log(logHead+"entering ",this._shortcutsInfo);return this._shortcutsInfo[shortcutKey]},setShortcut:function(shortcutKey,shortcutStoreDict){return this._shortcutsStore[shortcutKey].setAll(shortcutStoreDict)},setShortcutProp:function(shortcutKey,prop,value){return this._shortcutsStore[shortcutKey].set(prop,value)},delShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].del(prop)},getShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].get(prop)},setShortcutHostnameOrUrl:function(shortcutKey,value){const logHead="ShortcutsManager::setShortcutHostnameOrUrl("+shortcutKey+', "'+value+'"): ';let currDict=this._shortcutsStore[shortcutKey].getAll();let toSet="hostname";let toDel="url";if(isUrl(value)){toSet="url";toDel="hostname";this._log(logHead+"setting as URL")}else{this._log(logHead+"setting as hostname")}currDict[toSet]=value;delete currDict[toDel];return this.setShortcut(shortcutKey,currDict)},getShortcutHostnameOrUrl:function(shortcutKey){let hostname=this.getShortcutProp(shortcutKey,"hostname");if(hostname==null||hostname==""){return this.getShortcutProp(shortcutKey,"url")}return hostname},isShortcutKey:function(key){return this._shortcutKeys.includes(key)},keyToUiString:function(shortcutKey){let idx=this._shortcutKeys.indexOf(shortcutKey);if(idx==-1){return"SC-err"}return"SC"+(idx+1)}});Classes.SettingsStore=Classes.AsyncBase.subclass({_storageKeyPrefix:"",_options:null,_customGroups:null,_pinnedGroups:null,_shortcutsManager:null,_eventManager:null,_init:function(storageKeyPrefix){this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit()];this._options=Classes.PersistentDict.createAs(this._storageKeyPrefix+"options",chrome.storage.sync);promiseArray.push(this._options.getInitPromise());this._options.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._customGroupsManager=Classes.CustomGroupsManager.create(this._storageKeyPrefix);promiseArray.push(this._customGroupsManager.getInitPromise());this._customGroupsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._pinnedGroups=Classes.PersistentSet.createAs(this._storageKeyPrefix+"pinnedGroups",chrome.storage.sync);promiseArray.push(this._pinnedGroups.getInitPromise());this._pinnedGroups.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._shortcutsManager=Classes.ShortcutsManager.create(this._storageKeyPrefix);promiseArray.push(this._shortcutsManager.getInitPromise());this._shortcutsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(function(){perfProf.mark("settingsLoaded")})},_onUpdatedCb:function(ev){let key=ev.detail.key;if(key==null){key=ev.detail.target.getId()}this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},getAllOptions:function(){this._assert(this.isInitialized());return this._options},_getOption:function(prop){this._assert(this.isInitialized());return this._options.get(prop)},_getBooleanOption:function(prop){let retVal=this._getOption(prop);if(retVal==null){return false}return retVal},_setOption:function(prop,value){this._assert(this.isInitialized());return this._options.set(prop,value)},getOptionShowTabId:function(){return this._getBooleanOption("showTabId")},setOptionShowTabId:function(value){return this._setOption("showTabId",value)},getOptionAdvancedMenu:function(){return this._getBooleanOption("advancedMenu")},setOptionAdvancedMenu:function(value){return this._setOption("advancedMenu",value)},getOptionSearchUrl:function(){return this._getOption("searchUrl")},setOptionSearchUrl:function(value){return this._setOption("searchUrl",value)},getPinnedGroups:function(){this._assert(this.isInitialized());return this._pinnedGroups},isGroupPinned:function(groupName){return this._pinnedGroups.has(groupName)},pinGroup:function(groupName){return this._pinnedGroups.add(groupName)},unpinGroup:function(groupName){return this._pinnedGroups.del(groupName)},getCustomGroupsManager:function(){this._assert(this.isInitialized());return this._customGroupsManager},getShortcutsManager:function(){this._assert(this.isInitialized());return this._shortcutsManager}});perfProf.mark("settingsStarted");Classes.Base.roDef(window,"settingsStore",Classes.SettingsStore.create());settingsStore.debug();Classes.ScheduledJob=Classes.Base.subclass({_handle:null,_recurInterval:null,_init:function(jobFn){Classes.Base._init.call(this);if(jobFn!=null){this._jobFn=jobFn}else{this._jobFn=this._job}},run:function(delay){const logHead="ScheduledJob::run(delay = "+delay+", now = "+Date.now()+"): ";if(delay==null||delay==0){this.skip();this._jobFn();return}if(this._handle!=null){this._log(logHead+"already scheduled, handleId = "+this._handle);return}this._handle=setTimeout(function(){this._jobFn();this._handle=null}.bind(this),delay)},start:function(interval,runOnceNow){runOnceNow=optionalWithDefault(runOnceNow,true);const logHead="ScheduledJob::start("+interval+"): ";if(this._handle!=null){this._err(logHead+"already scheduled, handleId = "+this._handle);return}this._log(logHead+"starting");if(runOnceNow){this._jobFn()}this._recurInterval=interval;this._handle=this._safeSetInterval(this._jobFn.bind(this),interval)},stop:function(){const logHead="ScheduledJob::stop(): ";if(this._handle==null){this._log(logHead+"not scheduled");return}if(this._recurInterval==null){clearInterval(this._handle);this._recurInterval=null}else{clearTimeout(this._handle)}this._handle=null},skip:function(){const logHead="ScheduledJob::skip(): ";if(this._handle==null){this._log(logHead+"not scheduled");return}let savedRecurInterval=this._recurInterval;this.stop();if(savedRecurInterval!=null){this.start(savedRecurInterval,false)}},isRunning:function(){return this._handle!=null},_job:function(){this._errorMustSubclass("ScheduledJob::_job()")},_safeSetInterval:function(fn,interval){const logHead="ScheduledJob::_safeSetInterval(): ";if(typeof interval!=="number"){this._err(logHead+"interval is not a number ("+interval+"), bypassing setInterval() to avoid trouble");return}if(interval<1e3){this._err(logHead+"interval is too small ("+interval+"), bypassing setInterval() to avoid trouble");return}return setInterval(fn,interval)}});Classes.PopupClient=Classes.MsgClient.subclass({_init:function(){Classes.MsgClient._init.apply(this,arguments)}});Classes.TabsManager=Classes.Base.subclass({_backTabs:null,_fwdTabs:null,_popupClient:null,_activeTabId:null,_isActiveWindowIdNone:null,_tabsCount:null,_normTabs:null,_updateScAllTabsJob:null,_updateScAllTabsDelay:1e3,_windowFocusLossPoller:null,_windowFocusLossInterval:1e3,_tabsCountAssertPoller:null,_init:function(){Classes.Base._init.apply(this,arguments);this._popupClient=Classes.PopupClient.create();this._popupClient.debug();this._backTabs=Classes.BoundArray.create(1e3);this._fwdTabs=Classes.BoundArray.create(1e3);this._isActiveWindowIdNone=false;this._updateScAllTabsJob=Classes.ScheduledJob.create(this._updateShortcutsAllTabs.bind(this));this._updateScAllTabsJob.debug();this._updateScAllTabsJob.run();this._windowFocusLossPoller=Classes.ScheduledJob.create(this._windowFocusLossCb.bind(this));this._windowFocusLossPoller.debug();this._setActiveTabId().then(function(activeTabId){const logHead="TabsManager::_init().then(): ";this._log(logHead+"entering");this._addAllListeners();this._windowFocusLossPoller.start(this._windowFocusLossInterval)}.bind(this));this._setTabsCount().then(function(){this._tabsCountAssertPoller=Classes.ScheduledJob.create(this._tabsCountAssertCb.bind(this));this._tabsCountAssertPoller.start(30*1e3)}.bind(this))},_addAllListeners:function(){chrome.tabs.onCreated.addListener(this._onTabCreatedCb.bind(this));chrome.tabs.onUpdated.addListener(this._onTabUpdatedCb.bind(this));chrome.tabs.onActivated.addListener(this._onTabActivatedCb.bind(this));https:chrome.tabs.onRemoved.addListener(this._onTabRemovedCb.bind(this));chrome.tabs.onAttached.addListener(this._onTabAttachedCb.bind(this));chrome.tabs.onMoved.addListener(this._onTabMovedCb.bind(this));chrome.windows.onFocusChanged.addListener(this._onWindowFocusChangeCb.bind(this));chrome.commands.onCommand.addListener(this._onCommandCb.bind(this));settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._settingStoreUpdatedCb.bind(this))},_tabsCountAssertCb:function(){this._queryTabs().then(function(tabs){logHead="TabsManager::_tabsCountAssertCb().cb: ";let tabsCount=tabs.length;if(tabsCount!=this._tabsCount){this._err(logHead+"found discrepancy: "+tabsCount+" "+this._tabsCount);this._tabsCount=tabsCount;this._setPopupBadge(tabsCount)}}.bind(this))},_queryTabs:function(){return chromeUtils.wrap(chrome.tabs.query,"TabsManager::_queryTabs(): ",{})},_updateShortcutsAllTabs:function(){const logHead="TabsManager::_updateShortcutsAllTabs(): ";return this._queryTabs().then(function(tabs){this._log(logHead+"query completed, updating shortcuts");this._normTabs=Classes.NormalizedTabs.create(tabs);settingsStore.getShortcutsManager().updateTabs(this._normTabs.getTabs())}.bind(this))},_updateShortcutsOneTab:function(tab){const logHead="TabsManager::_updateShortcutsOneTab("+tab.id+"): ";this._log(logHead+"updating shortcuts with ",tab);this._normTabs.updateTab(tab);settingsStore.getShortcutsManager().updateTabs(this._normTabs.getTabs())},_setTabsCount:function(){return this._queryTabs().then(function(tabs){let tabsCount=tabs.length;this._tabsCount=tabsCount;this._setPopupBadge(tabsCount);return tabsCount}.bind(this))},_incrementTabsCount:function(){this._setPopupBadge(++this._tabsCount)},_decrementTabsCount:function(){this._tabsCount--;if(this._tabsCount<0){this._tabsCount=0}this._setPopupBadge(this._tabsCount)},_setPopupBadge:function(tabsCount){const logHead="TabsManager::_setPopupBadge("+tabsCount+"): ";this._log(logHead+"entering");if(tabsCount>999){tabsCount="999+"}return chromeUtils.wrap(chrome.browserAction.setBadgeText,logHead,{text:tabsCount.toString()})},_windowFocusLossCb:function(){const logHead="TabsManager::_windowFocusLossCb(): ";chromeUtils.wrap(chrome.windows.getCurrent,logHead,null).then(function(window){if(this._isActiveWindowIdNone&&window.focused){this._log(logHead+"focus restored, simulate focus change event: ",window);this._onWindowFocusChangeCb(window.id);return}if(!this._isActiveWindowIdNone&&!window.focused){this._log(logHead+"lost focus, simulate focus change event: ",window);this._onWindowFocusChangeCb(chrome.windows.WINDOW_ID_NONE);return}}.bind(this))},_onTabCreatedCb:function(tab){const logHead="TabsManager::_onTabCreatedCb(tabId: "+tab.id+", time: "+Date.now()+"): ";this._log(logHead+"tab: ",tab);this._updateShortcutsOneTab(tab);this._incrementTabsCount()},_onTabRemovedCb:function(tabId,removeInfo){const logHead="TabsManager::_onTabRemovedCb(tabId: "+tabId+", time: "+Date.now()+"): ";this._log(logHead+"removeInfo: ",removeInfo);this._updateScAllTabsJob.run(this._updateScAllTabsDelay);this._decrementTabsCount();if(this._activeTabId==tabId){this._activeTabId=null}this._printBackTabs();this._backTabs.removeValue(tabId);this._printBackTabs();this._fwdTabs.removeValue(tabId)},_onTabUpdatedCb:function(tabId,changeInfo,tab){const logHead="TabsManager::_onTabUpdatedCb(tabId: "+tabId+", time: "+Date.now()+"): ";this._log(logHead+"changeInfo: ",changeInfo);if(tab.pendingUrl!=null&&tab.url!=tab.pendingUrl){this._log(logHead+"URL changing from "+tab.url+" to "+tab.pendingUrl)}this._updateShortcutsOneTab(tab)},_onTabAttachedCb:function(tabId,attachInfo){const logHead="TabsManager::onTabAttachedCb(tabId "+tabId+", time: "+Date.now()+"): ";this._log(logHead+"attachInfo: ",attachInfo);this._updateScAllTabsJob.run(this._updateScAllTabsDelay)},_onTabMovedCb:function(tabId,moveInfo){const logHead="TabsManager::onTabMovedCb(tabId "+tabId+", time: "+Date.now()+"): ";this._log(logHead+"moveInfo: ",moveInfo);this._updateScAllTabsJob.run(this._updateScAllTabsDelay)},_settingStoreUpdatedCb:function(ev){const logHead="TabsManager::_settingStoreUpdatedCb("+ev.detail.key+"): ";this._log(logHead+"entering")},_cleanUpStacks:function(tabId){while(this._backTabs.peek()==tabId){this._backTabs.pop()}while(this._fwdTabs.peek()==tabId){this._fwdTabs.pop()}},_onTabActivatedCb:function(activeInfo){const logHead="TabsManager::_onTabActivatedCb(time: "+Date.now()+"): ";this._log(logHead+"activeInfo: ",activeInfo);this._printBackTabs();if(this._activeTabId!=null){this._backTabs.push(this._activeTabId)}this._activeTabId=activeInfo.tabId;this._cleanUpStacks(activeInfo.tabId);this._isActiveWindowIdNone=false;this._printBackTabs();this._notifyPopup()},_onWindowFocusChangeCb:function(windowId){const logHead="TabsManager::_onWindowFocusChangeCb(): ";this._log(logHead+"windowId: "+windowId);if(windowId==chrome.windows.WINDOW_ID_NONE){if(this._isActiveWindowIdNone){this._log(logHead+"duplicated event")}else{this._log(logHead+"all Chrome windows have lost focus");this._isActiveWindowIdNone=true}return}this._isActiveWindowIdNone=false;this._printBackTabs();this._setActiveTabId().then(function(oldActiveTabId,newActiveTabId){const logHead="TabsManager::_onWindowFocusChangeCb().then("+oldActiveTabId+", "+newActiveTabId+"): ";this._log(logHead+"entering");if(oldActiveTabId!=null&&oldActiveTabId!=newActiveTabId){this._backTabs.push(oldActiveTabId);this._notifyPopup()}this._cleanUpStacks(newActiveTabId);this._printBackTabs()}.bind(this,this._activeTabId))},_getChromeActiveTab:function(){return chromeUtils.wrap(chrome.tabs.query,"TabsManager::_getChromeActiveTab(): ",{active:true,currentWindow:true})},_setActiveTabId:function(){return this._getChromeActiveTab().then(function(tabs){const logHead="TabsManager::_setActiveTabId().cb: ";if(tabs.length==0){this._log(logHead+"info not available");this._activeTabId=null}else{this._log(logHead+"setting this._activeTabId to "+tabs[0].id,tabs[0]);this._activeTabId=tabs[0].id}return this._activeTabId}.bind(this))},_printBackTabs:function(){const logHead="TabsManager::_printBackTabs(): ";this._log(logHead+JSON.stringify(this._backTabs.get()))},_closeOldActiveTab:function(oldActiveTabId){const logHead="TabsManager::_closeOldActiveTab("+oldActiveTabId+"): ";this._log(logHead+"closing tab ID");if(this._activeTabId==oldActiveTabId){this._log(logHead+"previous and current tab ID are the same")}chromeUtils.closeTab(oldActiveTabId)},_notifyPopup:function(){},_goBack:function(closeCurrentTab){closeCurrentTab=optionalWithDefault(closeCurrentTab,false);const logHead="TabsManager::_goBack("+closeCurrentTab+"): ";this._printBackTabs();if(this._isActiveWindowIdNone){this._log(logHead+"special case: back from chrome.windows.WINDOW_ID_NONE");this._isActiveWindowIdNone=false;chromeUtils.activateTab(this._activeTabId);return}const oldActiveTabId=this._activeTabId;const nextTabId=this._backTabs.pop();if(nextTabId!=null){if(this._activeTabId!=null){this._fwdTabs.push(this._activeTabId);this._activeTabId=null}this._log(logHead+"switching back to tab "+nextTabId);chromeUtils.activateTab(nextTabId)}else{this._log(logHead+"no previous tabs to go back to")}if(closeCurrentTab&&oldActiveTabId!=null){this._closeOldActiveTab(oldActiveTabId)}this._printBackTabs()},_goFwd:function(closeCurrentTab){closeCurrentTab=optionalWithDefault(closeCurrentTab,false);const logHead="TabsManager::_goFwd("+closeCurrentTab+"): ";const oldActiveTabId=this._activeTabId;const nextTabId=this._fwdTabs.pop();if(nextTabId!=null){this._log(logHead+"switching forward to tab "+nextTabId);chromeUtils.activateTab(nextTabId);if(closeCurrentTab&&oldActiveTabId!=null){this._closeOldActiveTab(oldActiveTabId)}}else{this._log(logHead+"no forward tabs to go back to")}},_getClipboardAsText:function(){const logHead="TabsManager::_getClipboardAsText(): ";const textAreaId="clipboard";const textAreaHtml=`
		<textarea id="${textAreaId}" name="clipboard"></textarea>
	`;let backgroundPage=chrome.extension.getBackgroundPage();if(backgroundPage==null){this._err(logHead+"unable to load DOM from background page");return null}backgroundPage.document.body.innerHTML=textAreaHtml;let textAreaElem=backgroundPage.document.getElementById(textAreaId);if(textAreaElem==null){this._err(logHead+"unable to get textarea element");return null}textAreaElem.focus();if(!backgroundPage.document.execCommand("paste")){this._err(logHead+"paste command not supported");return null}let retVal=textAreaElem.value;backgroundPage.document.body.textContent="";return retVal},_launchOrSearch:function(url){const logHead="TabsManager::_launchOrSearch(): ";if(url==null){return}let searchUrl=optionalWithDefault(settingsStore.getOptionSearchUrl(),"https://www.google.com/search?q=%s");if(!isUrl(url)){this._log(logHead+"the clipboard doesn't contain a URL, opening a search page instead: "+url);url=searchUrl.replace("%s",url)}chromeUtils.wrap(chrome.tabs.create,logHead,{active:true,url:url}).then(function(tab){chromeUtils.focusWindow(tab.id)}.bind(this))},_runCustomShortcutSearch:function(scInfo){const logHead="TabsManager::_runCustomShortcutSearch(): ";let text=this._getClipboardAsText();let url=scInfo.searchUrl.replace("%s",text);this._log(logHead+"converted searchUrl to: "+url,scInfo);if(scInfo.candidateTabs==null){this._log(logHead+"no candidateTabs, opening in new tab");chromeUtils.loadUrl(url);return}let lowerCaseUrl=url.toLowerCase();let tabIdx=scInfo.candidateTabs.findIndex(function(elem){if(elem.tm.lowerCaseUrl==lowerCaseUrl){return true}return false}.bind(this));tabIdx=tabIdx!=-1?tabIdx:0;this._log(logHead+"opening in candidateTabs["+tabIdx+"]",scInfo.candidateTabs[tabIdx]);chromeUtils.loadUrl(url,scInfo.candidateTabs[tabIdx].id)},_manageCustomShortcut:function(shortcut){const logHead="TabsManager::_manageCustomShortcut("+shortcut+"): ";this._log(logHead+"entering");let scInfo=settingsStore.getShortcutsManager().getShortcutInfo(shortcut);if(scInfo==null){this._err(logHead+"unknown shortcut key");return}let tabId=scInfo.tab!=null?scInfo.tab.id:null;if(scInfo.url!=null){this._log(logHead+"loading URL "+scInfo.url);chromeUtils.loadUrl(scInfo.url,tabId);return}if(tabId!=null){this._log(logHead+"opening tabId "+tabId+", no URL change");chromeUtils.activateTab(tabId);return}this._log(logHead+"tabId = "+tabId+", search case: ",scInfo);this._runCustomShortcutSearch(scInfo)},_onCommandCb:function(cmd){const logHead="TabsManager::_onCommandCb("+cmd+"): ";this._log(logHead+"entering");switch(cmd){case window.ExtCommands.BACK:this._goBack();break;case window.ExtCommands.FWD:this._goFwd();break;case window.ExtCommands.CLOSEBACK:this._goBack(true);break;case window.ExtCommands.CLOSEFWD:this._goFwd(true);break;case window.ExtCommands.LAUNCHORSEARCH:let url=this._getClipboardAsText();this._launchOrSearch(url);break;case window.ExtCommands.SHORTCUT01:case window.ExtCommands.SHORTCUT02:case window.ExtCommands.SHORTCUT03:case window.ExtCommands.SHORTCUT04:this._manageCustomShortcut(cmd);break;default:this._err(logHead+"unknown command");break}}});Classes.InBrowserMsgServer=Classes.MsgServer.subclass({_init:function(){Classes.MsgServer._init.apply(this,arguments);this.addCmd("testNative",this._cmdTestNative.bind(this))},_cmdTestNative:function(request,sender,sendResponse){chrome.runtime.sendNativeMessage(nativeExtensionId,request,function(sendLocalResponse,response){this._log("MsgServer::_cmdTestNative().cb(): received from native "+JSON.stringify(response));sendLocalResponse(response)}.bind(this,sendResponse));return null}});Classes.NmhServer=Classes.MsgServer.subclass({_nativePort:null,_init:function(){Classes.MsgServer._init.apply(this,arguments);this.roDef(this,"_nmhExtensionId",this._id)},start:function(){this._nativePort=chrome.runtime.connectNative(this._nmhExtensionId);this._nativePort.onDisconnect.addListener(this._onDisconnectCb.bind(this));this._nativePort.onMessage.addListener(this._processMsgCb.bind(this))},_onDisconnectCb:function(){const logHead="NmhServer::_onDisconnectCb(): ";if(chrome.runtime.lastError){this._err(logHead+"disconnected due to: "+chrome.runtime.lastError.message)}else{this._log(logHead+"disconnected")}},_processMsgCb:function(request){const logHead="NmhServer::_processMsgCb(args count = "+arguments.length+"): ";this._log(logHead+JSON.stringify(request));var response=this._processMsgInner(request);this._nativePort.postMessage(response)}});Classes.NmhClient=Classes.MsgClient.subclass({_init:function(){Classes.MsgClient._init.apply(this,arguments);this.roDef(this,"_nmhExtensionId",this._id)},_requestInner:function(request){const logHead="NmhClient::_requestInner(): ";return chromeUtils.wrap(chrome.runtime.sendNativeMessage,logHead,this._nmhExtensionId,request)},isNmhInstalled:function(){return this.sendRequest("poll").then(function(){return true},function(chromeLastError){const logHead="NmhClient::isNmhInstalled().onRejected(): ";if(chromeLastError.message==chromeUtils.Error.NMH_NOTFOUND){this._log(logHead+chromeLastError.message);return Promise.resolve(false)}this._err(logHead+chromeLastError.message);return Promise.resolve(true)}.bind(this))}});chrome.runtime.onInstalled.addListener(function(){if(!isProd()){console.log("onInstalled.addListener() called")}});if(!isProd()){window.addEventListener("error",function(e){console.log("Unhandled exception: "+e.error.message);return false})}window.addEventListener("load",init);var inBrowserMsgServer=null;var tabsManager=null;var bgInitPromiseResolveFn=null;var backgroundInitPromise=new Promise(function(resolve,reject){bgInitPromiseResolveFn=resolve});function openUrlCb(request,sender,sendResponse){chromeUtils.loadUrl(request.url,-1).then(function(){sendResponse({status:"success"})});return null}function init(){settingsStore.getInitPromise().then(function(){inBrowserMsgServer=Classes.InBrowserMsgServer.createAs("inBrowserMsgServer");inBrowserMsgServer.start();inBrowserMsgServer.debug();inBrowserMsgServer.addCmd("launchUrl",openUrlCb);tabsManager=Classes.TabsManager.createAs("tabsManager");tabsManager.debug();bgInitPromiseResolveFn()})}