// AUTO-GENERATED FILE, do not edit, use 'npm run dist' to build
// Copyright and licensing information at https://github.com/marcodb26/TabMania/blob/main/LICENSE

function setProd(flag){Object.defineProperty(window,"productionCode",{value:flag,configurable:false,enumerable:false,writable:false})}setProd(true);function isProd(){return window.productionCode??false}function optionalWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null){return defaultValue}return value}function emptyFn(){}Classes={};Classes.Base={_Base_:{lastId:0,_idGen:function(){return++this.lastId}},__idPrefix:null,roDef:function(obj,propName,propValue){Object.defineProperty(obj,propName,{value:propValue,configurable:true,enumerable:false,writable:false})},_genLogFn:function(consoleFn,setPrefix=false,consoleObj=console){if(!setPrefix){return Function.prototype.bind.call(consoleFn,consoleObj)}return Function.prototype.bind.call(consoleFn,consoleObj,"["+this._id+"]")},create:function(){return this.createAs(null,...arguments)},createAs:function(id,...restArgs){var retVal=Object.create(this);this.roDef(retVal,"_hiddenId",this._Base_._idGen());this.roDef(retVal,"_id",id==null?this._formatId(retVal._hiddenId):id);this.debug.call(retVal,false);this.roDef(retVal,"_err",this._genLogFn.call(retVal,console.error,true));this.roDef(retVal,"_assert",this._genLogFn.call(retVal,console.assert));retVal._init.apply(retVal,restArgs);return retVal},debug:function(flag=true){if(flag&&!isProd()){this.roDef(this,"_log",this._genLogFn(console.log,true));this.roDef(this._log,"raw",this._genLogFn(console.log,false));this.roDef(this._log,"trace",this._genLogFn(console.trace,true))}else{this.roDef(this,"_log",emptyFn);this.roDef(this._log,"raw",emptyFn);this.roDef(this._log,"trace",emptyFn)}},subclass:function(extension){return Object.assign({},this,extension)},getId:function(){return this._id},_init:function(){},_formatId:function(hiddenId){if(this.__idPrefix==null){return hiddenId}return this.__idPrefix+"-"+hiddenId},_errorMustSubclass:function(){return Function.prototype.bind.call(console.error,console,"This method must be subclassed: ")}()};Classes.AsyncBase=Classes.Base.subclass({_initPromise:null,_initialized:null,_init:function(){Classes.Base._init.call(this);this._initialized=false;this._initPromise=this._asyncInit().then(function(){this._initialized=true}.bind(this))},_asyncInit:function(){return Promise.resolve()},isInitialized:function(){return this._initialized},getInitPromise:function(){return this._initPromise}});Classes.EventManager=Classes.Base.subclass({_elem:null,_ownerObj:null,_init:function(domId){Classes.Base._init.call(this);this._elem=document.createElement("div");if(domId!=null){this._elem.setAttribute("id",domId);document.body.append(this._elem)}this.addEventListener=this._elem.addEventListener.bind(this._elem);this.removeEventListener=this._elem.removeEventListener.bind(this._elem)},dispatchEvent:function(eventName,detailObj){this._elem.dispatchEvent(new CustomEvent(eventName,{detail:detailObj}))},notifyListeners:function(eventId,extraData={}){let detail=Object.assign({target:this._ownerObj},extraData);this.dispatchEvent(eventId,detail)},attachRegistrationFunctions:function(obj){obj.addEventListener=this.addEventListener;obj.removeEventListener=this.removeEventListener;this._assert(this._ownerObj==null);this._ownerObj=obj},discard:function(){this.addEventListener=null;this.removeEventListener=null;this._ownerObj.addEventListener=null;this._ownerObj.removeEventListener=null;this._ownerObj=null;this._elem.remove();gcChecker.add(this);gcChecker.add(this._elem,this.getId()+"._elem");this._elem=null},addEventListener:function(){},removeEventListener:function(){}});Classes.Base.roDef(Classes.EventManager,"Events",{});Classes.Base.roDef(Classes.EventManager.Events,"UPDATED","tmUpdated");Classes.EventListenersWrapper=Classes.Base.subclass({_weakRefListeners:null,_listenFnName:null,_unlistenFnName:null,_init:function(listenFnName="addEventListener",unlistenFnName="removeEventListener"){Classes.Base._init.call(this);this.debug();this._weakRefListeners=[];this._listenFnName=listenFnName;this._unlistenFnName=unlistenFnName},listen:function(obj,...listenerArgs){const logHead="EventListenersWrapper.listen():";if(obj==null){this._err(logHead,"event target can't be null",obj);return}let weakRefArgs=[];for(let i=0;i<arguments.length;i++){if(["function","object"].includes(typeof arguments[i])){try{weakRefArgs[i]={weakRef:new WeakRef(arguments[i]),type:"weakRef"}}catch(e){this._err(logHead,"building new WeakRef(), on argument ",i,arguments[i]);throw e}}else{weakRefArgs[i]={arg:arguments[i],type:"standard"}}}this._weakRefListeners.push(weakRefArgs);obj[this._listenFnName].apply(obj,listenerArgs)},unlisten:function(obj,...listenerArgs){const logHead="EventListenersWrapper.unlisten():";if(obj[this._unlistenFnName]==null){this._log(logHead,"obj",obj?.getId()??"[not derived from Base]","missing _unlistenFnName =",this._unlistenFnName,arguments);return}obj[this._unlistenFnName].apply(obj,listenerArgs)},_unlistenWrapper:function(weakRefObj,...listenerWeakRefArgs){let allArgs=[];for(let i=0;i<arguments.length;i++){switch(arguments[i].type){case"weakRef":allArgs[i]=arguments[i].weakRef.deref();break;case"standard":allArgs[i]=arguments[i].arg;break}if(allArgs[i]===undefined){return}}this.unlisten.apply(this,allArgs)},clear:function(){for(let i=0;i<this._weakRefListeners.length;i++){this._unlistenWrapper.apply(this,this._weakRefListeners[i])}this._weakRefListeners=[]},discard:function(){this.clear()}});Classes.Error=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)}});Classes.Base.roDef(Classes.Error,"NOTRUNNING","Not running");Classes.TmUtils=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug();this.err=this._err;this.log=this._log;if(isProd()){this.freeze=this._freezeProd}else{this.freeze=this._freezeDev}},err:null,log:null,isEqual:function(objA,objB,verbose){verbose=optionalWithDefault(verbose,false);const logHead="TmUtils::isEqual():";let debugFn=this._log;if(!verbose){debugFn=emptyFn}if(typeof objA!=typeof objB){debugFn(logHead,"different types",objA,objB);return false}if(typeof objA!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead,'"'+typeof objA+'" is not supported');return objA===objB}if(Array.isArray(objA)){if(Array.isArray(objB)){if(objA.length!=objB.length){debugFn(logHead,"different array length",objA,objB);return false}for(let i=0;i<objA.length;i++){if(!this.isEqual(objA[i],objB[i],verbose)){debugFn(logHead,"different array value at index:",i,objA,objB);return false}}return true}else{debugFn(logHead,"objA is an Array, objB is not",objA,objB);return false}}if(objA==null||objB==null){return objA===objB}let keysA=Object.keys(objA).sort();let keysB=Object.keys(objB).sort();if(keysA.length!=keysB.length){debugFn(logHead,"different object key counts",keysA,keysB);return false}for(let i=0;i<keysA.length;i++){if(keysA[i]!=keysB[i]){debugFn(logHead,"different keys:",keysA[i]," / ",keysB[i]);return false}if(!this.isEqual(objA[keysA[i]],objB[keysB[i]],verbose)){debugFn(logHead,"different values for key:",keysA[i],objA[keysA[i]],objB[keysB[i]]);return false}}return true},deepCopy:function(obj){const logHead="TmUtils::deepCopy(): ";if(obj===undefined){return undefined}if(typeof obj=="string"){return obj.repeat(1)}if(typeof obj!="object"){this._assert(!["function","symbol"].includes(typeof objA),logHead+'"'+typeof objA+'" is not supported');return obj}if(obj==null){return null}if(Array.isArray(obj)){let retVal=Array(obj.length);for(let i=0;i<obj.length;i++){retVal[i]=this.deepCopy(obj[i])}return retVal}let retVal={};let keys=Object.keys(obj);for(let i=0;i<keys.length;i++){retVal[keys[i]]=this.deepCopy(obj[keys[i]])}return retVal},arrayDiff:function(a,b,sortCmpFn,nodeCmpFn,inPlace){inPlace=optionalWithDefault(inPlace,true);let basicSortCmpFn=function(x,y){if(x==y){return 0}if(x<y){return-1}return 1};let basicNodeCmpFn=function(x,y){return x==y};sortCmpFn=optionalWithDefault(sortCmpFn,basicSortCmpFn);nodeCmpFn=optionalWithDefault(nodeCmpFn,basicNodeCmpFn);if(!inPlace){a=[].concat(a);b=[].concat(b)}a.sort(sortCmpFn);b.sort(sortCmpFn);let added=[];let deleted=[];let changed=[];let aIdx=0;let bIdx=0;for(;aIdx<a.length&&bIdx<b.length;){let sortCmpResult=sortCmpFn(a[aIdx],b[bIdx]);if(sortCmpResult==0){if(!nodeCmpFn(a[aIdx],b[bIdx])){changed.push(b[bIdx])}aIdx++;bIdx++}else{if(sortCmpResult<0){deleted.push(a[aIdx]);aIdx++}else{added.push(b[bIdx]);bIdx++}}}for(;aIdx<a.length;aIdx++){deleted.push(a[aIdx])}for(;bIdx<b.length;bIdx++){added.push(b[bIdx])}return[added,deleted,changed]},_regexEscapePatternObj:/[-\/\\^$*+?.()|[\]{}]/g,regexEscape:function(string){return string.replace(this._regexEscapePatternObj,"\\$&")},_freezeDev:function(obj){return Object.freeze(obj)},_freezeProd:function(obj){return obj},freeze:null,splitCamelCase:function(str){let splits=str.split(/([A-Z][a-z]+)/);let lowerCaseSplits=[];for(let i=0;i<splits.length;i++){if(splits[i]!=""){lowerCaseSplits.push(splits[i].toLowerCase())}}if(lowerCaseSplits.length==0){return""}lowerCaseSplits[0]=this.toUpperCaseInitial(lowerCaseSplits[0]);return lowerCaseSplits.join(" ")},toLowerCaseInitial:function(str){return str.charAt(0).toLowerCase()+str.substring(1)},toUpperCaseInitial:function(str){return str.charAt(0).toUpperCase()+str.substring(1)},isTabPinned:function(tab){return tab.pinned||tab.tm.pinInherited!=null}});Classes.Base.roDef(window,"tmUtils",Classes.TmUtils.create());tmUtils.debug();Classes.TmConsole=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this)},clearStorage:function(){chrome.storage.local.clear();chrome.storage.sync.clear()},showStorage:function(){chrome.storage.local.get(function(result){console.log(result)});chrome.storage.sync.get(function(result){console.log(result)})},_showTabInfoInner:function(tabId,bsTabLabel){let tabsBsTabViewer=popupViewer.getBsTabByLabel(bsTabLabel);let[tabInfo,tileInfo]=tabsBsTabViewer.getTabInfo(tabId);if(tileInfo==null&&tabInfo==null){console.log('Not found in bsTab "'+bsTabLabel+'"');return}console.log('Found in bsTab "'+bsTabLabel+'"');if(tileInfo!=null&&tabInfo==null){console.log("tabInfo (through tile):",tileInfo.getTabInfo())}else{console.log("tabInfo:",tabInfo)}console.log("tileInfo:",tileInfo)},showTabInfo:function(tabId){this._showTabInfoInner(tabId,"home");this._showTabInfoInner(tabId,"incognito")},showSearchParserInfo:function(){let allTabsBsTabViewer=null;if(popupViewer.isSettingsBsTabActive()){allTabsBsTabViewer=popupViewer.getHomeBsTab()}else{allTabsBsTabViewer=popupViewer.getActiveBsTab()}let searchParserText=allTabsBsTabViewer.getSearchParserInfo();if(searchParserText==null){console.log("No active search, nothing to show");return}console.log(searchParserText)},showBookmarksStats:function(){if(!bookmarksManager.isActive()){console.log("bookmarksManager is not active");return}console.log("bookmarksManager statistics:",bookmarksManager.getStats())},_getRandomInt:function(min,max){return Math.floor(min)+Math.floor(Math.random()*Math.floor(max-min))},testConcatPush:function(){let createArrays=function(arrayCnt,arraySize){let retVal=Array(arrayCnt);for(let i=0;i<arrayCnt;i++){retVal[i]=Array(arraySize);for(let j=0;j<arraySize;j++){retVal[i][j]=this._getRandomInt(0,100)}}return retVal}.bind(this);function appendArray(dst,src){let dstLength=dst.length;let srcLength=src.length;dst.length=dstLength+srcLength;for(let i=0;i<srcLength;i++){dst[dstLength+i]=src[i]}}let maxRepeat=100;let origArray=createArrays(1e3,100);perfProf.mark("testConcatPush_concatStart");let concatResult=null;for(let r=0;r<maxRepeat;r++){concatResult=[].concat.apply([],origArray)}perfProf.mark("testConcatPush_concatEnd");perfProf.mark("testConcatPush_pushStart");let pushResult=null;for(let r=0;r<maxRepeat;r++){pushResult=[];for(let i=0;i<origArray.length;i++){pushResult.push.apply(pushResult,origArray[i])}}perfProf.mark("testConcatPush_pushEnd");perfProf.mark("testConcatPush_appendStart");let appendResult=null;for(let r=0;r<maxRepeat;r++){appendResult=[];for(let i=0;i<origArray.length;i++){appendArray(appendResult,origArray[i])}}perfProf.mark("testConcatPush_appendEnd");if(!tmUtils.isEqual(concatResult,pushResult)){this._err("Invalid result, concat() and push() generated different output arrays");return}if(!tmUtils.isEqual(concatResult,appendResult)){this._err("Invalid result, concat() and appendArray() generated different output arrays");return}console.log("Valid result, concat(), push() and appendArray() generated the same output");let toMeasure={concat:["testConcatPush_concatStart","testConcatPush_concatEnd"],push:["testConcatPush_pushStart","testConcatPush_pushEnd"],append:["testConcatPush_appendStart","testConcatPush_appendEnd"]};perfProf.showMeasures(toMeasure);perfProf.clearMarksByPrefix(toMeasure);perfProf.clearMeasures(toMeasure)},testIncludesRegex:function(){let createStrings=function(stringCnt,stringLength){let retVal=Array(stringCnt);for(let i=0;i<stringCnt;i++){let tmp=[];for(let j=0;j<stringLength;j++){tmp.push(String.fromCharCode(this._getRandomInt(97,122)))}retVal[i]=tmp.join("")}return retVal}.bind(this);let maxRepeat=100;let strings=createStrings(1e4,1e3);function runTest(testFn){let found=null;for(let r=0;r<maxRepeat;r++){found=[];for(let i=0;i<strings.length;i++){if(testFn(strings[i])){found.push(strings[i])}}}return found}let queries=createStrings(10,50);let regex=null;let escapedQueries=[];for(let i=0;i<queries.length;i++){queries[i]="aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"+queries[i];escapedQueries[i]=tmUtils.regexEscape(queries[i])}console.log("queries, escapedQueries",queries,escapedQueries);try{regex=new RegExp("("+escapedQueries.join(")|(")+")")}catch(e){console.error("Unable to parse regex",e);return}perfProf.mark("testIncludesRegex_includesStart");let includesFound=runTest(function(string){for(let i=0;i<queries.length;i++){if(string.includes(queries[i])){return true}}return false});perfProf.mark("testIncludesRegex_includesEnd");perfProf.mark("testIncludesRegex_regexStart");let regexFound=runTest(function(string){return regex.test(string)});perfProf.mark("testIncludesRegex_regexEnd");if(!tmUtils.isEqual(includesFound,regexFound)){this._err("Invalid result, includes() and RegExp.test() generated different output strings");return}console.log("Valid result, includes() and RegExp.test() generated the same output:",regexFound);let toMeasure={"includes()":["testIncludesRegex_includesStart","testIncludesRegex_includesEnd"],"RegExp.test()":["testIncludesRegex_regexStart","testIncludesRegex_regexEnd"]};perfProf.showMeasures(toMeasure);perfProf.clearMarksByPrefix(toMeasure);perfProf.clearMeasures(toMeasure)}});Classes.Base.roDef(window,"tmConsole",Classes.TmConsole.create());tmConsole.debug();Classes.PersistentDict=Classes.AsyncBase.subclass({_storageObj:null,_dict:null,_eventManager:null,_initPromise:null,_initialized:null,_init:function(storageObj=chrome.storage.local){this.debug();this._storageObj=storageObj;this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);chrome.storage.onChanged.addListener(this._onStorageChangedCb.bind(this));Classes.AsyncBase._init.call(this)},_asyncInit:function(){let parentPromise=Classes.AsyncBase._asyncInit.call(this);let thisPromise=chromeUtils.storageGet(this._id,this._storageObj).then(function(results){const logHead="PersistentDict._initDict().cb:";this._dict={};if(this._id in results){this._dict=results[this._id];this._log(logHead,"initializing this._dict to",this._dict)}else{this._log(logHead,"key",this._id,"not found, initializing empty")}}.bind(this));return Promise.all([parentPromise,thisPromise])},_onStorageChangedCb:function(changes,areaName){const logHead="PersistentDict._onStorageChangedCb("+areaName+"):";if(!this.isInitialized()){this._log(logHead,"still initializing, ignoring event");return}if(chromeUtils.storageObjByAreaName(areaName)!=this._storageObj){this._log(logHead,"not my storage object, ignoring event");return}if(!(this._id in changes)){this._log(logHead,"not my storage key, ignoring event",changes);return}if(tmUtils.isEqual(this._dict,changes[this._id].newValue)){this._log(logHead,"the object has not changed, ignoring event",changes);return}this._log(logHead,"setting to",changes[this._id]);this._dict=changes[this._id].newValue??{};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED)},_persist:function(){var items={};items[this._id]=this._dict;this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED);return chromeUtils.storageSet(items,this._storageObj)},_setInner:function(key,value=null){if(tmUtils.isEqual(this._dict[key],value)){return false}this._dict[key]=tmUtils.deepCopy(value);return true},set:function(key,value=null){const logHead="PersistentDict.set():";this._assert(this.isInitialized(),logHead,"still waiting for initialization",key,value);if(this._setInner(key,value)){return this._persist()}this._log(logHead,"the key has not changed, ignoring call",key,value);return Promise.resolve()},get:function(key){const logHead="PersistentDict.get():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");return tmUtils.deepCopy(this._dict[key])},has:function(key,ignoreCase=false){const logHead="PersistentDict.has():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(!ignoreCase){return key in this._dict}let allKeys=Object.keys(this._dict);let searchKey=key.toLowerCase();let result=allKeys.findIndex(function(currKey){return currKey.toLowerCase()==searchKey});return result!=-1},rename:function(key,newKey){const logHead="PersistentDict.rename("+key+", "+newKey+"):";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(!(key in this._dict)){this._log(logHead,"original key not in _dict, nothing to do");return Promise.resolve()}if(newKey in this._dict){this._err(logHead,"new key already in _dict, can't overwrite");return Promise.reject()}this._dict[newKey]=this._dict[key];delete this._dict[key];this._log(logHead,"completed",this._dict);return this._persist()},_delInner:function(key){if(!(key in this._dict)){return false}delete this._dict[key];return true},del:function(key){const logHead="PersistentDict.del():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(this._delInner(key)){return this._persist()}return Promise.resolve()},delMany:function(keyList){let anyChanges=false;for(let i=0;i<keyList.length;i++){if(this._delInner(keyList[i])){anyChanges=true}}if(anyChanges){return this._persist()}return Promise.resolve()},setAll:function(dict){const logHead="PersistentDict.setAll():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");if(tmUtils.isEqual(this._dict,dict)){this._log(logHead,"the object has not changed, ignoring call",dict,this._dict);return Promise.resolve()}this._dict=tmUtils.deepCopy(dict);return this._persist()},getAll:function(){const logHead="PersistentDict.getAll():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");return tmUtils.deepCopy(this._dict)},getAllKeys:function(){const logHead="PersistentSet.getAllKeys():";this._assert(this.isInitialized(),logHead,"still waiting for initialization");return Object.keys(this._dict)}});Classes.PersistentSet=Classes.PersistentDict.subclass({add:function(key){return this.set(key)},addMany:function(keyList){let anyChanges=false;for(let i=0;i<keyList.length;i++){if(this._setInner(keyList[i])){anyChanges=true}}if(anyChanges){return this._persist()}return Promise.resolve()},getAll:function(){return this.getAllKeys()},setAll:function(keys){let dict={};for(let i=0;i<keys.length;i++){dict[keys[i]]=null}return Classes.PersistentDict.setAll.call(this,dict)}});Classes.GarbageCollectionChecker=Classes.Base.subclass({_weakRefs:null,_cnt:null,_init:function(){Classes.Base._init.call(this);this.debug();this._weakRefs=[];this._cnt=0;if(isProd()){this.add=emptyFn}else{this.add({txt:"a test object"},"test-obj")}},add:function(obj,label=obj.getId?.()??""){this._weakRefs.push({weakRef:new WeakRef(obj),label:label,timestamp:performance.now(),pos:this._cnt++})},check:function(clear=false){let cleared=[];let collected=[];let more=true;while(this._weakRefs.length>0&&clear&&more){if(this._weakRefs[0].weakRef.deref()===undefined){let item=this._weakRefs.shift();cleared.push(item);collected.push(item)}else{more=false}}for(let i=0;i<this._weakRefs.length;i++){if(this._weakRefs[0].weakRef.deref()===undefined){collected.push(this._weakRefs[i])}}return{cleared:cleared,collected:collected,weakRefs:this._weakRefs}}});Classes.Base.roDef(window,"gcChecker",Classes.GarbageCollectionChecker.createAs("gcChecker"));Classes.BoundArray=Classes.Base.subclass({_array:null,_maxElements:null,_init:function(maxElements){Classes.Base._init.apply(this,arguments);this._maxElements=maxElements;this._array=[];this.debug()},resize:function(){if(this._array.length>=this._maxElements){this._array.splice(0,this._maxElements-this._array.length)}return this._array.length},push:function(value){this._array.push(value);return this.resize()},pop:function(){return this._array.pop()},isEmpty:function(){return this._array.length==0},peek:function(cnt){if(this.isEmpty()){return null}if(cnt==null){return this._array[this._array.length-1]}if(cnt>this._array.length){cnt=this._array.length}return this._array.slice(-cnt)},append:function(value){this._array.splice(-1,0,...value);return this.resize()},removeValueOLD:function(value){var nextIndex=0;while((nextIndex=this._array.indexOf(value,nextIndex))!=-1){this._array.splice(nextIndex,1)}},removeValue:function(value,matchFn){matchFn=optionalWithDefault(matchFn,function(a,b){return a==b});const logHead="BoundArray::removeValue("+value+"): ";let foundIdx=[];for(let i=0;i<this._array.length;i++){if(matchFn(value,this._array[i])){foundIdx.push(i)}}this._log(logHead+"need to remove these indices:",foundIdx);for(let i=foundIdx.length-1;i>=0;i--){this._log(logHead+"now removing index "+foundIdx[i]+" (value = "+this._array[foundIdx[i]]+")");this._array.splice(foundIdx[i],1)}},get:function(pos){if(pos!=undefined){return this._array[pos]}return this._array}});Classes.MsgServer=Classes.Base.subclass({_cmdMap:null,_init:function(){Classes.Base._init.apply(this,arguments);this._cmdMap={}},start:function(){chrome.runtime.onMessage.addListener(this._processMsgCb.bind(this))},_printTabInfo:function(tab){if(tab){return tab.id}return"[extension]"},_processMsgInner:function(request,sender,sendResponse){if(request.cmd in this._cmdMap){return this._cmdMap[request.cmd].fn.apply(this,arguments)}else{return this.formatErrMsg("unknown command: "+request.cmd)}},_processMsgCb:function(request,sender,sendResponse){const logHead="MsgServer::_processMsgCb(from tab "+this._printTabInfo(sender.tab)+"): ";this._log(logHead+JSON.stringify(request),sender);var response=this._processMsgInner.apply(this,arguments);if(response==null){if(this._cmdMap[request.cmd].needResponse){return true}sendResponse("");return false}sendResponse(response);return false},addCmd:function(cmd,fn,needResponse){needResponse=optionalWithDefault(needResponse,true);var cmdWrapper=safeFnWrapper(fn,null,function(e){this._err('cmd "'+cmd+'" generated an exception: ',e);return this.formatErrMsg(e.message,e.toString())}.bind(this));this._cmdMap[cmd]={fn:cmdWrapper,needResponse:needResponse}},formatErrMsg:function(msg,details){var retVal={status:"error",message:msg};if(details!=null){retVal.details=details}return retVal}});Classes.MsgClient=Classes.Base.subclass({_init:function(){Classes.Base._init.apply(this,arguments)},_requestInner:function(request){const logHead="MsgClient::_requestInner("+JSON.stringify(request)+"): ";this._log(logHead+"entering");return chromeUtils.wrap(chrome.runtime.sendMessage,logHead,request)},_formatRequest:function(cmd,otherOptions){return{cmd:cmd,...otherOptions}},sendRequest:function(cmd,otherOptions){const request=this._formatRequest.apply(this,arguments);return this._requestInner(request).then(function(response){this._debugResponse(cmd,response);return response}.bind(this))},sendNotification:function(cmd,otherOptions){const notification=this._formatRequest.apply(this,arguments);return this._requestInner(notification)},_debugResponse:function(cmd,response){const logHead="MsgClient::_debugResponse("+cmd+"): ";if(response.status!="success"){this._err(logHead+"response failed: "+JSON.stringify(response))}}});function optArrayWithDefault(value,defaultValue){if(typeof value==="undefined"||value==null||value.length==0){return defaultValue}return value}function delay(delayTime){return new Promise(function(resolve){setTimeout(resolve,delayTime)})}function safeFnWrapper(fnToWrap,errMsgPrefix,errFn){return function(){try{return fnToWrap(...arguments)}catch(e){if(errMsgPrefix!=null){tmUtils.err(errMsgPrefix+e.message+" |",e)}if(errFn!=null){return errFn(e,...arguments)}}}}function isUrl(url){try{let urlObj=new URL(url);return true}catch(e){return false}}function stackTrace(){return(new Error).stack}function asyncFn(fn){return Promise.resolve().then(fn)}Classes.PerfProfiler=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},mark:function(mark){performance.mark(mark)},measure:function(name,startMark,endMark){try{performance.measure(...arguments)}catch(e){this._log("Measure failed for",name,[startMark,endMark],e)}},log:function(){const logHead="PerfProfiler::log(): ";this._log.raw("%c"+logHead+"type measure: %o","background-color: powderblue;",performance.getEntriesByType("measure"))},logAll:function(){const logHead="PerfProfiler::log(): ";this._log(logHead+"all types: ",performance.getEntries())},_sortEntries:function(a,b){if(a.startTime>b.startTime){return 1}if(a.startTime<b.startTime){return-1}return 0},_getMeasures:function(measuresTable){for(const[measureName,marks]of Object.entries(measuresTable)){this.measure(measureName,marks[0],marks[1])}let p=[];for(const measureName of Object.keys(measuresTable)){p=p.concat(performance.getEntriesByName(measureName,"measure"));performance.clearMeasures(measureName)}p.sort(this._sortEntries);return p},_getMarks:function(measuresTable){let p=[];for(const[measureName,marks]of Object.entries(measuresTable)){p=p.concat(performance.getEntriesByName(marks[0],"mark"));p=p.concat(performance.getEntriesByName(marks[1],"mark"))}p.sort(this._sortEntries);return p},_getMarksByPrefix:function(measuresTable){let allMarks=performance.getEntriesByType("mark");let markPrefixes=[];for(const[measureName,marks]of Object.entries(measuresTable)){markPrefixes.push(marks[0],marks[1])}let p=[];for(const[index,entry]of Object.entries(allMarks)){for(const[index,prefix]of Object.entries(markPrefixes)){if(entry.name.startsWith(prefix)){p.push(entry)}}}p.sort(this._sortEntries);return p},clearMarksByPrefix:function(measuresTable){let allMarks=performance.getEntriesByType("mark");let markPrefixes=[];for(const[measureName,marks]of Object.entries(measuresTable)){markPrefixes.push(marks[0],marks[1])}for(const[index,entry]of Object.entries(allMarks)){for(const[index,prefix]of Object.entries(markPrefixes)){if(entry.name.startsWith(prefix)){performance.clearMarks(entry.name)}}}},clearMeasures:function(measuresTable){for(const[measureName,marks]of Object.entries(measuresTable)){performance.clearMeasures(measureName)}},showMeasures:function(measuresTable){console.table(this._getMarksByPrefix(measuresTable),["name","startTime"]);console.table(this._getMeasures(measuresTable),["name","duration","startTime"])},showAllMarks:function(){console.table(performance.getEntriesByType("mark"),["name","startTime"])},showAllEntries:function(){console.table(performance.getEntries(),["entryType","name","duration","startTime"])},showSearch:function(){let toMeasure={"parse query":["parseQueryStart","parseQueryEnd"],"full search":["searchStart","searchEnd"],"chrome.history.search()":["historySearchStart","historySearchEnd"],"history reduce":["historyReduceStart","historyReduceEnd"],"filter bookmarks":["bookmarksSearchStart","bookmarksSearchEnd"],"filter tabs + rcTabs + hItems":["searchFilterStart","searchFilterEnd"],"sort search results":["searchSortStart","searchSortEnd"],render:["searchRenderStart","searchRenderEnd"]};this.showMeasures(toMeasure)},showAsyncQueues:function(){let toMeasure={"discard batch":["discardAsyncQueueBatchStart","discardAsyncQueueBatchEnd"],"run batch":["runAsyncQueueBatchStart","runAsyncQueueBatchEnd"],"full run":["runAsyncQueueStart","runAsyncQueueEnd"]};console.table(this._getMarksByPrefix(toMeasure),["name","startTime"])},showStats:function(){chromeUtils.queryTabs({},"PerfProfiler::tmStats(): ").then(function(tabs){console.log("Total tabs count: "+tabs.length);console.table(performance.getEntriesByType("measure"),["name","duration","startTime"])})}});Classes.Base.roDef(window,"perfProf",Classes.PerfProfiler.create());Classes.AsyncQueue=Classes.Base.subclass({__idPrefix:"AsyncQueue",_eventManager:null,_queues:null,_batchSize:50,_running:null,_discarded:null,_init:function(){const logHead="AsyncQueue::_init(): ";Classes.Base._init.call(this);this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);this._initQueues();this._running=false;this._discarded=false},_isRunning:function(){return this._running},_isDiscarded:function(){return this._discarded},_initQueues:function(){this._queues={};this._queues[Classes.AsyncQueue.priority.HIGH]={name:Classes.AsyncQueue.priority.HIGH,delay:0,queue:[]};this._queues[Classes.AsyncQueue.priority.NORMAL]={name:Classes.AsyncQueue.priority.NORMAL,delay:0,queue:[]};this._queues[Classes.AsyncQueue.priority.LOW]={name:Classes.AsyncQueue.priority.LOW,delay:200,queue:[]}},_getQueue:function(priority){return this._queues[priority]},_getQueueToProcess:function(){const logHead="AsyncQueue::_getQueueToProcess(): ";let priorities=[Classes.AsyncQueue.priority.HIGH,Classes.AsyncQueue.priority.NORMAL,Classes.AsyncQueue.priority.LOW];for(priority of priorities){if(this._queues[priority].queue.length!=0){this._log(logHead+'queue of priority "'+priority+'" has pending work: '+this._queues[priority].queue.length);return this._queues[priority]}}this._log(logHead+"all queues are empty");return null},_getAllQueueLengths:function(){let retVal=[];for(const[priority,queue]of Object.entries(this._queues)){retVal.push(priority+": "+queue.queue.length)}return retVal},_processQueue:async function(perfLabel,processFn,resumeFn,cleanupFn){const logHead="AsyncQueue::_processQueue(): ";let processedCnt=this._batchSize;let firstRound=true;let queue=null;while((queue=this._getQueueToProcess())!=null){while(queue.queue.length>0){if(processedCnt>=this._batchSize){if(!firstRound){perfProf.mark(perfLabel+"AsyncQueueBatchEnd"+this._id);await delay(queue.delay)}else{firstRound=false}processedCnt=0;if(resumeFn!=null&&!resumeFn()){if(cleanupFn!=null){await cleanupFn()}return false}perfProf.mark(perfLabel+"AsyncQueueBatchStart"+this._id)}let entry=queue.queue.shift();processFn(entry);processedCnt++}}perfProf.mark(perfLabel+"AsyncQueueBatchEnd"+this._id);return true},_discardProcessFn:function(entry){if(entry.discardFn!=null){entry.discardFn()}},_runResumeFn:function(){return!this._isDiscarded()},_runProcessFn:function(entry){let retVal=entry.fn();entry.resolveFn(retVal)},_runCleanupFn:async function(){const logHead="AsyncQueue::_runCleanupFn(): ";this._log(logHead+"entering, queue lengths = ",this._getAllQueueLengths());await this._processQueue("discard",this._discardProcessFn.bind(this))},_runQueue:async function(){const logHead="AsyncQueue::_runQueue(): ";if(this._isRunning()){return}this._log(logHead+"entering");this._running=true;perfProf.mark("runAsyncQueueStart"+this._id);let normalState=true;try{while(this._getQueueToProcess()!=null&&normalState){normalState=await this._processQueue("run",this._runProcessFn.bind(this),this._runResumeFn.bind(this),this._runCleanupFn.bind(this))}}catch(e){this._err(logHead,e)}perfProf.mark("runAsyncQueueEnd"+this._id);this._running=false},_enqueueInner:function(queueEntry,priority){this._getQueue(priority).queue.push(queueEntry);this._runQueue()},enqueue:function(fn,fnSignature,priority){priority=optionalWithDefault(priority,Classes.AsyncQueue.priority.NORMAL);return new Promise(function(resolveFn,rejectFn){let queueEntry={fn:safeFnWrapper(fn,fnSignature,rejectFn),resolveFn:resolveFn,rejectFn:rejectFn,discardFn:null};this._enqueueInner(queueEntry,priority)}.bind(this))},discard:async function(){const logHead="AsyncQueue::discard(): ";this._discarded=true;gcChecker.add(this);if(!this._isRunning()){this._assert(this._getQueueToProcess()==null);if(this._getQueueToProcess()!=null){await this._runCleanupFn()}}}});Classes.Base.roDef(Classes.AsyncQueue,"priority",{});Classes.Base.roDef(Classes.AsyncQueue.priority,"HIGH","high");Classes.Base.roDef(Classes.AsyncQueue.priority,"NORMAL","normal");Classes.Base.roDef(Classes.AsyncQueue.priority,"LOW","low");Classes.SerialPromises=Classes.Base.subclass({_currPromise:null,_nextPromise:null,_init:function(){Classes.Base._init.call(this);this.debug();this.reset()},_resetCurrPromise:function(){this._currPromise=null},_runNext:function(nextPromise,nextFn,debugInfo){const logHead="SerialPromises::_runNext("+debugInfo+"): ";if(nextPromise!=null&&nextPromise!=this._nextPromise){this._log(logHead+"suppressing old call");return null}this._log(logHead+"running new call");this._currPromise=nextFn();return this._currPromise.then(this._resetCurrPromise.bind(this),this._resetCurrPromise.bind(this))},next:function(nextFn,debugInfo){if(this._currPromise==null){return this._runNext(null,nextFn,debugInfo)}this._nextPromise=new Promise(function(resolve,reject){this._currPromise.then(resolve,resolve)}.bind(this));return this._nextPromise.then(this._runNext.bind(this,this._nextPromise,nextFn,debugInfo))},reset:function(){this._currPromise=null;this._nextPromise=null}});Classes.ChromeUtils=Classes.Base.subclass({bAction:chrome.browserAction,_init:function(){Classes.Base._init.apply(this,arguments)},_wrapInner:function(verbose,chromeFn,debugCtx,...args){return new Promise(function(resolve,reject){chromeFn(...args,function(){const logHead="ChromeUtils::wrap().cb: "+(debugCtx!=null?debugCtx:"");if(chrome.runtime.lastError){if(verbose){this._err(logHead+"chrome.runtime.lastError = "+chrome.runtime.lastError.message)}reject(chrome.runtime.lastError)}else{resolve(...arguments)}}.bind(this))}.bind(this))},wrap:function(chromeFn,debugCtx,...args){return this._wrapInner(true,...arguments)},wrapQuiet:function(){return this._wrapInner(false,...arguments)},getExtensionId:function(){const logHead="chromeUtils::getExtensionId(): ";let retVal=chrome.runtime.getURL("");this._log(logHead,retVal);retVal=retVal.replace("chrome-extension://","");retVal=retVal.replace("/","");return retVal},_queryWithFilter:async function(queryFn,callerLogHead,queryInfo){const incognitoFlag=queryInfo?.incognito;delete queryInfo?.incognito;let objs=await this.wrap(queryFn,callerLogHead,queryInfo);if(incognitoFlag!==undefined){return objs.filter(obj=>obj.incognito==incognitoFlag)}return objs},queryTabs:async function(queryInfo,callerLogHead){const logHead="ChromeUtils::queryTabs(): ";callerLogHead=optionalWithDefault(callerLogHead,logHead);if(queryInfo.windowId!=null&&queryInfo.incognito!==undefined){delete queryInfo.incognito}if(queryInfo.url==null){return this._queryWithFilter(chrome.tabs.query,callerLogHead,queryInfo)}let fragmentOffset=queryInfo.url.indexOf("#");if(fragmentOffset==-1){return this._queryWithFilter(chrome.tabs.query,callerLogHead,queryInfo)}let origUrl=queryInfo.url;queryInfo.url=queryInfo.url.substring(0,fragmentOffset);let tabListNoFragment=await this._queryWithFilter(chrome.tabs.query,callerLogHead,queryInfo);this._log(logHead+"chrome.tabs.query() for "+queryInfo.url+" returned:",tabListNoFragment);let tabList=[];for(let i=0;i<tabListNoFragment.length;i++){let currTab=tabListNoFragment[i];if(currTab.url==origUrl||currTab.pendingUrl==origUrl){tabList.push(currTab)}}return tabList},getLeastTabbedWindowId:function(incognito=false,preferredWinId){const logHead="ChromeUtils::getLeastTabbedWindowId(): ";let options={populate:true,incognito:incognito,windowTypes:["normal"]};let preferredWinTabsCount=999999;function leastTabbedReducer(currentMinWin,winInfo){let tabsCount=winInfo.tabs.length;if(winInfo.id==preferredWinId){preferredWinTabsCount=tabsCount}if(currentMinWin==0||currentMinWin.tabsCount>tabsCount){return{winInfo:winInfo,tabsCount:tabsCount}}return currentMinWin}return this._queryWithFilter(chrome.windows.getAll,logHead,options).then(function(winList){if(winList.length==0){return null}let minWin=winList.reduce(leastTabbedReducer,0);if(minWin.tabsCount<preferredWinTabsCount-1){this._log(logHead+"Found: ",minWin);return minWin.winInfo.id}this._assert(minWin.tabsCount<=preferredWinTabsCount,logHead+"unexpected");this._log(logHead+"Found multiple matches, returning preferredWinId",preferredWinId,minWin);return preferredWinId}.bind(this))},getEmptyTabsList:function(incognito=false,windowId){const logHead="ChromeUtils::getEmptyTabsList():";return this.queryTabs({url:"chrome://newtab/",incognito:incognito,windowId:windowId},logHead)},discardTab:async function(tab){const logHead="ChromeUtils::discardTab("+tab.id+"): ";if(tab.active){let activateIndex=tab.index-1;if(tab.index==0){activateIndex=1}let neighborTabs=await this.queryTabs({index:activateIndex,windowId:tab.windowId},logHead);this._log(logHead+"tabs.query for index "+activateIndex+" returned: ",neighborTabs);if(neighborTabs.length!=0){await this.activateTab(neighborTabs[0],false)}}this.wrap(chrome.tabs.discard,logHead,tab.id);this._log(logHead+"completed")},focusWindowByTabId:function(tabId){const logHead="ChromeUtils::focusWindowByTabId("+tabId+"): ";return this.wrap(chrome.tabs.get,logHead,tabId).then(function(tab){this._log(logHead+tab.windowId,tab);return this.focusWindow(tab)}.bind(this))},focusWindow:function(tab){const logHead="ChromeUtils::focusWindow():";return this.wrap(chrome.windows.update,logHead,tab.windowId,{focused:true})},createWindow:function(createData){const logHead="ChromeUtils::createWindow():";return this.wrap(chrome.windows.create,logHead,createData)},activateTabByTabId:function(tabId){let activatePromise=this.wrap(chrome.tabs.update,"ChromeUtils::activateTabByTabId(): ",tabId,{active:true});let focusPromise=this.focusWindowByTabId(tabId);return Promise.all([activatePromise,focusPromise])},activateTab:function(tab,focusWindow=true){const logHead="ChromeUtils::activateTab(): ";let activatePromise=this.wrap(chrome.tabs.update,logHead,tab.id,{active:true});if(!focusWindow){return activatePromise}let focusPromise=this.wrap(chrome.windows.update,logHead,tab.windowId,{focused:true});return Promise.all([activatePromise,focusPromise])},_createTabInner:function(url,winId=chrome.windows.WINDOW_ID_CURRENT){const logHead="ChromeUtils::_createTabInner("+url+"): ";let promiseA=this.wrap(chrome.tabs.create,logHead,{url:url,windowId:winId});let promiseB=this.wrap(chrome.windows.update,logHead,winId,{focused:true});return Promise.all([promiseA,promiseB])},createTab:async function(options){const logHead="ChromeUtils.createTab():";let incognito=options?.incognito??false;let reuse=options?.reuse??true;let url=options?.url??null;let winId=options?.winId??null;let tabs=[];if(reuse){tabs=await this.getEmptyTabsList(incognito,winId)}this._log(logHead,"empty tabs:",tabs,options,incognito,winId,reuse);if(tabs.length!=0){return this.loadUrl(url,{tabId:tabs[0].id})}if(winId==null){winId=await this.getLeastTabbedWindowId(incognito)}if(winId==null){return this.createWindow({incognito:incognito,url:url,focused:true})}return this._createTabInner(url,winId)},loadUrl:function(url,options){const logHead="ChromeUtils::loadUrl("+url+"):";let incognito=options?.incognito??false;let tabId=options?.tabId??null;let winId=options?.winId??null;this._log(logHead,"entering",incognito,tabId,winId);this._assert(!(tabId!=null&&winId!=null),logHead);if(winId==chrome.windows.WINDOW_ID_NONE){this._assert(tabId==null);return this.createWindow({focused:true,url:url,incognito:incognito})}if(tabId==null){return this.createTab({incognito:incognito,url:url,winId:winId})}let promiseA=null;let promiseB=null;promiseA=this.activateTabByTabId(tabId);promiseB=this.wrap(chrome.tabs.update,logHead,tabId,{url:url});return Promise.all([promiseA,promiseB])},moveTab:function(tab,newWindowId,activate,oldWindowActiveTabId){activate=optionalWithDefault(activate,false);const logHead="chromeUtils::moveTab(activate: "+activate+"): ";if(oldWindowActiveTabId!=null&&tab.active){this.wrap(chrome.tabs.update,logHead,oldWindowActiveTabId,{active:true})}let moveProperties={index:-1,windowId:newWindowId};let movePromise=this.wrap(chrome.tabs.move,logHead,tab.id,moveProperties);let focusPromise=null;let activatePromise=null;if(activate){focusPromise=this.wrap(chrome.windows.update,logHead,newWindowId,{focused:true});activatePromise=this.wrap(chrome.tabs.update,logHead,tab.id,{active:true})}else{focusPromise=Promise.resolve();activatePromise=Promise.resolve()}return Promise.all([movePromise,focusPromise,activatePromise])},moveTabToLeastTabbedWindow:function(tab,activate,oldWindowActiveTabId){activate=optionalWithDefault(activate,false);const logHead="chromeUtils::moveTabToLeastTabbedWindow(activate: "+activate+"): ";return this.getLeastTabbedWindowId(tab.incognito,tab.windowId).then(function(winId){if(tab.windowId==winId){this._log(logHead+"tab "+tab.id+" is already in the least tabbed window "+winId);return null}return this.moveTab(tab,winId,activate,oldWindowActiveTabId)}.bind(this))},closeTab:function(tabId){return this.wrap(chrome.tabs.remove,"ChromeUtils::closeTab(): ",tabId)},inject:function(tabId,jsFile,jsCode){const logHead="ChromeUtils::inject("+tabId+"): ";let injectDetails={};if(jsFile!=null&&jsFile!=""){injectDetails.file=jsFile}else{if(jsCode!=null&&jsCode!=""){injectDetails.code=jsCode}}return this.wrapQuiet(chrome.tabs.executeScript,logHead,tabId,injectDetails).catch(function(chromeLastError){switch(chromeLastError.message){case Classes.ChromeUtils.Error.INJECT_NOFRAME:return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_ERRORPAGE:this._log(logHead+"tab has an error (network down?)");return Promise.resolve(null);case Classes.ChromeUtils.Error.INJECT_EXTGALLERY:this._log(logHead+"can't inject in the extensions gallery");return Promise.resolve(null);default:this._err(logHead+"unknown error: "+chromeLastError.message);return Promise.reject(chromeLastError)}}.bind(this))},getBookmarkPathList:async function(bmNode){const logHead="ChromeUtils::getBookmarkPathList("+bmNode.id+"): ";let pathList=[];while(bmNode!=null&&bmNode.parentId!=null){let result=await this.wrap(chrome.bookmarks.get,logHead,bmNode.parentId);if(result.length>0){bmNode=result[0];pathList.push(bmNode.title!=null?bmNode.title:"")}else{bmNode=null;this._err(logHead+"unexpected, it should not get here")}}pathList.reverse();return pathList},getBookmarksCount:function(){const logHead="ChromeUtils::getBookmarksCount("+bmNode.id+"): ";return this.wrap(chrome.bookmarks.getTree,logHead).then(function(nodesList){return nodesList.length}.bind(this))},storageGet:function(keys,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageGet(): ";return this.wrap(storageObj.get.bind(storageObj),logHead,keys)},storageSet:function(items,storageObj){storageObj=optionalWithDefault(storageObj,chrome.storage.local);const logHead="ChromeUtils::storageSet(): ";return this.wrap(storageObj.set.bind(storageObj),logHead,items)},_areaNamesDict:{sync:chrome.storage.sync,local:chrome.storage.local,managed:chrome.storage.managed},storageObjByAreaName:function(areaName){const logHead="ChromeUtils.storageObjByAreaName("+areaName+"): ";let retVal=this._areaNamesDict[areaName];this._assert(retVal!=null,logHead+"assertion failed");return retVal}});Classes.Base.roDef(Classes.ChromeUtils,"Error",{});Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_COMMUNICATION","Error when communicating with the native messaging host.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_EXITED","Native host has exited.");Classes.Base.roDef(Classes.ChromeUtils.Error,"NMH_NOTFOUND","Specified native messaging host not found.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_NOFRAME","The frame was removed.");Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_ERRORPAGE",'Cannot access contents of url "chrome-error://chromewebdata/". Extension manifest must request permission to access this host.');Classes.Base.roDef(Classes.ChromeUtils.Error,"INJECT_EXTGALLERY","The extensions gallery cannot be scripted.");Classes.Base.roDef(window,"chromeUtils",Classes.ChromeUtils.create());chromeUtils.debug();Classes.TabNormalizer=Classes.Base.subclass({_init:function(){Classes.Base._init.call(this);this.debug()},compareTitlesFn:function(a,b){return a.tm.sortTitle.localeCompare(b.tm.sortTitle)},compareTabsFn:function(a,b){if(tmUtils.isTabPinned(a)&&!tmUtils.isTabPinned(b)){return-1}if(tmUtils.isTabPinned(b)&&!tmUtils.isTabPinned(a)){return 1}return Classes.TabNormalizer.compareTitlesFn(a,b)},comparePositionFn:function(a,b){if(a.windowId<b.windowId){return-1}if(a.windowId>b.windowId){return 1}if(a.index<b.index){return-1}if(a.index>b.index){return 1}return 0},getProtocolHostname:function(url){try{var urlObj=new URL(url);return[urlObj.protocol,urlObj.hostname]}catch(e){return[null,null]}},_titleNormalizationPattern:/^(([^a-z0-9]+)|(www\.))/i,normalizeLowerCaseTitle:function(lowerCaseTitle){return lowerCaseTitle.replace(this._titleNormalizationPattern,"")},_cleanupChromeBookmarksManagerTitle:function(title,url){if(!url.startsWith("chrome://bookmarks/?id=")){return title}if(title!="Bookmarks"){return title}let split=url.split("=");if(split.length<2){return title}let bmNode=null;try{bmNode=bookmarksManager.getBmNode(+split[1])}catch(e){return title}if(bmNode==null){return title}let type="Folder";if(bmNode.url!=null){type="Bookmark"}return`${title} - ${type} "${bmNode.title}"`},_cleanupTitle:function(title,url){if(url==null){return title}if(title==""){return url}return this._cleanupChromeBookmarksManagerTitle(title,url)},updateUrl:function(tab){let url=(tab.url!=""?tab.url:tab.pendingUrl)??"";let[protocol,hostname]=this.getProtocolHostname(url);tab.tm.url=url;tab.tm.protocol=protocol;tab.tm.hostname=hostname;tab.tm.customGroupName=settingsStore.getCustomGroupsManager().getCustomGroupByHostname(hostname);tab.tm.lowerCaseUrl=url.toLowerCase()},updateTitle:function(tab,oldTab){tab.title=this._cleanupTitle(tab.title,tab.tm.url);let lowerCaseTitle=tab.title.toLowerCase();tab.tm.lowerCaseTitle=lowerCaseTitle;if(oldTab!=null&&tab.status=="loading"){tab.tm.sortTitle=oldTab.tm.sortTitle}else{tab.tm.sortTitle=this.normalizeLowerCaseTitle(lowerCaseTitle)}},_updateFavIcon:function(tab){let useCachedFavIcon=false;const cachedFavIconUrl=this.buildCachedFavIconUrl(tab.tm.url);if(tab.favIconUrl==null||tab.favIconUrl==""||this.isCachedFavIconUrl(tab.favIconUrl)){tab.favIconUrl=cachedFavIconUrl;useCachedFavIcon=true}tab.tm.useCachedFavIcon=useCachedFavIcon;tab.tm.cachedFavIconUrl=cachedFavIconUrl},formatExtendedId:function(tab,type){type=type??(tab?.tm.type??Classes.TabNormalizer.type.TAB);switch(type){case Classes.TabNormalizer.type.TAB:return tab.windowId+":"+tab.id+"/"+tab.index;case Classes.TabNormalizer.type.RCTAB:return"rc["+tab.sessionId+"]";case Classes.TabNormalizer.type.BOOKMARK:return"bm["+(tab.parentId!=null?tab.parentId:"")+"."+tab.bookmarkId+"]";case Classes.TabNormalizer.type.HISTORY:return"h["+tab.historyId+"]";default:const logHead="TabNormalizer.formatExtendedId():";this._err(logHead,"unknown type",type,tab);break}return"[none]"},_addNormalizedShortcutBadges:function(tab,secondary){let sm=settingsStore.getShortcutsManager();let scKeys=sm.getShortcutKeysForTab(tab,!secondary);let array=tab.tm.primaryShortcutBadges;if(secondary){array=tab.tm.secondaryShortcutBadges}scKeys.forEach(function(key){let keyAsString=sm.keyToUiString(key);array.push(keyAsString);tab.tm.searchBadges.push(keyAsString.toLowerCase())}.bind(this))},addShortcutBadges:function(tab){const logHead="TabNormalizer.addShortcutBadges():";if(tab.tm.type!=Classes.TabNormalizer.type.TAB){this._err(logHead,"this function can only be called for standard tabs");return}if(tab.tm.primaryShortcutBadges.length!=0||tab.tm.secondaryShortcutBadges.length!=0){this._err(logHead,"this function can only be called once after normalize()");return}this._addNormalizedShortcutBadges(tab,false);this._addNormalizedShortcutBadges(tab,true)},_addNormalizedVisualBadge:function(tab,badge,visible=true){if(visible){tab.tm.visualBadges.push(badge)}tab.tm.searchBadges.push(badge.toLowerCase())},_updateSearchBadges:function(tab){if(tab.active){this._addNormalizedVisualBadge(tab,"active")}if(tab.audible){this._addNormalizedVisualBadge(tab,"audible",false)}if(tab.discarded){this._addNormalizedVisualBadge(tab,"suspended",false)}if(tab.tm.type==Classes.TabNormalizer.type.RCTAB){this._addNormalizedVisualBadge(tab,"closed",false)}if(tab.highlighted){this._addNormalizedVisualBadge(tab,"highlighted",false)}if(tab.incognito){this._addNormalizedVisualBadge(tab,"incognito",false)}if(tab.mutedInfo!=null&&tab.mutedInfo.muted){this._addNormalizedVisualBadge(tab,"muted",false)}this._addNormalizedVisualBadge(tab,tab.status,false);if(tmUtils.isTabPinned(tab)){this._addNormalizedVisualBadge(tab,"pinned",false)}if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false);tab.tm.customGroupBadges.push(tab.tm.customGroupName.toLowerCase())}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},_updateBookmarkBadges:function(tab){tab.tm.searchBadges.push("bookmark");if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false);tab.tm.customGroupBadges.push(tab.tm.customGroupName.toLowerCase())}if(tmUtils.isTabPinned(tab)){this._addNormalizedVisualBadge(tab,"pinned",false)}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},_updateHistoryBadges:function(tab){if(tab.tm.customGroupName!=null){this._addNormalizedVisualBadge(tab,tab.tm.customGroupName,false);tab.tm.customGroupBadges.push(tab.tm.customGroupName.toLowerCase())}this._addNormalizedVisualBadge(tab,tab.tm.extId,settingsStore.getOptionShowTabId())},buildCachedFavIconUrl:function(url){return"chrome://favicon/size/16@1x/"+url},isCachedFavIconUrl:function(favIconUrl){return favIconUrl.startsWith("chrome://favicon/size/16@1x/")},_isTabMatchingBookmark:function(tab,bmNode){if(tab.tm.url!=""){return tab.tm.url.startsWith(bmNode.url)}return false},_setPinInheritance:function(tab,bmNode){tab.tm.pinInherited={type:"bookmark",id:bmNode.bookmarkId};if(tab.title==""||tab.url.includes(tab.title)||tab.title==tab.pendingUrl){tab.title=bmNode.title}},_updatePinInheritance:function(tab){if(window.bookmarksManager==null){return}let pinnedBookmarks=bookmarksManager.getPinnedBookmarks();if(pinnedBookmarks.length==0){return}for(let i=0;i<pinnedBookmarks.length;i++){let bmNode=pinnedBookmarks[i];if(!this._isTabMatchingBookmark(tab,bmNode)){continue}this._setPinInheritance(tab,bmNode);return}},normalizeBookmarkId:function(id){return"b"+id},_initBookmarkAsTab:function(tab){tab.bookmarkId=tab.id;tab.id=this.normalizeBookmarkId(tab.id);tab.status="unloaded"},updateBookmarkFolder:function(tab){const logHead="TabNormalizer.updateBookmarkFolder():";let folder=bookmarksManager.getBmFolderSync(tab);if(folder!=null){tab.tm.folder=folder;tab.tm.lowerCaseFolder=folder.toLowerCase()}else{this._log(logHead,"folder not available for",tab);tab.tm.folder="";tab.tm.lowerCaseFolder=""}},normalizeHistoryItemId:function(id){return"h"+id},_initHistoryItemAsTab:function(tab){tab.historyId=tab.id;tab.id=this.normalizeHistoryItemId(tab.id);tab.status="unloaded"},normalizeRecentlyClosedId:function(id){return"c"+id},_initRecentlyClosedAsTab:function(tab){tab.active=false;tab.id=this.normalizeRecentlyClosedId(tab.sessionId);tab.status="unloaded"},normalize:function(tab,options={}){let addShortcutBadges=options.addShortcutBadges??true;let type=options.type??Classes.TabNormalizer.type.TAB;let oldTab=options.oldTab;const logHead="TabNormalizer.normalize():";if(tab.tm==null){switch(type){case Classes.TabNormalizer.type.TAB:break;case Classes.TabNormalizer.type.RCTAB:this._initRecentlyClosedAsTab(tab);break;case Classes.TabNormalizer.type.BOOKMARK:this._initBookmarkAsTab(tab);break;case Classes.TabNormalizer.type.HISTORY:this._initHistoryItemAsTab(tab);break;default:this._err(logHead,"unknown type",type);break}}else{this._assert(tab.tm.type==type,tab,type)}tab.tm={type:type,url:null,protocol:null,hostname:null,pinInherited:null,customGroupName:null,lowerCaseUrl:null,lowerCaseTitle:null,sortTitle:null,useCachedFavIcon:null,cachedFavIconUrl:null,folder:"",lowerCaseFolder:"",wantsAttention:false,extId:this.formatExtendedId(tab,type),visualBadges:[],searchBadges:[],customGroupBadges:[],primaryShortcutBadges:[],secondaryShortcutBadges:[]};this.updateUrl(tab);if(type==Classes.TabNormalizer.type.TAB){this._updatePinInheritance(tab)}this.updateTitle(tab,oldTab);this._updateFavIcon(tab);switch(type){case Classes.TabNormalizer.type.TAB:this._updateSearchBadges(tab);if(addShortcutBadges){this.addShortcutBadges(tab)}break;case Classes.TabNormalizer.type.RCTAB:this._updateSearchBadges(tab);break;case Classes.TabNormalizer.type.BOOKMARK:this.updateBookmarkFolder(tab);this._updateBookmarkBadges(tab);break;case Classes.TabNormalizer.type.HISTORY:this._updateHistoryBadges(tab);break;default:this._err(logHead,"unknown type",type);break}}});Classes.Base.roDef(Classes.TabNormalizer,"type",{});Classes.Base.roDef(Classes.TabNormalizer.type,"TAB","tab");Classes.Base.roDef(Classes.TabNormalizer.type,"RCTAB","rctab");Classes.Base.roDef(Classes.TabNormalizer.type,"BOOKMARK","bookmark");Classes.Base.roDef(Classes.TabNormalizer.type,"HISTORY","history");Classes.Base.roDef(window,"tabNormalizer",Classes.TabNormalizer.createAs("tabNormalizer"));Classes.TabsStoreBase=Classes.Base.subclass({_dict:null,_list:null,_useList:null,_init:function(tabs,useList=true){Classes.Base._init.call(this);this._useList=useList;this.reset();if(tabs!=null){if(this._useList){this._list=tabs}for(let i=0;i<tabs.length;i++){this._dict[tabs[i].id]=tabs[i]}}},reset:function(){this._dict={};if(this._useList){this._list=[]}},_findTabIndexById:function(searchTabId){if(!this._useList){return-1}return this._list.findIndex(function(tab){if(tab.id==searchTabId){return true}return false}.bind(this))},add:function(tab,value){value=optionalWithDefault(value,tab);this._dict[tab.id]=value;if(this._useList){this._list.push(value)}},update:function(tab,value,tabIdx){value=optionalWithDefault(value,tab);if(!(tab.id in this._dict)){Classes.TabsStoreBase.add.call(this,tab,value);return null}if(tabIdx==null){tabIdx=this._findTabIndexById(tab.id)}if(this._useList){this._assert(tabIdx!=-1)}let retVal=this._dict[tab.id];this._dict[tab.id]=value;if(tabIdx!=-1){this._list[tabIdx]=value}return retVal},removeById:function(tabId){if(!(tabId in this._dict)){return null}let tabIdx=this._findTabIndexById(tabId);if(this._useList){this._assert(tabIdx!=-1,tabId,this._dict[tabId],this._list)}let retVal=this._dict[tabId];delete this._dict[tabId];if(tabIdx!=-1){this._list.splice(tabIdx,1)}return retVal},getById:function(searchTabId){return this._dict[searchTabId]},hasById:function(searchTabId){return this.getById(searchTabId)!==undefined},get:function(){if(!this._useList){return Object.values(this._dict)}return this._list},getDict:function(){return this._dict},getTabIdList:function(){return Object.keys(this._dict)},getCount:function(){return this._list.length},discard:function(){this.reset();gcChecker.add(this)}});Classes.TabsStore=Classes.TabsStoreBase.subclass({_tabsLoading:null,_tabsPinnedFromBookmarks:null,_init:function(tabs,oldTabsDict){this._tabsLoading=Classes.TabsStoreBase.create();this._tabsPinnedFromBookmarks=Classes.TabsStoreBase.create(null,false);Classes.TabsStoreBase._init.call(this,tabs);this.debug();this.normalizeAll({addShortcutBadges:false,oldTabsDict:oldTabsDict})},normalizeAll:function(options){options=optionalWithDefault(options,{});let oldTabsDict=optionalWithDefault(options.oldTabsDict,[]);const logHead="TabsStore::normalizeAll(): ";perfProf.mark("normalizeStart");let tabs=this.get();this._tabsLoading.reset();this._tabsPinnedFromBookmarks.reset();for(let i=0;i<tabs.length;i++){let tab=tabs[i];tabNormalizer.normalize(tab,{addShortcutBadges:options.addShortcutBadges,oldTab:oldTabsDict[tab.id]});if(tab.status=="loading"){this._log(logHead+"found tab in loading status",tab);this._tabsLoading.add(tab)}if(tab.tm.pinInherited!=null){this._tabsPinnedFromBookmarks.add(tab,tab.tm.pinInherited.id)}}perfProf.mark("normalizeEnd");perfProf.measure("Normalize","normalizeStart","normalizeEnd")},addShortcutBadges:function(){let tabs=this.get();for(let i=0;i<tabs.length;i++){tabNormalizer.addShortcutBadges(tabs[i])}},reset:function(){this._tabsLoading.reset();this._tabsPinnedFromBookmarks.reset();Classes.TabsStoreBase.reset.call(this)},_addOrUpdateInner:function(newTab,oldTab){const logHead="TabsStore::_addOrUpdateInner(): ";tabNormalizer.normalize(newTab,{oldTab:oldTab});if(newTab.status=="loading"){this._log(logHead+"found tab in loading status",newTab);this._tabsLoading.add(newTab)}else{this._tabsLoading.removeById(newTab.id)}if(newTab.tm.pinInherited!=null){this._tabsPinnedFromBookmarks.add(newTab,newTab.tm.pinInherited.id)}else{this._tabsPinnedFromBookmarks.removeById(newTab.id)}},add:function(newTab){Classes.TabsStoreBase.add.call(this,newTab);this._addOrUpdateInner(newTab)},update:function(newTab,tabIdx){let oldTab=Classes.TabsStoreBase.update.call(this,newTab,null,tabIdx);this._addOrUpdateInner(newTab,oldTab);return oldTab},removeById:function(tabId){let retVal=Classes.TabsStoreBase.removeById.call(this,tabId);if(retVal==null){return null}this._tabsLoading.removeById(tabId);this._tabsPinnedFromBookmarks.removeById(tabId);return retVal},_tabsCmp:function(a,b){return tmUtils.isEqual(a,b,false)},cloneTabs:function(){return tmUtils.deepCopy(this.get())},diff:function(oldTabList){let sortByIdFn=function(x,y){if(x.id==y.id){return 0}if(x.id<y.id){return-1}return 1};return tmUtils.arrayDiff(oldTabList,this.get(),sortByIdFn,this._tabsCmp.bind(this))},getTabsLoading:function(){return this._tabsLoading.getDict()},getPinnedBookmarkIdsFromTabs:function(){return this._tabsPinnedFromBookmarks.get()}});Classes.Base.roDef(window,"ExtCommands",{});Classes.Base.roDef(window.ExtCommands,"BACK","00back");Classes.Base.roDef(window.ExtCommands,"FWD","01fwd");Classes.Base.roDef(window.ExtCommands,"LAUNCHORSEARCH","02los");Classes.Base.roDef(window.ExtCommands,"CLOSEBACK","03closeback");Classes.Base.roDef(window.ExtCommands,"CLOSEFWD","04closefwd");Classes.Base.roDef(window.ExtCommands,"SHORTCUT01","90shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT02","91shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT03","92shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT04","93shortcut");Classes.Base.roDef(window.ExtCommands,"SHORTCUT05","94shortcut");Classes.ShortcutsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_shortcutsStore:null,_tabs:null,_eventManager:null,_shortcutsInfo:null,_shortcutKeys:[window.ExtCommands.SHORTCUT01,window.ExtCommands.SHORTCUT02,window.ExtCommands.SHORTCUT03,window.ExtCommands.SHORTCUT04,window.ExtCommands.SHORTCUT05],_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this._shortcutsStore=null;this._shortcutsInfo=null;this._tabs=[];this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this._shortcutsStore={};for(let i=0;i<this._shortcutKeys.length;i++){let persDict=this._shortcutsStore[this._shortcutKeys[i]]=Classes.PersistentDict.createAs(this._storageKeyPrefix+"shortcut0"+(i+1),chrome.storage.sync);promiseArray.push(persDict.getInitPromise());persDict.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this,this._shortcutKeys[i]))}return Promise.all(promiseArray).then(this._computeShortcutsInfo.bind(this))},_onUpdatedCb:function(key,ev){this._computeInfo(key);this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_propertySearch:function(key,value){let retVal=this._tabs.reduce(function(res,tab){if(tab.incognito==false&&tab.tm[key]==value){res.push(tab)}return res},[]);return retVal.sort(Classes.TabNormalizer.comparePositionFn)},_computeByHostname:function(hostname){const logHead="ShortcutsManager::_computeByHostname("+hostname+"): ";let tabs=this._propertySearch("hostname",hostname);if(tabs.length==0){this._log(logHead+"setting as URL");return{url:"https://"+hostname}}return{tab:tabs[0]}},_computeByUrlNoSearch:function(sc,forceNewTab){if(forceNewTab){return{url:sc.get("url")}}let tabs=this._propertySearch("lowerCaseUrl",sc.get("url").toLowerCase());if(tabs.length==0){return{url:sc.get("url")}}return{tab:tabs[0]}},_computeByUrl:function(sc){let forceNewTab=optionalWithDefault(sc.get("alwaysNewTab"),false);let useClipboard=optionalWithDefault(sc.get("useClipboard"),false);if(!useClipboard){return this._computeByUrlNoSearch(sc,forceNewTab)}if(!sc.get("url").includes("%s")){return this._computeByUrlNoSearch(sc,forceNewTab)}if(forceNewTab){return{searchUrl:sc.get("url")}}let retVal={searchUrl:sc.get("url")};let[protocol,hostname]=tabNormalizer.getProtocolHostname(retVal.searchUrl);let tabs=this._propertySearch("hostname",hostname);if(tabs.length!=0){retVal.candidateTabs=tabs}return retVal},_computeInfo:function(shortcutKey){let sc=this._shortcutsStore[shortcutKey];if(sc.get("tabMania")!=null){this._shortcutsInfo[shortcutKey]={tabMania:true};return}if(sc.get("hostname")!=null){this._shortcutsInfo[shortcutKey]=this._computeByHostname(sc.get("hostname"));return}if(sc.get("url")==null){this._shortcutsInfo[shortcutKey]={empty:true};return}this._shortcutsInfo[shortcutKey]=this._computeByUrl(sc)},_computeShortcutsInfo:function(){this._shortcutsInfo={};this._shortcutKeys.forEach(this._computeInfo.bind(this))},updateTabs:function(tabs){this._assert(this.isInitialized());this._tabs=optionalWithDefault(tabs,[]);this._computeShortcutsInfo()},_isTabInCandidateTabs:function(tabId,candidateTabs,firstCandidate){if(candidateTabs==null){return false}if(firstCandidate){return candidateTabs[0].id==tabId}let idx=candidateTabs.findIndex(function(elem,index){if(index==0){return false}if(elem.id==tabId){return true}return false});return idx!=-1},getShortcutKeys:function(){return this._shortcutKeys},getSearchShortcutKeys:function(){let retVal=[];this._shortcutKeys.forEach(function(key){if(this._shortcutsInfo[key].searchUrl!=null){retVal.push(key)}}.bind(this));return retVal},getShortcutKeysForTab:function(tab,firstCandidate){firstCandidate=optionalWithDefault(firstCandidate,true);let retVal=[];this._shortcutKeys.forEach(function(key){if(this._shortcutsInfo[key].tab!=null&&this._shortcutsInfo[key].tab.id==tab.id&&firstCandidate){retVal.push(key)}if(this._isTabInCandidateTabs(tab.id,this._shortcutsInfo[key].candidateTabs,firstCandidate)){retVal.push(key)}}.bind(this));return retVal},getShortcutInfo:function(shortcutKey){const logHead="ShortcutsManager::getShortcutInfo("+shortcutKey+"): ";this._log(logHead+"entering ",this._shortcutsInfo);return this._shortcutsInfo[shortcutKey]},setShortcut:function(shortcutKey,shortcutStoreDict){return this._shortcutsStore[shortcutKey].setAll(shortcutStoreDict)},setShortcutProp:function(shortcutKey,prop,value){return this._shortcutsStore[shortcutKey].set(prop,value)},delShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].del(prop)},getShortcutProp:function(shortcutKey,prop){return this._shortcutsStore[shortcutKey].get(prop)},setShortcutTitle:function(shortcutKey,value){return this.setShortcutProp(shortcutKey,"title",value)},getShortcutTitle:function(shortcutKey){return optionalWithDefault(this.getShortcutProp(shortcutKey,"title"),"")},setShortcutHostnameOrUrl:function(shortcutKey,value){const logHead="ShortcutsManager::setShortcutHostnameOrUrl("+shortcutKey+', "'+value+'"): ';value=value.trim();let currDict=this._shortcutsStore[shortcutKey].getAll();if(value==""||value.toLowerCase()=="tabmania"){this._log(logHead+"clearing both hostname and URL");delete currDict["hostname"];delete currDict["url"];if(value.toLowerCase()=="tabmania"){currDict["tabMania"]=value}else{delete currDict["tabMania"]}return this.setShortcut(shortcutKey,currDict)}delete currDict["tabMania"];let toSet="hostname";let toDel="url";if(isUrl(value)){toSet="url";toDel="hostname";this._log(logHead+"setting as URL")}else{this._log(logHead+"setting as hostname")}currDict[toSet]=value;delete currDict[toDel];return this.setShortcut(shortcutKey,currDict)},getShortcutHostnameOrUrl:function(shortcutKey){let tabMania=this.getShortcutProp(shortcutKey,"tabMania");if(tabMania!=null){return tabMania}let hostname=this.getShortcutProp(shortcutKey,"hostname");if(hostname==null||hostname==""){return this.getShortcutProp(shortcutKey,"url")}return hostname},isShortcutKey:function(key){return this._shortcutKeys.includes(key)},keyToUiString:function(shortcutKey){let idx=this._shortcutKeys.indexOf(shortcutKey);if(idx==-1){return"SC-err"}return"SC"+(idx+1)}});Classes.CustomGroupsManager=Classes.AsyncBase.subclass({_storageKeyPrefix:null,_customGroupsStore:null,_parsedCustomGroups:null,_eventManager:null,_init:function(storageKeyPrefix){this._storageKeyPrefix=storageKeyPrefix;this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this._customGroupsStore=Classes.PersistentDict.createAs(this._storageKeyPrefix+"customGroups",chrome.storage.sync);promiseArray.push(this._customGroupsStore.getInitPromise());this._customGroupsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(this._buildCustomGroups.bind(this))},_onUpdatedCb:function(ev){let key=ev.detail.target.getId();const logHead="CustomGroupsManager._onUpdatedCb():";this._log(logHead,"processing update",key);this._buildCustomGroups();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},_parseRegex:function(matchList){const logHead="CustomGroupsManager._parseRegex():";if(matchList==null){return null}let list=matchList.split("\n");let trimmedList=[];list.forEach(function(regex){let trimmedRegex=regex.trim();if(trimmedRegex!=""){trimmedList.push("("+tmUtils.regexEscape(trimmedRegex)+")")}}.bind(this));if(trimmedList.length==0){return null}let fullExpr=trimmedList.join("|");this._log(logHead,"after split:",matchList,fullExpr);try{return new RegExp(fullExpr)}catch(e){this._err(logHead,"unable to parse regex",e,matchList);return null}},_buildCustomGroups:function(){const logHead="CustomGroupsManager._buildCustomGroups():";this._parsedCustomGroups={};let groupTitles=this.getCustomGroupNames();groupTitles.forEach(function(title){this._parsedCustomGroups[title]=this.getCustomGroup(title);this._log(logHead,'processing group "'+title+'":',this._parsedCustomGroups[title]);this._parsedCustomGroups[title].parsedRegex=this._parseRegex(this._parsedCustomGroups[title].matchList)}.bind(this))},getCustomGroupByHostname:function(hostname){let titles=this.getCustomGroupNames();for(let i=0;i<titles.length;i++){if(this._parsedCustomGroups[titles[i]].parsedRegex!=null&&this._parsedCustomGroups[titles[i]].parsedRegex.test(hostname)){return titles[i]}}return null},hasCustomGroup:function(name,ignoreCase){return this._customGroupsStore.has(name,ignoreCase)},getCustomGroupNames:function(){return this._customGroupsStore.getAllKeys()},getCustomGroup:function(name){return this._customGroupsStore.get(name)},setCustomGroup:function(name,obj){return this._customGroupsStore.set(name,obj)},renameCustomGroup:function(name,newName){return this._customGroupsStore.rename(name,newName)},delCustomGroup:function(name){return this._customGroupsStore.del(name)},getCustomGroupProp:function(name,prop){if(!this._customGroupsStore.has(name)){return null}return this._customGroupsStore.get(name)[prop]},setCustomGroupProp:function(name,prop,value){const logHead="CustomGroupsManager.setCustomGroupProp():";if(!this._customGroupsStore.has(name)){this._err(logHead,"custom group not found",name);return Promise.reject()}this._log(logHead,"setting value:",name,prop,value);let groupInfo=this.getCustomGroup(name);groupInfo[prop]=value;return this.setCustomGroup(name,groupInfo)},_colorToCalloutCss:{none:"",gray:"tm-callout-gray",blue:"tm-callout-blue",red:"tm-callout-red",yellow:"tm-callout-yellow",green:"tm-callout-green",pink:"tm-callout-pink",purple:"tm-callout-purple",cyan:"tm-callout-cyan"},getCustomGroupCssByColor:function(color){return this._colorToCalloutCss[color]},getCustomGroupColor:function(groupName){let color=this.getCustomGroupProp(groupName,"color")??"none";if(color=="grey"){color="gray";this.setCustomGroupProp(groupName,"color",color)}return color},getCustomGroupCss:function(groupName){let color=this.getCustomGroupColor(groupName);return this.getCustomGroupCssByColor(color)}});Classes.SettingsStore=Classes.AsyncBase.subclass({_storageKeyPrefix:"",_options:null,_customGroups:null,_pinnedGroups:null,_pinnedBookmarks:null,_shortcutsManager:null,_eventManager:null,_init:function(storageKeyPrefix){this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this._options=Classes.PersistentDict.createAs(this._storageKeyPrefix+"options",chrome.storage.sync);promiseArray.push(this._options.getInitPromise());this._options.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._customGroupsManager=Classes.CustomGroupsManager.create(this._storageKeyPrefix);promiseArray.push(this._customGroupsManager.getInitPromise());this._customGroupsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._pinnedGroups=Classes.PersistentSet.createAs(this._storageKeyPrefix+"pinnedGroups",chrome.storage.sync);promiseArray.push(this._pinnedGroups.getInitPromise());this._pinnedGroups.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._pinnedBookmarks=Classes.PersistentSet.createAs(this._storageKeyPrefix+"pinnedBookmarks",chrome.storage.sync);promiseArray.push(this._pinnedBookmarks.getInitPromise());this._pinnedBookmarks.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));this._shortcutsManager=Classes.ShortcutsManager.create(this._storageKeyPrefix);promiseArray.push(this._shortcutsManager.getInitPromise());this._shortcutsManager.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));return Promise.all(promiseArray).then(function(){perfProf.mark("settingsLoaded")})},_onUpdatedCb:function(ev){let key=ev.detail.key;if(key==null){key=ev.detail.target.getId()}this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},getAllOptions:function(){this._assert(this.isInitialized());return this._options},_getOption:function(prop){this._assert(this.isInitialized());return this._options.get(prop)},_getBooleanOption:function(prop,defaultValue=false){let retVal=this._getOption(prop);if(retVal==null){return defaultValue}return retVal},_setOption:function(prop,value){this._assert(this.isInitialized());return this._options.set(prop,value)},getOptionRecentlyClosedInSearch:function(){return this._getBooleanOption("recentlyClosedInSearch",true)},setOptionRecentlyClosedInSearch:function(value){return this._setOption("recentlyClosedInSearch",value)},getOptionBookmarksInSearch:function(){return this._getBooleanOption("bookmarksInSearch",true)},setOptionBookmarksInSearch:function(value){return this._setOption("bookmarksInSearch",value)},getOptionHistoryInSearch:function(){return this._getBooleanOption("historyInSearch")},setOptionHistoryInSearch:function(value){return this._setOption("historyInSearch",value)},getOptionBookmarksInIncognitoSearch:function(){return this._getBooleanOption("bookmarksInIncognitoSearch",true)},setOptionBookmarksInIncognitoSearch:function(value){return this._setOption("bookmarksInIncognitoSearch",value)},getOptionShowTabId:function(){if(!this._getBooleanOption("devMode")){return false}return this._getBooleanOption("showTabId")},setOptionShowTabId:function(value){return this._setOption("showTabId",value)},getOptionDevMode:function(){return this._getBooleanOption("devMode")},setOptionDevMode:function(value){return this._setOption("devMode",value)},getOptionAdvancedMenu:function(){return this._getBooleanOption("advancedMenu")},setOptionAdvancedMenu:function(value){return this._setOption("advancedMenu",value)},getOptionSearchUrl:function(){return this._getOption("searchUrl")},setOptionSearchUrl:function(value){return this._setOption("searchUrl",value)},getOptionNewTabToLtw:function(){return this._getBooleanOption("newTabToLtw",false)},setOptionNewTabToLtw:function(value){return this._setOption("newTabToLtw",value)},getOptionNewTabToLtwNoOpener:function(){return this._getBooleanOption("newTabToLtwNoOpener",true)},setOptionNewTabToLtwNoOpener:function(value){return this._setOption("newTabToLtwNoOpener",value)},getOptionNewTabToLtwWithOpener:function(){return this._getBooleanOption("newTabToLtwWithOpener")},setOptionNewTabToLtwWithOpener:function(value){return this._setOption("newTabToLtwWithOpener",value)},getOptionNewTabToLtwEmpty:function(){return this._getBooleanOption("newTabToLtwEmpty",true)},setOptionNewTabToLtwEmpty:function(value){return this._setOption("newTabToLtwEmpty",value)},getOptionNewTabDedup:function(){return this._getBooleanOption("newTabDedup",false)},setOptionNewTabDedup:function(value){return this._setOption("newTabDedup",value)},getOptionNewTabDedupNoOpener:function(){return this._getBooleanOption("newTabDedupNoOpener",true)},setOptionNewTabDedupNoOpener:function(value){return this._setOption("newTabDedupNoOpener",value)},getOptionNewTabDedupWithOpener:function(){return this._getBooleanOption("newTabDedupWithOpener",true)},setOptionNewTabDedupWithOpener:function(value){return this._setOption("newTabDedupWithOpener",value)},getOptionNewTabDedupEmpty:function(){return this._getBooleanOption("newTabDedupEmpty",true)},setOptionNewTabDedupEmpty:function(value){return this._setOption("newTabDedupEmpty",value)},getOptionStartupOpenPopup:function(){return this._getBooleanOption("startupOpenPopup",false)},setOptionStartupOpenPopup:function(value){return this._setOption("startupOpenPopup",value)},getOptionIncognitoBsTab:function(){return this._getBooleanOption("incognitoBsTab",false)},setOptionIncognitoBsTab:function(value){return this._setOption("incognitoBsTab",value)},getPinnedGroups:function(){this._assert(this.isInitialized());return this._pinnedGroups},isGroupPinned:function(groupName){return this._pinnedGroups.has(groupName)},pinGroup:function(groupName){return this._pinnedGroups.add(groupName)},unpinGroup:function(groupName){return this._pinnedGroups.del(groupName)},getPinnedBookmarks:function(){this._assert(this.isInitialized());return this._pinnedBookmarks},isBookmarkPinned:function(bmId){return this._pinnedBookmarks.has(bmId)},pinBookmark:function(bmId){return this._pinnedBookmarks.add(bmId)},pinManyBookmarks:function(bmIdList){return this._pinnedBookmarks.addMany(bmIdList)},unpinBookmark:function(bmId){return this._pinnedBookmarks.del(bmId)},unpinManyBookmarks:function(bmIdList){return this._pinnedBookmarks.delMany(bmIdList)},getCustomGroupsManager:function(){this._assert(this.isInitialized());return this._customGroupsManager},getShortcutsManager:function(){this._assert(this.isInitialized());return this._shortcutsManager}});perfProf.mark("settingsStarted");Classes.Base.roDef(window,"settingsStore",Classes.SettingsStore.create());settingsStore.debug();Classes.LocalStore=Classes.AsyncBase.subclass({_storageKeyPrefix:"",standardTabsBsTabExpandedGroups:null,incognitoTabsBsTabExpandedGroups:null,_bootstrapTabs:null,_eventManager:null,_incognitoAccess:null,_init:function(storageKeyPrefix){this.debug();this._eventManager=Classes.EventManager.create();this._eventManager.attachRegistrationFunctions(this);Classes.AsyncBase._init.call(this)},_asyncInit:function(){const logHead="LocalStore::_asyncInit(): ";let promiseArray=[Classes.AsyncBase._asyncInit.call(this)];this.standardTabsBsTabExpandedGroups=Classes.PersistentSet.createAs("standardTabsBsTab_expanded");promiseArray.push(this.standardTabsBsTabExpandedGroups.getInitPromise());this.incognitoTabsBsTabExpandedGroups=Classes.PersistentSet.createAs("incognitoTabsBsTab_expanded");promiseArray.push(this.incognitoTabsBsTabExpandedGroups.getInitPromise());this._bootstrapTabs=Classes.PersistentDict.createAs("bootstrapTabs");promiseArray.push(this._bootstrapTabs.getInitPromise());this._bootstrapTabs.addEventListener(Classes.EventManager.Events.UPDATED,this._onUpdatedCb.bind(this));promiseArray.push(chromeUtils.wrap(chrome.extension.isAllowedIncognitoAccess,logHead).then(function(isAllowedAccess){this._incognitoAccess=isAllowedAccess}.bind(this)));return Promise.all(promiseArray).then(function(){perfProf.mark("localStoreLoaded")})},_onUpdatedCb:function(ev){let key=ev.detail.target.getId();this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,{key:key})},getActiveBsTabId:function(){return this._bootstrapTabs.get("activeTabId")},setActiveBsTabId:function(bsTabId){return this._bootstrapTabs.set("activeTabId",bsTabId)},isPopupDocked:function(){return false},setPopupDocked:function(docked){return Promise.resolve()},getPopupSize:function(){return this._bootstrapTabs.get("popupSize")},setPopupSize:function(posX,posY,width,height){size={posX:posX,posY:posY,width:width,height:height};return this._bootstrapTabs.set("popupSize",size)},isAllowedIncognitoAccess:function(){return this._incognitoAccess}});perfProf.mark("localStoreStarted");Classes.Base.roDef(window,"localStore",Classes.LocalStore.create());localStore.debug();Classes.ScheduledJob=Classes.Base.subclass({_handle:null,_jobName:null,_recurInterval:null,_init:function(jobFn,jobName){Classes.Base._init.call(this);this._jobName=optionalWithDefault(jobName,"");if(jobFn!=null){this._jobFn=jobFn}else{this._jobFn=this._job}},run:function(delay){const logHead="ScheduledJob::run(delay = "+delay+", now: "+Date.now()+', job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(delay==null||delay==0){this.skip();this._jobFn();return}if(this._handle!=null){this._log(logHead+"already scheduled");return}this._handle=setTimeout(function(){this._jobFn();this._handle=null}.bind(this),delay)},start:function(interval,runOnceNow){runOnceNow=optionalWithDefault(runOnceNow,true);const logHead="ScheduledJob::start("+interval+', job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(this.isRunning()){this._log(logHead+"already scheduled");return}this._recurInterval=interval;this._handle=this._safeSetInterval(this._jobFn.bind(this),interval);this._log(logHead+"started");if(runOnceNow){this._jobFn()}},stop:function(){const logHead='ScheduledJob::stop(job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(!this.isRunning()){this._log(logHead+"not scheduled");return}this._log(logHead+"stopping");if(this._recurInterval==null){clearInterval(this._handle);this._recurInterval=null}else{clearTimeout(this._handle)}this._handle=null},skip:function(){const logHead='ScheduledJob::skip(job name: "'+this._jobName+'", handleId: '+this._handle+"): ";if(this._handle==null){this._log(logHead+"not scheduled");return}this._log(logHead+"skipping");let savedRecurInterval=this._recurInterval;this.stop();if(savedRecurInterval!=null){this.start(savedRecurInterval,false)}},discard:function(){this.stop();this._jobFn=null;gcChecker.add(this)},isRunning:function(){return this._handle!=null},_job:function(){this._errorMustSubclass("ScheduledJob::_job()")},_safeSetInterval:function(fn,interval){const logHead="ScheduledJob::_safeSetInterval(): ";if(typeof interval!=="number"){this._err(logHead+"interval is not a number ("+interval+"), bypassing setInterval() to avoid trouble");return}if(interval<1e3){this._err(logHead+"interval is too small ("+interval+"), bypassing setInterval() to avoid trouble");return}return setInterval(fn,interval)}});Classes.PopupDockerBase=Classes.Base.subclass({_undockedInitWidth:420,_undockedInitHeight:800,_init:function(){Classes.Base._init.call(this);this.debug()},getPopupUrl:function(undocked){undocked=optionalWithDefault(undocked,false);let urlSearch="";if(undocked){urlSearch="?undocked"}return chrome.runtime.getURL(isProd()?"popup.html"+urlSearch:"popup/popup.html"+urlSearch)},_launchUndocked:function(){const logHead="PopupDockerBase::_launchUndocked(): ";let storedSize=optionalWithDefault(localStore.getPopupSize(),{});let createData={url:this.getPopupUrl(true),focused:true,type:"popup",left:optionalWithDefault(storedSize.posX,0),top:optionalWithDefault(storedSize.posY,0),width:optionalWithDefault(storedSize.width,this._undockedInitWidth),height:optionalWithDefault(storedSize.height,this._undockedInitHeight)};chromeUtils.wrap(chrome.windows.create,logHead,createData).then(function(){this._log(logHead+"launched",createData)}.bind(this))},_openUndocked:function(){const logHead="PopupDockerBase::_openUndocked(): ";this._log(logHead+"entering");chromeUtils.queryTabs({url:this.getPopupUrl(true)},logHead).then(function(tabs){if(tabs.length==0){this._log(logHead+"undocked tab not found, launching it");this._launchUndocked();return}if(tabs.length>1){this._log(logHead+"unexpected, multiple undocked popups found")}chromeUtils.activateTab(tabs[0]).then(function(){const extTabId=tabNormalizer.formatExtendedId(tabs[0]);this._log(logHead+"activated tab "+extTabId)}.bind(this))}.bind(this))},_setDocked:function(docked){docked=optionalWithDefault(docked,true);const logHead="PopupDockerBase::_setDocked("+docked+"): ";localStore.setPopupDocked(docked);let popupUrl="";if(docked){popupUrl=this.getPopupUrl()}chromeUtils.wrap(chromeUtils.bAction.setPopup,logHead,{popup:popupUrl}).then(function(){this._log(logHead+"chromeUtils.bAction.setPopup() succeeded")}.bind(this))},showState:function(){const logHead="PopupDockerBase::showState(): ";chromeUtils.wrap(chromeUtils.bAction.getPopup,logHead,{}).then(function(result){this._log(logHead+'chromeUtils.bAction.getPopup() returned "'+result+'" (empty means "undocked")')}.bind(this))}});Classes.Base.roDef(Classes.PopupDockerBase,"cmd",{});Classes.Base.roDef(Classes.PopupDockerBase.cmd,"SEARCH","search");Classes.PopupDockerBg=Classes.PopupDockerBase.subclass({_eventManager:null,_init:function(){Classes.PopupDockerBase._init.call(this);this.debug();this._eventManager=Classes.EventManager.create("popupDockerBg");this._eventManager.attachRegistrationFunctions(this);chromeUtils.bAction.onClicked.addListener(this._onClickedCb.bind(this));this._setDocked(localStore.isPopupDocked());if(!localStore.isPopupDocked()&&settingsStore.getOptionStartupOpenPopup()){this._launchUndocked()}},runPopupSearch:function(searchQuery){this.sendEvent(Classes.PopupDockerBase.cmd.SEARCH,searchQuery)},sendEvent:function(cmd,data){let extraData={cmd:cmd,data:data};this._eventManager.notifyListeners(Classes.EventManager.Events.UPDATED,extraData)},_onClickedCb:function(){this._openUndocked()}});Classes.PopupClient=Classes.MsgClient.subclass({_init:function(){Classes.MsgClient._init.apply(this,arguments)}});Classes.TabsManager=Classes.Base.subclass({_backTabs:null,_fwdTabs:null,_popupClient:null,_activeTabId:null,_isActiveWindowIdNone:null,_tabsCount:null,_normTabs:null,_updateScAllTabsJob:null,_updateScAllTabsDelay:1e3,_windowFocusLossPoller:null,_windowFocusLossInterval:1e3,_tabsCountAssertPoller:null,_init:function(){Classes.Base._init.apply(this,arguments);this._popupClient=Classes.PopupClient.create();this._popupClient.debug();this._backTabs=Classes.BoundArray.create(1e3);this._fwdTabs=Classes.BoundArray.create(1e3);this._isActiveWindowIdNone=false;this._updateScAllTabsJob=Classes.ScheduledJob.create(this._updateShortcutsAllTabs.bind(this),this._id+".updateScAllTabs");this._updateScAllTabsJob.debug();this._updateScAllTabsJob.run();this._windowFocusLossPoller=Classes.ScheduledJob.create(this._windowFocusLossCb.bind(this),this._id+".windowFocusLossPoller");this._windowFocusLossPoller.debug();this._setActiveTabId().then(function(activeTabId){const logHead="TabsManager::_init().then(): ";this._log(logHead+"entering");this._addAllListeners();this._windowFocusLossPoller.start(this._windowFocusLossInterval)}.bind(this));this._setTabsCount().then(function(){this._tabsCountAssertPoller=Classes.ScheduledJob.create(this._tabsCountAssertCb.bind(this),"tabsCountAssertPoller");this._tabsCountAssertPoller.start(30*1e3)}.bind(this))},_addAllListeners:function(){chrome.tabs.onCreated.addListener(this._onTabCreatedCb.bind(this));chrome.tabs.onUpdated.addListener(this._onTabUpdatedCb.bind(this));chrome.tabs.onActivated.addListener(this._onTabActivatedCb.bind(this));https:chrome.tabs.onRemoved.addListener(this._onTabRemovedCb.bind(this));chrome.tabs.onAttached.addListener(this._onTabAttachedCb.bind(this));chrome.tabs.onMoved.addListener(this._onTabMovedCb.bind(this));chrome.windows.onFocusChanged.addListener(this._onWindowFocusChangeCb.bind(this));settingsStore.addEventListener(Classes.EventManager.Events.UPDATED,this._settingStoreUpdatedCb.bind(this))},_tabsCountAssertCb:function(){this._queryTabs().then(function(tabs){logHead="TabsManager::_tabsCountAssertCb().cb: ";let tabsCount=tabs.length;if(tabsCount!=this._tabsCount){this._err(logHead+"found discrepancy: "+tabsCount+" "+this._tabsCount);this._tabsCount=tabsCount;this._setPopupBadge(tabsCount)}}.bind(this))},_queryTabs:function(incognito){return chromeUtils.queryTabs({incognito:incognito},"TabsManager::_queryTabs(): ")},_updateShortcutsAllTabs:function(){const logHead="TabsManager::_updateShortcutsAllTabs():";return this._queryTabs(false).then(function(tabs){this._log(logHead,"query completed, updating shortcuts");this._normTabs=Classes.TabsStore.create(tabs);settingsStore.getShortcutsManager().updateTabs(this._normTabs.get());this._normTabs.addShortcutBadges()}.bind(this))},_updateShortcutsOneTab:function(tab){const logHead="TabsManager::_updateShortcutsOneTab("+tab.id+"):";this._normTabs.update(tab);if(tab.incognito){this._log(logHead,"ignoring incognito tab for shortcuts");return}this._log(logHead,"updating shortcuts with ",tab);settingsStore.getShortcutsManager().updateTabs(this._normTabs.get())},_setTabsCount:function(){return this._queryTabs().then(function(tabs){let tabsCount=tabs.length;this._tabsCount=tabsCount;this._setPopupBadge(tabsCount);return tabsCount}.bind(this))},_incrementTabsCount:function(){this._setPopupBadge(++this._tabsCount)},_decrementTabsCount:function(){this._tabsCount--;if(this._tabsCount<0){this._tabsCount=0}this._setPopupBadge(this._tabsCount)},_setPopupBadge:function(tabsCount){const logHead="TabsManager::_setPopupBadge("+tabsCount+"): ";this._log(logHead+"entering");if(tabsCount>999){tabsCount="999+"}return chromeUtils.wrap(chromeUtils.bAction.setBadgeText,logHead,{text:tabsCount.toString()})},_windowFocusLossCb:function(){const logHead="TabsManager::_windowFocusLossCb(): ";chromeUtils.wrap(chrome.windows.getCurrent,logHead,null).then(function(window){if(this._isActiveWindowIdNone&&window.focused){this._log(logHead+"focus restored, simulate focus change event: ",window);this._onWindowFocusChangeCb(window.id,"simulated");return}if(!this._isActiveWindowIdNone&&!window.focused){this._log(logHead+"lost focus, simulate focus change event: ",window);this._onWindowFocusChangeCb(chrome.windows.WINDOW_ID_NONE,"simulated");return}}.bind(this))},_isTabDedupActive:function(tab){if(!settingsStore.getOptionNewTabDedup()){return false}if(tab.openerTabId==null){if(!settingsStore.getOptionNewTabDedupNoOpener()){return false}}else{if(tab.pendingUrl=="chrome://newtab/"){if(!settingsStore.getOptionNewTabDedupEmpty()){return false}}else{if(!settingsStore.getOptionNewTabDedupWithOpener()){return false}}}return true},_findExistingUrlMatchTab:async function(tab){const logHead="TabsManager::_findExistingUrlMatchTab(): ";if(!this._isTabDedupActive(tab)){this._log(logHead+"new tab deduplication configured off");return null}if(tab.tm.url==""){this._log(logHead+"no URL",tab);return null}let tabList=await chromeUtils.queryTabs({url:tab.tm.url,incognito:tab.incognito},logHead);if(tabList.length==0){return null}let thisTabIdx=-1;for(let i=0;i<tabList.length;i++){if(tabList[i].id==tab.id){if(thisTabIdx==-1){thisTabIdx=i}else{this._err(logHead+"more than one tab with same ID",tab.id,thisTabIdx,i,tabList)}continue}if(tabList[i].windowId==tab.windowId){return tabList[i]}}if(thisTabIdx!=0){return tabList[0]}if(tabList.length>1){return tabList[1]}return null},_getLtwIdForMove:async function(tab){if(!settingsStore.getOptionNewTabToLtw()){return null}if(tab.openerTabId==null){if(!settingsStore.getOptionNewTabToLtwNoOpener()){return null}}else{if(tab.pendingUrl=="chrome://newtab/"){if(!settingsStore.getOptionNewTabToLtwEmpty()){return null}}else{if(!settingsStore.getOptionNewTabToLtwWithOpener()){return null}}}let moveWinId=await chromeUtils.getLeastTabbedWindowId(tab.incognito,tab.windowId);if(moveWinId==tab.windowId){return null}return moveWinId},_createdTabSpecialActions:async function(tab){const logHead="TabsManager._createdTabSpecialActions():";if(tab.tm.protocol=="chrome-extension:"){return}if(!tab.active){return}if(tab.sessionId!==undefined){this._log(logHead,"ignoring tab with 'sessionId' property:",tab.sessionId,tab);return}let refActiveTabId=this._activeTabId;let existingTabPromise=this._findExistingUrlMatchTab(tab);let ltwIdPromise=this._getLtwIdForMove(tab);let winInfoPromise=chromeUtils.wrap(chrome.windows.get,logHead,tab.windowId);let[existingTab,ltwId,winInfo]=await Promise.all([existingTabPromise,ltwIdPromise,winInfoPromise]);if(winInfo!=null&&winInfo.type=="popup"){this._log(logHead,"popup window, ignoring",winInfo);return}if(existingTab==null&&ltwId==null){this._log(logHead,"nothing to do");return}if(existingTab!=null){this._log(logHead,"found existing tab (new, existing):",tab,existingTab);if(existingTab.windowId!=tab.windowId){chromeUtils.wrap(chrome.tabs.update,logHead,refActiveTabId,{active:true})}return Promise.all([chromeUtils.activateTab(existingTab),chromeUtils.closeTab(tab.id)])}this._log(logHead,"moving tab to least tabbed window",ltwId,tab);return chromeUtils.moveTab(tab,ltwId,true,refActiveTabId)},_onTabCreatedCb:function(tab){const logHead="TabsManager::_onTabCreatedCb(tabId: "+tab.id+", time: "+Date.now()+"): ";this._log(logHead+"tab: ",tab);this._updateShortcutsOneTab(tab);this._incrementTabsCount();this._createdTabSpecialActions(tab)},_onTabRemovedCb:function(tabId,removeInfo){const logHead="TabsManager._onTabRemovedCb(tabId: "+tabId+", time: "+Date.now()+"):";this._log(logHead,"removeInfo:",removeInfo);this._updateScAllTabsJob.run(this._updateScAllTabsDelay);this._decrementTabsCount();if(this._activeTabId==tabId){this._activeTabId=null}this._printBackTabs(logHead);this._backTabs.removeValue(tabId);this._printBackTabs(logHead);this._fwdTabs.removeValue(tabId)},_onTabUpdatedCb:function(tabId,changeInfo,tab){const logHead="TabsManager::_onTabUpdatedCb(tabId: "+tabId+", time: "+Date.now()+"): ";this._log(logHead+"changeInfo: ",changeInfo);if(tab.pendingUrl!=null&&tab.url!=tab.pendingUrl){this._log(logHead+"URL changing from "+tab.url+" to "+tab.pendingUrl)}this._updateShortcutsOneTab(tab)},_onTabAttachedCb:function(tabId,attachInfo){const logHead="TabsManager::onTabAttachedCb(tabId "+tabId+", time: "+Date.now()+"): ";this._log(logHead+"attachInfo: ",attachInfo);this._updateScAllTabsJob.run(this._updateScAllTabsDelay)},_onTabMovedCb:function(tabId,moveInfo){const logHead="TabsManager::onTabMovedCb(tabId "+tabId+", time: "+Date.now()+"): ";this._log(logHead+"moveInfo: ",moveInfo);this._updateScAllTabsJob.run(this._updateScAllTabsDelay)},_settingStoreUpdatedCb:function(ev){const logHead="TabsManager::_settingStoreUpdatedCb("+ev.detail.key+"): ";this._log(logHead+"entering")},_cleanUpStacks:function(tabId){while(this._backTabs.peek()==tabId){this._backTabs.pop()}while(this._fwdTabs.peek()==tabId){this._fwdTabs.pop()}},_onTabActivatedCb:function(activeInfo){const logHead="TabsManager._onTabActivatedCb(time: "+Date.now()+"):";this._log(logHead,"activeInfo:",activeInfo);this._printBackTabs(logHead);let oldActiveTabId=this._activeTabId;this._activeTabId=activeInfo.tabId;if(oldActiveTabId!=null){if(this._backTabs.peek()!=oldActiveTabId){this._backTabs.push(oldActiveTabId);this._notifyPopup()}else{this._log(logHead+"tabId "+oldActiveTabId+" already at the top of _backTabs, nothing to do")}}this._cleanUpStacks(activeInfo.tabId);this._isActiveWindowIdNone=false;this._printBackTabs(logHead)},_onWindowFocusChangeCb:function(windowId,simulated="real"){const logHead="TabsManager._onWindowFocusChangeCb("+simulated+"):";this._log(logHead,"windowId:",windowId);if(windowId==chrome.windows.WINDOW_ID_NONE){if(this._isActiveWindowIdNone){this._log(logHead,"duplicated event")}else{this._log(logHead,"all Chrome windows have lost focus");this._isActiveWindowIdNone=true}return}this._isActiveWindowIdNone=false;this._printBackTabs(logHead);this._setActiveTabId().then(function(oldActiveTabId,newActiveTabId){const logHead="TabsManager._onWindowFocusChangeCb().then("+oldActiveTabId+", "+newActiveTabId+"):";this._log(logHead,"entering");if(oldActiveTabId!=null&&oldActiveTabId!=newActiveTabId){if(this._backTabs.peek()!=oldActiveTabId){this._backTabs.push(oldActiveTabId);this._notifyPopup()}else{this._log(logHead,"tabId",oldActiveTabId,"already at the top of _backTabs, nothing to do")}}this._cleanUpStacks(newActiveTabId);this._printBackTabs(logHead)}.bind(this,this._activeTabId))},_getChromeActiveTab:function(){return chromeUtils.queryTabs({active:true,currentWindow:true},"TabsManager::_getChromeActiveTab(): ")},_setActiveTabId:function(){return this._getChromeActiveTab().then(function(tabs){const logHead="TabsManager::_setActiveTabId().cb: ";if(tabs.length==0){this._log(logHead+"info not available");this._activeTabId=null}else{this._log(logHead+"setting this._activeTabId to "+tabs[0].id,tabs[0]);this._activeTabId=tabs[0].id}return this._activeTabId}.bind(this))},_printBackTabs:function(logHead="TabsManager._printBackTabs():"){this._log(logHead,"backTabs is:",this._backTabs.get())},_closeOldActiveTab:function(oldActiveTabId){const logHead="TabsManager::_closeOldActiveTab("+oldActiveTabId+"): ";this._log(logHead+"closing tab ID");if(this._activeTabId==oldActiveTabId){this._log(logHead+"previous and current tab ID are the same")}chromeUtils.closeTab(oldActiveTabId)},_notifyPopup:function(){},goBack:function(closeCurrentTab=false){const logHead="TabsManager.goBack("+closeCurrentTab+"):";this._printBackTabs(logHead);if(this._isActiveWindowIdNone){this._log(logHead+"special case: back from chrome.windows.WINDOW_ID_NONE");this._isActiveWindowIdNone=false;chromeUtils.activateTabByTabId(this._activeTabId);return}const oldActiveTabId=this._activeTabId;const nextTabId=this._backTabs.pop();if(nextTabId!=null){if(this._activeTabId!=null){this._fwdTabs.push(this._activeTabId);this._activeTabId=null}this._log(logHead+"switching back to tab "+nextTabId);chromeUtils.activateTabByTabId(nextTabId)}else{this._log(logHead+"no previous tabs to go back to")}if(closeCurrentTab&&oldActiveTabId!=null){this._closeOldActiveTab(oldActiveTabId)}this._printBackTabs(logHead)},goFwd:function(closeCurrentTab=false){const logHead="TabsManager.goFwd("+closeCurrentTab+"):";const oldActiveTabId=this._activeTabId;const nextTabId=this._fwdTabs.pop();if(nextTabId!=null){this._log(logHead+"switching forward to tab "+nextTabId);chromeUtils.activateTabByTabId(nextTabId);if(closeCurrentTab&&oldActiveTabId!=null){this._closeOldActiveTab(oldActiveTabId)}}else{this._log(logHead+"no forward tabs to go back to")}}});Classes.KeyboardShortcuts=Classes.Base.subclass({_clipboardTextAreaElem:null,_init:function(){Classes.Base._init.call(this);this._initClipboardDomTextArea();chrome.commands.onCommand.addListener(this._onCommandCb.bind(this))},_initClipboardDomTextArea:function(){const logHead="KeyboardShortcuts::_initClipboardDomTextArea(): ";const textAreaId="KeyboardShortcutsClipboard";const textAreaHtml=`
		<textarea id="${textAreaId}" name="clipboard"></textarea>
	`;let elem=document.createElement("div");elem.innerHTML=textAreaHtml;document.body.append(elem);this._clipboardTextAreaElem=document.getElementById(textAreaId);if(this._clipboardTextAreaElem==null){this._err(logHead+"unable to get textarea element")}},_getClipboardAsText:function(){const logHead="KeyboardShortcuts::_getClipboardAsText(): ";this._clipboardTextAreaElem.focus();if(!document.execCommand("paste")){this._err(logHead+"paste command not supported");return null}let retVal=this._clipboardTextAreaElem.value;this._clipboardTextAreaElem.value="";return retVal},launchOrSearch:function(url,incognito=false){const logHead="KeyboardShortcuts::launchOrSearch(): ";if(url==null){return}let searchUrl=optionalWithDefault(settingsStore.getOptionSearchUrl(),"https://www.google.com/search?q=%s");if(!isUrl(url)){this._log(logHead+"the clipboard doesn't contain a URL, opening a search page instead: "+url);url=searchUrl.replace("%s",url)}chromeUtils.loadUrl(url,{incognito:incognito})},runCustomShortcutSearch:function(scInfo,searchText,incognito=false){const logHead="KeyboardShortcuts::runCustomShortcutSearch(searchText: "+searchText+"): ";if(searchText==null||searchText==""){this._log(logHead+"no search text, nothing to do");return}if(scInfo.tabMania){this._log(logHead+"running search query in the the TabMania popup");popupDockerBg.runPopupSearch(searchText);return}let url=scInfo.searchUrl.replace("%s",searchText);this._log(logHead+"converted searchUrl to: "+url,scInfo);if(scInfo.candidateTabs==null){this._log(logHead+"no candidateTabs, opening in new tab");chromeUtils.loadUrl(url,{incognito:incognito});return}let lowerCaseUrl=url.toLowerCase();let tabIdx=scInfo.candidateTabs.findIndex(function(elem){if(elem.tm.lowerCaseUrl==lowerCaseUrl){return true}return false}.bind(this));tabIdx=tabIdx!=-1?tabIdx:0;this._log(logHead+"opening in candidateTabs["+tabIdx+"]",scInfo.candidateTabs[tabIdx]);chromeUtils.loadUrl(url,{tabId:scInfo.candidateTabs[tabIdx].id})},_manageCustomShortcut:function(shortcutKey){const logHead="KeyboardShortcuts::_manageCustomShortcut("+shortcutKey+"): ";this._log(logHead+"entering");let scInfo=settingsStore.getShortcutsManager().getShortcutInfo(shortcutKey);if(scInfo==null){this._err(logHead+"unknown shortcut key");return}if(scInfo.empty){chromeUtils.createTab();return}let tabId=scInfo.tab!=null?scInfo.tab.id:null;if(scInfo.url!=null){this._log(logHead+"loading URL "+scInfo.url);chromeUtils.loadUrl(scInfo.url,{tabId:tabId});return}if(scInfo.tab!=null){this._log(logHead+"opening tabId "+tabId+", no URL change");chromeUtils.activateTab(scInfo.tab);return}this._log(logHead+"tabId = "+tabId+", search case: ",scInfo);this.runCustomShortcutSearch(scInfo,this._getClipboardAsText())},_onCommandCb:function(cmd){const logHead="KeyboardShortcuts::_onCommandCb("+cmd+"): ";this._log(logHead+"entering");switch(cmd){case window.ExtCommands.BACK:tabsManager.goBack();break;case window.ExtCommands.FWD:tabsManager.goFwd();break;case window.ExtCommands.CLOSEBACK:tabsManager.goBack(true);break;case window.ExtCommands.CLOSEFWD:tabsManager.goFwd(true);break;case window.ExtCommands.LAUNCHORSEARCH:let url=this._getClipboardAsText();this.launchOrSearch(url);break;case window.ExtCommands.SHORTCUT01:case window.ExtCommands.SHORTCUT02:case window.ExtCommands.SHORTCUT03:case window.ExtCommands.SHORTCUT04:case window.ExtCommands.SHORTCUT05:this._manageCustomShortcut(cmd);break;default:this._err(logHead+"unknown command");break}}});Classes.ContextMenu=Classes.Base.subclass({_allMenuItems:null,_updateAllSerialPromises:null,_init:function(){Classes.Base._init.call(this);this._updateAllSerialPromises=Classes.SerialPromises.createAs("ContextMenu::_updateAllSerialPromises");this._updateAllSerialPromises.next(this._updateAllMenuItems.bind(this,"init"),"init");settingsStore.getShortcutsManager().addEventListener(Classes.EventManager.Events.UPDATED,this._onShortcutUpdatedCb.bind(this))},_blinkPopupIconBadge:async function(tabId){const logHead="ContextMenu::_blinkPopupIconBadge("+tabId+")";let origColorArray=await chromeUtils.wrap(chromeUtils.bAction.getBadgeBackgroundColor,logHead,{tabId:tabId});let setBadgeBgColor=chromeUtils.bAction.setBadgeBackgroundColor;for(let i=0;i<3;i++){await chromeUtils.wrap(setBadgeBgColor,logHead,{tabId:tabId,color:"#FF0000"});await delay(150);await chromeUtils.wrap(setBadgeBgColor,logHead,{tabId:tabId,color:origColorArray});await delay(150)}},_moveToLeastTabbedCb:function(itemData,tab){const logHead="ContextMenu::_moveToLeastTabbedCb(): ";this._log(logHead+"entering",itemData,tab);chromeUtils.moveTabToLeastTabbedWindow(tab,true);this._blinkPopupIconBadge(tab.id)},_openInLeastTabbedCb:function(itemData,tab){const logHead="ContextMenu::_openInLeastTabbedCb(): ";if(itemData.linkUrl==null){this._err(logHead+"no link URL, nothing to do",itemData,tab);return}this._log(logHead+"entering",itemData,tab);chromeUtils.loadUrl(itemData.linkUrl,{incognito:tab.incognito})},_searchPopupCb:function(itemData,tab){const logHead="ContextMenu::_searchPopupCb(): ";this._log(logHead+"entering",itemData,tab);popupDockerBg.runPopupSearch(itemData.selectionText)},_searchCb:function(shortcutKey,itemData,tab){const logHead="ContextMenu::_searchCb(shortcutKey: "+shortcutKey+"): ";if(itemData.selectionText==null||itemData.selectionText==""){this._log(logHead+"no text selected, nothing to do",itemData,tab);return}this._log(logHead+"entering",itemData,tab);if(shortcutKey==null){keyboardShortcuts.launchOrSearch(itemData.selectionText,false);return}let scInfo=settingsStore.getShortcutsManager().getShortcutInfo(shortcutKey);keyboardShortcuts.runCustomShortcutSearch(scInfo,itemData.selectionText)},_addAllMenuItems:function(allMenuItems){let promisesList=[];allMenuItems.forEach(function(menuItem){const logHead="ContextMenu::_addAllMenuItems().iter("+menuItem.id+"): ";promisesList.push(chromeUtils.wrap(chrome.contextMenus.create,logHead,menuItem))}.bind(this));return Promise.all(promisesList)},_defineSelectionMenuItems:function(){let allSelectionMenuItems=[{id:"launchOrSearch",title:"Launch or search",contexts:["selection"],onclick:this._searchCb.bind(this,null)}];let sm=settingsStore.getShortcutsManager();let searchKeys=sm.getSearchShortcutKeys();searchKeys.forEach(function(key){let shortcutTitle=sm.getShortcutTitle(key);let title="";if(shortcutTitle!=""){title="Search with "+shortcutTitle+" ("+sm.keyToUiString(key)+")"}else{title="Search with sm.keyToUiString(key) (no title assigned)"}allSelectionMenuItems.push({id:key,title:title,contexts:["selection"],onclick:this._searchCb.bind(this,key)})}.bind(this));allSelectionMenuItems.push({id:"tabManiaSearch",title:"Search tabs in TabMania",contexts:["selection"],onclick:this._searchPopupCb.bind(this)});return allSelectionMenuItems},_defineAllMenuItems:function(){const logHead="ContextMenu::_defineAllMenuItems(): ";let allMenuItems=[{id:"moveToLeastTabbed",title:"Move this tab to least tabbed window",contexts:["page"],documentUrlPatterns:["*://*/*","chrome://*/*","file:///*"],onclick:this._moveToLeastTabbedCb.bind(this)},{id:"openInLeastTabbed",title:"Open in least tabbed window",contexts:["link"],onclick:this._openInLeastTabbedCb.bind(this)}];return allMenuItems.concat(this._defineSelectionMenuItems())},_updateAllMenuItems:function(debugInfo){const logHead="ContextMenu::_updateAllMenuItems("+debugInfo+"): ";return chromeUtils.wrap(chrome.contextMenus.removeAll,logHead).then(function(){this._log(logHead+"menus cleared, building them again");this._allMenuItems=this._defineAllMenuItems();return this._addAllMenuItems(this._allMenuItems)}.bind(this))},_onShortcutUpdatedCb:function(ev){let key=ev.detail.key;const logHead="ContextMenu::_onShortcutUpdatedCb("+key+"): ";this._log(logHead+"entering");this._updateAllSerialPromises.next(this._updateAllMenuItems.bind(this,key),key)}});Classes.InBrowserMsgServer=Classes.MsgServer.subclass({_init:function(){Classes.MsgServer._init.apply(this,arguments);this.addCmd("testNative",this._cmdTestNative.bind(this))},_cmdTestNative:function(request,sender,sendResponse){chrome.runtime.sendNativeMessage(nativeExtensionId,request,function(sendLocalResponse,response){this._log("MsgServer::_cmdTestNative().cb(): received from native "+JSON.stringify(response));sendLocalResponse(response)}.bind(this,sendResponse));return null}});Classes.NmhServer=Classes.MsgServer.subclass({_nativePort:null,_init:function(){Classes.MsgServer._init.apply(this,arguments);this.roDef(this,"_nmhExtensionId",this._id)},start:function(){this._nativePort=chrome.runtime.connectNative(this._nmhExtensionId);this._nativePort.onDisconnect.addListener(this._onDisconnectCb.bind(this));this._nativePort.onMessage.addListener(this._processMsgCb.bind(this))},_onDisconnectCb:function(){const logHead="NmhServer::_onDisconnectCb(): ";if(chrome.runtime.lastError){this._err(logHead+"disconnected due to: "+chrome.runtime.lastError.message)}else{this._log(logHead+"disconnected")}},_processMsgCb:function(request){const logHead="NmhServer::_processMsgCb(args count = "+arguments.length+"): ";this._log(logHead+JSON.stringify(request));var response=this._processMsgInner(request);this._nativePort.postMessage(response)}});Classes.NmhClient=Classes.MsgClient.subclass({_init:function(){Classes.MsgClient._init.apply(this,arguments);this.roDef(this,"_nmhExtensionId",this._id)},_requestInner:function(request){const logHead="NmhClient::_requestInner(): ";return chromeUtils.wrap(chrome.runtime.sendNativeMessage,logHead,this._nmhExtensionId,request)},isNmhInstalled:function(){return this.sendRequest("poll").then(function(){return true},function(chromeLastError){const logHead="NmhClient::isNmhInstalled().onRejected(): ";if(chromeLastError.message==chromeUtils.Error.NMH_NOTFOUND){this._log(logHead+chromeLastError.message);return Promise.resolve(false)}this._err(logHead+chromeLastError.message);return Promise.resolve(true)}.bind(this))}});chrome.runtime.onInstalled.addListener(function(){if(!isProd()){console.log("onInstalled.addListener() called")}});if(!isProd()){window.addEventListener("error",function(e){console.log("Unhandled exception: "+e.error.message);return false})}window.addEventListener("load",init);var inBrowserMsgServer=null;var tabsManager=null;var keyboardShortcuts=null;var bgInitPromiseResolveFn=null;var backgroundInitPromise=new Promise(function(resolve,reject){bgInitPromiseResolveFn=resolve});function openUrlCb(request,sender,sendResponse){chromeUtils.loadUrl(request.url,{winId:chrome.windows.WINDOW_ID_NONE}).then(function(){sendResponse({status:"success"})});return null}function init(){Promise.all([settingsStore.getInitPromise(),localStore.getInitPromise()]).then(function(){Classes.Base.roDef(window,"popupDockerBg",Classes.PopupDockerBg.create());inBrowserMsgServer=Classes.InBrowserMsgServer.createAs("inBrowserMsgServer");inBrowserMsgServer.start();inBrowserMsgServer.debug();inBrowserMsgServer.addCmd("launchUrl",openUrlCb);tabsManager=Classes.TabsManager.createAs("tabsManager");tabsManager.debug();keyboardShortcuts=Classes.KeyboardShortcuts.createAs("keyboardShortcuts");keyboardShortcuts.debug();let contextMenu=Classes.ContextMenu.create();contextMenu.debug();bgInitPromiseResolveFn()})}